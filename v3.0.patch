From 2ddbbcf394d123dad4184aded300551c1e047179 Mon Sep 17 00:00:00 2001
From: Francesco Carnevale <fpcarnevale@gmail.com>
Date: Fri, 13 Feb 2026 14:22:40 +0000
Subject: [PATCH] v3.0: KAROL_DATA centralizzato, CE, Simulazioni, Analisi
 Costi

- Fase 1: KAROL_DATA con breakdown costi, budget, benchmark settore
- Fase 1: formatEuro sostituisce fmtK/fmtM ovunque
- Fase 1: Overview ridisegnata con 6 card costi gestionali + Costo PL/gg
- Fase 2: Nuovo tab Conto Economico (Consolidato + per BU + Forecast)
- Fase 3: Tab Analisi con stacked bars e benchmark incidenza %
- Fase 3: Nuovo tab Simulazioni what-if con slider
- 7 tab: Overview | CE | Strutture | Trend | Cash Flow | Analisi | Simulazioni

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
---
 index.html | 752 ++++++++++++++++++++++++++++++++++++++++++-----------
 1 file changed, 599 insertions(+), 153 deletions(-)

diff --git a/index.html b/index.html
index 09d5e15..92eae18 100644
--- a/index.html
+++ b/index.html
@@ -28,7 +28,7 @@ body { font-family: 'DM Sans', 'Segoe UI', sans-serif; background: #F0F4F8; }
 <div id="root"></div>
 <script type="text/template" data-type="babel-source">
 const { useState } = React;
-const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LineChart, Line, Legend, AreaChart, Area, Cell, ReferenceLine, ComposedChart } = Recharts;
+const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LineChart, Line, Legend, AreaChart, Area, Cell, ReferenceLine, ComposedChart, PieChart, Pie, Treemap } = Recharts;
 
 // ============================================================================
 // PALETTE COLORI KAROL â€” D1
@@ -45,122 +45,192 @@ const C = {
 };
 
 // ============================================================================
-// DATI CE â€” Master Excel (elabora.py output 13/02/2026)
+// KAROL_DATA â€” Struttura centralizzata dati CdG
 // ============================================================================
-const UO = [
-  { cod: 'VLB', nome: 'RSA Villabate', tipo: 'RSA Alzheimer', pl: 44, colore: C.VLB, datiReali: false,
-    ricavi: 2004045, costiDir: 1675033, molI: 329012, molIPct: .1642,
-    sede: 353127, molG: -24115, molGPct: -.0120,
-    pers: 1147329, persPct: .5725, occ: .900, ricGg: 138.66,
-    rM: [169640,149876,173154,168672,174978,166476,164006,154880,163696,174683,170602,173382],
-    cM: [140731,139023,141794,142431,139408,138816,138345,135571,138366,140063,138567,141919] },
-  { cod: 'CTA', nome: 'CTA Ex Stagno', tipo: 'Psichiatrico', pl: 40, colore: C.CTA, datiReali: false,
-    ricavi: 1895648, costiDir: 1670541, molI: 225107, molIPct: .1187,
-    sede: 326072, molG: -100965, molGPct: -.0533,
-    pers: 1125426, persPct: .5937, occ: .920, ricGg: 141.19,
-    rM: [159954,144470,163122,157669,165770,157080,153507,148029,153462,166605,161823,164157],
-    cM: [139727,138994,137273,138930,139301,139815,137848,136411,139877,142422,140868,139074] },
-  { cod: 'COS', nome: 'CdC Cosentino', tipo: 'Riabilitazione', pl: 50, colore: C.COS, datiReali: false,
-    ricavi: 3799179, costiDir: 2924314, molI: 874865, molIPct: .2303,
-    sede: 541917, molG: 332949, molGPct: .0876,
-    pers: 1790988, persPct: .4714, occ: .860, ricGg: 241.99,
-    rM: [320319,290930,321212,318851,328869,319828,309744,294979,308393,333165,321909,330982],
-    cM: [244695,241092,240802,247326,245338,242449,243186,234286,242532,244702,251201,246704] },
-  { cod: 'LAB', nome: 'Karol Lab', tipo: 'Laboratorio', pl: 0, colore: C.LAB, datiReali: false,
-    ricavi: 1450153, costiDir: 891341, molI: 558813, molIPct: .3853,
-    sede: 212873, molG: 345940, molGPct: .2386,
-    pers: 438075, persPct: .3021, occ: null, ricGg: null,
-    rM: [123238,120564,123838,126162,120026,116683,116136,111219,116108,127791,130075,118316],
-    cM: [74958,73556,74432,75376,76159,75846,73710,69849,73075,74976,74564,74839] },
-  { cod: 'KCP', nome: 'Karol Casa Protetta', tipo: 'Casa Protetta', pl: 20, colore: C.KCP, datiReali: false,
-    ricavi: 700261, costiDir: 603299, molI: 96961, molIPct: .1385,
-    sede: 158011, molG: -61050, molGPct: -.0872,
-    pers: 391420, persPct: .5590, occ: null, ricGg: null,
-    rM: [59361,53405,61086,58202,60141,57339,57604,54021,57324,61888,58959,60931],
-    cM: [49419,50019,50686,50607,50544,50694,49326,48620,50241,51418,51571,50155] },
-];
-
-const TOT = { ric: 9849287, cDir: 7764528, molI: 2084759, molIPct: .2117, sede: 1592000, molG: 492759, molGPct: .0500, pers: 4893238, persPct: .4968 };
-
-const KPI = [
-  { kpi: 'MOL-I %', uo: 'VLB', v: .1642, tgt: .15, a: 'VERDE' },
-  { kpi: 'MOL-G %', uo: 'VLB', v: -.0120, tgt: .08, a: 'ROSSO' },
-  { kpi: 'Pers. %', uo: 'VLB', v: .5725, tgt: .55, a: 'GIALLO' },
-  { kpi: 'Occ. %', uo: 'VLB', v: .900, tgt: .90, a: 'GIALLO' },
-  { kpi: 'MOL-I %', uo: 'CTA', v: .1187, tgt: .15, a: 'GIALLO' },
-  { kpi: 'MOL-G %', uo: 'CTA', v: -.0533, tgt: .08, a: 'ROSSO' },
-  { kpi: 'Pers. %', uo: 'CTA', v: .5937, tgt: .55, a: 'GIALLO' },
-  { kpi: 'Occ. %', uo: 'CTA', v: .920, tgt: .90, a: 'VERDE' },
-  { kpi: 'MOL-I %', uo: 'COS', v: .2303, tgt: .15, a: 'VERDE' },
-  { kpi: 'MOL-G %', uo: 'COS', v: .0876, tgt: .08, a: 'GIALLO' },
-  { kpi: 'Pers. %', uo: 'COS', v: .4714, tgt: .55, a: 'VERDE' },
-  { kpi: 'Occ. %', uo: 'COS', v: .860, tgt: .90, a: 'GIALLO' },
-  { kpi: 'MOL-I %', uo: 'LAB', v: .3853, tgt: .15, a: 'VERDE' },
-  { kpi: 'MOL-G %', uo: 'LAB', v: .2386, tgt: .08, a: 'VERDE' },
-  { kpi: 'Pers. %', uo: 'LAB', v: .3021, tgt: .55, a: 'VERDE' },
-  { kpi: 'MOL-I %', uo: 'KCP', v: .1385, tgt: .15, a: 'GIALLO' },
-  { kpi: 'MOL-G %', uo: 'KCP', v: -.0872, tgt: .08, a: 'ROSSO' },
-  { kpi: 'Pers. %', uo: 'KCP', v: .5590, tgt: .55, a: 'GIALLO' },
-];
-
-// Cash Flow
-const waterfallRaw = [
-  { voce: 'Ricavi', valore: 9849287, tipo: 'entrata' },
-  { voce: 'Personale', valore: -4893238, tipo: 'uscita' },
-  { voce: 'Costi diretti', valore: -1581693, tipo: 'uscita' },
-  { voce: 'Servizi/Utenze', valore: -915897, tipo: 'uscita' },
-  { voce: 'EBITDA', valore: 2084759, tipo: 'subtotale' },
-  { voce: 'Costi Sede', valore: -1592000, tipo: 'uscita' },
-  { voce: 'MOL-G', valore: 492759, tipo: 'subtotale' },
-  { voce: 'Var. CCN', valore: -145000, tipo: 'uscita' },
-  { voce: 'CF Operativo', valore: 347759, tipo: 'subtotale' },
-  { voce: 'CAPEX', valore: -280000, tipo: 'uscita' },
-  { voce: 'Free CF', valore: 67759, tipo: 'subtotale' },
-  { voce: 'Debito', valore: -520000, tipo: 'uscita' },
-  { voce: 'Imposte', valore: -148000, tipo: 'uscita' },
-  { voce: 'CF Netto', valore: -600241, tipo: 'finale' },
-];
+const KAROL_DATA = {
+  meta: { anno: 2025, mesi_chiusi: 12, dati_reali: false, ultimo_aggiornamento: '13/02/2026' },
 
+  // Benchmark settore RSA/Healthcare
+  BENCHMARK: {
+    pers_pct: 0.55, mol_i_pct: 0.15, mol_g_pct: 0.08,
+    occ_pct: 0.90, costo_pl_gg: 130, dso: 120, dpo: 90, dscr: 1.2, cop_cassa_mesi: 2.0,
+  },
+
+  // UnitÃ  Operative con breakdown costi completo
+  UO: [
+    { cod: 'VLB', nome: 'RSA Villabate', tipo: 'RSA Alzheimer', pl: 44, colore: C.VLB,
+      ricavi: 2004045, budget_ricavi: 2100000,
+      costi: { personale: 1147329, materiali: 189704, servizi: 198000, utenze: 78000, manutenzione: 62000, altri: 0 },
+      budget_costi: { personale: 1120000, materiali: 180000, servizi: 190000, utenze: 75000, manutenzione: 55000, altri: 0 },
+      sede: 353127, ammortamenti: 85000, oneri_fin: 32000,
+      occ: 0.900, gg_degenza: 14454,
+      rM: [169640,149876,173154,168672,174978,166476,164006,154880,163696,174683,170602,173382],
+      cM: [140731,139023,141794,142431,139408,138816,138345,135571,138366,140063,138567,141919],
+    },
+    { cod: 'CTA', nome: 'CTA Ex Stagno', tipo: 'Psichiatrico', pl: 40, colore: C.CTA,
+      ricavi: 1895648, budget_ricavi: 2000000,
+      costi: { personale: 1125426, materiali: 158115, servizi: 215000, utenze: 82000, manutenzione: 52000, altri: 38000 },
+      budget_costi: { personale: 1080000, materiali: 150000, servizi: 200000, utenze: 78000, manutenzione: 48000, altri: 35000 },
+      sede: 326072, ammortamenti: 72000, oneri_fin: 28000,
+      occ: 0.920, gg_degenza: 13432,
+      rM: [159954,144470,163122,157669,165770,157080,153507,148029,153462,166605,161823,164157],
+      cM: [139727,138994,137273,138930,139301,139815,137848,136411,139877,142422,140868,139074],
+    },
+    { cod: 'COS', nome: 'CdC Cosentino', tipo: 'Riabilitazione', pl: 50, colore: C.COS,
+      ricavi: 3799179, budget_ricavi: 3700000,
+      costi: { personale: 1790988, materiali: 385326, servizi: 420000, utenze: 155000, manutenzione: 98000, altri: 75000 },
+      budget_costi: { personale: 1750000, materiali: 370000, servizi: 400000, utenze: 148000, manutenzione: 90000, altri: 70000 },
+      sede: 541917, ammortamenti: 120000, oneri_fin: 45000,
+      occ: 0.860, gg_degenza: 15695,
+      rM: [320319,290930,321212,318851,328869,319828,309744,294979,308393,333165,321909,330982],
+      cM: [244695,241092,240802,247326,245338,242449,243186,234286,242532,244702,251201,246704],
+    },
+    { cod: 'LAB', nome: 'Karol Lab', tipo: 'Laboratorio', pl: 0, colore: C.LAB,
+      ricavi: 1450153, budget_ricavi: 1400000,
+      costi: { personale: 438075, materiali: 215266, servizi: 125000, utenze: 48000, manutenzione: 35000, altri: 30000 },
+      budget_costi: { personale: 430000, materiali: 210000, servizi: 120000, utenze: 45000, manutenzione: 32000, altri: 28000 },
+      sede: 212873, ammortamenti: 55000, oneri_fin: 15000,
+      occ: null, gg_degenza: null,
+      rM: [123238,120564,123838,126162,120026,116683,116136,111219,116108,127791,130075,118316],
+      cM: [74958,73556,74432,75376,76159,75846,73710,69849,73075,74976,74564,74839],
+    },
+    { cod: 'KCP', nome: 'Karol Casa Protetta', tipo: 'Casa Protetta', pl: 20, colore: C.KCP,
+      ricavi: 700261, budget_ricavi: 750000,
+      costi: { personale: 391420, materiali: 78879, servizi: 68000, utenze: 32000, manutenzione: 22000, altri: 11000 },
+      budget_costi: { personale: 380000, materiali: 75000, servizi: 65000, utenze: 30000, manutenzione: 20000, altri: 10000 },
+      sede: 158011, ammortamenti: 38000, oneri_fin: 12000,
+      occ: null, gg_degenza: 7300,
+      rM: [59361,53405,61086,58202,60141,57339,57604,54021,57324,61888,58959,60931],
+      cM: [49419,50019,50686,50607,50544,50694,49326,48620,50241,51418,51571,50155],
+    },
+  ],
+
+  // Costi sede HQ
+  SEDE: { totale: 1592000, personale_hq: 680000, affitti: 320000, consulenze: 245000, IT: 142000, assicurazioni: 95000, altri: 110000 },
+
+  // Cash Flow
+  cashflow: {
+    waterfallRaw: [
+      { voce: 'Ricavi', valore: 9849287, tipo: 'entrata' },
+      { voce: 'Personale', valore: -4893238, tipo: 'uscita' },
+      { voce: 'Materiali', valore: -1027290, tipo: 'uscita' },
+      { voce: 'Servizi/Utenze', valore: -1421000, tipo: 'uscita' },
+      { voce: 'Altri Costi', valore: -423000, tipo: 'uscita' },
+      { voce: 'MOL-I', valore: 2084759, tipo: 'subtotale' },
+      { voce: 'Costi Sede', valore: -1592000, tipo: 'uscita' },
+      { voce: 'MOL-G', valore: 492759, tipo: 'subtotale' },
+      { voce: 'Ammortamenti', valore: -370000, tipo: 'uscita' },
+      { voce: 'Oneri Fin.', valore: -132000, tipo: 'uscita' },
+      { voce: 'Risultato Op.', valore: -9241, tipo: 'subtotale' },
+      { voce: 'Var. CCN', valore: -145000, tipo: 'uscita' },
+      { voce: 'CF Operativo', valore: 347759, tipo: 'subtotale' },
+      { voce: 'CAPEX', valore: -280000, tipo: 'uscita' },
+      { voce: 'Free CF', valore: 67759, tipo: 'subtotale' },
+      { voce: 'Debito', valore: -520000, tipo: 'uscita' },
+      { voce: 'Imposte', valore: -148000, tipo: 'uscita' },
+      { voce: 'CF Netto', valore: -600241, tipo: 'finale' },
+    ],
+    cassaSett: [
+      { s: 'S1', saldo: 420, incassi: 180, pag: 150 }, { s: 'S2', saldo: 390, incassi: 120, pag: 150 },
+      { s: 'S3', saldo: 340, incassi: 100, pag: 150 }, { s: 'S4', saldo: 510, incassi: 320, pag: 150 },
+      { s: 'S5', saldo: 460, incassi: 100, pag: 150 }, { s: 'S6', saldo: 380, incassi: 70, pag: 150 },
+      { s: 'S7', saldo: 290, incassi: 60, pag: 150 },  { s: 'S8', saldo: 240, incassi: 100, pag: 150 },
+      { s: 'S9', saldo: 210, incassi: 120, pag: 150 },  { s: 'S10', saldo: 180, incassi: 120, pag: 150 },
+      { s: 'S11', saldo: 350, incassi: 320, pag: 150 }, { s: 'S12', saldo: 400, incassi: 200, pag: 150 },
+    ],
+    scenari: [
+      { anno: '2025', ott: 350, base: 250, pess: 80 },
+      { anno: '2026', ott: 720, base: 480, pess: 120 },
+      { anno: '2027', ott: 1150, base: 750, pess: -50 },
+      { anno: '2028', ott: 1650, base: 1050, pess: -180 },
+      { anno: '2029', ott: 2250, base: 1400, pess: -350 },
+    ],
+    kpi: { dso: 135, dpo: 95, dscr: 1.15, cop_cassa: 1.8, ccn: 145000, capex: 280000, debito_annuo: 520000 },
+  },
+
+  narrative: [
+    { uo: 'VLB', alert: 'GIALLO', testo: 'MOL-I 16,4% in target, ma costi sede (17,6% ricavi) assorbono il margine â†’ MOL-G -â‚¬24.115. Azione: rinegoziare allocazione sede o aumentare occupancy oltre 90%.', outlook: 'Strutturale' },
+    { uo: 'CTA', alert: 'ROSSO', testo: 'MOL-G -â‚¬100.965. Personale al 59,4% dei ricavi. Costo servizi (â‚¬215.000) elevato. Azione: ottimizzare mix medici/OSS e rinegoziare servizi esternalizzati.', outlook: 'Persistente' },
+    { uo: 'COS', alert: 'VERDE', testo: 'Best performer. MOL-I 23%, MOL-G 8,8%. Mix ricavi diversificato. Ricavo/giornata â‚¬242 il piÃ¹ alto.', outlook: 'Favorevole' },
+    { uo: 'LAB', alert: 'VERDE', testo: 'Top performer con MOL-G 23,9%. Asset-light, personale solo 30,2%. Potenziale per crescita volumi.', outlook: 'Molto favorevole' },
+    { uo: 'KCP', alert: 'ROSSO', testo: 'MOL-G -â‚¬61.050 (-8,7%). Diseconomie di scala: 20 PL, sede 22,6% ricavi. Valutare accorpamento con VLB.', outlook: 'Strutturale' },
+    { uo: 'GRUPPO', alert: 'ROSSO', testo: 'MOL-G â‚¬492.759 (5,0%) sotto target 8%. Costi sede â‚¬1.592.000 (16,2%). COS+LAB generano margine, VLB/CTA/KCP lo erodono. CF netto -â‚¬600.241 per debito (â‚¬520.000) e CAPEX (â‚¬280.000).', outlook: 'Critico â€” piano efficientamento necessario' },
+  ],
+};
+
+// ============================================================================
+// COMPUTED â€” Aggregati calcolati da KAROL_DATA
+// ============================================================================
+const D = KAROL_DATA;
+const UO = D.UO;
+const BENCH = D.BENCHMARK;
+
+// Helper costi totali per UO
+const costiTot = u => Object.values(u.costi).reduce((s, v) => s + v, 0);
+const budgetCostiTot = u => Object.values(u.budget_costi).reduce((s, v) => s + v, 0);
+
+// Calcola MOL-I, MOL-G, margini per ogni UO
+UO.forEach(u => {
+  u.costiDir = costiTot(u);
+  u.molI = u.ricavi - u.costiDir;
+  u.molIPct = u.ricavi > 0 ? u.molI / u.ricavi : 0;
+  u.molG = u.molI - u.sede;
+  u.molGPct = u.ricavi > 0 ? u.molG / u.ricavi : 0;
+  u.persPct = u.ricavi > 0 ? u.costi.personale / u.ricavi : 0;
+  u.ricGg = u.gg_degenza ? u.ricavi / u.gg_degenza : null;
+  u.costo_pl_gg = (u.pl && u.gg_degenza) ? u.costiDir / u.gg_degenza : null;
+  // EBIT (risultato operativo)
+  u.ebit = u.molG - u.ammortamenti - u.oneri_fin;
+  // Budget delta
+  u.delta_ricavi = u.ricavi - u.budget_ricavi;
+  u.delta_costi = u.costiDir - budgetCostiTot(u);
+});
+
+const TOT = {
+  ric: UO.reduce((s, u) => s + u.ricavi, 0),
+  cDir: UO.reduce((s, u) => s + u.costiDir, 0),
+  pers: UO.reduce((s, u) => s + u.costi.personale, 0),
+  molI: UO.reduce((s, u) => s + u.molI, 0),
+  sede: D.SEDE.totale,
+  ammort: UO.reduce((s, u) => s + u.ammortamenti, 0),
+  oneri_fin: UO.reduce((s, u) => s + u.oneri_fin, 0),
+};
+TOT.molIPct = TOT.ric > 0 ? TOT.molI / TOT.ric : 0;
+TOT.molG = TOT.molI - TOT.sede;
+TOT.molGPct = TOT.ric > 0 ? TOT.molG / TOT.ric : 0;
+TOT.persPct = TOT.ric > 0 ? TOT.pers / TOT.ric : 0;
+TOT.ebit = TOT.molG - TOT.ammort - TOT.oneri_fin;
+TOT.budget_ric = UO.reduce((s, u) => s + u.budget_ricavi, 0);
+TOT.budget_cDir = UO.reduce((s, u) => s + budgetCostiTot(u), 0);
+
+// KPI semafori auto-calcolati
+const autoKPI = [];
+UO.forEach(u => {
+  autoKPI.push({ kpi: 'MOL-I %', uo: u.cod, v: u.molIPct, tgt: BENCH.mol_i_pct, a: u.molIPct >= BENCH.mol_i_pct ? 'VERDE' : u.molIPct >= BENCH.mol_i_pct * 0.7 ? 'GIALLO' : 'ROSSO' });
+  autoKPI.push({ kpi: 'MOL-G %', uo: u.cod, v: u.molGPct, tgt: BENCH.mol_g_pct, a: u.molGPct >= BENCH.mol_g_pct ? 'VERDE' : u.molGPct >= 0 ? 'GIALLO' : 'ROSSO' });
+  autoKPI.push({ kpi: 'Pers. %', uo: u.cod, v: u.persPct, tgt: BENCH.pers_pct, a: u.persPct <= BENCH.pers_pct ? 'VERDE' : u.persPct <= BENCH.pers_pct * 1.1 ? 'GIALLO' : 'ROSSO' });
+  if (u.occ !== null) autoKPI.push({ kpi: 'Occ. %', uo: u.cod, v: u.occ, tgt: BENCH.occ_pct, a: u.occ >= BENCH.occ_pct ? 'VERDE' : u.occ >= BENCH.occ_pct * 0.9 ? 'GIALLO' : 'ROSSO' });
+  if (u.costo_pl_gg !== null) autoKPI.push({ kpi: 'Costo PL/gg', uo: u.cod, v: u.costo_pl_gg, tgt: BENCH.costo_pl_gg, a: u.costo_pl_gg <= BENCH.costo_pl_gg ? 'VERDE' : u.costo_pl_gg <= BENCH.costo_pl_gg * 1.15 ? 'GIALLO' : 'ROSSO' });
+});
+const KPI = autoKPI;
+
+// Waterfall calcolato
+const { waterfallRaw, cassaSett, scenari } = D.cashflow;
 let rt = 0;
 const waterfall = waterfallRaw.map(w => {
   if (w.tipo === 'entrata') { rt = w.valore; return { ...w, base: 0, barra: w.valore, col: C.verde }; }
-  if (w.tipo === 'uscita') { const b = rt + w.valore; const r = { ...w, base: Math.min(rt, rt + w.valore), barra: Math.abs(w.valore), col: C.rosso }; rt += w.valore; return r; }
-  if (w.tipo === 'subtotale') { rt = w.valore; return { ...w, base: 0, barra: w.valore, col: '#2563eb' }; }
+  if (w.tipo === 'uscita') { const r = { ...w, base: Math.min(rt, rt + w.valore), barra: Math.abs(w.valore), col: C.rosso }; rt += w.valore; return r; }
+  if (w.tipo === 'subtotale') { rt = w.valore; return { ...w, base: 0, barra: Math.abs(w.valore), col: w.valore >= 0 ? '#2563eb' : '#b91c1c' }; }
   rt = w.valore; return { ...w, base: 0, barra: Math.abs(w.valore), col: w.valore >= 0 ? '#047857' : '#b91c1c' };
 });
 
-const cassaSett = [
-  { s: 'S1', saldo: 420, incassi: 180, pag: 150 }, { s: 'S2', saldo: 390, incassi: 120, pag: 150 },
-  { s: 'S3', saldo: 340, incassi: 100, pag: 150 }, { s: 'S4', saldo: 510, incassi: 320, pag: 150 },
-  { s: 'S5', saldo: 460, incassi: 100, pag: 150 }, { s: 'S6', saldo: 380, incassi: 70, pag: 150 },
-  { s: 'S7', saldo: 290, incassi: 60, pag: 150 },  { s: 'S8', saldo: 240, incassi: 100, pag: 150 },
-  { s: 'S9', saldo: 210, incassi: 120, pag: 150 },  { s: 'S10', saldo: 180, incassi: 120, pag: 150 },
-  { s: 'S11', saldo: 350, incassi: 320, pag: 150 }, { s: 'S12', saldo: 400, incassi: 200, pag: 150 },
-];
-
-const scenari = [
-  { anno: '2025', ott: 350, base: 250, pess: 80 },
-  { anno: '2026', ott: 720, base: 480, pess: 120 },
-  { anno: '2027', ott: 1150, base: 750, pess: -50 },
-  { anno: '2028', ott: 1650, base: 1050, pess: -180 },
-  { anno: '2029', ott: 2250, base: 1400, pess: -350 },
-];
-
-const narrative = [
-  { uo: 'VLB', alert: 'GIALLO', testo: 'MOL-I 16,4% in target, ma costi sede (17,6% ricavi) assorbono il margine â†’ MOL-G -â‚¬24k. Azione: rinegoziare allocazione sede o aumentare occupancy oltre 90%.', outlook: 'Strutturale' },
-  { uo: 'CTA', alert: 'ROSSO', testo: 'MOL-G -â‚¬101k. Personale al 59,4% dei ricavi. Il costo medici (â‚¬362k) Ã¨ il piÃ¹ alto del gruppo. Azione: ottimizzare mix medici/OSS.', outlook: 'Persistente' },
-  { uo: 'COS', alert: 'VERDE', testo: 'Best performer. MOL-I 23%, MOL-G 8,8%. Mix ricavi diversificato. Ricavo/giornata â‚¬242 il piÃ¹ alto.', outlook: 'Favorevole' },
-  { uo: 'LAB', alert: 'VERDE', testo: 'Top performer con MOL-G 23,9%. Asset-light, personale solo 30,2%. Potenziale per crescita volumi.', outlook: 'Molto favorevole' },
-  { uo: 'KCP', alert: 'ROSSO', testo: 'MOL-G -â‚¬61k (-8,7%). Diseconomie di scala: 20 PL, sede 22,6% ricavi. Valutare accorpamento con VLB.', outlook: 'Strutturale' },
-  { uo: 'GRUPPO', alert: 'ROSSO', testo: 'MOL-G 5,0% sotto target 8%. Costi sede 16,2%. COS+LAB generano margine, VLB/CTA/KCP lo erodono. CF netto -â‚¬600k per debito (â‚¬520k) e CAPEX (â‚¬280k).', outlook: 'Critico â€” piano efficientamento necessario' },
-];
+const narrative = D.narrative;
 
 // ============================================================================
-// HELPERS
+// HELPERS â€” formattazione importi PRECISI (no abbreviazioni)
 // ============================================================================
-const fmt = v => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v);
-const fmtK = v => 'â‚¬' + (v/1000).toFixed(0) + 'k';
-const fmtM = v => 'â‚¬' + (v/1000000).toFixed(1) + 'M';
+const formatEuro = v => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v);
+const fmt = formatEuro;
 const fmtPct = v => (v * 100).toFixed(1) + '%';
 const mesi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
 
@@ -182,17 +252,31 @@ const Badge = ({ reale }) => {
 
 const alertCol = a => ({ color: a === 'ROSSO' ? C.rosso : a === 'GIALLO' ? C.giallo : C.verde, bg: a === 'ROSSO' ? C.rossoBg : a === 'GIALLO' ? C.gialloBg : C.verdeBg });
 
+// Helper delta con freccia
+const DeltaBadge = ({ v, inverse }) => {
+  const pos = inverse ? v <= 0 : v >= 0;
+  const col = pos ? C.verde : C.rosso;
+  const bg = pos ? C.verdeBg : C.rossoBg;
+  const arrow = v > 0 ? 'â–²' : v < 0 ? 'â–¼' : 'â€”';
+  return React.createElement('span', { style: { fontSize: 10, padding: '2px 6px', borderRadius: 8, background: bg, color: col, fontWeight: 600 } }, arrow + ' ' + formatEuro(Math.abs(v)));
+};
+
 // ============================================================================
 // COMPONENTE PRINCIPALE
 // ============================================================================
 const KarolDashboard = () => {
   const [tab, setTab] = useState('overview');
   const [selUO, setSelUO] = useState(null);
+  const [ceView, setCeView] = useState('consolidato');
+  const [simRic, setSimRic] = useState(0);
+  const [simPers, setSimPers] = useState(0);
+  const [simOcc, setSimOcc] = useState(0);
+  const [simSede, setSimSede] = useState(0);
 
   const nR = KPI.filter(k => k.a === 'ROSSO').length;
   const nG = KPI.filter(k => k.a === 'GIALLO').length;
   const nV = KPI.filter(k => k.a === 'VERDE').length;
-  const uoReali = UO.filter(u => u.datiReali).length;
+  const uoReali = D.meta.dati_reali ? UO.length : 0;
 
   // Scostamento MOL-G
   const scost = [...UO].map(u => ({ nome: u.cod, nomeC: u.nome, scost: u.molG, fill: u.molG >= 0 ? C.verde : C.rosso })).sort((a,b) => a.scost - b.scost);
@@ -202,10 +286,12 @@ const KarolDashboard = () => {
 
   const tabs = [
     { id: 'overview', label: 'Overview', icon: 'ðŸ“Š' },
+    { id: 'ce', label: 'Conto Economico', icon: 'ðŸ“‹' },
     { id: 'strutture', label: 'Strutture', icon: 'ðŸ¥' },
     { id: 'trend', label: 'Trend', icon: 'ðŸ“ˆ' },
     { id: 'cashflow', label: 'Cash Flow', icon: 'ðŸ’°' },
     { id: 'analisi', label: 'Analisi', icon: 'ðŸ”' },
+    { id: 'simulazioni', label: 'Simulazioni', icon: 'ðŸŽ›ï¸' },
   ];
 
   const cardS = { background: C.card, borderRadius: 10, padding: 20, boxShadow: '0 1px 4px rgba(0,0,0,0.05)', border: '1px solid ' + C.bordo };
@@ -235,13 +321,13 @@ const KarolDashboard = () => {
       <div style={{ maxWidth: 1280, margin: '-20px auto 0', padding: '0 24px', position: 'relative', zIndex: 1 }}>
         <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(155px, 1fr))', gap: 12 }}>
           {[
-            { label: 'Ricavi Totali', valore: fmtM(TOT.ric), colore: C.CTA },
-            { label: 'MOL Industriale', valore: fmtM(TOT.molI), sub: fmtPct(TOT.molIPct), colore: C.verde },
-            { label: 'Costi Sede', valore: fmtM(TOT.sede), sub: '16,2% ricavi', colore: C.viola },
-            { label: 'MOL Gestionale', valore: fmtM(TOT.molG), sub: fmtPct(TOT.molGPct), colore: TOT.molG >= 0 ? C.verde : C.rosso },
-            { label: 'DSO ASP', valore: '135 gg', sub: 'Target <120', colore: C.giallo },
-            { label: 'Copertura Cassa', valore: '1,8 mesi', sub: 'Target >2,0', colore: C.giallo },
-            { label: 'Alert', valore: (nR+nG) + ' attivi', sub: nR + 'ðŸ”´ ' + nG + 'ðŸŸ¡ ' + nV + 'ðŸŸ¢', colore: C.rosso },
+            { label: 'Ricavi Totali', valore: fmt(TOT.ric), colore: C.CTA },
+            { label: 'MOL Industriale', valore: fmt(TOT.molI), sub: fmtPct(TOT.molIPct), colore: C.verde },
+            { label: 'Costi Sede', valore: fmt(TOT.sede), sub: fmtPct(TOT.sede / TOT.ric) + ' ricavi', colore: C.viola },
+            { label: 'MOL Gestionale', valore: fmt(TOT.molG), sub: fmtPct(TOT.molGPct), colore: TOT.molG >= 0 ? C.verde : C.rosso },
+            { label: 'DSO ASP', valore: D.cashflow.kpi.dso + ' gg', sub: 'Target <' + BENCH.dso, colore: D.cashflow.kpi.dso > BENCH.dso ? C.giallo : C.verde },
+            { label: 'Copertura Cassa', valore: D.cashflow.kpi.cop_cassa + ' mesi', sub: 'Target >' + BENCH.cop_cassa_mesi, colore: D.cashflow.kpi.cop_cassa < BENCH.cop_cassa_mesi ? C.giallo : C.verde },
+            { label: 'Alert', valore: (nR+nG) + ' attivi', sub: nR + ' rossi / ' + nG + ' gialli / ' + nV + ' verdi', colore: nR > 0 ? C.rosso : C.giallo },
           ].map((kpi, i) => (
             <div key={i} style={{ background: C.card, borderRadius: 10, padding: '14px 16px', boxShadow: '0 1px 4px rgba(0,0,0,0.06)', borderLeft: '3px solid ' + kpi.colore, borderTop: '1px solid #f1f5f9' }}>
               <div style={{ fontSize: 11, color: C.t3, fontWeight: 500, marginBottom: 6 }}>{kpi.label}</div>
@@ -271,23 +357,28 @@ const KarolDashboard = () => {
         {tab === 'overview' && (
           <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
 
-            {/* B4: Occupancy Gauge */}
-            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: 12 }}>
-              {UO.filter(u => u.occ !== null).map((u, i) => {
-                const pct = u.occ * 100;
-                const col = pct >= 90 ? C.verde : pct >= 80 ? C.giallo : C.rosso;
+            {/* 6 Card Costi Gestionali */}
+            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: 12 }}>
+              {[
+                { label: 'Personale', valore: TOT.pers, pct: TOT.persPct, bench: BENCH.pers_pct, icon: 'ðŸ‘¥', inv: true },
+                { label: 'Materiali/Farmaci', valore: UO.reduce((s,u) => s + u.costi.materiali, 0), pct: UO.reduce((s,u) => s + u.costi.materiali, 0) / TOT.ric, bench: 0.12, icon: 'ðŸ’Š', inv: true },
+                { label: 'Servizi', valore: UO.reduce((s,u) => s + u.costi.servizi, 0), pct: UO.reduce((s,u) => s + u.costi.servizi, 0) / TOT.ric, bench: 0.12, icon: 'ðŸ”§', inv: true },
+                { label: 'Utenze', valore: UO.reduce((s,u) => s + u.costi.utenze, 0), pct: UO.reduce((s,u) => s + u.costi.utenze, 0) / TOT.ric, bench: 0.05, icon: 'âš¡', inv: true },
+                { label: 'Manutenzione', valore: UO.reduce((s,u) => s + u.costi.manutenzione, 0), pct: UO.reduce((s,u) => s + u.costi.manutenzione, 0) / TOT.ric, bench: 0.03, icon: 'ðŸ—ï¸', inv: true },
+                { label: 'Costi Sede/HQ', valore: TOT.sede, pct: TOT.sede / TOT.ric, bench: 0.12, icon: 'ðŸ¢', inv: true },
+              ].map((c, i) => {
+                const ok = c.inv ? c.pct <= c.bench : c.pct >= c.bench;
+                const warn = c.inv ? c.pct <= c.bench * 1.15 : c.pct >= c.bench * 0.85;
+                const col = ok ? C.verde : warn ? C.giallo : C.rosso;
+                const bg = ok ? C.verdeBg : warn ? C.gialloBg : C.rossoBg;
                 return (
-                  <div key={i} style={{ ...cardS, textAlign: 'center', padding: '12px 8px' }}>
-                    <p style={{ fontSize: 11, color: C.t2, marginBottom: 8, fontWeight: 600 }}>
-                      <span style={{ display: 'inline-block', width: 8, height: 8, borderRadius: '50%', background: u.colore, marginRight: 4 }}></span>
-                      {u.cod} â€” Occupancy
-                    </p>
-                    <svg width="100" height="60" viewBox="0 0 100 60" style={{ margin: '0 auto', display: 'block' }}>
-                      <path d="M 10 55 A 40 40 0 0 1 90 55" fill="none" stroke="#e2e8f0" strokeWidth="8" strokeLinecap="round" />
-                      <path d="M 10 55 A 40 40 0 0 1 90 55" fill="none" stroke={col} strokeWidth="8" strokeLinecap="round" strokeDasharray={(pct / 100 * 126) + ' 126'} />
-                      <text x="50" y="50" textAnchor="middle" fontSize="16" fontWeight="700" fill={col}>{pct.toFixed(0)}%</text>
-                    </svg>
-                    <p style={{ fontSize: 10, color: C.t3, marginTop: 4 }}>{u.pl} PL | Target 90%</p>
+                  <div key={i} style={{ ...cardS, padding: '14px 16px', borderLeft: '3px solid ' + col }}>
+                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 }}>
+                      <span style={{ fontSize: 11, color: C.t3, fontWeight: 500 }}>{c.icon} {c.label}</span>
+                      <span style={{ fontSize: 10, padding: '2px 6px', borderRadius: 8, background: bg, color: col, fontWeight: 600 }}>{fmtPct(c.pct)}</span>
+                    </div>
+                    <div style={{ fontSize: 17, fontWeight: 700, color: C.t1 }}>{fmt(c.valore)}</div>
+                    <div style={{ fontSize: 10, color: C.t3, marginTop: 2 }}>Bench: {fmtPct(c.bench)}</div>
                   </div>
                 );
               })}
@@ -301,7 +392,7 @@ const KarolDashboard = () => {
                 <ResponsiveContainer width="100%" height={260}>
                   <BarChart data={scost} layout="vertical" margin={{ left: 50, right: 50 }}>
                     <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
-                    <XAxis type="number" tickFormatter={fmtK} fontSize={11} stroke={C.t3} />
+                    <XAxis type="number" tickFormatter={v => fmt(v)} fontSize={10} stroke={C.t3} />
                     <YAxis type="category" dataKey="nome" fontSize={12} width={45} stroke={C.t2} />
                     <Tooltip formatter={v => [fmt(v), 'MOL-G']} />
                     <ReferenceLine x={0} stroke={C.t3} strokeWidth={1.5} />
@@ -315,15 +406,15 @@ const KarolDashboard = () => {
                 </div>
               </div>
 
-              {/* B2: Tabella semaforo */}
+              {/* B2: Tabella semaforo aggiornata con Costo PL/gg */}
               <div style={cardS}>
                 <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Matrice KPI per UO</h3>
                 <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Semaforo performance operativa</p>
                 <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
                   <thead>
                     <tr style={{ borderBottom: '2px solid ' + C.bordo }}>
-                      {['UO', 'MOL-I %', 'MOL-G %', 'Pers. %', 'Occ. %'].map(h => (
-                        <th key={h} style={{ padding: '8px 6px', textAlign: h === 'UO' ? 'left' : 'center', color: C.t2, fontWeight: 600, fontSize: 11 }}>{h}</th>
+                      {['UO', 'MOL-I %', 'MOL-G %', 'Pers. %', 'Occ. %', 'Costo PL/gg'].map(h => (
+                        <th key={h} style={{ padding: '8px 4px', textAlign: h === 'UO' ? 'left' : 'center', color: C.t2, fontWeight: 600, fontSize: 10 }}>{h}</th>
                       ))}
                     </tr>
                   </thead>
@@ -334,16 +425,16 @@ const KarolDashboard = () => {
                         const k = kpis.find(x => x.kpi.startsWith(name));
                         if (!k) return <td style={{ textAlign: 'center', color: C.t3, fontSize: 11 }}>n/d</td>;
                         const ac = alertCol(k.a);
-                        return <td style={{ textAlign: 'center' }}><span style={{ background: ac.bg, color: ac.color, padding: '2px 8px', borderRadius: 10, fontSize: 11, fontWeight: 600, fontFamily: 'monospace' }}>{fmtPct(k.v)}</span></td>;
+                        const display = name === 'Costo PL' ? fmt(k.v) : fmtPct(k.v);
+                        return <td style={{ textAlign: 'center' }}><span style={{ background: ac.bg, color: ac.color, padding: '2px 6px', borderRadius: 10, fontSize: 10, fontWeight: 600, fontFamily: 'monospace' }}>{display}</span></td>;
                       };
                       return (
-                        <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, cursor: 'pointer' }} onClick={() => setSelUO(u)}>
-                          <td style={{ padding: '10px 6px', fontWeight: 600, color: C.t1 }}>
-                            <span style={{ display: 'inline-block', width: 10, height: 10, borderRadius: 3, background: u.colore, marginRight: 8 }}></span>
+                        <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, cursor: 'pointer' }} onClick={() => { setSelUO(u); setTab('strutture'); }}>
+                          <td style={{ padding: '10px 4px', fontWeight: 600, color: C.t1, fontSize: 12 }}>
+                            <span style={{ display: 'inline-block', width: 10, height: 10, borderRadius: 3, background: u.colore, marginRight: 6 }}></span>
                             {u.cod}
-                            <Badge reale={u.datiReali} />
                           </td>
-                          {cell('MOL-I')}{cell('MOL-G')}{cell('Pers')}{cell('Occ')}
+                          {cell('MOL-I')}{cell('MOL-G')}{cell('Pers')}{cell('Occ')}{cell('Costo PL')}
                         </tr>
                       );
                     })}
@@ -374,6 +465,206 @@ const KarolDashboard = () => {
           </div>
         )}
 
+        {/* ======================== CONTO ECONOMICO ======================== */}
+        {tab === 'ce' && (() => {
+          // CE Consolidato righe
+          const ceRighe = [
+            { voce: 'Ricavi', val: TOT.ric, bud: TOT.budget_ric, cls: 'header' },
+            { voce: '  Personale', val: -TOT.pers, bud: -UO.reduce((s,u) => s + u.budget_costi.personale, 0), cls: 'costo' },
+            { voce: '  Materiali/Farmaci', val: -UO.reduce((s,u) => s + u.costi.materiali, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.materiali, 0), cls: 'costo' },
+            { voce: '  Servizi', val: -UO.reduce((s,u) => s + u.costi.servizi, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.servizi, 0), cls: 'costo' },
+            { voce: '  Utenze', val: -UO.reduce((s,u) => s + u.costi.utenze, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.utenze, 0), cls: 'costo' },
+            { voce: '  Manutenzione', val: -UO.reduce((s,u) => s + u.costi.manutenzione, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.manutenzione, 0), cls: 'costo' },
+            { voce: '  Altri costi diretti', val: -UO.reduce((s,u) => s + u.costi.altri, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.altri, 0), cls: 'costo' },
+            { voce: 'MOL Industriale', val: TOT.molI, bud: TOT.budget_ric - TOT.budget_cDir, cls: 'subtotale' },
+            { voce: '  Costi Sede/HQ', val: -TOT.sede, bud: -1550000, cls: 'costo' },
+            { voce: 'MOL Gestionale', val: TOT.molG, bud: (TOT.budget_ric - TOT.budget_cDir) - 1550000, cls: 'subtotale' },
+            { voce: '  Ammortamenti', val: -TOT.ammort, bud: -350000, cls: 'costo' },
+            { voce: '  Oneri finanziari', val: -TOT.oneri_fin, bud: -125000, cls: 'costo' },
+            { voce: 'Risultato Operativo', val: TOT.ebit, bud: (TOT.budget_ric - TOT.budget_cDir) - 1550000 - 350000 - 125000, cls: 'totale' },
+          ];
+
+          // CE per singola BU
+          const ceBU = (u) => [
+            { voce: 'Ricavi', val: u.ricavi, bud: u.budget_ricavi, cls: 'header' },
+            { voce: '  Personale', val: -u.costi.personale, bud: -u.budget_costi.personale, cls: 'costo' },
+            { voce: '  Materiali', val: -u.costi.materiali, bud: -u.budget_costi.materiali, cls: 'costo' },
+            { voce: '  Servizi', val: -u.costi.servizi, bud: -u.budget_costi.servizi, cls: 'costo' },
+            { voce: '  Utenze', val: -u.costi.utenze, bud: -u.budget_costi.utenze, cls: 'costo' },
+            { voce: '  Manutenzione', val: -u.costi.manutenzione, bud: -u.budget_costi.manutenzione, cls: 'costo' },
+            { voce: '  Altri', val: -u.costi.altri, bud: -u.budget_costi.altri, cls: 'costo' },
+            { voce: 'MOL Industriale', val: u.molI, bud: u.budget_ricavi - budgetCostiTot(u), cls: 'subtotale' },
+            { voce: '  Quota Sede', val: -u.sede, bud: -u.sede * 0.95, cls: 'costo' },
+            { voce: 'MOL Gestionale', val: u.molG, bud: (u.budget_ricavi - budgetCostiTot(u)) - u.sede * 0.95, cls: 'subtotale' },
+            { voce: '  Ammortamenti', val: -u.ammortamenti, bud: -u.ammortamenti * 0.95, cls: 'costo' },
+            { voce: '  Oneri finanziari', val: -u.oneri_fin, bud: -u.oneri_fin * 0.95, cls: 'costo' },
+            { voce: 'Risultato Operativo', val: u.ebit, bud: (u.budget_ricavi - budgetCostiTot(u)) - u.sede * 0.95 - u.ammortamenti * 0.95 - u.oneri_fin * 0.95, cls: 'totale' },
+          ];
+
+          // Forecast â€” linearizzazione a 12 mesi
+          const forecastLin = UO.map(u => {
+            const mesiChiusi = D.meta.mesi_chiusi;
+            const ricMese = u.ricavi / mesiChiusi;
+            const costMese = u.costiDir / mesiChiusi;
+            return { cod: u.cod, nome: u.nome, colore: u.colore, ric12: ricMese * 12, cost12: costMese * 12, molI12: (ricMese - costMese) * 12 };
+          });
+
+          const CETable = ({ righe }) => (
+            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
+              <thead>
+                <tr style={{ borderBottom: '2px solid ' + C.bordo, background: '#f8fafc' }}>
+                  <th style={{ padding: '10px 8px', textAlign: 'left', color: C.t2, fontWeight: 600, width: '35%' }}>Voce</th>
+                  <th style={{ padding: '10px 8px', textAlign: 'right', color: C.t2, fontWeight: 600 }}>Consuntivo</th>
+                  <th style={{ padding: '10px 8px', textAlign: 'right', color: C.t2, fontWeight: 600 }}>Budget</th>
+                  <th style={{ padding: '10px 8px', textAlign: 'right', color: C.t2, fontWeight: 600 }}>Delta</th>
+                  <th style={{ padding: '10px 8px', textAlign: 'right', color: C.t2, fontWeight: 600 }}>% Ricavi</th>
+                </tr>
+              </thead>
+              <tbody>
+                {righe.map((r, i) => {
+                  const delta = r.val - r.bud;
+                  const isH = r.cls === 'header' || r.cls === 'subtotale' || r.cls === 'totale';
+                  const bg = r.cls === 'totale' ? '#f0f4f8' : r.cls === 'subtotale' ? '#f8fafc' : 'transparent';
+                  const fw = isH ? 700 : 400;
+                  const ricRef = righe[0].val;
+                  return (
+                    <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, background: bg }}>
+                      <td style={{ padding: '8px', fontWeight: fw, color: C.t1, fontSize: isH ? 13 : 12 }}>{r.voce}</td>
+                      <td style={{ padding: '8px', textAlign: 'right', fontWeight: fw, color: C.t1, fontFamily: 'monospace' }}>{fmt(r.val)}</td>
+                      <td style={{ padding: '8px', textAlign: 'right', color: C.t2, fontFamily: 'monospace' }}>{fmt(r.bud)}</td>
+                      <td style={{ padding: '8px', textAlign: 'right' }}>
+                        <span style={{ color: delta >= 0 ? C.verde : C.rosso, fontWeight: 600, fontFamily: 'monospace', fontSize: 11 }}>
+                          {delta >= 0 ? '+' : ''}{fmt(delta)}
+                        </span>
+                      </td>
+                      <td style={{ padding: '8px', textAlign: 'right', color: C.t3, fontSize: 11, fontFamily: 'monospace' }}>
+                        {ricRef !== 0 ? fmtPct(Math.abs(r.val) / Math.abs(ricRef)) : '-'}
+                      </td>
+                    </tr>
+                  );
+                })}
+              </tbody>
+            </table>
+          );
+
+          return (
+            <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
+              {/* Sub-tab navigation */}
+              <div style={{ display: 'flex', gap: 8 }}>
+                {[{ id: 'consolidato', l: 'CE Consolidato' }, { id: 'perbu', l: 'CE per BU' }, { id: 'forecast', l: 'Forecast' }].map(st => (
+                  <button key={st.id} onClick={() => setCeView(st.id)}
+                    style={{ padding: '8px 18px', border: '2px solid ' + (ceView === st.id ? C.primario : C.bordo), background: ceView === st.id ? C.primario + '10' : C.card, borderRadius: 8, cursor: 'pointer', fontSize: 13, fontWeight: ceView === st.id ? 700 : 500, color: ceView === st.id ? C.primario : C.t2, fontFamily: 'inherit' }}>
+                    {st.l}
+                  </button>
+                ))}
+              </div>
+
+              {/* CE Consolidato */}
+              {ceView === 'consolidato' && (
+                <div style={cardS}>
+                  <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Conto Economico Consolidato â€” Gruppo Karol Sicilia</h3>
+                  <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Anno {D.meta.anno} â€” {D.meta.mesi_chiusi} mesi | Consuntivo vs Budget</p>
+                  <CETable righe={ceRighe} />
+                  <div style={{ marginTop: 16, padding: '10px 14px', background: TOT.ebit >= 0 ? C.verdeBg : C.rossoBg, borderRadius: 8, borderLeft: '4px solid ' + (TOT.ebit >= 0 ? C.verde : C.rosso) }}>
+                    <p style={{ fontSize: 12, color: C.t1 }}>
+                      Risultato operativo: <strong>{fmt(TOT.ebit)}</strong> â€” MOL-G {fmtPct(TOT.molGPct)} (target {fmtPct(BENCH.mol_g_pct)})
+                    </p>
+                  </div>
+                </div>
+              )}
+
+              {/* CE per BU */}
+              {ceView === 'perbu' && (
+                <div>
+                  <div style={{ display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' }}>
+                    {UO.map(u => (
+                      <button key={u.cod} onClick={() => setSelUO(u)}
+                        style={{ padding: '8px 16px', border: '2px solid ' + (selUO && selUO.cod === u.cod ? u.colore : C.bordo), background: selUO && selUO.cod === u.cod ? u.colore + '15' : C.card, borderRadius: 8, cursor: 'pointer', fontSize: 13, fontWeight: 600, color: selUO && selUO.cod === u.cod ? u.colore : C.t2, fontFamily: 'inherit' }}>
+                        {u.cod} â€” {u.nome}
+                      </button>
+                    ))}
+                  </div>
+                  {(() => {
+                    const u = selUO || UO[0];
+                    return (
+                      <div style={cardS}>
+                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
+                          <div>
+                            <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1 }}>CE â€” {u.nome}</h3>
+                            <p style={{ fontSize: 11, color: C.t2 }}>{u.tipo}{u.pl > 0 ? ' â€” ' + u.pl + ' PL' : ''}</p>
+                          </div>
+                          <div style={{ textAlign: 'right' }}>
+                            <span style={{ fontSize: 18, fontWeight: 700, color: u.molG >= 0 ? C.verde : C.rosso }}>{fmt(u.molG)}</span>
+                            <div style={{ fontSize: 10, color: C.t3 }}>MOL-G ({fmtPct(u.molGPct)})</div>
+                          </div>
+                        </div>
+                        <CETable righe={ceBU(u)} />
+                        {/* Riconciliazione */}
+                        <div style={{ marginTop: 12, padding: '8px 12px', background: '#f8fafc', borderRadius: 6, fontSize: 11, color: C.t2 }}>
+                          Riconciliazione: Ricavi {fmt(u.ricavi)} âˆ’ Costi Diretti {fmt(u.costiDir)} = MOL-I {fmt(u.molI)} âˆ’ Sede {fmt(u.sede)} = MOL-G {fmt(u.molG)} âœ“
+                        </div>
+                      </div>
+                    );
+                  })()}
+                </div>
+              )}
+
+              {/* Forecast */}
+              {ceView === 'forecast' && (
+                <div style={cardS}>
+                  <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Forecast â€” Linearizzazione a 12 Mesi</h3>
+                  <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Proiezione lineare basata su {D.meta.mesi_chiusi} mesi consuntivati</p>
+                  <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
+                    <thead>
+                      <tr style={{ borderBottom: '2px solid ' + C.bordo, background: '#f8fafc' }}>
+                        <th style={{ padding: '8px', textAlign: 'left', color: C.t2 }}>UO</th>
+                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>Consuntivo</th>
+                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>Forecast 12M</th>
+                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>Budget</th>
+                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>Fc vs Budget</th>
+                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>MOL-I Fc</th>
+                      </tr>
+                    </thead>
+                    <tbody>
+                      {forecastLin.map((f, i) => {
+                        const u = UO[i];
+                        const fcVsBud = f.ric12 - u.budget_ricavi;
+                        return (
+                          <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo }}>
+                            <td style={{ padding: '8px', fontWeight: 600, color: C.t1 }}>
+                              <span style={{ display: 'inline-block', width: 10, height: 10, borderRadius: 3, background: f.colore, marginRight: 6 }}></span>
+                              {f.cod}
+                            </td>
+                            <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'monospace' }}>{fmt(u.ricavi)}</td>
+                            <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 600 }}>{fmt(f.ric12)}</td>
+                            <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'monospace', color: C.t2 }}>{fmt(u.budget_ricavi)}</td>
+                            <td style={{ padding: '8px', textAlign: 'right' }}>
+                              <span style={{ color: fcVsBud >= 0 ? C.verde : C.rosso, fontWeight: 600, fontFamily: 'monospace', fontSize: 11 }}>
+                                {fcVsBud >= 0 ? '+' : ''}{fmt(fcVsBud)}
+                              </span>
+                            </td>
+                            <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'monospace', color: f.molI12 >= 0 ? C.verde : C.rosso, fontWeight: 600 }}>{fmt(f.molI12)}</td>
+                          </tr>
+                        );
+                      })}
+                      <tr style={{ borderTop: '2px solid ' + C.primario, background: '#f0f4f8' }}>
+                        <td style={{ padding: '8px', fontWeight: 700 }}>TOTALE</td>
+                        <td style={{ padding: '8px', textAlign: 'right', fontWeight: 700, fontFamily: 'monospace' }}>{fmt(TOT.ric)}</td>
+                        <td style={{ padding: '8px', textAlign: 'right', fontWeight: 700, fontFamily: 'monospace' }}>{fmt(forecastLin.reduce((s,f) => s + f.ric12, 0))}</td>
+                        <td style={{ padding: '8px', textAlign: 'right', fontWeight: 700, fontFamily: 'monospace', color: C.t2 }}>{fmt(TOT.budget_ric)}</td>
+                        <td style={{ padding: '8px', textAlign: 'right' }}>
+                          {(() => { const d = forecastLin.reduce((s,f) => s + f.ric12, 0) - TOT.budget_ric; return <span style={{ color: d >= 0 ? C.verde : C.rosso, fontWeight: 700, fontFamily: 'monospace' }}>{d >= 0 ? '+' : ''}{fmt(d)}</span>; })()}
+                        </td>
+                        <td style={{ padding: '8px', textAlign: 'right', fontWeight: 700, fontFamily: 'monospace', color: forecastLin.reduce((s,f) => s + f.molI12, 0) >= 0 ? C.verde : C.rosso }}>{fmt(forecastLin.reduce((s,f) => s + f.molI12, 0))}</td>
+                      </tr>
+                    </tbody>
+                  </table>
+                </div>
+              )}
+            </div>
+          );
+        })()}
+
         {/* ======================== STRUTTURE ======================== */}
         {tab === 'strutture' && (
           <div>
@@ -395,7 +686,7 @@ const KarolDashboard = () => {
                   <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                     <div>
                       <h3 style={{ fontSize: 17, fontWeight: 700, color: C.t1 }}>{u.nome} <Badge reale={u.datiReali} /></h3>
-                      <p style={{ fontSize: 12, color: C.t2 }}>{u.tipo}{u.pl > 0 ? ' â€” ' + u.pl + ' PL' : ''} | Ricavo/gg: {u.ricGg ? 'â‚¬' + u.ricGg.toFixed(0) : 'n/a'}</p>
+                      <p style={{ fontSize: 12, color: C.t2 }}>{u.tipo}{u.pl > 0 ? ' â€” ' + u.pl + ' PL' : ''} | Ricavo/gg: {u.ricGg ? fmt(Math.round(u.ricGg)) : 'n/a'}{u.costo_pl_gg ? ' | Costo PL/gg: ' + fmt(Math.round(u.costo_pl_gg)) : ''}</p>
                     </div>
                     <div style={{ textAlign: 'right' }}>
                       <div style={{ fontSize: 22, fontWeight: 700, color: u.molG >= 0 ? C.verde : C.rosso }}>{fmt(u.molG)}</div>
@@ -426,7 +717,7 @@ const KarolDashboard = () => {
                     <ComposedChart data={data} margin={{ top: 10, right: 20, left: 10, bottom: 5 }}>
                       <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                       <XAxis dataKey="mese" fontSize={12} stroke={C.t3} />
-                      <YAxis tickFormatter={fmtK} fontSize={11} stroke={C.t3} />
+                      <YAxis tickFormatter={v => fmt(v)} fontSize={11} stroke={C.t3} />
                       <Tooltip formatter={v => [fmt(v)]} />
                       <Legend />
                       <Bar dataKey="Ricavi" fill={u.colore} radius={[4,4,0,0]} barSize={20} />
@@ -451,7 +742,7 @@ const KarolDashboard = () => {
                 <LineChart data={trendUO} margin={{ top: 10, right: 20, left: 10, bottom: 5 }}>
                   <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                   <XAxis dataKey="mese" fontSize={12} stroke={C.t3} />
-                  <YAxis tickFormatter={fmtK} fontSize={11} stroke={C.t3} />
+                  <YAxis tickFormatter={v => fmt(v)} fontSize={11} stroke={C.t3} />
                   <Tooltip formatter={(v, name) => [fmt(v), name]} />
                   <Legend />
                   {UO.map(u => (
@@ -502,8 +793,8 @@ const KarolDashboard = () => {
                 <BarChart data={waterfall} margin={{ top: 20, right: 20, left: 20, bottom: 50 }}>
                   <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                   <XAxis dataKey="voce" fontSize={10} angle={-35} textAnchor="end" height={60} stroke={C.t2} />
-                  <YAxis tickFormatter={fmtM} fontSize={11} stroke={C.t3} />
-                  <Tooltip formatter={(v, name) => { if (name === 'base') return ['','']; return [fmtM(v), 'Valore']; }} />
+                  <YAxis tickFormatter={v => fmt(v)} fontSize={11} stroke={C.t3} />
+                  <Tooltip formatter={(v, name) => { if (name === 'base') return ['','']; return [fmt(v), 'Valore']; }} />
                   <Bar dataKey="base" stackId="a" fill="transparent" />
                   <Bar dataKey="barra" stackId="a" radius={[3,3,0,0]} barSize={36}>
                     {waterfall.map((d, i) => <Cell key={i} fill={d.col} />)}
@@ -533,8 +824,8 @@ const KarolDashboard = () => {
                     </defs>
                     <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                     <XAxis dataKey="s" fontSize={11} stroke={C.t3} />
-                    <YAxis tickFormatter={v => 'â‚¬' + v + 'k'} fontSize={11} stroke={C.t3} domain={[0, 600]} />
-                    <Tooltip formatter={v => ['â‚¬' + v + 'k']} />
+                    <YAxis tickFormatter={v => 'â‚¬' + v + '.000'} fontSize={10} stroke={C.t3} domain={[0, 600]} />
+                    <Tooltip formatter={v => ['â‚¬' + v + '.000']} />
                     <ReferenceLine y={200} stroke={C.rosso} strokeDasharray="6 4" strokeWidth={2} label={{ value: 'Soglia min.', position: 'right', fontSize: 10, fill: C.rosso }} />
                     <Area type="monotone" dataKey="saldo" name="Saldo" stroke={C.CTA} strokeWidth={2.5} fill="url(#gradC)" dot={(props) => {
                       const { cx, cy, payload } = props;
@@ -555,8 +846,8 @@ const KarolDashboard = () => {
                   <ComposedChart data={scenari} margin={{ top: 10, right: 10, left: 10, bottom: 5 }}>
                     <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                     <XAxis dataKey="anno" fontSize={12} stroke={C.t3} />
-                    <YAxis tickFormatter={v => 'â‚¬' + v + 'k'} fontSize={11} stroke={C.t3} />
-                    <Tooltip formatter={v => ['â‚¬' + v + 'k']} />
+                    <YAxis tickFormatter={v => 'â‚¬' + v + '.000'} fontSize={11} stroke={C.t3} />
+                    <Tooltip formatter={v => ['â‚¬' + v + '.000']} />
                     <Legend />
                     <ReferenceLine y={0} stroke={C.t3} strokeWidth={1} />
                     <Line type="monotone" dataKey="ott" name="Ottimistico" stroke={C.verde} strokeWidth={2} dot={{ r: 4, fill: C.verde }} />
@@ -589,12 +880,60 @@ const KarolDashboard = () => {
           </div>
         )}
 
-        {/* ======================== ANALISI ======================== */}
+        {/* ======================== ANALISI COSTI ======================== */}
         {tab === 'analisi' && (
           <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
+
+            {/* Composizione costi per categoria â€” Stacked Bar */}
             <div style={cardS}>
-              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Variance Analysis â€” Decomposizione Scostamenti</h3>
-              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Driver decomposition con narrative per il management</p>
+              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Composizione Costi per UO</h3>
+              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Stacked bar â€” Breakdown categorie di costo</p>
+              <ResponsiveContainer width="100%" height={320}>
+                <BarChart data={UO.map(u => ({
+                  nome: u.cod, Personale: u.costi.personale, Materiali: u.costi.materiali,
+                  Servizi: u.costi.servizi, Utenze: u.costi.utenze, Manutenzione: u.costi.manutenzione, Altri: u.costi.altri
+                }))} margin={{ top: 10, right: 20, left: 20, bottom: 5 }}>
+                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
+                  <XAxis dataKey="nome" fontSize={12} stroke={C.t2} />
+                  <YAxis tickFormatter={v => fmt(v)} fontSize={9} stroke={C.t3} />
+                  <Tooltip formatter={v => [fmt(v)]} />
+                  <Legend />
+                  <Bar dataKey="Personale" stackId="a" fill="#3b82f6" />
+                  <Bar dataKey="Materiali" stackId="a" fill="#8b5cf6" />
+                  <Bar dataKey="Servizi" stackId="a" fill="#06b6d4" />
+                  <Bar dataKey="Utenze" stackId="a" fill="#f59e0b" />
+                  <Bar dataKey="Manutenzione" stackId="a" fill="#ef4444" />
+                  <Bar dataKey="Altri" stackId="a" fill="#94a3b8" radius={[4,4,0,0]} />
+                </BarChart>
+              </ResponsiveContainer>
+            </div>
+
+            {/* Benchmark confronto â€” incidenza % su ricavi */}
+            <div style={cardS}>
+              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Benchmark â€” Incidenza Costi su Ricavi</h3>
+              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Confronto UO vs benchmark settore</p>
+              <ResponsiveContainer width="100%" height={300}>
+                <BarChart data={UO.map(u => ({
+                  nome: u.cod,
+                  'Pers %': +(u.persPct * 100).toFixed(1),
+                  'Bench Pers': +(BENCH.pers_pct * 100).toFixed(1),
+                  'Costi Dir %': +((u.costiDir / u.ricavi) * 100).toFixed(1),
+                }))} layout="vertical" margin={{ left: 45, right: 30 }}>
+                  <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
+                  <XAxis type="number" domain={[0, 100]} tickFormatter={v => v + '%'} fontSize={11} stroke={C.t3} />
+                  <YAxis type="category" dataKey="nome" fontSize={12} stroke={C.t2} />
+                  <Tooltip formatter={v => [v + '%']} />
+                  <Legend />
+                  <Bar dataKey="Pers %" fill="#3b82f6" barSize={14} radius={[0,4,4,0]} />
+                  <Bar dataKey="Bench Pers" fill="#cbd5e1" barSize={14} radius={[0,4,4,0]} />
+                  <Bar dataKey="Costi Dir %" fill="#8b5cf6" barSize={14} radius={[0,4,4,0]} />
+                </BarChart>
+              </ResponsiveContainer>
+            </div>
+
+            {/* Narrative per UO */}
+            <div style={cardS}>
+              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Variance Analysis â€” Narrative</h3>
               {narrative.map((n, i) => {
                 const u = UO.find(x => x.cod === n.uo);
                 const ac = alertCol(n.alert);
@@ -619,11 +958,118 @@ const KarolDashboard = () => {
           </div>
         )}
 
+        {/* ======================== SIMULAZIONI ======================== */}
+        {tab === 'simulazioni' && (() => {
+          // Calcola impatto simulazione
+          const simTotRic = TOT.ric * (1 + simRic / 100);
+          const simTotPers = TOT.pers * (1 + simPers / 100);
+          const simTotSede = TOT.sede * (1 + simSede / 100);
+          const simAltriCosti = TOT.cDir - TOT.pers;
+          const simMolI = simTotRic - simTotPers - simAltriCosti;
+          const simMolG = simMolI - simTotSede;
+          const simEbit = simMolG - TOT.ammort - TOT.oneri_fin;
+
+          const deltaRic = simTotRic - TOT.ric;
+          const deltaMolG = simMolG - TOT.molG;
+          const deltaEbit = simEbit - TOT.ebit;
+
+          const SliderRow = ({ label, value, setter, min, max, step, unit }) => (
+            <div style={{ marginBottom: 16 }}>
+              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 }}>
+                <span style={{ fontSize: 13, fontWeight: 600, color: C.t1 }}>{label}</span>
+                <span style={{ fontSize: 14, fontWeight: 700, color: value === 0 ? C.t3 : value > 0 ? C.verde : C.rosso, fontFamily: 'monospace' }}>
+                  {value > 0 ? '+' : ''}{value}{unit || '%'}
+                </span>
+              </div>
+              <input type="range" min={min} max={max} step={step || 1} value={value}
+                onChange={e => setter(Number(e.target.value))}
+                style={{ width: '100%', accentColor: C.primario }} />
+              <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 10, color: C.t3 }}>
+                <span>{min}{unit || '%'}</span><span>0</span><span>+{max}{unit || '%'}</span>
+              </div>
+            </div>
+          );
+
+          return (
+            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
+              {/* Panel sliders */}
+              <div style={cardS}>
+                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Leve What-If</h3>
+                <p style={{ fontSize: 11, color: C.t3, marginBottom: 20 }}>Trascina gli slider per simulare variazioni % su base annua</p>
+                <SliderRow label="Ricavi (variazione %)" value={simRic} setter={setSimRic} min={-20} max={20} />
+                <SliderRow label="Costo Personale (variazione %)" value={simPers} setter={setSimPers} min={-15} max={15} />
+                <SliderRow label="Costi Sede (variazione %)" value={simSede} setter={setSimSede} min={-30} max={10} />
+                <SliderRow label="Occupancy (delta pp)" value={simOcc} setter={setSimOcc} min={-10} max={10} />
+                <button onClick={() => { setSimRic(0); setSimPers(0); setSimOcc(0); setSimSede(0); }}
+                  style={{ marginTop: 8, padding: '8px 20px', background: C.primario, color: 'white', border: 'none', borderRadius: 6, cursor: 'pointer', fontSize: 12, fontWeight: 600, fontFamily: 'inherit' }}>
+                  Reset
+                </button>
+              </div>
+
+              {/* Panel risultati */}
+              <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
+                <div style={cardS}>
+                  <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 16 }}>Impatto Simulazione</h3>
+                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12 }}>
+                    {[
+                      { label: 'Ricavi Sim.', val: simTotRic, delta: deltaRic, base: TOT.ric },
+                      { label: 'MOL-G Sim.', val: simMolG, delta: deltaMolG, base: TOT.molG },
+                      { label: 'EBIT Sim.', val: simEbit, delta: deltaEbit, base: TOT.ebit },
+                    ].map((r, i) => (
+                      <div key={i} style={{ padding: 12, borderRadius: 8, background: r.delta >= 0 ? C.verdeBg : C.rossoBg, textAlign: 'center' }}>
+                        <div style={{ fontSize: 10, color: C.t3, marginBottom: 4 }}>{r.label}</div>
+                        <div style={{ fontSize: 16, fontWeight: 700, color: C.t1 }}>{fmt(r.val)}</div>
+                        <div style={{ fontSize: 11, color: r.delta >= 0 ? C.verde : C.rosso, fontWeight: 600, marginTop: 2 }}>
+                          {r.delta >= 0 ? '+' : ''}{fmt(r.delta)}
+                        </div>
+                        <div style={{ fontSize: 10, color: C.t3, marginTop: 2 }}>Base: {fmt(r.base)}</div>
+                      </div>
+                    ))}
+                  </div>
+                </div>
+
+                {/* Waterfall impatto */}
+                <div style={cardS}>
+                  <h3 style={{ fontSize: 13, fontWeight: 700, color: C.t1, marginBottom: 8 }}>Waterfall Impatto</h3>
+                  <ResponsiveContainer width="100%" height={220}>
+                    <BarChart data={[
+                      { voce: 'MOL-G Attuale', base: 0, val: TOT.molG, col: C.primario },
+                      { voce: 'Î” Ricavi', base: TOT.molG, val: deltaRic, col: deltaRic >= 0 ? C.verde : C.rosso },
+                      { voce: 'Î” Personale', base: TOT.molG + deltaRic, val: -(simTotPers - TOT.pers), col: simTotPers <= TOT.pers ? C.verde : C.rosso },
+                      { voce: 'Î” Sede', base: simMolI - simTotSede + (simTotSede - TOT.sede), val: -(simTotSede - TOT.sede), col: simTotSede <= TOT.sede ? C.verde : C.rosso },
+                      { voce: 'MOL-G Sim.', base: 0, val: simMolG, col: simMolG >= 0 ? '#047857' : '#b91c1c' },
+                    ]} margin={{ top: 10, right: 10, left: 10, bottom: 30 }}>
+                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
+                      <XAxis dataKey="voce" fontSize={10} angle={-25} textAnchor="end" height={50} stroke={C.t2} />
+                      <YAxis tickFormatter={v => fmt(v)} fontSize={9} stroke={C.t3} />
+                      <Tooltip formatter={v => [fmt(v)]} />
+                      <Bar dataKey="base" stackId="a" fill="transparent" />
+                      <Bar dataKey="val" stackId="a" radius={[3,3,0,0]} barSize={32}>
+                        {[0,1,2,3,4].map(i => <Cell key={i} fill={[C.primario, deltaRic >= 0 ? C.verde : C.rosso, simTotPers <= TOT.pers ? C.verde : C.rosso, simTotSede <= TOT.sede ? C.verde : C.rosso, simMolG >= 0 ? '#047857' : '#b91c1c'][i]} />)}
+                      </Bar>
+                    </BarChart>
+                  </ResponsiveContainer>
+                </div>
+
+                {/* Margine di sicurezza */}
+                <div style={{ ...cardS, padding: '12px 16px' }}>
+                  <div style={{ fontSize: 12, fontWeight: 600, color: C.t1, marginBottom: 6 }}>KPI Simulati</div>
+                  <div style={{ display: 'flex', gap: 12 }}>
+                    <span style={{ fontSize: 11, color: C.t2 }}>MOL-G %: <strong style={{ color: simMolG / simTotRic >= 0.08 ? C.verde : C.rosso }}>{fmtPct(simMolG / simTotRic)}</strong></span>
+                    <span style={{ fontSize: 11, color: C.t2 }}>Pers %: <strong style={{ color: simTotPers / simTotRic <= 0.55 ? C.verde : C.rosso }}>{fmtPct(simTotPers / simTotRic)}</strong></span>
+                    <span style={{ fontSize: 11, color: C.t2 }}>Sede %: <strong style={{ color: simTotSede / simTotRic <= 0.12 ? C.verde : C.rosso }}>{fmtPct(simTotSede / simTotRic)}</strong></span>
+                  </div>
+                </div>
+              </div>
+            </div>
+          );
+        })()}
+
       </div>
 
       {/* FOOTER */}
       <div style={{ textAlign: 'center', padding: '16px 0', fontSize: 11, color: C.t3, borderTop: '1px solid ' + C.bordo }}>
-        Karol CdG v2.0 â€” Gruppo Karol S.p.A. â€” Dati simulati test pipeline | Finance Analysis: Variance Decomposition + Waterfall
+        Karol CdG v3.0 â€” Gruppo Karol S.p.A. â€” Cruscotto Controllo di Gestione Sicilia | Aggiornamento: {D.meta.ultimo_aggiornamento}
       </div>
     </div>
   );
-- 
2.34.1

