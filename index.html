<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Karol CdG — Controllo di Gestione</title>
<script type="importmap">
{"imports":{"react":"https://esm.sh/react@18.2.0","react-dom":"https://esm.sh/react-dom@18.2.0","react/jsx-runtime":"https://esm.sh/react@18.2.0/jsx-runtime","recharts":"https://esm.sh/recharts@2.12.7?external=react,react-dom"}}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script type="module">
import React, { useState } from 'react';
import ReactDOM from 'react-dom';
import * as Recharts from 'recharts';
window.React = React;
window.ReactDOM = ReactDOM;
window.Recharts = Recharts;
const s = document.querySelector('script[data-type="babel-source"]');
if (s) { const c = Babel.transform(s.textContent, {presets:['react']}).code; new Function(c)(); }
</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'DM Sans', 'Segoe UI', sans-serif; background: #F0F4F8; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/template" data-type="babel-source">
const { useState } = React;
const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LineChart, Line, Legend, AreaChart, Area, Cell, ReferenceLine, ComposedChart, PieChart, Pie, Treemap } = Recharts;

// ============================================================================
// PALETTE COLORI KAROL — D1
// ============================================================================
const C = {
  primario: '#1F4E79', primarioChiaro: '#2E75B6', primarioScuro: '#163A5C',
  sfondo: '#F0F4F8', card: '#FFFFFF', bordo: '#e2e8f0',
  verde: '#059669', verdeBg: '#dcfce7', verdeChiaro: '#10b981',
  giallo: '#d97706', gialloBg: '#fef9c3', gialloChiaro: '#f59e0b',
  rosso: '#dc2626', rossoBg: '#fee2e2', rossoChiaro: '#ef4444',
  viola: '#7c3aed', violaBg: '#ede9fe',
  RSA: '#0ea5e9', CTA: '#3b82f6', COS: '#8b5cf6', LAB: '#f59e0b', KCP: '#ec4899',
  budget: '#cbd5e1', t1: '#1e293b', t2: '#64748b', t3: '#94a3b8',
};

// ============================================================================
// KAROL_DATA — Struttura centralizzata dati CdG
// ============================================================================
const KAROL_DATA = {
  meta: { anno: 2025, mesi_chiusi: 8, dati_reali: true, ultimo_aggiornamento: '14/02/2026',
    fonte: 'Bilancio Verifica 31/08/2025 + Piano Rateizzazioni + Rottamazione 5 + CE Q1 + HR Zucchetti', metodo_ann: 'CE 8M×1,5 cross-validated vs Q1×4' },

  // Benchmark settore RSA/Healthcare
  BENCHMARK: {
    pers_pct: 0.55, mol_i_pct: 0.15, mol_g_pct: 0.08,
    occ_pct: 0.90, costo_pl_gg: 130, dso: 60, dpo: 90, dscr: 1.2, cop_cassa_mesi: 2.0,
  },

  // Unità Operative — DATI REALI Q1 2025 annualizzati (×4)
  // Personale: fonte HR Zucchetti (più completo di CE C1=67, include TFR/INAIL/mensilità agg.)
  // Altri costi: fonte CE DARE per C1 (materiali=55, servizi=57+59+61+63, utenze=65, altri=71)
  // Ricavi: fonte CE AVERE (incl. convenzionato + privato + ambulatori + adeguamenti)
  // LAB: fuori perimetro gruppo, riportata separatamente
  UO: [
    { cod: 'RSA', nome: 'RSA Villabate', tipo: 'RSA Alzheimer', pl: 44, colore: C.RSA,
      ricavi: 2632599, budget_ricavi: 2632599, // Q1 658.150 × 4
      costi: { personale: 1971012, materiali: 22552, servizi: 224063, utenze: 219307, manutenzione: 0, altri: 3315 },
      budget_costi: { personale: 1971012, materiali: 22552, servizi: 224063, utenze: 219307, manutenzione: 0, altri: 3315 },
      sede: 0, ammortamenti: 214000, oneri_fin: 514, // D&A allocata pro-rata ricavi (24% di €893k)
      // IMMOBILE: in locazione — affitto €219k/anno incluso in utenze
      immobile: { tipo: 'locazione', affitto_reale: 219307, affitto_figurativo: 0, costo_storico: 0 },
      // NOTA: RSA include personale Centro Gottardo (FKT ~€40k fatture), cucina, trasporto disabili
      occ: 0.900, gg_degenza: 14454,
      rM: [227327, 204228, 226594],
      cM: [155958, 173522, 163273],
    },
    { cod: 'CTA', nome: 'CTA Ex Stagno', tipo: 'Psichiatrico', pl: 40, colore: C.CTA,
      ricavi: 2817347, budget_ricavi: 2817347, // Q1 704.337 × 4
      costi: { personale: 1668136, materiali: 20355, servizi: 194451, utenze: 4820, manutenzione: 0, altri: 302 },
      budget_costi: { personale: 1668136, materiali: 20355, servizi: 194451, utenze: 4820, manutenzione: 0, altri: 302 },
      sede: 0, ammortamenti: 229000, oneri_fin: 465, // D&A allocata pro-rata ricavi (26% di €893k)
      // IMMOBILE: proprietà Karol S.p.A. — acquistato €3M (2016), mutuo ancora attivo, no affitto a CE
      // Affitto figurativo al 6% costo storico per normalizzare confronto BU
      immobile: { tipo: 'proprieta', affitto_reale: 0, affitto_figurativo: 180000, costo_storico: 3000000, anno_acquisto: 2016, ammort_pct: 0.20, da_immob: 90000 },
      // NOTA: fattura €235k/mese, incassa solo €183k (media 7M 2025). Extra-tariffa €53k/mese = credito contenzioso €7M+
      occ: 0.920, gg_degenza: 13432,
      rM: [244596, 222658, 237082],
      cM: [134740, 141514, 140780],
    },
    { cod: 'COS', nome: 'CdC Cosentino', tipo: 'Riabilitazione', pl: 50, colore: C.COS,
      ricavi: 4860598, budget_ricavi: 4860598, // Q1 1.215.149 × 4
      costi: { personale: 2092806, materiali: 1231668, servizi: 626943, utenze: 88474, manutenzione: 0, altri: 14598 },
      budget_costi: { personale: 2092806, materiali: 1231668, servizi: 626943, utenze: 88474, manutenzione: 0, altri: 14598 },
      sede: 0, ammortamenti: 395000, oneri_fin: 5461, // D&A allocata pro-rata ricavi (44% di €893k)
      // IMMOBILE: proprietà Karol S.p.A. — acquistato €4M, debiti acquisizione accollati, no affitto a CE
      immobile: { tipo: 'proprieta', affitto_reale: 0, affitto_figurativo: 240000, costo_storico: 4000000, anno_acquisto: 2016, ammort_pct: 0.20, da_immob: 120000 },
      // NOTA: estate non opera — calo fatturato privato Q2-Q3
      occ: 0.860, gg_degenza: 15695,
      rM: [348508, 423023, 443618],
      cM: [176692, 168717, 177792],
    },
    { cod: 'KCP', nome: 'Karol Casa Protetta', tipo: 'Casa Protetta', pl: 20, colore: C.KCP,
      ricavi: 664941, budget_ricavi: 664941, // Q1 166.235 × 4
      costi: { personale: 527070, materiali: 16484, servizi: 62787, utenze: 60000, manutenzione: 0, altri: 32 },
      budget_costi: { personale: 527070, materiali: 16484, servizi: 62787, utenze: 60000, manutenzione: 0, altri: 32 },
      sede: 0, ammortamenti: 55000, oneri_fin: 4, // D&A allocata pro-rata ricavi (6% di €893k)
      // IMMOBILE: in locazione — affitto €60k/anno (€5k/mese)
      immobile: { tipo: 'locazione', affitto_reale: 60000, affitto_figurativo: 0, costo_storico: 0 },
      // NOTA: brucia €300k+/anno — piano chiusura e spostamento 40 PL a BRT
      occ: null, gg_degenza: 7300,
      rM: [57768, 54536, 53932],
      cM: [42490, 45721, 43557],
    },
  ],

  // LAB — Fuori perimetro gruppo, monitoraggio separato
  LAB: {
    cod: 'LAB', nome: 'Karol Lab', tipo: 'Laboratorio Controllata',
    ricavi_q1: 0, costi_q1_personale: 39443, costi_q1_ce: 34525,
    nota: 'Azienda controllata — non inclusa nei totali di gruppo. Costo personale HR Q1: €39.443, costo CE Q1: €34.525. Nessun ricavo attribuito nel CE Q1.',
  },

  // Costi sede HQ — da CE Div.18 × 4
  // Personale HQ da HR Zucchetti: €292.951 Q1 → €1.171.805 FY
  SEDE: { totale: 2335144, personale_hq: 1171805, affitti: 92861, consulenze: 811812, IT: 0, assicurazioni: 0, altri: 165619,
    oneri_fin: 91009, imposte: 68239,
    ricavi_hq: 208790, // CE AVERE Div.18 × 4 (proventi finanziari, sopravvenienze)
    // RICAVI INTERCOMPANY (da consolidato 2024, non in Div.18 CE) — riducono costo netto Sede
    ricavi_interco: { betania: 600000, zaharaziz: 65000, lab_ristorno: 100000, totale: 765000 },
    // PERSONALE HQ — scomposizione funzionale (DA COMPLETARE con dati Zucchetti dettaglio)
    // €1.172k totale — stima allocazione per funzione da verificare
    funzioni: [
      { funzione: 'Amministrazione/Contabilità', stima: null, note: 'Contabilità interna, deposito bilanci esterno (costo limitato)', duplica_bu: true },
      { funzione: 'HR/Buste paga/Consulenza lavoro', stima: null, note: 'Gestione centralizzata per tutte le BU', duplica_bu: false },
      { funzione: 'Ufficio Acquisti', stima: null, note: '⚠ CRITICO: se comprano anche i direttori amm.vi BU → doppio costo, metà responsabilità', duplica_bu: true },
      { funzione: 'Direzione Generale + Staff', stima: null, note: 'Amministratore, emolumenti CdA, sindaci', duplica_bu: false },
      { funzione: 'Tecnico/Manutentore/Ingegnere', stima: null, note: 'Supervisione acquisti, consulenze energetiche, manutenzione attrezzature mediche', duplica_bu: false },
      { funzione: 'Ufficio Qualità', stima: null, note: 'Revisioni contratti ASP, visite ispettive, accreditamenti', duplica_bu: false },
      { funzione: 'Ufficio Legale', stima: null, note: 'Contenzioso, contratti, tutte le strutture', duplica_bu: false },
      { funzione: 'IT/Informatica', stima: null, note: 'Responsabile informatico', duplica_bu: false },
      { funzione: 'Marketing', stima: null, note: 'Centralizzato', duplica_bu: false },
      { funzione: 'Lab Analisi (buste paga S.p.A.)', stima: 80000, note: 'Personale Lab a busta paga Karol — da verificare se in Div.18 o separato', duplica_bu: false },
    ],
    // CONSULENZE €812k — breakdown DA COMPLETARE (management ha detto "raccolgo informazioni")
    consulenze_det: [
      { fornitore: 'Da dettagliare', importo: 811812, tipo: 'servizi professionali', note: '⚠ In attesa dettaglio per fornitore/contratto' },
    ],
    nota: 'Totale costi HQ Q1 €583.786 × 4. Include: personale €1.172k, consulenze/servizi €812k, altri oneri €166k, affitti €93k, oneri fin. €91k, imposte €68k. Ricavi interco da controllate €765k (Betania €600k, Zaharaziz €65k, Lab €100k) riducono costo netto a ~€1.570k.' },

  // Cash Flow
  cashflow: {
    // Waterfall calcolato da dati reali Q1×4 — BU operative (escluso LAB)
    // Ricavi BU: 10.975.485 | Personale BU: 6.259.024 | Mat: 1.291.059 | Servizi: 1.108.244 | Utenze: 312.601 | Altri: 18.247
    // MOL-I BU: 1.986.310 | Sede HQ: 2.335.144 | MOL-G: -348.834
    waterfallRaw: [
      { voce: 'Ricavi BU', valore: 10975485, tipo: 'entrata' },
      { voce: 'Personale', valore: -6259024, tipo: 'uscita' },
      { voce: 'Materiali', valore: -1291059, tipo: 'uscita' },
      { voce: 'Servizi', valore: -1108244, tipo: 'uscita' },
      { voce: 'Utenze/Affitti', valore: -312601, tipo: 'uscita' },
      { voce: 'Altri Costi', valore: -18247, tipo: 'uscita' },
      { voce: 'MOL-I BU', valore: 1986310, tipo: 'subtotale' },
      { voce: 'Proventi HQ', valore: 208790, tipo: 'entrata' },
      { voce: 'Costi Sede', valore: -2335144, tipo: 'uscita' },
      { voce: 'MOL-G', valore: -140044, tipo: 'subtotale' },
      { voce: 'D&A (FY24)', valore: -893000, tipo: 'uscita' },
      { voce: 'Oneri Fin.', valore: -268000, tipo: 'uscita' },
      { voce: 'Imposte', valore: -68239, tipo: 'uscita' },
      { voce: 'EBIT', valore: -1369283, tipo: 'finale' },
    ],
    // ===== MODELLO TESORERIA ROLLING 13 SETTIMANE =====
    // NOTA CRITICA: CTA fattura €235k/mese ma ASP autorizza factoring solo su €182.800/mese (media 7M 2025)
    // La differenza (~€53k/mese = adeguamento extra-tariffa €640k/anno) NON è cassa — accumula crediti, parte contenzioso €7M+
    // Incassi ASP reali incassabili: RSA ~€219k/m, CTA ~€183k/m (non €235k!), COS ~€324k ASP + €81k privato, KCP ~€55k/m
    // Totale ASP incassabile: €781k/mese → factoring 90% = €703k/mese, holdback 10% = €78k rientra a 45-60gg
    // Uscite: stipendi+affitti+utenze+F24 metà mese (~€734k), materiali+servizi (~€268k), rate (~€126k)
    // Delta mensile strutturale: €911k incassi - €1.128k uscite = -€217k/mese
    tesoreria: {
      saldo_iniziale: 7909, // Cassa reale inizio 2025 (da BP)
      // Flussi medi mensili — CORRETTI per CTA (solo quota incassabile €183k, non €235k)
      incassi_mese: {
        factoring_1_tranche: 421000,  // 60% di €703k ASP factoring entro il 15
        factoring_2_tranche: 281000,  // 40% restante entro fine mese
        holdback_rientro: 78000,      // 10% holdback rientra con 45-60gg ritardo
        privato_cash: 81000,          // COS visite/esami/FKT incasso giornaliero (~€20k/sett)
        intercompany_betania: 50000,  // Servizi direzione Betania (~€600k/anno ÷ 12)
        cta_extra_non_cash: 53000,    // ⚠ MEMO: adeguamento CTA fatturato NON incassato — credito contenzioso
      },
      uscite_mese: {
        stipendi_bu: 522000,          // Personale BU (€6.259k/12)
        stipendi_hq: 98000,           // Personale HQ (€1.172k/12)
        affitti: 26000,               // Affitti (RSA €219k + altri) / 12
        utenze: 8000,                 // Utenze (€96k/12 — escluso RSA che è in affitti)
        materiali_farmaci: 108000,    // Materiali (€1.291k/12)
        servizi_consulenze: 160000,   // Servizi + consulenze (€1.108k + €812k) / 12
        f24_inps: 80000,              // F24 mensile (contributi + imposte)
        rate_mutui: 77000,            // Mutui esistenti (€920k cap+int / 12)
        rate_cartelle: 28000,         // Cartelle rateizzate reali (€333k/12 per 2025 da file ADER)
        fornitori_arretrati: 0,       // Piano rientro fornitori (parte dal 2026)
      },
      // Calendario settimanale tipo (4 settimane = 1 ciclo mensile)
      // S1: holdback + privato €98k | nessuna uscita concentrata → unico respiro
      // S2: factoring 1° €441k (~15 del mese) | stipendi+F24+affitti+utenze €734k → SETTIMANA CRITICA
      // S3: privato + interco €70k | materiali+servizi €268k → deficit
      // S4: factoring 2° €301k (~30 del mese) | mutui+cartelle €126k → recupero parziale
      eventi_straord: [
        { sett: 'S9', desc: 'Erogazione Mutuo MCC €5M', importo: 5000000, tipo: 'entrata', data_stima: 'Apr-Giu 2026' },
        { sett: 'S9', desc: 'Saldo arretrati personale', importo: -995974, tipo: 'uscita', data_stima: 'Post-erogazione' },
        { sett: 'S10', desc: 'Incasso Regione CTA 1° tranche €3M', importo: 3000000, tipo: 'entrata', data_stima: 'H2 2026' },
        { sett: 'S12+', desc: 'CAPEX nuove BU (BRT+KMC+ROM)', importo: -2286587, tipo: 'uscita', data_stima: '2026-2027' },
      ],
    },
    // 13 settimane STRESS TEST (solo flussi operativi, zero eventi straordinari)
    // Mostra la realtà nuda: deficit €217k/mese, cassa negativa da S2 e in costante peggioramento
    cassaSett_base: [
      // Mese 1 (saldo iniziale €8k)
      { s: 'S1',  saldo: 106, inc_det: 'Holdback €78k + privato €20k', usc_det: '—', incassi: 98, pag: 0 },
      { s: 'S2',  saldo: -187, inc_det: 'Factoring 1° €421k + privato €20k', usc_det: 'Stipendi €620k + F24 €80k + affitti+utenze €34k', incassi: 441, pag: 734, alert: true },
      { s: 'S3',  saldo: -385, inc_det: 'Privato €20k + interco Betania €50k', usc_det: 'Materiali €108k + servizi €160k', incassi: 70, pag: 268 },
      { s: 'S4',  saldo: -210, inc_det: 'Factoring 2° €281k + privato €20k', usc_det: 'Mutui €77k + cartelle €49k', incassi: 301, pag: 126 },
      // Mese 2
      { s: 'S5',  saldo: -112, inc_det: 'Holdback + privato', usc_det: '—', incassi: 98, pag: 0 },
      { s: 'S6',  saldo: -405, inc_det: 'Factoring 1° + privato', usc_det: 'Stipendi+F24+affitti+utenze', incassi: 441, pag: 734, alert: true },
      { s: 'S7',  saldo: -603, inc_det: 'Privato + interco', usc_det: 'Materiali+servizi', incassi: 70, pag: 268 },
      { s: 'S8',  saldo: -428, inc_det: 'Factoring 2° + privato', usc_det: 'Mutui+cartelle', incassi: 301, pag: 126 },
      // Mese 3 (massima tensione pre-mutuo)
      { s: 'S9',  saldo: -330, inc_det: 'Holdback + privato', usc_det: '—', incassi: 98, pag: 0 },
      { s: 'S10', saldo: -623, inc_det: 'Factoring 1° + privato', usc_det: 'Stipendi+F24+affitti+utenze', incassi: 441, pag: 734, alert: true },
      { s: 'S11', saldo: -821, inc_det: 'Privato + interco', usc_det: 'Materiali+servizi', incassi: 70, pag: 268 },
      { s: 'S12', saldo: -646, inc_det: 'Factoring 2° + privato', usc_det: 'Mutui+cartelle', incassi: 301, pag: 126 },
      { s: 'S13', saldo: -548, inc_det: 'Holdback + privato', usc_det: '—', incassi: 98, pag: 0 },
    ],
    // 13 settimane SCENARIO PIANO (con mutuo MCC + incasso Regione)
    cassaSett_piano: [
      // Mese 1-2: identici a stress — nessun evento straordinario ancora
      { s: 'S1',  saldo: 106, inc_det: 'Holdback + privato', usc_det: '—', incassi: 98, pag: 0 },
      { s: 'S2',  saldo: -187, inc_det: 'Factoring 1°', usc_det: 'Stipendi+F24+affitti+utenze', incassi: 441, pag: 734, alert: true },
      { s: 'S3',  saldo: -385, inc_det: 'Privato + interco', usc_det: 'Materiali+servizi', incassi: 70, pag: 268 },
      { s: 'S4',  saldo: -210, inc_det: 'Factoring 2°', usc_det: 'Mutui+cartelle', incassi: 301, pag: 126 },
      { s: 'S5',  saldo: -112, inc_det: 'Holdback + privato', usc_det: '—', incassi: 98, pag: 0 },
      { s: 'S6',  saldo: -405, inc_det: 'Factoring 1°', usc_det: 'Stipendi+F24+affitti+utenze', incassi: 441, pag: 734, alert: true },
      { s: 'S7',  saldo: -603, inc_det: 'Privato + interco', usc_det: 'Materiali+servizi', incassi: 70, pag: 268 },
      { s: 'S8',  saldo: -428, inc_det: 'Factoring 2°', usc_det: 'Mutui+cartelle', incassi: 301, pag: 126 },
      // Mese 3: ★ EROGAZIONE MUTUO MCC + INCASSO REGIONE
      { s: 'S9',  saldo: 3674, inc_det: '★ MUTUO MCC €5M + holdback+privato', usc_det: '★ Saldo arretrati personale €996k', incassi: 5098, pag: 996, evento: 'Erogazione Mutuo MCC €5M' },
      { s: 'S10', saldo: 6381, inc_det: '★ REGIONE CTA €3M + Factoring 1°', usc_det: 'Stipendi+F24+affitti+utenze', incassi: 3441, pag: 734, evento: 'Incasso Regione €3M (contenzioso CTA)' },
      { s: 'S11', saldo: 6183, inc_det: 'Privato + interco', usc_det: 'Materiali+servizi', incassi: 70, pag: 268 },
      { s: 'S12', saldo: 5958, inc_det: 'Factoring 2°', usc_det: 'Mutui+cartelle + CAPEX avvio BU €400k', incassi: 301, pag: 526 },
      { s: 'S13', saldo: 6056, inc_det: 'Holdback + privato', usc_det: '—', incassi: 98, pag: 0 },
    ],
    scenari: [
      // Base = piano finanziario BP reale (cassa finale dal foglio PIANO_FINANZIARIO)
      // Ottimistico = base + CTA €2M extra + ZES €550k + ramp-up rapido (-3M)
      // Pessimistico = ritardo mutuo 6M + ramp-up Roma +6M + no incasso Regione extra
      { anno: '2025', ott: 200, base: 8, pess: -200 },      // Cassa reale ~€8k
      { anno: '2026', ott: 3200, base: 1914, pess: 400 },   // Post-mutuo €5M
      { anno: '2027', ott: 3500, base: 2342, pess: 800 },   // Ramp-up BU
      { anno: '2028', ott: 2800, base: 1557, pess: 200 },   // Picco debt service
      { anno: '2029', ott: 2700, base: 1427, pess: 300 },   // Stabilizzazione
      { anno: '2030', ott: 2800, base: 1359, pess: 500 },   // Inizio consolidamento
      { anno: '2031', ott: 3000, base: 1598, pess: 700 },
      { anno: '2032', ott: 3500, base: 2079, pess: 1000 },
      { anno: '2033', ott: 4000, base: 2361, pess: 1200 },
      { anno: '2034', ott: 4800, base: 3149, pess: 1800 },
      { anno: '2035', ott: 6500, base: 5011, pess: 3000 },  // PFN → 0
    ],
    kpi: { dso: 50, dpo: 75, dscr: 0.97, cop_cassa: 0.03, ccn: -2100000, capex: 2424245, debito_annuo: 1503802 },
    // Scadenziario crediti/debiti (simulato)
    scadenziario: {
      crediti: [
        { fascia: '0-30 gg', importo: 380000, pct: 0.31 },
        { fascia: '31-60 gg', importo: 420000, pct: 0.34 },
        { fascia: '61-90 gg', importo: 285000, pct: 0.23 },
        { fascia: '> 90 gg', importo: 145000, pct: 0.12 },
      ],
      debiti: [
        { fascia: '0-30 gg', importo: 210000, pct: 0.27 },
        { fascia: '31-60 gg', importo: 290000, pct: 0.37 },
        { fascia: '61-90 gg', importo: 185000, pct: 0.24 },
        { fascia: '> 90 gg', importo: 95000, pct: 0.12 },
      ],
      totCrediti: 1230000,
      totDebiti: 780000,
    },
  },

  narrative: [
    { uo: 'RSA', alert: 'ROSSO', testo: 'Personale 74,9% dei ricavi — include personale Centro Gottardo (FKT, ~€40k fatture attive), cucina centralizzata e trasporto disabili allocati impropriamente. Affitto €219k da proprietario rigido. Piano strategico: spostare i 40 PL convenzionati al Borgo Ritrovato (nuova BU giugno 2026) per risparmiare locazione e razionalizzare personale.', outlook: 'In ristrutturazione — migrazione a BRT prevista H2 2026' },
    { uo: 'CTA', alert: 'GIALLO', testo: 'MOL-I contabile 33% ma ATTENZIONE: fattura €235k/mese, incassa solo €183k/mese (media 7M 2025). I €53k/mese di adeguamento extra-tariffa (€640k/anno) non sono cassa — si accumulano come crediti e fanno parte del contenzioso €7M+ con Regione. Transazione imminente. Se confermata: game-changer per liquidità. Rischio residuo: se adeguamento non rinnovato, ricavi reali -23% e MOL-I crolla.', outlook: 'In attesa transazione regionale — alto impatto su cassa e crediti' },
    { uo: 'COS', alert: 'VERDE', testo: 'Top performer per volumi: ricavi FY stimati €4,86M. MOL-I 16,5%. Estate non opera: calo fatturato privato Q2-Q3 spiega parte del deterioramento MOL 8M. Materiali elevati (€1,23M) per attività chirurgica/riabilitativa. Personale 43,1% — il migliore del gruppo.', outlook: 'Favorevole — attenzione stagionalità estiva' },
    { uo: 'KCP', alert: 'ROSSO', testo: 'Casa Protetta 20 PL brucia €300k+/anno. Personale 79,3% dei ricavi — insostenibile per diseconomie di scala. Piano: chiusura e spostamento PL al Borgo Ritrovato, con razionalizzazione personale e risparmio su costi fissi.', outlook: 'In chiusura — migrazione PL a BRT' },
    { uo: 'GRUPPO', alert: 'ROSSO', testo: 'MOL-I BU €1,99M (18,1%) sopra benchmark, ma Sede HQ €2,34M (21,3%) + D&A €893k + Oneri Fin. €268k portano l\'EBIT a -€1,37M. Crescita storica a debito + COVID + gestione paternalistica (eccesso personale). Normalizzando il bilancio 2024 (senza €1,26M interessi ASP straordinari): perdita operativa reale ~€800k. Target management: -10% costi per superare DSCR critico 2027-28. Strumento: mutuo bancario 10yr (non Bond) + crediti fiscali innovazione/patent box + transazione CTA €7M.', outlook: 'Critico — passaggio stretto 2027-28, piano di rientro in corso' },
  ],

  // ====== PIANO FINANZIARIO — Dati reali da BP Excel + Memorandum Mutuo ======
  piano: {
    // Mutuo bancario MCC (Fondo Garanzia PMI, garanzia 80%)
    mutuo: { importo: 5000000, durata_anni: 10, tasso: 0.05, preammortamento_mesi: 12,
      rata_annua: 632983, data_stima_erogazione: 'Giugno 2026', garanzia: 'MCC 80%',
      commissione_mcc: 20000, tipo: 'Francese (rata costante)',
      utilizzo: { capex: { pct: 0.457, importo: 2286587 }, arretrati_personale: { pct: 0.199, importo: 995974 }, buffer_liquidita: { pct: 0.344, importo: 1717439 } },
      // Piano ammortamento annuale dal foglio Excel
      piano_amm: [
        { anno: 2026, deb_iniz: 5000000, capitale: 0, interessi: 250000, rata: 250000, deb_fin: 5000000 },
        { anno: 2027, deb_iniz: 5000000, capitale: 382983, interessi: 250000, rata: 632983, deb_fin: 4617017 },
        { anno: 2028, deb_iniz: 4617017, capitale: 402132, interessi: 230851, rata: 632983, deb_fin: 4214885 },
        { anno: 2029, deb_iniz: 4214885, capitale: 422239, interessi: 210744, rata: 632983, deb_fin: 3792646 },
        { anno: 2030, deb_iniz: 3792646, capitale: 443351, interessi: 189632, rata: 632983, deb_fin: 3349295 },
        { anno: 2031, deb_iniz: 3349295, capitale: 465518, interessi: 167465, rata: 632983, deb_fin: 2883777 },
        { anno: 2032, deb_iniz: 2883777, capitale: 488794, interessi: 144189, rata: 632983, deb_fin: 2394983 },
        { anno: 2033, deb_iniz: 2394983, capitale: 513234, interessi: 119749, rata: 632983, deb_fin: 1881749 },
        { anno: 2034, deb_iniz: 1881749, capitale: 538896, interessi: 94087, rata: 632983, deb_fin: 1342853 },
        { anno: 2035, deb_iniz: 1342853, capitale: 565840, interessi: 67143, rata: 632983, deb_fin: 777013 },
      ],
    },
    // PIANO FINANZIARIO COMPLETO (dal foglio PIANO_FINANZIARIO del BP)
    anni: [2025, 2026, 2027, 2028, 2029, 2030, 2031, 2032, 2033, 2034, 2035],
    fcf: {
      ebitda:   [1450172, 2339958, 2665528, 2821163, 2984002, 3154378, 3332639, 3519151, 3714295, 3918474, 4132107],
      imposte:  [-94953, -202609, -304504, -387625, -466765, -533479, -593731, -658074, -724525, -796129, -868076],
      capex:    [0, -2424245, -137658, -137658, -137658, -137658, -137658, -137658, -137658, -137658, -137658],
      delta_ccn:[113223, 2339918, 1951136, 102057, 88413, 88190, 87962, 87729, 87729, -12507, -12748],
      fcf_op:   [1465707, 2053023, 4174502, 2397936, 2467992, 2571430, 2689212, 2811148, 2839605, 2971939, 3113379],
    },
    // Servizio debito — dettaglio per categoria
    servizio: {
      mutui_esistenti_cap: [612286, 1516034, 1108075, 799345, 449336, 316705, 252304, 257512, 262891, 198446, 180850],
      mutui_nuovi_cap:     [0, 0, 382983, 402132, 422239, 443351, 465518, 488794, 513234, 538896, 565840],
      mutui_interessi:     [308266, 778779, 643085, 501858, 382054, 314166, 277242, 233958, 191777, 140227, 96906],
      cartelle_ratezz:     [333011, 455330, 853223, 783999, 684747, 469820, 469499, 458825, 452358, 452358, 339269],
      cartelle_rottam:     [0, 68689, 137379, 137379, 137379, 137379, 137379, 137379, 137379, 137379, 68689],
      cartelle_inps:       [181943, 412112, 521783, 458382, 321580, 208368, 98224, 3911, 0, 0, 0],
      cartelle_interessi:  [68296, 72010, 72010, 72010, 72010, 72010, 72010, 72010, 72010, 72010, 72010],
      fornitori:           [0, 300000, 100000, 100000, 200000, 750000, 750000, 750000, 1000000, 716003, 0],
      personale:           [0, 995974, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      rottamazione5_nc:    [0, 620089, 0, 0, 0, 0, 0, 0, 0, 0, 0], // non-cash, riduce stock
      totale:              [1503802, 5147008, 3746529, 3183095, 2597334, 2639789, 2450165, 2330378, 2557639, 2183309, 1251554],
    },
    // Risorse straordinarie
    risorse_straord: [0, 5000000, 0, 0, 0, 0, 0, 0, 0, 0, 0], // erogazione mutuo 2026
    incasso_regione: [0, 3000000, 2000000, 100000, 100000, 100000, 100000, 100000, 0, 0, 0],
    // Dinamica cassa
    cassa: [7909, 1913924, 2341897, 1556738, 1427395, 1359036, 1598083, 2078853, 2360819, 3149448, 5011274],
    // Stock debiti residui
    stock: {
      bancari:       [6434757, 9918723, 8427665, 7226187, 6354612, 5594556, 4876734, 4130428, 3354303, 2616961, 1870271],
      tributari:     [12362737, 10806517, 9294132, 7914372, 6770666, 5955099, 5249997, 4649883, 4060146, 3470409, 3062451],
      fornitori:     [4516003, 4216003, 4116003, 4016003, 3816003, 3066003, 2316003, 1566003, 566003, 0, 0],
      personale:     [995974, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      totale:        [24309471, 24941242, 21837799, 19156562, 16941281, 14615658, 12442734, 10346314, 7980452, 6087370, 4932723],
    },
    pfn: {
      standard:   [6426848, 8004799, 6085767, 5669449, 4927217, 4235519, 3278651, 2051575, 993484, -532487, -3141002],
      gestionale: [18801562, 20527319, 18995902, 17199824, 15213886, 13056621, 10744651, 8267461, 5619633, 2937922, -78551],
    },
    // CE proiezioni
    ricavi: [13174227, 17021878, 18636684, 19080019, 19536250, 20005838, 20489260, 20987017, 21499627, 22027632, 22571598],
    // Nuove BU
    nuove_bu: [
      { cod: 'BRT', nome: 'Borgo Ritrovato', tipo: 'RSA 40PL + Casa Protetta 20PL + FKT', pl: 60, regione: 'Sicilia (Palermo)',
        capex_residuo: 0, ricavi_regime: 2918060, apertura_stima: 'Giugno 2026', ramp_up_mesi: 4,
        ricavi_bu: { r2025: 0, r2026: 3178890, r2027: 3377516 }, // Include RSA spostata
        nota: 'Assorbe 40 PL convenzionati da RSA + FKT €250k. Elimina affitto RSA €219k.' },
      { cod: 'KMC', nome: 'Karol Medical Center', tipo: 'Day Surgery + Ambulatorio Privato', pl: 0, regione: 'Sicilia (Palermo)',
        capex_residuo: 710000, ricavi_regime: 1428800, apertura_stima: 'Aprile 2026', ramp_up_mesi: 9,
        ricavi_bu: { r2025: 0, r2026: 857280, r2027: 1428800 }, // 9M primo anno, a regime 2027
        nota: 'CAPEX: edili €71k + arredi/tech €639k. Sale operatorie + ambulatori privati.' },
      { cod: 'ROM', nome: 'RSA Roma Santa Margherita', tipo: 'RSA 77PL (RI + Estensiva + Semi-res)', pl: 77, regione: 'Lazio',
        capex_residuo: 1200000, ricavi_regime: 4190901, apertura_stima: 'Aprile 2026', ramp_up_mesi: 12,
        ricavi_bu: { r2025: 0, r2026: 2514541, r2027: 4190901 }, // 9M primo anno, a regime 2027
        nota: 'Pre-accreditamento solido. Tariffe Lazio: RI €227/gg, Est. €154/gg, Semi-res €79/gg.' },
    ],
    // Crediti attesi (non nel CE operativo)
    crediti_attesi: {
      cta_contenzioso: { importo: 5500000, probabilita: 'alta', tempistica: 'imminente', incasso_piano: '3M 2026 + 2M 2027 + 100k/anno' },
      crediti_fiscali: { importo: 1500000, tipo: 'innovazione + patent box', stato: 'in certificazione (studio Roma)' },
      zes_unica: { importo: 550000, finestra: 'marzo-maggio 2026', nel_bp: false },
    },
    // Obiettivi
    target: { riduzione_costi_pct: 0.10, ricavi_2027: 18636684, ebitda_target_pct: 0.143, pfn_zero: 2035 },
  },

  // ====== CE CONSUNTIVO 8M 2025 — Da Bilancio di Verifica Provvisorio 31/08/2025 ======
  ce_8m: {
    periodo: '8M Gen-Ago 2025',
    ricavi: {
      asp: 6111541, cta_extra: 394610, deg_privata: 226935, ambulatoriale: 101372,
      riabilitazione: 49549, punto_prelievi: 65544, serv_non_san: 148564,
      comfort: 4524, ticket: 31323, visite: 2320, cartelle: 1320,
      sopravvenienze: 13035,
      betania: 432740, zaharaziz: 32904, altri_proventi: 3193,
      totale: 7619473,
      totale_cash: 7224863, // Escluso CTA extra €395k
    },
    costi: {
      acquisti_prod: 640802, acquisti_diversi: 30317, sopravv_acq: 33955,
      tot_acquisti: 705074,
      servizi_prod: 537498, intermediazione: 48324, utenze: 278665, manutenzioni: 92914,
      tot_servizi: 957401,
      veicoli: 44198,
      lav_autonomo: 109245, organi_sociali: 140973, tot_lav_non_dip: 250217,
      spese_amm: 197262,
      god_beni_terzi: 312109,
      personale: 4716317,
      oneri_diversi: 117732,
      tot_operativi: 7300310,
    },
    financials: {
      ebitda: 319163, ebitda_pct: 0.042,
      ebitda_reale: -75447, // Escluso CTA extra non-cash
      ebitda_reale_pct: -0.010,
      oneri_fin: 196644, proventi_fin: 13344,
      imposte: 63446,
      risultato_netto: 72417,
    },
    kpi_8m: {
      personale_pct: 0.619, // 61,9% — sopra soglia 55%
      protesi: 363913, // Voce singola più grande acquisti
      sanzioni_tributarie: 68913, // Puro spreco
      factoring_costo: 147730, // Costo anticipazione
      spese_legali_totali: 143369, // Consulenze + spese amm.legali
    },
    anomalie: [
      { voce: 'Personale 61,9%', impatto_ann: 1540000, nota: '€7,07M ann. vs €5,53M budget — Delta €1,54M, sopra soglia 55%', priorita: 1 },
      { voce: 'EBITDA reale negativo', impatto_ann: -113000, nota: 'CTA extra escluso: €319k - €395k = -€76k in 8M', priorita: 2 },
      { voce: 'Sanzioni tributarie', impatto_ann: 103000, nota: 'Puro spreco da ritardi — recuperabile al 100%', priorita: 3 },
      { voce: 'Affitti vs budget', impatto_ann: 247000, nota: '€314k ann. vs €67k budget: sottostima 4,7×', priorita: 4 },
      { voce: 'Manutenzioni vs budget', impatto_ann: 76000, nota: '€139k ann. vs €63k budget: +120%', priorita: 5 },
      { voce: 'Factoring €222k/anno', impatto_ann: 222000, nota: 'Costo della crisi di liquidità', priorita: 6 },
      { voce: 'Budget 2026 irrealistico', impatto_ann: 1750000, nota: 'Gap €2,13M in ricavi ambulatoriale/servizi', priorita: 7 },
    ],
  },

  // ====== MAPPA DEBITI — Dati reali da Bilancio Verifica 31/08/2025 + Piano Rateizzazioni ======
  debiti: {
    data_riferimento: '31/08/2025',
    stock: {
      bancari: { totale: 6435000, dettaglio: [
        { desc: 'Intesa mutuo ipotecario', residuo: 1834000, tipo: 'MLT' },
        { desc: 'Intesa liquidità €500k', residuo: 384000, tipo: 'MLT' },
        { desc: 'IRFIS 24/6231', residuo: 793000, tipo: 'MLT' },
        { desc: 'Banca Progetto', residuo: 631000, tipo: 'MLT' },
        { desc: 'Banca Progetto investim.', residuo: 952000, tipo: 'MLT' },
        { desc: 'B.Pop Sant\'Angelo', residuo: 178000, tipo: 'MLT' },
        { desc: 'Banca Sistema', residuo: 100000, tipo: 'BT', nota: '⚠ tasso sconosciuto' },
        { desc: 'MCC residuo', residuo: 445000, tipo: 'MLT' },
        { desc: 'Soci c/finanziamento', residuo: 80000, tipo: 'MLT' },
        { desc: 'Altri/minori', residuo: 38000, tipo: 'BT' },
      ]},
      erariali: { totale: 5941000, netto_crediti_rs: 4472000, dettaglio: [
        { desc: 'Cartella MH 18/09/24', residuo: 3008000, nota: '⚠ NON in Rott.5', in_rate: true, rate_mese: 37697 },
        { desc: 'Cartella MI 18/09/24', residuo: 289000 },
        { desc: 'Ritenute dip. 2023', residuo: 1090000 },
        { desc: 'Ritenute dip. 2024', residuo: 949000 },
        { desc: 'Ritenute dip. 2025', residuo: 539000, nota: 'correnti' },
        { desc: 'Ritenute aut. 2020', residuo: 202000, nota: '⚠ aperte da 5 anni' },
        { desc: 'Ritenute aut. 2024', residuo: 215000 },
        { desc: 'Rateizzazioni ADER varie', residuo: 846000, in_rate: true },
        { desc: 'Rottamazione quater', residuo: 166000, nota: '→ Rott.5' },
        { desc: 'Cartelle minori 2024-25', residuo: 221000 },
        { desc: 'Crediti R&S', residuo: -1469000, nota: 'In uso F24' },
      ]},
      previdenziali: { totale: 4347000, dettaglio: [
        { desc: 'INPS 2025 corrente', residuo: 849000 },
        { desc: 'Rateizz. INPS 245219', residuo: 1095000, in_rate: true, nota: 'Probabile in Rott.5' },
        { desc: 'Rateizz. INPS 422157', residuo: 594000, in_rate: true },
        { desc: 'INPS sospeso 10/23-9/24', residuo: 1188000, nota: 'Giudice Catanzaro — vittime racket' },
        { desc: 'Fondi pensione', residuo: 452000 },
        { desc: 'INAIL', residuo: 75000 },
      ]},
      commerciali: { totale: 5449000, dettaglio: [
        { desc: 'Fornitori', residuo: 5375000, nota: 'Stock alto' },
        { desc: 'Fatture da ricevere', residuo: 67000 },
        { desc: 'Partite da liquidare', residuo: 7000 },
      ]},
      personale: { totale: 1259000, dettaglio: [
        { desc: 'Stipendi arretrati reali', residuo: 900000, nota: '⚠ ~€900k arretrati' },
        { desc: 'Stipendi correnti agosto', residuo: 542000 },
        { desc: 'Compensazioni', residuo: -183000 },
      ]},
      infragruppo: { totale_debiti: 10979000, totale_crediti: 7400000, netto: -3579000, dettaglio: [
        { desc: 'vs Karol Betania', debito: 8708000, credito: 4405000, netto: -4303000, nota: '⚠ VORAGINE' },
        { desc: 'vs Karol Lab', debito: 1661000, credito: 215000, netto: -1446000 },
        { desc: 'vs Cosentino', debito: 171000, credito: 1256000, netto: 1085000 },
        { desc: 'vs Karol Hospital', debito: 229000, credito: 1427000, netto: 1198000 },
        { desc: 'vs Zaharaziz', debito: 0, credito: 2542000, netto: 2542000, nota: 'Credito immobilizzato' },
        { desc: 'vs Karol Domus', debito: 50000, credito: 0, netto: -50000 },
        { desc: 'vs KSS San Carlo', debito: 5000, credito: 95000, netto: 90000 },
      ]},
      altri: { totale: 1637000, dettaglio: [
        { desc: 'Accolli piano art.67', residuo: 188000 },
        { desc: 'Accolli Cosentino', residuo: 437000 },
        { desc: 'Regione POFESR', residuo: 558000, nota: '⚠ Causa pendente' },
        { desc: 'Cessioni V dipendenti', residuo: 95000 },
        { desc: 'Fornitori a lungo', residuo: 124000 },
        { desc: 'Varie minori', residuo: 235000 },
      ]},
    },
    rate_annuali: [
      { anno: 2025, capitale: 264715, interessi: 68296, totale: 333011, mese: 27751 },
      { anno: 2026, capitale: 383023, interessi: 72307, totale: 455330, mese: 37944 },
      { anno: 2027, capitale: 696195, interessi: 157028, totale: 853223, mese: 71102, nota: 'Sospese ripartono' },
      { anno: 2028, capitale: 747808, interessi: 36191, totale: 784000, mese: 65333 },
      { anno: 2029, capitale: 672066, interessi: 12681, totale: 684747, mese: 57062 },
      { anno: 2030, capitale: 468554, interessi: 1266, totale: 469820, mese: 39152 },
    ],
    rottamazione5: {
      karol_spa: { definibile: 1236408, residuo: 1856497, sopravvenienza: 620089, n_cartelle: 10 },
      betania: { definibile: 507920, residuo: 720770, sopravvenienza: 212850, n_cartelle: 1 },
      totale_risparmio: 832939,
      nota: 'Cartella MH €3.008k NON inclusa. Probabile inclusione INPS 245219. Sopravvenienza €620k migliora CE 2026.',
    },
    esposizione: { bancari: 6435000, erariali_netti: 4472000, previdenziali: 4347000, commerciali: 5449000, personale: 1259000, infragruppo_netto: 3579000, altri: 1637000, totale: 27178000, cassa: -231000 },
    rate_mensili_2025: { cartelle: 27751, mutui: 77000, inps_rate: 24500, totale: 129251 },
    da_verificare: [
      'Betania posizione netta -€4,3M: formazione e piano rientro',
      'Zaharaziz credito immobilizzato €2,54M: recuperabilità',
      'Ritenute autonomi 2020 €202k: perché ancora aperte',
      'Cartella MH €3.008k: natura e rateizzabilità',
      'INPS sospeso €1,19M: piano post-sentenza Catanzaro',
      'Banca Sistema €100k: tasso applicato',
      'POFESR €558k: esito causa pendente',
    ],
  },
};

// ============================================================================
// COMPUTED — Aggregati calcolati da KAROL_DATA
// ============================================================================
const D = KAROL_DATA;
const UO = D.UO;
const BENCH = D.BENCHMARK;

// Helper costi totali per UO
const costiTot = u => Object.values(u.costi).reduce((s, v) => s + v, 0);
const budgetCostiTot = u => Object.values(u.budget_costi).reduce((s, v) => s + v, 0);

// Calcola MOL-I, MOL-G, margini per ogni UO
UO.forEach(u => {
  u.costiDir = costiTot(u);
  u.molI = u.ricavi - u.costiDir;
  u.molIPct = u.ricavi > 0 ? u.molI / u.ricavi : 0;
  u.molG = u.molI - u.sede;
  u.molGPct = u.ricavi > 0 ? u.molG / u.ricavi : 0;
  u.persPct = u.ricavi > 0 ? u.costi.personale / u.ricavi : 0;
  u.ricGg = u.gg_degenza ? u.ricavi / u.gg_degenza : null;
  u.costo_pl_gg = (u.pl && u.gg_degenza) ? u.costiDir / u.gg_degenza : null;
  // EBIT (risultato operativo)
  u.ebit = u.molG - u.ammortamenti - u.oneri_fin;
  // Budget delta
  u.delta_ricavi = u.ricavi - u.budget_ricavi;
  u.delta_costi = u.costiDir - budgetCostiTot(u);
  // CE NORMALIZZATO — costo di occupazione equo per confronto BU
  // CTA/COS: aggiunge affitto figurativo (6% costo storico immobile)
  // RSA/KCP: invariato (già paga affitto reale)
  const aff = u.immobile ? u.immobile.affitto_figurativo : 0;
  u.costo_occupazione = u.immobile ? (u.immobile.affitto_reale + aff) : 0; // costo effettivo + figurativo
  u.costiNorm = u.costiDir + aff;
  u.molINorm = u.ricavi - u.costiNorm;
  u.molINormPct = u.ricavi > 0 ? u.molINorm / u.ricavi : 0;
});

const TOT = {
  ric: UO.reduce((s, u) => s + u.ricavi, 0),
  cDir: UO.reduce((s, u) => s + u.costiDir, 0),
  pers: UO.reduce((s, u) => s + u.costi.personale, 0),
  molI: UO.reduce((s, u) => s + u.molI, 0),
  sede: D.SEDE.totale,
  ammort: UO.reduce((s, u) => s + u.ammortamenti, 0),
  oneri_fin: UO.reduce((s, u) => s + u.oneri_fin, 0),
};
TOT.molIPct = TOT.ric > 0 ? TOT.molI / TOT.ric : 0;
TOT.molG = TOT.molI - TOT.sede;
TOT.molGPct = TOT.ric > 0 ? TOT.molG / TOT.ric : 0;
TOT.persPct = TOT.ric > 0 ? TOT.pers / TOT.ric : 0;
TOT.ebit = TOT.molG - TOT.ammort - TOT.oneri_fin;
TOT.budget_ric = UO.reduce((s, u) => s + u.budget_ricavi, 0);
TOT.budget_cDir = UO.reduce((s, u) => s + budgetCostiTot(u), 0);
// Ricavi intercompany HQ (riducono costo netto Sede)
const INTERCO = D.SEDE.ricavi_interco;
TOT.sede_lorda = TOT.sede; // €2.335k costi lordi
TOT.sede_netta = TOT.sede - INTERCO.totale - D.SEDE.ricavi_hq; // €2.335k - €765k interco - €209k proventi = €1.361k
// Totali normalizzati (affitto figurativo)
const TOT_AFFITTI_FIG = UO.reduce((s, u) => s + (u.immobile ? u.immobile.affitto_figurativo : 0), 0); // €420k
TOT.molINorm = UO.reduce((s, u) => s + u.molINorm, 0);
TOT.molINormPct = TOT.ric > 0 ? TOT.molINorm / TOT.ric : 0;
TOT.sedeNorm = TOT.sede - TOT_AFFITTI_FIG; // HQ ridotta per affitti figurativi
TOT.sedeNettaNorm = TOT.sede_netta - TOT_AFFITTI_FIG; // Sede netta + affitti figurativi
TOT.molGNorm = TOT.molINorm - TOT.sedeNorm;

// KPI semafori auto-calcolati
const autoKPI = [];
UO.forEach(u => {
  autoKPI.push({ kpi: 'MOL-I %', uo: u.cod, v: u.molIPct, tgt: BENCH.mol_i_pct, a: u.molIPct >= BENCH.mol_i_pct ? 'VERDE' : u.molIPct >= BENCH.mol_i_pct * 0.7 ? 'GIALLO' : 'ROSSO' });
  autoKPI.push({ kpi: 'MOL-G %', uo: u.cod, v: u.molGPct, tgt: BENCH.mol_g_pct, a: u.molGPct >= BENCH.mol_g_pct ? 'VERDE' : u.molGPct >= 0 ? 'GIALLO' : 'ROSSO' });
  autoKPI.push({ kpi: 'Pers. %', uo: u.cod, v: u.persPct, tgt: BENCH.pers_pct, a: u.persPct <= BENCH.pers_pct ? 'VERDE' : u.persPct <= BENCH.pers_pct * 1.1 ? 'GIALLO' : 'ROSSO' });
  if (u.occ !== null) autoKPI.push({ kpi: 'Occ. %', uo: u.cod, v: u.occ, tgt: BENCH.occ_pct, a: u.occ >= BENCH.occ_pct ? 'VERDE' : u.occ >= BENCH.occ_pct * 0.9 ? 'GIALLO' : 'ROSSO' });
  if (u.costo_pl_gg !== null) autoKPI.push({ kpi: 'Costo PL/gg', uo: u.cod, v: u.costo_pl_gg, tgt: BENCH.costo_pl_gg, a: u.costo_pl_gg <= BENCH.costo_pl_gg ? 'VERDE' : u.costo_pl_gg <= BENCH.costo_pl_gg * 1.15 ? 'GIALLO' : 'ROSSO' });
});
const KPI = autoKPI;

// Waterfall calcolato
const { waterfallRaw, scenari } = D.cashflow;
const cassaSett_base = D.cashflow.cassaSett_base;
const cassaSett_piano = D.cashflow.cassaSett_piano;
const tesoreria = D.cashflow.tesoreria;
let rt = 0;
const waterfall = waterfallRaw.map(w => {
  if (w.tipo === 'entrata') { const b = rt; rt += w.valore; return { ...w, base: b, barra: w.valore, col: C.verde }; }
  if (w.tipo === 'uscita') { const r = { ...w, base: Math.min(rt, rt + w.valore), barra: Math.abs(w.valore), col: C.rosso }; rt += w.valore; return r; }
  if (w.tipo === 'subtotale') { rt = w.valore; return { ...w, base: 0, barra: Math.abs(w.valore), col: w.valore >= 0 ? '#2563eb' : '#b91c1c' }; }
  rt = w.valore; return { ...w, base: 0, barra: Math.abs(w.valore), col: w.valore >= 0 ? '#047857' : '#b91c1c' };
});

const narrative = D.narrative;

// ============================================================================
// KPI CALCOLATI — Copertura Cassa unificata (no hardcoded)
// ============================================================================
const copCassa = (() => {
  const saldo = tesoreria.saldo_iniziale || 8000;
  const burn = tesoreria.uscite_mese ? Object.values(tesoreria.uscite_mese).reduce((s,v) => s+v, 0) : 217000;
  const incassi = tesoreria.incassi_mese ? Object.values(tesoreria.incassi_mese).reduce((s,v) => s+v, 0) : 0;
  const deficit = burn - incassi;
  const mesi = deficit > 0 ? saldo / deficit : 99;
  const giorni = Math.round(mesi * 30);
  return { saldo, burn, incassi, deficit, mesi: +mesi.toFixed(2), giorni };
})();

// ============================================================================
// HELPERS — formattazione importi PRECISI (no abbreviazioni)
// ============================================================================
const formatEuro = v => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v);
const fmt = formatEuro;
const fmtPct = v => (v * 100).toFixed(1) + '%';
const mesi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
const mesiDisp = mesi.slice(0, D.meta.mesi_chiusi); // Solo mesi con dati reali

const Semaforo = ({ valore, testo, verdeMin, gialloMin, invertito }) => {
  let colore, sfondo;
  if (invertito) {
    colore = valore <= verdeMin ? C.verde : valore <= gialloMin ? C.giallo : C.rosso;
  } else {
    colore = valore >= verdeMin ? C.verde : valore >= gialloMin ? C.giallo : C.rosso;
  }
  sfondo = colore === C.verde ? C.verdeBg : colore === C.giallo ? C.gialloBg : C.rossoBg;
  return React.createElement('span', { style: { background: sfondo, color: colore, padding: '2px 10px', borderRadius: 12, fontSize: 11, fontWeight: 600 } }, testo || (typeof valore === 'number' ? (valore % 1 === 0 ? valore : valore.toFixed(1)) : valore));
};

const Badge = ({ reale }) => {
  if (reale) return React.createElement('span', { style: { fontSize: 9, padding: '1px 6px', borderRadius: 10, background: C.verdeBg, color: C.verde, marginLeft: 6, fontWeight: 600 } }, 'Consuntivo');
  return React.createElement('span', { style: { fontSize: 9, padding: '1px 6px', borderRadius: 10, background: '#fff7ed', color: '#c2410c', marginLeft: 6, fontWeight: 600 } }, 'Dati simulati');
};

const alertCol = a => ({ color: a === 'ROSSO' ? C.rosso : a === 'GIALLO' ? C.giallo : C.verde, bg: a === 'ROSSO' ? C.rossoBg : a === 'GIALLO' ? C.gialloBg : C.verdeBg });

// Helper delta con freccia
const DeltaBadge = ({ v, inverse }) => {
  const pos = inverse ? v <= 0 : v >= 0;
  const col = pos ? C.verde : C.rosso;
  const bg = pos ? C.verdeBg : C.rossoBg;
  const arrow = v > 0 ? '▲' : v < 0 ? '▼' : '—';
  return React.createElement('span', { style: { fontSize: 10, padding: '2px 6px', borderRadius: 8, background: bg, color: col, fontWeight: 600 } }, arrow + ' ' + formatEuro(Math.abs(v)));
};

// ============================================================================
// COMPONENTE PRINCIPALE
// ============================================================================
const KarolDashboard = () => {
  const [tab, setTab] = useState('overview');
  const [selUO, setSelUO] = useState(null);
  const [ceView, setCeView] = useState('consolidato');
  const [simRic, setSimRic] = useState(0);
  const [simPers, setSimPers] = useState(0);
  const [simOcc, setSimOcc] = useState(0);
  const [simSede, setSimSede] = useState(0);
  const [showExport, setShowExport] = useState(false);
  const [exporting, setExporting] = useState(false);
  const [fcMethod, setFcMethod] = useState('lin');

  // ---- Export PDF — Report strutturato multi-pagina ----
  const exportPDF = async () => {
    setExporting(true);
    setShowExport(false);
    try {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const W = pdf.internal.pageSize.getWidth();
      const H = pdf.internal.pageSize.getHeight();
      const M = 15; // margine
      const CW = W - 2 * M; // content width
      let Y = M;

      const fmtN = v => { const abs = Math.abs(Math.round(v)); const s = abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.'); return (v < 0 ? '-' : '') + '€ ' + s; };
      const fmtP = v => (v * 100).toFixed(1).replace('.', ',') + '%';

      const checkPage = (need) => { if (Y + need > H - 15) { pdf.addPage(); Y = M; addFooter(); } };
      const addFooter = () => {
        const pg = pdf.internal.getNumberOfPages();
        pdf.setFontSize(8); pdf.setTextColor(150);
        pdf.text('Karol S.p.A. — Controllo di Gestione — ' + D.meta.ultimo_aggiornamento, M, H - 8);
        pdf.text('Pag. ' + pg, W - M, H - 8, { align: 'right' });
      };

      // Helper tabella
      const drawTable = (headers, rows, colWidths, opts = {}) => {
        const rH = 7; // row height
        const fSize = opts.fontSize || 8;
        checkPage(rH * (rows.length + 2));
        // Header
        pdf.setFillColor(240, 244, 248);
        pdf.rect(M, Y, CW, rH, 'F');
        pdf.setFontSize(fSize); pdf.setTextColor(80);
        pdf.setFont(undefined, 'bold');
        let x = M;
        headers.forEach((h, i) => {
          const align = i === 0 ? 'left' : 'right';
          const tx = i === 0 ? x + 2 : x + colWidths[i] - 2;
          pdf.text(h, tx, Y + 5, { align });
          x += colWidths[i];
        });
        Y += rH;
        // Rows
        pdf.setFont(undefined, 'normal');
        rows.forEach((row, ri) => {
          checkPage(rH);
          if (row._bold) pdf.setFont(undefined, 'bold');
          if (row._bg) { pdf.setFillColor(...(row._bg)); pdf.rect(M, Y, CW, rH, 'F'); }
          x = M;
          row.cells.forEach((cell, i) => {
            const align = i === 0 ? 'left' : 'right';
            const tx = i === 0 ? x + 2 : x + colWidths[i] - 2;
            if (row._colors && row._colors[i]) { const c = row._colors[i]; pdf.setTextColor(c[0], c[1], c[2]); }
            else { pdf.setTextColor(row._bold ? 30 : 60); }
            pdf.text(String(cell), tx, Y + 5, { align });
            x += colWidths[i];
          });
          pdf.setFont(undefined, 'normal');
          Y += rH;
          pdf.setDrawColor(230); pdf.line(M, Y, W - M, Y);
        });
        Y += 4;
      };

      // === PAGINA 1: COPERTINA + RIEPILOGO ===
      pdf.setFontSize(22); pdf.setTextColor(30, 41, 59);
      pdf.text('KAROL S.p.A.', W / 2, 40, { align: 'center' });
      pdf.setFontSize(14); pdf.setTextColor(100);
      pdf.text('Controllo di Gestione — Gruppo Sicilia', W / 2, 50, { align: 'center' });
      pdf.setFontSize(11); pdf.setTextColor(60);
      pdf.text('Anno ' + D.meta.anno + ' — ' + D.meta.mesi_chiusi + ' mesi consuntivati', W / 2, 60, { align: 'center' });
      pdf.text('Report generato il ' + new Date().toLocaleDateString('it-IT'), W / 2, 67, { align: 'center' });

      // KPI sintesi
      Y = 82;
      const kpiSintesi = [
        ['Ricavi Totali', fmtN(TOT.ric)], ['MOL Industriale', fmtN(TOT.molI) + ' (' + fmtP(TOT.molIPct) + ')'],
        ['Costi Sede', fmtN(TOT.sede)], ['MOL Gestionale', fmtN(TOT.molG) + ' (' + fmtP(TOT.molGPct) + ')'],
        ['EBIT', fmtN(TOT.ebit)], ['Personale %', fmtP(TOT.persPct)],
      ];
      pdf.setFontSize(10); pdf.setTextColor(30);
      pdf.setFont(undefined, 'bold'); pdf.text('Indicatori Chiave', M, Y); Y += 6;
      kpiSintesi.forEach(([l, v]) => {
        pdf.setFont(undefined, 'normal'); pdf.setTextColor(80); pdf.text(l + ':', M + 2, Y);
        pdf.setFont(undefined, 'bold'); pdf.setTextColor(30); pdf.text(v, M + 70, Y);
        Y += 6;
      });

      // Tabella riepilogo UO
      Y += 6;
      pdf.setFont(undefined, 'bold'); pdf.setTextColor(30); pdf.setFontSize(10);
      pdf.text('Riepilogo per Unità Operativa', M, Y); Y += 6;
      const rH = ['UO', 'Ricavi', 'Costi Dir.', 'MOL-I', 'MOL-I %', 'Sede', 'MOL-G', 'Pers %'];
      const rW = [32, 22, 22, 22, 16, 20, 22, 16];
      const rRows = UO.map(u => ({
        cells: [u.cod, fmtN(u.ricavi), fmtN(u.costiDir), fmtN(u.molI), fmtP(u.molIPct), fmtN(u.sede), fmtN(u.molG), fmtP(u.persPct)],
        _colors: { 3: u.molI >= 0 ? [5,150,105] : [220,38,38], 6: u.molG >= 0 ? [5,150,105] : [220,38,38] },
      }));
      rRows.push({ cells: ['TOTALE', fmtN(TOT.ric), fmtN(TOT.cDir), fmtN(TOT.molI), fmtP(TOT.molIPct), fmtN(TOT.sede), fmtN(TOT.molG), fmtP(TOT.persPct)], _bold: true, _bg: [240,244,248] });
      drawTable(rH, rRows, rW);
      addFooter();

      // === PAGINA 2: CE CONSOLIDATO ===
      pdf.addPage(); Y = M; addFooter();
      pdf.setFontSize(14); pdf.setTextColor(30); pdf.setFont(undefined, 'bold');
      pdf.text('Conto Economico Consolidato', M, Y + 5); Y += 12;

      const budCosti = { pers: UO.reduce((s,u) => s + u.budget_costi.personale, 0), mat: UO.reduce((s,u) => s + u.budget_costi.materiali, 0), serv: UO.reduce((s,u) => s + u.budget_costi.servizi, 0), ut: UO.reduce((s,u) => s + u.budget_costi.utenze, 0), man: UO.reduce((s,u) => s + u.budget_costi.manutenzione, 0), altri: UO.reduce((s,u) => s + u.budget_costi.altri, 0) };
      const budCDir = Object.values(budCosti).reduce((s,v) => s + v, 0);
      const ceH = ['Voce', 'Consuntivo', 'Budget', 'Delta', '% Ricavi'];
      const ceW = [46, 30, 30, 30, 26];
      const mRic = (v, base) => base !== 0 ? fmtP(Math.abs(v) / Math.abs(base)) : '-';
      const ceRows2 = [
        { cells: ['Ricavi', fmtN(TOT.ric), fmtN(TOT.budget_ric), fmtN(TOT.ric - TOT.budget_ric), '100,0%'], _bold: true },
        { cells: ['  Personale', fmtN(-TOT.pers), fmtN(-budCosti.pers), fmtN(budCosti.pers - TOT.pers), mRic(TOT.pers, TOT.ric)] },
        { cells: ['  Materiali', fmtN(-UO.reduce((s,u) => s + u.costi.materiali, 0)), fmtN(-budCosti.mat), '', mRic(UO.reduce((s,u) => s + u.costi.materiali, 0), TOT.ric)] },
        { cells: ['  Servizi', fmtN(-UO.reduce((s,u) => s + u.costi.servizi, 0)), fmtN(-budCosti.serv), '', ''] },
        { cells: ['  Utenze', fmtN(-UO.reduce((s,u) => s + u.costi.utenze, 0)), fmtN(-budCosti.ut), '', ''] },
        { cells: ['  Manutenzione', fmtN(-UO.reduce((s,u) => s + u.costi.manutenzione, 0)), fmtN(-budCosti.man), '', ''] },
        { cells: ['MOL Industriale', fmtN(TOT.molI), fmtN(TOT.budget_ric - budCDir), fmtN(TOT.molI - (TOT.budget_ric - budCDir)), fmtP(TOT.molIPct)], _bold: true, _bg: [240,244,248] },
        { cells: ['  Costi Sede', fmtN(-TOT.sede), fmtN(-1550000), fmtN(1550000 - TOT.sede), mRic(TOT.sede, TOT.ric)] },
        { cells: ['MOL Gestionale', fmtN(TOT.molG), '', '', fmtP(TOT.molGPct)], _bold: true, _bg: [240,244,248] },
        { cells: ['  Ammortamenti', fmtN(-TOT.ammort), fmtN(-350000), '', ''] },
        { cells: ['  Oneri Finanziari', fmtN(-TOT.oneri_fin), fmtN(-125000), '', ''] },
        { cells: ['Risultato Operativo', fmtN(TOT.ebit), '', '', fmtP(TOT.ebit / TOT.ric)], _bold: true, _bg: [230,240,255],
          _colors: { 1: TOT.ebit >= 0 ? [5,150,105] : [220,38,38] } },
      ];
      drawTable(ceH, ceRows2, ceW, { fontSize: 9 });

      // === PAGINA 3: CASH FLOW ===
      pdf.addPage(); Y = M; addFooter();
      pdf.setFontSize(14); pdf.setTextColor(30); pdf.setFont(undefined, 'bold');
      pdf.text('Cash Flow', M, Y + 5); Y += 12;

      const cfH = ['Voce', 'Importo', 'Tipo'];
      const cfW = [60, 50, 50];
      const cfRows2 = waterfallRaw.map(w => ({
        cells: [w.voce, fmtN(w.valore), w.tipo],
        _bold: w.tipo === 'subtotale' || w.tipo === 'finale',
        _bg: (w.tipo === 'subtotale' || w.tipo === 'finale') ? [240,244,248] : null,
        _colors: { 1: w.valore >= 0 ? [5,150,105] : [220,38,38] },
      }));
      drawTable(cfH, cfRows2, cfW, { fontSize: 9 });

      // KPI Cash Flow
      Y += 4;
      pdf.setFontSize(10); pdf.setFont(undefined, 'bold'); pdf.setTextColor(30);
      pdf.text('KPI Cash Flow', M, Y); Y += 7;
      const kpCF = D.cashflow.kpi;
      const ccc = kpCF.dso + 15 - kpCF.dpo;
      [['DSO ASP', kpCF.dso + ' gg', '< ' + BENCH.dso + ' gg'], ['DPO Fornitori', kpCF.dpo + ' gg', '< ' + BENCH.dpo + ' gg'],
       ['DSCR', kpCF.dscr + 'x', '> 1.2x'], ['Autonomia Cassa', copCassa.giorni + ' gg (' + copCassa.mesi + ' mesi)', '> 2.0 mesi'],
       ['CCC', ccc + ' gg', '< ' + (BENCH.dso + 15 - BENCH.dpo) + ' gg']].forEach(([l, v, t]) => {
        pdf.setFont(undefined, 'normal'); pdf.setTextColor(80); pdf.text(l + ':', M + 2, Y);
        pdf.setFont(undefined, 'bold'); pdf.setTextColor(30); pdf.text(v, M + 55, Y);
        pdf.setFont(undefined, 'normal'); pdf.setTextColor(140); pdf.text('(target: ' + t + ')', M + 85, Y);
        Y += 6;
      });

      // Scadenziario
      Y += 6;
      pdf.setFontSize(10); pdf.setFont(undefined, 'bold'); pdf.setTextColor(30);
      pdf.text('Scadenziario Crediti / Debiti', M, Y); Y += 7;
      const scH = ['Fascia', 'Crediti', '%', 'Debiti', '%', 'Saldo'];
      const scW = [28, 28, 18, 28, 18, 28];
      const sc = D.cashflow.scadenziario;
      const scRows = sc.crediti.map((cr, i) => {
        const db = sc.debiti[i]; const saldo = cr.importo - db.importo;
        return { cells: [cr.fascia, fmtN(cr.importo), fmtP(cr.pct), fmtN(db.importo), fmtP(db.pct), fmtN(saldo)],
          _colors: { 1: [5,150,105], 3: [220,38,38], 5: saldo >= 0 ? [5,150,105] : [220,38,38] } };
      });
      scRows.push({ cells: ['Totale', fmtN(sc.totCrediti), '100%', fmtN(sc.totDebiti), '100%', fmtN(sc.totCrediti - sc.totDebiti)], _bold: true, _bg: [240,244,248] });
      drawTable(scH, scRows, scW);

      // === PAGINA 4: NARRATIVE ===
      pdf.addPage(); Y = M; addFooter();
      pdf.setFontSize(14); pdf.setTextColor(30); pdf.setFont(undefined, 'bold');
      pdf.text('Variance Analysis — Narrative', M, Y + 5); Y += 14;

      D.narrative.forEach(n => {
        checkPage(30);
        const alertBg = n.alert === 'VERDE' ? [220,252,231] : n.alert === 'GIALLO' ? [254,249,195] : [254,226,226];
        const alertTx = n.alert === 'VERDE' ? [5,150,105] : n.alert === 'GIALLO' ? [146,64,14] : [220,38,38];
        pdf.setFillColor(...alertBg);
        pdf.roundedRect(M, Y, CW, 22, 2, 2, 'F');
        pdf.setFontSize(10); pdf.setFont(undefined, 'bold'); pdf.setTextColor(30);
        const u = UO.find(x => x.cod === n.uo);
        pdf.text(n.uo === 'GRUPPO' ? 'GRUPPO KAROL' : n.uo + ' — ' + (u ? u.nome : ''), M + 4, Y + 6);
        pdf.setFontSize(8); pdf.setTextColor(...alertTx);
        pdf.text('[' + n.alert + ']', M + 80, Y + 6);
        pdf.setFont(undefined, 'normal'); pdf.setTextColor(60); pdf.setFontSize(8);
        const lines = pdf.splitTextToSize(n.testo, CW - 8);
        pdf.text(lines, M + 4, Y + 12);
        pdf.setFontSize(7); pdf.setTextColor(120); pdf.setFont(undefined, 'italic');
        pdf.text('Outlook: ' + n.outlook, M + 4, Y + 19);
        Y += 26;
      });

      pdf.save('Karol_CdG_Report_' + new Date().toISOString().slice(0,10) + '.pdf');
    } catch(e) { console.error(e); alert('Errore export PDF: ' + e.message); }
    setExporting(false);
  };

  // ---- Export Excel ----
  const exportExcel = () => {
    setExporting(true);
    try {
      const wb = XLSX.utils.book_new();

      // Foglio Riepilogo
      const riepilogo = [
        ['KAROL S.p.A. — Controllo di Gestione Sicilia'],
        ['Anno ' + D.meta.anno + ' — ' + D.meta.mesi_chiusi + ' mesi'],
        [],
        ['UO', 'Ricavi', 'Costi Dir.', 'MOL-I', 'MOL-I %', 'Sede', 'MOL-G', 'MOL-G %', 'Pers %', 'Occ %'],
        ...UO.map(u => [u.cod + ' — ' + u.nome, u.ricavi, u.costiDir, u.molI, u.molIPct, u.sede, u.molG, u.molGPct, u.persPct, u.occ]),
        [],
        ['TOTALE', TOT.ric, TOT.cDir, TOT.molI, TOT.molIPct, TOT.sede, TOT.molG, TOT.molGPct, TOT.persPct, ''],
      ];
      const ws1 = XLSX.utils.aoa_to_sheet(riepilogo);
      ws1['!cols'] = [{ wch: 28 }, ...Array(9).fill({ wch: 16 })];
      XLSX.utils.book_append_sheet(wb, ws1, 'Riepilogo');

      // Foglio CE Consolidato
      const ceRows = [
        ['Voce', 'Consuntivo', 'Budget', 'Delta', '% Ricavi'],
        ['Ricavi', TOT.ric, TOT.budget_ric, TOT.ric - TOT.budget_ric, 1],
        ['Personale', -TOT.pers, -UO.reduce((s,u) => s + u.budget_costi.personale, 0), '', ''],
        ['Materiali', -UO.reduce((s,u) => s + u.costi.materiali, 0), -UO.reduce((s,u) => s + u.budget_costi.materiali, 0), '', ''],
        ['Servizi', -UO.reduce((s,u) => s + u.costi.servizi, 0), -UO.reduce((s,u) => s + u.budget_costi.servizi, 0), '', ''],
        ['Utenze', -UO.reduce((s,u) => s + u.costi.utenze, 0), -UO.reduce((s,u) => s + u.budget_costi.utenze, 0), '', ''],
        ['Manutenzione', -UO.reduce((s,u) => s + u.costi.manutenzione, 0), -UO.reduce((s,u) => s + u.budget_costi.manutenzione, 0), '', ''],
        ['MOL Industriale', TOT.molI, TOT.budget_ric - TOT.budget_cDir, '', TOT.molIPct],
        ['Costi Sede', -TOT.sede, -1550000, '', ''],
        ['MOL Gestionale', TOT.molG, '', '', TOT.molGPct],
        ['Ammortamenti', -TOT.ammort, -350000, '', ''],
        ['Oneri Finanziari', -TOT.oneri_fin, -125000, '', ''],
        ['Risultato Operativo', TOT.ebit, '', '', ''],
      ];
      const ws2 = XLSX.utils.aoa_to_sheet(ceRows);
      ws2['!cols'] = [{ wch: 22 }, ...Array(4).fill({ wch: 18 })];
      XLSX.utils.book_append_sheet(wb, ws2, 'CE Consolidato');

      // Foglio Trend Mensile
      const trendRows = [
        ['Mese', ...UO.map(u => u.cod + ' Ricavi'), ...UO.map(u => u.cod + ' Costi')],
        ...mesiDisp.map((m, i) => [m, ...UO.map(u => u.rM[i]), ...UO.map(u => u.cM[i])]),
      ];
      const ws3 = XLSX.utils.aoa_to_sheet(trendRows);
      XLSX.utils.book_append_sheet(wb, ws3, 'Trend Mensile');

      // Foglio KPI
      const kpiRows = [
        ['UO', 'KPI', 'Valore', 'Target', 'Semaforo'],
        ...KPI.map(k => [k.uo, k.kpi, k.v, k.tgt, k.a]),
      ];
      const ws4 = XLSX.utils.aoa_to_sheet(kpiRows);
      XLSX.utils.book_append_sheet(wb, ws4, 'KPI');

      // Foglio Cash Flow
      const cfRows = [
        ['Voce', 'Importo', 'Tipo'],
        ...waterfallRaw.map(w => [w.voce, w.valore, w.tipo]),
        [],
        ['KPI Cash Flow'],
        ['DSO ASP', D.cashflow.kpi.dso],
        ['DPO Fornitori', D.cashflow.kpi.dpo],
        ['DSCR', D.cashflow.kpi.dscr],
        ['Autonomia Cassa (giorni)', copCassa.giorni],
      ];
      const ws5 = XLSX.utils.aoa_to_sheet(cfRows);
      XLSX.utils.book_append_sheet(wb, ws5, 'Cash Flow');

      XLSX.writeFile(wb, 'Karol_CdG_Report_' + new Date().toISOString().slice(0,10) + '.xlsx');
    } catch(e) { alert('Errore export Excel: ' + e.message); }
    setExporting(false);
    setShowExport(false);
  };

  const nR = KPI.filter(k => k.a === 'ROSSO').length;
  const nG = KPI.filter(k => k.a === 'GIALLO').length;
  const nV = KPI.filter(k => k.a === 'VERDE').length;
  const uoReali = D.meta.dati_reali ? UO.length : 0;

  // Scostamento MOL-G
  const scost = [...UO].map(u => ({ nome: u.cod, nomeC: u.nome, scost: u.molG, fill: u.molG >= 0 ? C.verde : C.rosso })).sort((a,b) => a.scost - b.scost);

  // Trend multi-UO
  const trendUO = mesiDisp.map((m, i) => { const d = { mese: m }; UO.forEach(u => { d[u.cod] = u.rM[i]; }); return d; });

  const tabs = [
    { id: 'overview', label: 'Overview', icon: '📊' },
    { id: 'ce', label: 'Conto Economico', icon: '📋' },
    { id: 'strutture', label: 'Strutture', icon: '🏥' },
    { id: 'trend', label: 'Trend', icon: '📈' },
    { id: 'cashflow', label: 'Cash Flow', icon: '💰' },
    { id: 'debiti', label: 'Mappa Debiti', icon: '⚠️' },
    { id: 'piano', label: 'Piano Finanziario', icon: '🏗️' },
    { id: 'analisi', label: 'Analisi', icon: '🔍' },
    { id: 'simulazioni', label: 'Simulazioni', icon: '🎛️' },
  ];

  const cardS = { background: C.card, borderRadius: 10, padding: 20, boxShadow: '0 1px 4px rgba(0,0,0,0.05)', border: '1px solid ' + C.bordo };

  return (
    <div id="dashboard-content" style={{ background: C.sfondo, minHeight: '100vh', fontFamily: "'DM Sans', 'Segoe UI', sans-serif" }}>
      {/* HEADER */}
      <div style={{ background: 'linear-gradient(135deg, ' + C.primario + ' 0%, ' + C.primarioChiaro + ' 100%)', padding: '20px 32px', color: 'white' }}>
        <div style={{ maxWidth: 1280, margin: '0 auto', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <div>
            <div style={{ fontSize: 24, fontWeight: 800, letterSpacing: 2 }}>KAROL</div>
            <div style={{ fontSize: 12, opacity: 0.7, letterSpacing: 3, marginTop: 2 }}>CONTROLLO DI GESTIONE</div>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
            <button onClick={() => setShowExport(true)}
              style={{ padding: '8px 18px', background: 'rgba(255,255,255,0.15)', border: '1px solid rgba(255,255,255,0.3)', borderRadius: 8, color: 'white', cursor: 'pointer', fontSize: 13, fontWeight: 600, fontFamily: 'inherit', backdropFilter: 'blur(4px)' }}>
              📥 Export
            </button>
          </div>
          <div style={{ textAlign: 'right' }}>
            <div style={{ fontSize: 15, fontWeight: 600 }}>Sicilia — Anno {D.meta.anno} ({D.meta.mesi_chiusi} Mesi)</div>
            <div style={{ fontSize: 11, opacity: 0.7, marginTop: 4 }}>
              Completezza dati: {uoReali}/{UO.length} UO reali
              <span style={{ display: 'inline-block', width: 60, height: 5, borderRadius: 3, background: 'rgba(255,255,255,.2)', marginLeft: 8, verticalAlign: 'middle', overflow: 'hidden' }}>
                <span style={{ display: 'block', width: (uoReali/UO.length*100) + '%', height: '100%', borderRadius: 3, background: '#fca5a5' }}></span>
              </span>
            </div>
          </div>
        </div>
      </div>

      {/* EXPORT MODAL */}
      {showExport && (
        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', zIndex: 1000, display: 'flex', alignItems: 'center', justifyContent: 'center' }}
          onClick={() => setShowExport(false)}>
          <div style={{ background: C.card, borderRadius: 16, padding: '28px 32px', width: 420, boxShadow: '0 20px 60px rgba(0,0,0,0.2)' }}
            onClick={e => e.stopPropagation()}>
            <h3 style={{ fontSize: 18, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Export Report</h3>
            <p style={{ fontSize: 12, color: C.t3, marginBottom: 20 }}>Karol CdG — Anno {D.meta.anno}</p>
            <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
              <button onClick={exportPDF} disabled={exporting}
                style={{ padding: '14px 20px', background: C.rosso + '10', border: '2px solid ' + C.rosso + '30', borderRadius: 10, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 12, fontFamily: 'inherit' }}>
                <span style={{ fontSize: 24 }}>📄</span>
                <div style={{ textAlign: 'left' }}>
                  <div style={{ fontSize: 14, fontWeight: 700, color: C.t1 }}>Export PDF</div>
                  <div style={{ fontSize: 11, color: C.t3 }}>Report strutturato 4 pagine (Riepilogo, CE, Cash Flow, Narrative)</div>
                </div>
              </button>
              <button onClick={exportExcel} disabled={exporting}
                style={{ padding: '14px 20px', background: C.verde + '10', border: '2px solid ' + C.verde + '30', borderRadius: 10, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 12, fontFamily: 'inherit' }}>
                <span style={{ fontSize: 24 }}>📊</span>
                <div style={{ textAlign: 'left' }}>
                  <div style={{ fontSize: 14, fontWeight: 700, color: C.t1 }}>Export Excel</div>
                  <div style={{ fontSize: 11, color: C.t3 }}>Report completo: Riepilogo, CE, Trend, KPI, Cash Flow</div>
                </div>
              </button>
            </div>
            {exporting && <div style={{ textAlign: 'center', marginTop: 16, fontSize: 13, color: C.primario, fontWeight: 600 }}>Generazione in corso...</div>}
            <button onClick={() => setShowExport(false)}
              style={{ marginTop: 16, width: '100%', padding: '10px', background: 'transparent', border: '1px solid ' + C.bordo, borderRadius: 8, cursor: 'pointer', fontSize: 13, color: C.t2, fontFamily: 'inherit' }}>
              Chiudi
            </button>
          </div>
        </div>
      )}

      {/* KPI CARDS */}
      <div style={{ maxWidth: 1280, margin: '-20px auto 0', padding: '0 24px', position: 'relative', zIndex: 1 }}>
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(155px, 1fr))', gap: 12 }}>
          {[
            { label: 'Ricavi Totali', valore: fmt(TOT.ric), colore: C.CTA },
            { label: 'MOL Industriale', valore: fmt(TOT.molI), sub: fmtPct(TOT.molIPct), colore: C.verde },
            { label: 'Costi Sede', valore: fmt(TOT.sede), sub: fmtPct(TOT.sede / TOT.ric) + ' ricavi', colore: C.viola },
            { label: 'MOL Gestionale', valore: fmt(TOT.molG), sub: fmtPct(TOT.molGPct), colore: TOT.molG >= 0 ? C.verde : C.rosso },
            { label: 'EBITDA Reale', valore: fmt(D.ce_8m ? (D.ce_8m.ebitda.contabile - D.ce_8m.ebitda.cta_extra_non_cash) * 1.5 : TOT.molI), sub: D.ce_8m ? 'Escl. CTA extra-tariff' : '', colore: (D.ce_8m && (D.ce_8m.ebitda.contabile - D.ce_8m.ebitda.cta_extra_non_cash) < 0) ? C.rosso : C.verde },
            { label: 'Autonomia Cassa', valore: copCassa.giorni + ' gg', sub: copCassa.mesi + ' mesi (target >' + BENCH.cop_cassa_mesi + ')', colore: copCassa.mesi < 1 ? C.rosso : copCassa.mesi < BENCH.cop_cassa_mesi ? C.giallo : C.verde },
            { label: 'Alert', valore: (nR+nG) + ' attivi', sub: nR + ' rossi / ' + nG + ' gialli / ' + nV + ' verdi', colore: nR > 0 ? C.rosso : C.giallo },
          ].map((kpi, i) => (
            <div key={i} style={{ background: C.card, borderRadius: 10, padding: '14px 16px', boxShadow: '0 1px 4px rgba(0,0,0,0.06)', borderLeft: '3px solid ' + kpi.colore, borderTop: '1px solid #f1f5f9' }}>
              <div style={{ fontSize: 11, color: C.t3, fontWeight: 500, marginBottom: 6 }}>{kpi.label}</div>
              <div style={{ fontSize: 18, fontWeight: 700, color: kpi.colore }}>{kpi.valore}</div>
              {kpi.sub && <div style={{ fontSize: 11, color: C.t3, marginTop: 2 }}>{kpi.sub}</div>}
            </div>
          ))}
        </div>
      </div>

      {/* TAB NAVIGATION */}
      <div style={{ maxWidth: 1280, margin: '20px auto 0', padding: '0 24px' }}>
        <div style={{ display: 'flex', gap: 4, borderBottom: '2px solid ' + C.bordo }}>
          {tabs.map(t => (
            <button key={t.id} onClick={() => setTab(t.id)}
              style={{ padding: '10px 20px', border: 'none', cursor: 'pointer', background: tab === t.id ? C.card : 'transparent', color: tab === t.id ? C.primario : C.t2, fontWeight: tab === t.id ? 700 : 500, fontSize: 14, borderBottom: tab === t.id ? '3px solid ' + C.primario : '3px solid transparent', borderRadius: '8px 8px 0 0', transition: 'all 0.2s', fontFamily: 'inherit' }}>
              {t.icon} {t.label}
            </button>
          ))}
        </div>
      </div>

      {/* CONTENT */}
      <div style={{ maxWidth: 1280, margin: '0 auto', padding: '20px 24px 40px' }}>

        {/* ======================== OVERVIEW ======================== */}
        {tab === 'overview' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>

            {/* 6 Card Costi Gestionali */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: 12 }}>
              {[
                { label: 'Personale', valore: TOT.pers, pct: TOT.persPct, bench: BENCH.pers_pct, icon: '👥', inv: true },
                { label: 'Materiali/Farmaci', valore: UO.reduce((s,u) => s + u.costi.materiali, 0), pct: UO.reduce((s,u) => s + u.costi.materiali, 0) / TOT.ric, bench: 0.12, icon: '💊', inv: true },
                { label: 'Servizi', valore: UO.reduce((s,u) => s + u.costi.servizi, 0), pct: UO.reduce((s,u) => s + u.costi.servizi, 0) / TOT.ric, bench: 0.12, icon: '🔧', inv: true },
                { label: 'Utenze', valore: UO.reduce((s,u) => s + u.costi.utenze, 0), pct: UO.reduce((s,u) => s + u.costi.utenze, 0) / TOT.ric, bench: 0.05, icon: '⚡', inv: true },
                { label: 'Locazioni', valore: UO.reduce((s,u) => s + (u.immobile ? u.immobile.affitto_reale : 0), 0) + D.SEDE.affitti, pct: (UO.reduce((s,u) => s + (u.immobile ? u.immobile.affitto_reale : 0), 0) + D.SEDE.affitti) / TOT.ric, bench: 0.04, icon: '🏪', inv: true },
                { label: 'Costi Sede/HQ', valore: TOT.sede, pct: TOT.sede / TOT.ric, bench: 0.12, icon: '🏢', inv: true },
              ].map((c, i) => {
                const ok = c.inv ? c.pct <= c.bench : c.pct >= c.bench;
                const warn = c.inv ? c.pct <= c.bench * 1.15 : c.pct >= c.bench * 0.85;
                const col = ok ? C.verde : warn ? C.giallo : C.rosso;
                const bg = ok ? C.verdeBg : warn ? C.gialloBg : C.rossoBg;
                return (
                  <div key={i} style={{ ...cardS, padding: '14px 16px', borderLeft: '3px solid ' + col }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 }}>
                      <span style={{ fontSize: 11, color: C.t3, fontWeight: 500 }}>{c.icon} {c.label}</span>
                      <span style={{ fontSize: 10, padding: '2px 6px', borderRadius: 8, background: bg, color: col, fontWeight: 600 }}>{fmtPct(c.pct)}</span>
                    </div>
                    <div style={{ fontSize: 17, fontWeight: 700, color: C.t1 }}>{fmt(c.valore)}</div>
                    <div style={{ fontSize: 10, color: C.t3, marginTop: 2 }}>Bench: {fmtPct(c.bench)}</div>
                  </div>
                );
              })}
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
              {/* B1: Cash Autonomy Gauge */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Autonomia di Cassa</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Saldo attuale vs burn rate — stress test senza eventi straordinari</p>

                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 10, marginBottom: 14 }}>
                  <div style={{ padding: 12, background: C.rossoBg, borderRadius: 8 }}>
                    <div style={{ fontSize: 10, color: C.t3, marginBottom: 4 }}>Saldo Cassa</div>
                    <div style={{ fontSize: 18, fontWeight: 700, color: C.rosso }}>{fmt(copCassa.saldo)}</div>
                    <div style={{ fontSize: 9, color: C.t2, marginTop: 2 }}>Bilancio 31/08</div>
                  </div>
                  <div style={{ padding: 12, background: C.gialloBg, borderRadius: 8 }}>
                    <div style={{ fontSize: 10, color: C.t3, marginBottom: 4 }}>Deficit/mese</div>
                    <div style={{ fontSize: 18, fontWeight: 700, color: C.giallo }}>{fmt(copCassa.deficit)}</div>
                    <div style={{ fontSize: 9, color: C.t2, marginTop: 2 }}>Uscite - Incassi</div>
                  </div>
                  <div style={{ padding: 12, background: copCassa.giorni < 30 ? C.rossoBg : C.gialloBg, borderRadius: 8 }}>
                    <div style={{ fontSize: 10, color: C.t3, marginBottom: 4 }}>Autonomia</div>
                    <div style={{ fontSize: 18, fontWeight: 700, color: copCassa.giorni < 30 ? C.rosso : C.giallo }}>{copCassa.giorni} gg</div>
                    <div style={{ fontSize: 9, color: C.t2, marginTop: 2 }}>{copCassa.mesi} mesi</div>
                  </div>
                </div>

                <div style={{ padding: 10, background: C.rossoBg, borderRadius: 8, borderLeft: '4px solid ' + C.rosso, marginBottom: 10 }}>
                  <div style={{ fontSize: 11, fontWeight: 600, color: C.rosso, marginBottom: 4 }}>SCENARIO STRESS</div>
                  <div style={{ fontSize: 11, color: C.t1, lineHeight: 1.5 }}>
                    Senza mutuo MCC (€5M) e incasso Regione CTA (€3M), la cassa va in negativo entro <strong>2 settimane</strong>.
                    Dipendenza critica da factoring pro-soluto 90%.
                  </div>
                </div>

                <div style={{ padding: 10, background: '#f0fdf4', borderRadius: 8, borderLeft: '4px solid ' + C.verde }}>
                  <div style={{ fontSize: 11, fontWeight: 600, color: C.verde, marginBottom: 4 }}>PIANO</div>
                  <div style={{ fontSize: 11, color: C.t1, lineHeight: 1.5 }}>
                    Mutuo MCC €5M (erogazione apr 2026) + Rottamazione 5 (risparmio €833k) + chiusura KCP (€300k/anno).
                  </div>
                </div>

                <div style={{ textAlign: 'center', marginTop: 10, fontSize: 10, color: C.t3, cursor: 'pointer' }} onClick={() => setTab('cashflow')}>
                  Vedi tab Cash Flow per dettaglio settimana per settimana →
                </div>
              </div>

              {/* B2: Tabella semaforo aggiornata con Costo PL/gg */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Matrice KPI per UO</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Semaforo performance operativa</p>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
                  <thead>
                    <tr style={{ borderBottom: '2px solid ' + C.bordo }}>
                      {['UO', 'MOL-I %', 'MOL-G %', 'Pers. %', 'Occ. %', 'Costo PL/gg'].map(h => (
                        <th key={h} style={{ padding: '8px 4px', textAlign: h === 'UO' ? 'left' : 'center', color: C.t2, fontWeight: 600, fontSize: 10 }}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {UO.map((u, i) => {
                      const kpis = KPI.filter(k => k.uo === u.cod);
                      const cell = (name) => {
                        const k = kpis.find(x => x.kpi.startsWith(name));
                        if (!k) return <td style={{ textAlign: 'center', color: C.t3, fontSize: 11 }}>n/d</td>;
                        const ac = alertCol(k.a);
                        const display = name === 'Costo PL' ? fmt(k.v) : fmtPct(k.v);
                        return <td style={{ textAlign: 'center' }}><span style={{ background: ac.bg, color: ac.color, padding: '2px 6px', borderRadius: 10, fontSize: 10, fontWeight: 600, fontFamily: 'monospace' }}>{display}</span></td>;
                      };
                      return (
                        <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, cursor: 'pointer' }} onClick={() => { setSelUO(u); setTab('strutture'); }}>
                          <td style={{ padding: '10px 4px', fontWeight: 600, color: C.t1, fontSize: 12 }}>
                            <span style={{ display: 'inline-block', width: 10, height: 10, borderRadius: 3, background: u.colore, marginRight: 6 }}></span>
                            {u.cod}
                          </td>
                          {cell('MOL-I')}{cell('MOL-G')}{cell('Pers')}{cell('Occ')}{cell('Costo PL')}
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
                <div style={{ marginTop: 12, display: 'flex', gap: 16, justifyContent: 'center' }}>
                  {[{ c: C.verdeBg, t: C.verde, l: 'In target' }, { c: C.gialloBg, t: C.giallo, l: 'Attenzione' }, { c: C.rossoBg, t: C.rosso, l: 'Critico' }]
                    .map(leg => <span key={leg.l} style={{ fontSize: 10, display: 'flex', alignItems: 'center', gap: 4 }}>
                      <span style={{ width: 10, height: 10, borderRadius: 3, background: leg.c, border: '1px solid ' + leg.t }}></span>{leg.l}
                    </span>)}
                </div>
              </div>
            </div>

            {/* Sintesi direzionale */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Sintesi Direzionale</h3>
              {narrative.filter(n => n.uo === 'GRUPPO').map((n, i) => {
                const ac = alertCol(n.alert);
                return (
                  <div key={i} style={{ padding: '12px 16px', background: ac.bg, borderRadius: 8, borderLeft: '4px solid ' + ac.color, marginBottom: 8 }}>
                    <p style={{ fontSize: 12, color: C.t1, lineHeight: 1.6, marginBottom: 4 }}>{n.testo}</p>
                    <p style={{ fontSize: 11, color: C.t2, fontStyle: 'italic' }}>Outlook: {n.outlook}</p>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* ======================== CONTO ECONOMICO ======================== */}
        {tab === 'ce' && (() => {
          // CE Consolidato righe
          const ceRighe = [
            { voce: 'Ricavi', val: TOT.ric, bud: TOT.budget_ric, cls: 'header' },
            { voce: '  Personale', val: -TOT.pers, bud: -UO.reduce((s,u) => s + u.budget_costi.personale, 0), cls: 'costo' },
            { voce: '  Materiali/Farmaci', val: -UO.reduce((s,u) => s + u.costi.materiali, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.materiali, 0), cls: 'costo' },
            { voce: '  Servizi', val: -UO.reduce((s,u) => s + u.costi.servizi, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.servizi, 0), cls: 'costo' },
            { voce: '  Utenze', val: -UO.reduce((s,u) => s + u.costi.utenze, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.utenze, 0), cls: 'costo' },
            { voce: '  Manutenzione', val: -UO.reduce((s,u) => s + u.costi.manutenzione, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.manutenzione, 0), cls: 'costo' },
            { voce: '  Altri costi diretti', val: -UO.reduce((s,u) => s + u.costi.altri, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.altri, 0), cls: 'costo' },
            { voce: 'MOL Industriale', val: TOT.molI, bud: TOT.budget_ric - TOT.budget_cDir, cls: 'subtotale' },
            { voce: '  Costi Sede/HQ', val: -TOT.sede, bud: -1550000, cls: 'costo' },
            { voce: 'MOL Gestionale', val: TOT.molG, bud: (TOT.budget_ric - TOT.budget_cDir) - 1550000, cls: 'subtotale' },
            { voce: '  Ammortamenti', val: -TOT.ammort, bud: -350000, cls: 'costo' },
            { voce: '  Oneri finanziari', val: -TOT.oneri_fin, bud: -125000, cls: 'costo' },
            { voce: 'Risultato Operativo', val: TOT.ebit, bud: (TOT.budget_ric - TOT.budget_cDir) - 1550000 - 350000 - 125000, cls: 'totale' },
          ];

          // CE per singola BU
          const ceBU = (u) => [
            { voce: 'Ricavi', val: u.ricavi, bud: u.budget_ricavi, cls: 'header' },
            { voce: '  Personale', val: -u.costi.personale, bud: -u.budget_costi.personale, cls: 'costo' },
            { voce: '  Materiali', val: -u.costi.materiali, bud: -u.budget_costi.materiali, cls: 'costo' },
            { voce: '  Servizi', val: -u.costi.servizi, bud: -u.budget_costi.servizi, cls: 'costo' },
            { voce: '  Utenze', val: -u.costi.utenze, bud: -u.budget_costi.utenze, cls: 'costo' },
            { voce: '  Manutenzione', val: -u.costi.manutenzione, bud: -u.budget_costi.manutenzione, cls: 'costo' },
            { voce: '  Altri', val: -u.costi.altri, bud: -u.budget_costi.altri, cls: 'costo' },
            { voce: 'MOL Industriale', val: u.molI, bud: u.budget_ricavi - budgetCostiTot(u), cls: 'subtotale' },
            { voce: '  Quota Sede', val: -u.sede, bud: -u.sede * 0.95, cls: 'costo' },
            { voce: 'MOL Gestionale', val: u.molG, bud: (u.budget_ricavi - budgetCostiTot(u)) - u.sede * 0.95, cls: 'subtotale' },
            { voce: '  Ammortamenti', val: -u.ammortamenti, bud: -u.ammortamenti * 0.95, cls: 'costo' },
            { voce: '  Oneri finanziari', val: -u.oneri_fin, bud: -u.oneri_fin * 0.95, cls: 'costo' },
            { voce: 'Risultato Operativo', val: u.ebit, bud: (u.budget_ricavi - budgetCostiTot(u)) - u.sede * 0.95 - u.ammortamenti * 0.95 - u.oneri_fin * 0.95, cls: 'totale' },
          ];

          // Forecast — 3 metodi
          const mC = D.meta.mesi_chiusi;
          const mR = 12 - mC; // mesi residui
          const forecastCalc = UO.map(u => {
            const ricMese = u.ricavi / mC;
            const costMese = u.costiDir / mC;
            // Linearizzazione: media mensile × 12
            const lin_ric = ricMese * 12;
            const lin_cost = costMese * 12;
            // Budget residuo: consuntivo YTD + budget residuo proporzionale
            const budRicMese = u.budget_ricavi / 12;
            const budCostMese = budgetCostiTot(u) / 12;
            const bud_ric = u.ricavi + budRicMese * mR;
            const bud_cost = u.costiDir + budCostMese * mR;
            // Trend ponderato: media mobile ponderata ultimi 3 mesi × residui + YTD
            const rM = u.rM || [];
            const cM = u.cM || [];
            const w3ric = rM.length >= 3 ? (rM[rM.length-1]*3 + rM[rM.length-2]*2 + rM[rM.length-3]*1) / 6 : ricMese;
            const w3cost = cM.length >= 3 ? (cM[cM.length-1]*3 + cM[cM.length-2]*2 + cM[cM.length-3]*1) / 6 : costMese;
            const trnd_ric = u.ricavi + w3ric * mR;
            const trnd_cost = u.costiDir + w3cost * mR;
            return {
              cod: u.cod, nome: u.nome, colore: u.colore,
              lin: { ric: lin_ric, cost: lin_cost, molI: lin_ric - lin_cost },
              bud: { ric: bud_ric, cost: bud_cost, molI: bud_ric - bud_cost },
              trnd: { ric: trnd_ric, cost: trnd_cost, molI: trnd_ric - trnd_cost },
            };
          });
          const fcData = forecastCalc.map(f => ({ ...f, fc: f[fcMethod] }));

          const CETable = ({ righe }) => (
            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
              <thead>
                <tr style={{ borderBottom: '2px solid ' + C.bordo, background: '#f8fafc' }}>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: C.t2, fontWeight: 600, width: '35%' }}>Voce</th>
                  <th style={{ padding: '10px 8px', textAlign: 'right', color: C.t2, fontWeight: 600 }}>Consuntivo</th>
                  <th style={{ padding: '10px 8px', textAlign: 'right', color: C.t2, fontWeight: 600 }}>Budget</th>
                  <th style={{ padding: '10px 8px', textAlign: 'right', color: C.t2, fontWeight: 600 }}>Delta</th>
                  <th style={{ padding: '10px 8px', textAlign: 'right', color: C.t2, fontWeight: 600 }}>% Ricavi</th>
                </tr>
              </thead>
              <tbody>
                {righe.map((r, i) => {
                  const delta = r.val - r.bud;
                  const isH = r.cls === 'header' || r.cls === 'subtotale' || r.cls === 'totale';
                  const bg = r.cls === 'totale' ? '#f0f4f8' : r.cls === 'subtotale' ? '#f8fafc' : 'transparent';
                  const fw = isH ? 700 : 400;
                  const ricRef = righe[0].val;
                  return (
                    <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, background: bg }}>
                      <td style={{ padding: '8px', fontWeight: fw, color: C.t1, fontSize: isH ? 13 : 12 }}>{r.voce}</td>
                      <td style={{ padding: '8px', textAlign: 'right', fontWeight: fw, color: C.t1, fontFamily: 'monospace' }}>{fmt(r.val)}</td>
                      <td style={{ padding: '8px', textAlign: 'right', color: C.t2, fontFamily: 'monospace' }}>{fmt(r.bud)}</td>
                      <td style={{ padding: '8px', textAlign: 'right' }}>
                        <span style={{ color: delta >= 0 ? C.verde : C.rosso, fontWeight: 600, fontFamily: 'monospace', fontSize: 11 }}>
                          {delta >= 0 ? '+' : ''}{fmt(delta)}
                        </span>
                      </td>
                      <td style={{ padding: '8px', textAlign: 'right', color: C.t3, fontSize: 11, fontFamily: 'monospace' }}>
                        {ricRef !== 0 ? fmtPct(Math.abs(r.val) / Math.abs(ricRef)) : '-'}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          );

          return (
            <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
              {/* Sub-tab navigation */}
              <div style={{ display: 'flex', gap: 8 }}>
                {[{ id: 'consolidato', l: 'CE Consolidato' }, { id: 'perbu', l: 'CE per BU' }, { id: 'forecast', l: 'Forecast' }].map(st => (
                  <button key={st.id} onClick={() => setCeView(st.id)}
                    style={{ padding: '8px 18px', border: '2px solid ' + (ceView === st.id ? C.primario : C.bordo), background: ceView === st.id ? C.primario + '10' : C.card, borderRadius: 8, cursor: 'pointer', fontSize: 13, fontWeight: ceView === st.id ? 700 : 500, color: ceView === st.id ? C.primario : C.t2, fontFamily: 'inherit' }}>
                    {st.l}
                  </button>
                ))}
              </div>

              {/* CE Consolidato */}
              {ceView === 'consolidato' && (
                <div style={cardS}>
                  <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Conto Economico Consolidato — Gruppo Karol Sicilia</h3>
                  <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Anno {D.meta.anno} — {D.meta.mesi_chiusi} mesi | Consuntivo vs Budget</p>
                  <CETable righe={ceRighe} />
                  <div style={{ marginTop: 16, padding: '10px 14px', background: TOT.ebit >= 0 ? C.verdeBg : C.rossoBg, borderRadius: 8, borderLeft: '4px solid ' + (TOT.ebit >= 0 ? C.verde : C.rosso) }}>
                    <p style={{ fontSize: 12, color: C.t1 }}>
                      Risultato operativo: <strong>{fmt(TOT.ebit)}</strong> — MOL-G {fmtPct(TOT.molGPct)} (target {fmtPct(BENCH.mol_g_pct)})
                    </p>
                  </div>
                </div>
              )}

              {/* CE per BU */}
              {ceView === 'perbu' && (
                <div>
                  <div style={{ display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' }}>
                    {UO.map(u => (
                      <button key={u.cod} onClick={() => setSelUO(u)}
                        style={{ padding: '8px 16px', border: '2px solid ' + (selUO && selUO.cod === u.cod ? u.colore : C.bordo), background: selUO && selUO.cod === u.cod ? u.colore + '15' : C.card, borderRadius: 8, cursor: 'pointer', fontSize: 13, fontWeight: 600, color: selUO && selUO.cod === u.cod ? u.colore : C.t2, fontFamily: 'inherit' }}>
                        {u.cod} — {u.nome}
                      </button>
                    ))}
                  </div>
                  {(() => {
                    const u = selUO || UO[0];
                    return (
                      <div style={cardS}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                          <div>
                            <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1 }}>CE — {u.nome}</h3>
                            <p style={{ fontSize: 11, color: C.t2 }}>{u.tipo}{u.pl > 0 ? ' — ' + u.pl + ' PL' : ''}</p>
                          </div>
                          <div style={{ textAlign: 'right' }}>
                            <span style={{ fontSize: 18, fontWeight: 700, color: u.molG >= 0 ? C.verde : C.rosso }}>{fmt(u.molG)}</span>
                            <div style={{ fontSize: 10, color: C.t3 }}>MOL-G ({fmtPct(u.molGPct)})</div>
                          </div>
                        </div>
                        <CETable righe={ceBU(u)} />
                        {/* Riconciliazione */}
                        <div style={{ marginTop: 12, padding: '8px 12px', background: '#f8fafc', borderRadius: 6, fontSize: 11, color: C.t2 }}>
                          Riconciliazione: Ricavi {fmt(u.ricavi)} − Costi Diretti {fmt(u.costiDir)} = MOL-I {fmt(u.molI)} − Sede {fmt(u.sede)} = MOL-G {fmt(u.molG)} ✓
                        </div>
                      </div>
                    );
                  })()}
                </div>
              )}

              {/* Forecast */}
              {ceView === 'forecast' && (() => {
                const methods = [
                  { id: 'lin', l: 'Linearizzazione', desc: 'Media mensile × 12' },
                  { id: 'bud', l: 'Budget Residuo', desc: 'YTD + budget pro-rata residuo' },
                  { id: 'trnd', l: 'Trend Ponderato', desc: 'YTD + media mobile 3M ponderata × residuo' },
                ];
                const totFcRic = fcData.reduce((s,f) => s + f.fc.ric, 0);
                const totFcMolI = fcData.reduce((s,f) => s + f.fc.molI, 0);
                const totFcVsBud = totFcRic - TOT.budget_ric;
                // Barchart confronto metodi
                const barFcData = UO.map((u, i) => ({
                  cod: u.cod,
                  Budget: u.budget_ricavi,
                  Linearizzazione: forecastCalc[i].lin.ric,
                  'Budget Residuo': forecastCalc[i].bud.ric,
                  'Trend Ponderato': forecastCalc[i].trnd.ric,
                }));
                return (
                <div style={cardS}>
                  <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Forecast Anno — Confronto Metodi</h3>
                  <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>Proiezione basata su {mC} mesi consuntivati, {mR} mesi residui</p>
                  {/* Selettore metodo */}
                  <div style={{ display: 'flex', gap: 8, marginBottom: 16 }}>
                    {methods.map(m => (
                      <button key={m.id} onClick={() => setFcMethod(m.id)}
                        style={{ padding: '6px 14px', border: '2px solid ' + (fcMethod === m.id ? C.primario : C.bordo), background: fcMethod === m.id ? C.primario + '10' : 'white', borderRadius: 6, cursor: 'pointer', fontSize: 11, fontWeight: fcMethod === m.id ? 700 : 500, color: fcMethod === m.id ? C.primario : C.t2, fontFamily: 'inherit' }}>
                        {m.l}
                        <div style={{ fontSize: 9, color: C.t3, fontWeight: 400 }}>{m.desc}</div>
                      </button>
                    ))}
                  </div>
                  {/* Tabella forecast */}
                  <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
                    <thead>
                      <tr style={{ borderBottom: '2px solid ' + C.bordo, background: '#f8fafc' }}>
                        <th style={{ padding: '8px', textAlign: 'left', color: C.t2 }}>UO</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>Consuntivo YTD</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>Forecast 12M</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>Budget Anno</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>Fc vs Budget</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>MOL-I Fc</th>
                      </tr>
                    </thead>
                    <tbody>
                      {fcData.map((f, i) => {
                        const u = UO[i];
                        const fcVsBud = f.fc.ric - u.budget_ricavi;
                        return (
                          <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo }}>
                            <td style={{ padding: '8px', fontWeight: 600, color: C.t1 }}>
                              <span style={{ display: 'inline-block', width: 10, height: 10, borderRadius: 3, background: f.colore, marginRight: 6 }}></span>
                              {f.cod}
                            </td>
                            <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'monospace' }}>{fmt(u.ricavi)}</td>
                            <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 600 }}>{fmt(f.fc.ric)}</td>
                            <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'monospace', color: C.t2 }}>{fmt(u.budget_ricavi)}</td>
                            <td style={{ padding: '8px', textAlign: 'right' }}>
                              <span style={{ color: fcVsBud >= 0 ? C.verde : C.rosso, fontWeight: 600, fontFamily: 'monospace', fontSize: 11 }}>
                                {fcVsBud >= 0 ? '+' : ''}{fmt(fcVsBud)}
                              </span>
                            </td>
                            <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'monospace', color: f.fc.molI >= 0 ? C.verde : C.rosso, fontWeight: 600 }}>{fmt(f.fc.molI)}</td>
                          </tr>
                        );
                      })}
                      <tr style={{ borderTop: '2px solid ' + C.primario, background: '#f0f4f8' }}>
                        <td style={{ padding: '8px', fontWeight: 700 }}>TOTALE</td>
                        <td style={{ padding: '8px', textAlign: 'right', fontWeight: 700, fontFamily: 'monospace' }}>{fmt(TOT.ric)}</td>
                        <td style={{ padding: '8px', textAlign: 'right', fontWeight: 700, fontFamily: 'monospace' }}>{fmt(totFcRic)}</td>
                        <td style={{ padding: '8px', textAlign: 'right', fontWeight: 700, fontFamily: 'monospace', color: C.t2 }}>{fmt(TOT.budget_ric)}</td>
                        <td style={{ padding: '8px', textAlign: 'right' }}>
                          <span style={{ color: totFcVsBud >= 0 ? C.verde : C.rosso, fontWeight: 700, fontFamily: 'monospace' }}>{totFcVsBud >= 0 ? '+' : ''}{fmt(totFcVsBud)}</span>
                        </td>
                        <td style={{ padding: '8px', textAlign: 'right', fontWeight: 700, fontFamily: 'monospace', color: totFcMolI >= 0 ? C.verde : C.rosso }}>{fmt(totFcMolI)}</td>
                      </tr>
                    </tbody>
                  </table>
                  {/* Grafico confronto metodi */}
                  <div style={{ marginTop: 16 }}>
                    <h4 style={{ fontSize: 13, fontWeight: 600, color: C.t1, marginBottom: 8 }}>Confronto Metodi — Ricavi Forecast per UO</h4>
                    <ResponsiveContainer width="100%" height={260}>
                      <BarChart data={barFcData} margin={{ top: 10, right: 20, left: 20, bottom: 5 }}>
                        <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                        <XAxis dataKey="cod" fontSize={12} stroke={C.t2} />
                        <YAxis tickFormatter={v => fmt(v)} fontSize={9} stroke={C.t3} />
                        <Tooltip formatter={v => [fmt(v)]} />
                        <Legend />
                        <Bar dataKey="Budget" fill="#94a3b8" barSize={16} />
                        <Bar dataKey="Linearizzazione" fill="#3b82f6" barSize={16} />
                        <Bar dataKey="Budget Residuo" fill="#8b5cf6" barSize={16} />
                        <Bar dataKey="Trend Ponderato" fill="#06b6d4" barSize={16} />
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                  {/* Note metodo */}
                  <div style={{ marginTop: 12, padding: '10px 14px', background: '#f0f4f8', borderRadius: 8, fontSize: 11, color: C.t2 }}>
                    <strong>Metodo attivo: {methods.find(m => m.id === fcMethod)?.l}</strong> — {methods.find(m => m.id === fcMethod)?.desc}.
                    {fcMethod === 'lin' && ' Ipotesi: ritmo costante nei mesi residui uguale alla media YTD.'}
                    {fcMethod === 'bud' && ' Ipotesi: mesi residui seguono il budget originale, consuntivo acquisito.'}
                    {fcMethod === 'trnd' && ' Ipotesi: trend recente (pesi 3-2-1 su ultimi 3 mesi) proiettato sui mesi residui.'}
                  </div>
                </div>
                );
              })()}
            </div>
          );
        })()}

        {/* ======================== STRUTTURE ======================== */}
        {tab === 'strutture' && (
          <div>
            <div style={{ display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' }}>
              {UO.map(u => (
                <button key={u.cod} onClick={() => setSelUO(u)}
                  style={{ padding: '8px 16px', border: '2px solid ' + (selUO && selUO.cod === u.cod ? u.colore : C.bordo), background: selUO && selUO.cod === u.cod ? u.colore + '15' : C.card, borderRadius: 8, cursor: 'pointer', fontSize: 13, fontWeight: 600, color: selUO && selUO.cod === u.cod ? u.colore : C.t2, fontFamily: 'inherit' }}>
                  {u.cod} — {u.nome}
                </button>
              ))}
            </div>
            {(() => {
              const u = selUO || UO[0];
              const data = mesiDisp.map((m, i) => ({ mese: m, Ricavi: u.rM[i], Costi: u.cM[i], MOL: u.rM[i] - u.cM[i] }));
              const uKpi = KPI.filter(k => k.uo === u.cod);
              const uNarr = narrative.find(n => n.uo === u.cod);
              return (
                <div style={cardS}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                    <div>
                      <h3 style={{ fontSize: 17, fontWeight: 700, color: C.t1 }}>{u.nome} <Badge reale={u.datiReali} /></h3>
                      <p style={{ fontSize: 12, color: C.t2 }}>{u.tipo}{u.pl > 0 ? ' — ' + u.pl + ' PL' : ''} | Ricavo/gg: {u.ricGg ? fmt(Math.round(u.ricGg)) : 'n/a'}{u.costo_pl_gg ? ' | Costo PL/gg: ' + fmt(Math.round(u.costo_pl_gg)) : ''}</p>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontSize: 22, fontWeight: 700, color: u.molG >= 0 ? C.verde : C.rosso }}>{fmt(u.molG)}</div>
                      <div style={{ fontSize: 11, color: C.t3 }}>MOL Gestionale ({fmtPct(u.molGPct)})</div>
                    </div>
                  </div>
                  {/* KPI */}
                  <div style={{ display: 'flex', gap: 10, marginBottom: 16, flexWrap: 'wrap' }}>
                    {uKpi.map((k, i) => {
                      const ac = alertCol(k.a);
                      return (
                        <div key={i} style={{ padding: '8px 12px', borderRadius: 8, background: ac.bg, borderLeft: '3px solid ' + ac.color, flex: '1 1 120px' }}>
                          <div style={{ fontSize: 10, color: C.t2 }}>{k.kpi}</div>
                          <div style={{ fontSize: 18, fontWeight: 700, color: ac.color }}>{fmtPct(k.v)}</div>
                          <div style={{ fontSize: 9, color: C.t3 }}>vs {fmtPct(k.tgt)}</div>
                        </div>
                      );
                    })}
                  </div>
                  {/* Narrative */}
                  {uNarr && (
                    <div style={{ padding: '10px 14px', background: alertCol(uNarr.alert).bg, borderRadius: 8, borderLeft: '4px solid ' + alertCol(uNarr.alert).color, marginBottom: 16 }}>
                      <p style={{ fontSize: 12, color: C.t1, lineHeight: 1.5 }}>{uNarr.testo}</p>
                    </div>
                  )}
                  {/* Donut composizione costi + Chart trend */}
                  <div style={{ display: 'grid', gridTemplateColumns: '280px 1fr', gap: 16 }}>
                    <div>
                      <h4 style={{ fontSize: 12, fontWeight: 600, color: C.t2, marginBottom: 8 }}>Composizione Costi</h4>
                      <ResponsiveContainer width="100%" height={200}>
                        <PieChart>
                          <Pie data={[
                            { name: 'Personale', value: u.costi.personale, fill: '#3b82f6' },
                            { name: 'Materiali', value: u.costi.materiali, fill: '#8b5cf6' },
                            { name: 'Servizi', value: u.costi.servizi, fill: '#06b6d4' },
                            { name: 'Utenze', value: u.costi.utenze, fill: '#f59e0b' },
                            { name: 'Manut.', value: u.costi.manutenzione, fill: '#ef4444' },
                            { name: 'Altri', value: u.costi.altri, fill: '#94a3b8' },
                          ].filter(d => d.value > 0)} dataKey="value" innerRadius={50} outerRadius={80} paddingAngle={2}>
                          </Pie>
                          <Tooltip formatter={v => [fmt(v)]} />
                        </PieChart>
                      </ResponsiveContainer>
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: 6, justifyContent: 'center' }}>
                        {[
                          { c: '#3b82f6', l: 'Pers.' }, { c: '#8b5cf6', l: 'Mat.' }, { c: '#06b6d4', l: 'Serv.' },
                          { c: '#f59e0b', l: 'Uten.' }, { c: '#ef4444', l: 'Man.' }, { c: '#94a3b8', l: 'Altri' },
                        ].map(leg => <span key={leg.l} style={{ fontSize: 9, display: 'flex', alignItems: 'center', gap: 3 }}>
                          <span style={{ width: 8, height: 8, borderRadius: 2, background: leg.c }}></span>{leg.l}
                        </span>)}
                      </div>
                    </div>
                    <div>
                      <h4 style={{ fontSize: 12, fontWeight: 600, color: C.t2, marginBottom: 8 }}>Trend Mensile Ricavi vs Costi</h4>
                      <ResponsiveContainer width="100%" height={250}>
                        <ComposedChart data={data} margin={{ top: 10, right: 20, left: 10, bottom: 5 }}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                          <XAxis dataKey="mese" fontSize={12} stroke={C.t3} />
                          <YAxis tickFormatter={v => fmt(v)} fontSize={9} stroke={C.t3} />
                          <Tooltip formatter={v => [fmt(v)]} />
                          <Legend />
                          <Bar dataKey="Ricavi" fill={u.colore} radius={[4,4,0,0]} barSize={18} />
                          <Bar dataKey="Costi" fill={C.budget} radius={[4,4,0,0]} barSize={18} />
                          <Line type="monotone" dataKey="MOL" name="MOL-I" stroke={C.verde} strokeWidth={2} dot={{ r: 3 }} />
                        </ComposedChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </div>
              );
            })()}

            {/* TABELLA CE NORMALIZZATO — Confronto equo con costo di occupazione */}
            <div style={{ ...cardS, marginTop: 16 }}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>CE Industriale Normalizzato — Costo di Occupazione Equo</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>CTA e COS operano in immobili di proprietà (€7M, mutui attivi in Sede). RSA e KCP pagano affitto. Affitto figurativo al 6% costo storico per confronto equo.</p>
              <div style={{ overflowX: 'auto' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 11 }}>
                  <thead><tr style={{ borderBottom: '2px solid ' + C.primario, background: '#f0f4f8' }}>
                    <th style={{ padding: '6px 8px', textAlign: 'left', fontSize: 10, color: C.t2 }}>BU</th>
                    <th style={{ padding: '6px 8px', textAlign: 'right', fontSize: 10, color: C.t2 }}>Ricavi</th>
                    <th style={{ padding: '6px 8px', textAlign: 'right', fontSize: 10, color: C.t2 }}>Costi Dir.</th>
                    <th style={{ padding: '6px 8px', textAlign: 'right', fontSize: 10, color: C.t2 }}>MOL-I</th>
                    <th style={{ padding: '6px 8px', textAlign: 'right', fontSize: 10, color: C.t2 }}>MOL-I %</th>
                    <th style={{ padding: '6px 8px', textAlign: 'center', fontSize: 10, color: '#92400e', background: '#fef9c3' }}>Occupazione</th>
                    <th style={{ padding: '6px 8px', textAlign: 'right', fontSize: 10, color: C.primario, fontWeight: 700 }}>MOL-I Norm.</th>
                    <th style={{ padding: '6px 8px', textAlign: 'right', fontSize: 10, color: C.primario, fontWeight: 700 }}>MOL-I Norm. %</th>
                    <th style={{ padding: '6px 8px', textAlign: 'center', fontSize: 10, color: C.t2 }}>Delta</th>
                  </tr></thead>
                  <tbody>
                    {UO.map((u, i) => {
                      const aff = u.immobile ? u.immobile.affitto_figurativo : 0;
                      const affR = u.immobile ? u.immobile.affitto_reale : 0;
                      const occLabel = u.immobile && u.immobile.tipo === 'proprieta'
                        ? `Fig. ${fmt(aff)}` : affR > 0 ? `Aff. ${fmt(affR)}` : '—';
                      const occBg = u.immobile && u.immobile.tipo === 'proprieta' ? '#fef9c3' : 'transparent';
                      const deltaMol = u.molINorm - u.molI;
                      return (
                        <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo }}>
                          <td style={{ padding: '6px 8px', fontWeight: 600 }}><span style={{ display: 'inline-block', width: 8, height: 8, borderRadius: 2, background: u.colore, marginRight: 6 }}></span>{u.cod}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace' }}>{fmt(u.ricavi)}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace' }}>{fmt(u.costiDir)}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', color: u.molI >= 0 ? C.verde : C.rosso }}>{fmt(u.molI)}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', color: u.molIPct >= 0.15 ? C.verde : u.molIPct >= 0.08 ? C.giallo : C.rosso }}>{fmtPct(u.molIPct)}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'center', fontFamily: 'monospace', fontSize: 10, background: occBg, color: aff > 0 ? '#92400e' : C.t2 }}>{occLabel}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 700, color: u.molINorm >= 0 ? C.verde : C.rosso }}>{fmt(u.molINorm)}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 700, color: u.molINormPct >= 0.15 ? C.verde : u.molINormPct >= 0.08 ? C.giallo : C.rosso }}>{fmtPct(u.molINormPct)}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'center', fontFamily: 'monospace', fontSize: 10, color: deltaMol < 0 ? C.rosso : C.t3 }}>{deltaMol !== 0 ? fmt(deltaMol) : '—'}</td>
                        </tr>
                      );
                    })}
                    <tr style={{ borderTop: '2px solid ' + C.primario, background: '#f0f4f8' }}>
                      <td style={{ padding: '6px 8px', fontWeight: 700 }}>TOTALE BU</td>
                      <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 700 }}>{fmt(TOT.ric)}</td>
                      <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 700 }}>{fmt(TOT.cDir)}</td>
                      <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 700, color: TOT.molI >= 0 ? C.verde : C.rosso }}>{fmt(TOT.molI)}</td>
                      <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 700 }}>{fmtPct(TOT.molIPct)}</td>
                      <td style={{ padding: '6px 8px', textAlign: 'center', fontFamily: 'monospace', fontSize: 10, background: '#fef9c3', fontWeight: 700 }}>{fmt(TOT_AFFITTI_FIG)}</td>
                      <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 700, color: TOT.molINorm >= 0 ? C.verde : C.rosso }}>{fmt(TOT.molINorm)}</td>
                      <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 700 }}>{fmtPct(TOT.molINormPct)}</td>
                      <td style={{ padding: '6px 8px' }}></td>
                    </tr>
                    <tr style={{ background: '#eff6ff', borderTop: '1px solid ' + C.bordo }}>
                      <td colSpan={5} style={{ padding: '6px 8px', fontWeight: 600, fontSize: 10, color: C.primario }}>Sede HQ (normalizzata: -€{Math.round(TOT_AFFITTI_FIG/1000)}k "affitti interni" ricevuti)</td>
                      <td style={{ padding: '6px 8px', textAlign: 'center', fontFamily: 'monospace', fontSize: 10, color: C.verde }}>-{fmt(TOT_AFFITTI_FIG)}</td>
                      <td colSpan={2} style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontSize: 11, fontWeight: 600, color: C.rosso }}>{fmt(TOT.sedeNorm)}</td>
                      <td style={{ padding: '6px 8px', textAlign: 'center', fontFamily: 'monospace', fontSize: 10, color: C.verde }}>vs {fmt(TOT.sede)}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8, marginTop: 12 }}>
                <div style={{ padding: '8px 12px', background: '#fef9c3', borderRadius: 6, fontSize: 11, color: '#92400e' }}>
                  ⚠ CTA: MOL-I da {fmtPct(UO.find(u=>u.cod==='CTA').molIPct)} a <b>{fmtPct(UO.find(u=>u.cod==='CTA').molINormPct)}</b> con affitto figurativo €180k. Efficienza reale inferiore al dato contabile.
                </div>
                <div style={{ padding: '8px 12px', background: '#fef9c3', borderRadius: 6, fontSize: 11, color: '#92400e' }}>
                  ⚠ COS: MOL-I da {fmtPct(UO.find(u=>u.cod==='COS').molIPct)} a <b>{fmtPct(UO.find(u=>u.cod==='COS').molINormPct)}</b> con affitto figurativo €240k. Sede HQ si riduce da {fmt(TOT.sede)} a {fmt(TOT.sedeNorm)}.
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ======================== TREND ======================== */}
        {tab === 'trend' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
            {/* B3: Multi-UO overlay */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Trend Ricavi per UO — Confronto 12 Mesi</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Clicca sulla legenda per nascondere/mostrare le linee</p>
              <ResponsiveContainer width="100%" height={380}>
                <LineChart data={trendUO} margin={{ top: 10, right: 20, left: 10, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                  <XAxis dataKey="mese" fontSize={12} stroke={C.t3} />
                  <YAxis tickFormatter={v => fmt(v)} fontSize={11} stroke={C.t3} />
                  <Tooltip formatter={(v, name) => [fmt(v), name]} />
                  <Legend />
                  {UO.map(u => (
                    <Line key={u.cod} type="monotone" dataKey={u.cod} stroke={u.colore} strokeWidth={u.cod === 'COS' ? 3 : 2} dot={{ r: 3 }} activeDot={{ r: 6 }} />
                  ))}
                </LineChart>
              </ResponsiveContainer>
            </div>
            {/* Mini sparklines per UO */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: 12 }}>
              {UO.map(u => {
                const data = mesiDisp.map((m, i) => ({ m, R: u.rM[i], C: u.cM[i] }));
                return (
                  <div key={u.cod} style={{ ...cardS, padding: 14 }}>
                    <div style={{ display: 'flex', alignItems: 'center', marginBottom: 8 }}>
                      <span style={{ width: 10, height: 10, borderRadius: '50%', background: u.colore, display: 'inline-block', marginRight: 6 }}></span>
                      <span style={{ fontSize: 13, fontWeight: 600, color: C.t1 }}>{u.cod}</span>
                      <span style={{ fontSize: 11, color: C.t3, marginLeft: 6 }}>{u.tipo}</span>
                      <Badge reale={u.datiReali} />
                      <span style={{ marginLeft: 'auto', fontSize: 11, padding: '2px 8px', borderRadius: 12, background: u.molGPct >= .08 ? C.verdeBg : u.molGPct >= 0 ? C.gialloBg : C.rossoBg, color: u.molGPct >= .08 ? C.verde : u.molGPct >= 0 ? C.giallo : C.rosso, fontWeight: 600 }}>
                        MOL-G {fmtPct(u.molGPct)}
                      </span>
                    </div>
                    <ResponsiveContainer width="100%" height={120}>
                      <LineChart data={data} margin={{ top: 5, right: 10, left: 0, bottom: 5 }}>
                        <XAxis dataKey="m" fontSize={9} tick={{ fill: C.t3 }} />
                        <YAxis tickFormatter={v => (v/1000).toFixed(0) + 'k'} fontSize={9} width={38} />
                        <Tooltip formatter={v => [fmt(v)]} />
                        <Line type="monotone" dataKey="R" name="Ricavi" stroke={u.colore} strokeWidth={2} dot={false} />
                        <Line type="monotone" dataKey="C" name="Costi" stroke={C.rossoChiaro} strokeWidth={1.5} dot={false} strokeDasharray="4 3" />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* ======================== CASH FLOW ======================== */}
        {tab === 'cashflow' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
            {/* C1: Waterfall */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Composizione Cash Flow Annuale</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Waterfall da Ricavi a Cash Flow Netto — Gruppo Karol Sicilia</p>
              <ResponsiveContainer width="100%" height={340}>
                <BarChart data={waterfall} margin={{ top: 20, right: 20, left: 20, bottom: 50 }}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                  <XAxis dataKey="voce" fontSize={10} angle={-35} textAnchor="end" height={60} stroke={C.t2} />
                  <YAxis tickFormatter={v => fmt(v)} fontSize={11} stroke={C.t3} />
                  <Tooltip formatter={(v, name) => { if (name === 'base') return ['','']; return [fmt(v), 'Valore']; }} />
                  <Bar dataKey="base" stackId="a" fill="transparent" />
                  <Bar dataKey="barra" stackId="a" radius={[3,3,0,0]} barSize={36}>
                    {waterfall.map((d, i) => <Cell key={i} fill={d.col} />)}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
              <div style={{ display: 'flex', justifyContent: 'center', gap: 20, marginTop: 8 }}>
                {[{ c: C.verde, l: 'Entrate' }, { c: C.rosso, l: 'Uscite' }, { c: '#2563eb', l: 'Subtotali' }, { c: '#b91c1c', l: 'CF Netto (neg.)' }]
                  .map(leg => <span key={leg.l} style={{ fontSize: 11, display: 'flex', alignItems: 'center', gap: 5 }}>
                    <span style={{ width: 12, height: 12, borderRadius: 3, background: leg.c }}></span>{leg.l}
                  </span>)}
              </div>
            </div>

            {/* C2: TESORERIA ROLLING 13 SETTIMANE — Doppio scenario */}
            <div style={cardS}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 4 }}>
                <div>
                  <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1 }}>Tesoreria Rolling 13 Settimane — Saldo Cassa €k</h3>
                  <p style={{ fontSize: 11, color: C.t3 }}>Rosso = stress test (solo operativo) | Blu = piano (mutuo MCC + incasso Regione) | Soglia €200k</p>
                </div>
                <div style={{ background: '#fef3c7', padding: '4px 10px', borderRadius: 6, fontSize: 10, fontWeight: 600, color: '#92400e' }}>
                  Saldo iniziale: €{Math.round(tesoreria.saldo_iniziale/1000)}k
                </div>
              </div>
              <ResponsiveContainer width="100%" height={300}>
                <ComposedChart margin={{ top: 10, right: 20, left: 20, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                  <XAxis dataKey="s" type="category" allowDuplicatedCategory={false} fontSize={11} stroke={C.t3} />
                  <YAxis tickFormatter={v => (v >= 0 ? '' : '-') + '€' + Math.abs(v) + 'k'} fontSize={10} stroke={C.t3} />
                  <Tooltip content={({active, payload, label}) => {
                    if (!active || !payload || !payload.length) return null;
                    const base = cassaSett_base.find(d => d.s === label);
                    const piano = cassaSett_piano.find(d => d.s === label);
                    return <div style={{ background: 'white', border: '1px solid #e2e8f0', borderRadius: 8, padding: '10px 14px', fontSize: 11, maxWidth: 300, boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}>
                      <div style={{ fontWeight: 700, marginBottom: 6, fontSize: 12 }}>{label}</div>
                      {piano && piano.evento && <div style={{ color: '#059669', fontWeight: 600, marginBottom: 6 }}>★ {piano.evento}</div>}
                      <div style={{ color: C.rosso, marginBottom: 2 }}>Stress: €{base ? base.saldo : '?'}k</div>
                      <div style={{ color: C.CTA, marginBottom: 6 }}>Piano: €{piano ? piano.saldo : '?'}k</div>
                      {base && <div style={{ color: C.t3, fontSize: 10 }}>In: {base.inc_det}</div>}
                      {base && <div style={{ color: C.t3, fontSize: 10 }}>Out: {base.usc_det}</div>}
                    </div>;
                  }} />
                  <Legend />
                  <ReferenceLine y={200} stroke={C.rosso} strokeDasharray="6 4" strokeWidth={1.5} label={{ value: '€200k soglia', position: 'insideTopRight', fontSize: 9, fill: C.rosso }} />
                  <ReferenceLine y={0} stroke={C.t2} strokeWidth={1} />
                  <Area data={cassaSett_piano} type="monotone" dataKey="saldo" name="Piano (Mutuo+Regione)" stroke={C.CTA} strokeWidth={2.5} fill={C.CTA} fillOpacity={0.08} dot={(props) => {
                    const { cx, cy, payload } = props;
                    if (payload.evento) return <circle cx={cx} cy={cy} r={7} fill={C.verde} stroke="white" strokeWidth={2} />;
                    return <circle cx={cx} cy={cy} r={3} fill={C.CTA} stroke="white" strokeWidth={1.5} />;
                  }} />
                  <Line data={cassaSett_base} type="monotone" dataKey="saldo" name="Stress Test (no straord.)" stroke={C.rosso} strokeWidth={2} strokeDasharray="6 3" dot={(props) => {
                    const { cx, cy, payload } = props;
                    if (payload.alert) return <circle cx={cx} cy={cy} r={5} fill={C.rosso} stroke="white" strokeWidth={2} />;
                    return <circle cx={cx} cy={cy} r={3} fill={C.rosso} stroke="white" strokeWidth={1.5} />;
                  }} />
                </ComposedChart>
              </ResponsiveContainer>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8, marginTop: 8 }}>
                <div style={{ padding: '8px 12px', background: C.rossoBg, borderRadius: 6, fontSize: 11, color: C.rosso, fontWeight: 500 }}>
                  ⚠️ STRESS TEST: senza mutuo e Regione, la cassa va negativa da S2 e peggiora ogni mese. Dipendenza critica da factoring — zero buffer.
                </div>
                <div style={{ padding: '8px 12px', background: C.verdeBg, borderRadius: 6, fontSize: 11, color: C.verde, fontWeight: 500 }}>
                  ✓ PIANO: con erogazione MCC €5M (S9) e incasso Regione €3M (S10), la cassa si normalizza a ~€5,6M. Prerequisito: chiusura mutuo entro aprile 2026.
                </div>
              </div>
            </div>

            {/* C2b: Meccanica Factoring — ciclo mensile */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 8 }}>Ciclo Mensile Incassi-Pagamenti</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>Meccanica factoring pro-soluto 90% — 2 finestre/mese</p>
                {(() => {
                  const t = tesoreria;
                  // Escludi cta_extra_non_cash dal totale incassi — non è cassa, è credito
                  const totInc = Object.entries(t.incassi_mese).filter(([k]) => k !== 'cta_extra_non_cash').reduce((s,[,v]) => s+v, 0);
                  const totUsc = Object.values(t.uscite_mese).reduce((s,v) => s+v, 0);
                  const delta = totInc - totUsc;
                  const rows = [
                    { fase: '1-15 mese', label: 'Factoring 1° tranche (60% ASP)', incasso: t.incassi_mese.factoring_1_tranche, uscita: t.uscite_mese.stipendi_bu + t.uscite_mese.stipendi_hq + t.uscite_mese.f24_inps + t.uscite_mese.affitti + t.uscite_mese.utenze },
                    { fase: '15-30 mese', label: 'Factoring 2° tranche (40%)', incasso: t.incassi_mese.factoring_2_tranche, uscita: t.uscite_mese.rate_mutui + t.uscite_mese.rate_cartelle + t.uscite_mese.materiali_farmaci + t.uscite_mese.servizi_consulenze },
                    { fase: 'Continuo', label: 'Privato + Holdback + Interco', incasso: t.incassi_mese.holdback_rientro + t.incassi_mese.privato_cash + t.incassi_mese.intercompany_betania, uscita: 0 },
                    { fase: '⚠ Memo', label: 'CTA extra-tariffa: fatturato NON incassato', incasso: 0, uscita: 0, memo: t.incassi_mese.cta_extra_non_cash },
                  ];
                  return <div>
                    <table style={{ width: '100%', borderCollapse: 'collapse', marginBottom: 10 }}>
                      <thead><tr style={{ borderBottom: '2px solid ' + C.bordo }}>
                        <th style={{ padding: '6px 8px', textAlign: 'left', fontSize: 10, color: C.t2 }}>Fase</th>
                        <th style={{ padding: '6px 8px', textAlign: 'right', fontSize: 10, color: C.verde }}>Incassi</th>
                        <th style={{ padding: '6px 8px', textAlign: 'right', fontSize: 10, color: C.rosso }}>Uscite</th>
                        <th style={{ padding: '6px 8px', textAlign: 'right', fontSize: 10, color: C.t2 }}>Saldo</th>
                      </tr></thead>
                      <tbody>
                        {rows.map((r, i) => r.memo ? (
                          <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, background: '#fef9c3' }}>
                            <td colSpan={3} style={{ padding: '6px 8px', fontSize: 10, color: '#92400e', fontStyle: 'italic' }}>{r.fase} {r.label}</td>
                            <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontSize: 11, color: '#92400e' }}>€{fmt(r.memo)}/mese → crediti</td>
                          </tr>
                        ) : (
                          <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo }}>
                            <td style={{ padding: '6px 8px', fontSize: 11 }}><div style={{ fontWeight: 600 }}>{r.fase}</div><div style={{ fontSize: 10, color: C.t3 }}>{r.label}</div></td>
                            <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontSize: 12, color: C.verde }}>{fmt(r.incasso)}</td>
                            <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontSize: 12, color: C.rosso }}>{r.uscita > 0 ? fmt(r.uscita) : '—'}</td>
                            <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontSize: 12, color: r.incasso - r.uscita >= 0 ? C.verde : C.rosso, fontWeight: 600 }}>{fmt(r.incasso - r.uscita)}</td>
                          </tr>
                        ))}
                        <tr style={{ borderTop: '2px solid ' + C.primario, background: '#f0f4f8' }}>
                          <td style={{ padding: '6px 8px', fontWeight: 700, fontSize: 12 }}>Totale Mese</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 700, color: C.verde }}>{fmt(totInc)}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 700, color: C.rosso }}>{fmt(totUsc)}</td>
                          <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 700, color: delta >= 0 ? C.verde : C.rosso }}>{fmt(delta)}</td>
                        </tr>
                      </tbody>
                    </table>
                    <div style={{ padding: '8px 12px', background: delta >= 0 ? C.verdeBg : C.rossoBg, borderRadius: 6, fontSize: 11, color: delta >= 0 ? C.verde : C.rosso }}>
                      {delta >= 0
                        ? `Margine mensile operativo: +${fmt(delta)} — sufficiente per coprire varianze`
                        : `Deficit mensile: ${fmt(delta)} — la cassa erode ogni mese senza risorse straordinarie`}
                    </div>
                  </div>;
                })()}
              </div>

              {/* Scenari pluriennali */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Cassa Finale — Scenari 11 Anni</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Ottimistico / Base (BP) / Pessimistico (€k)</p>
                <ResponsiveContainer width="100%" height={240}>
                  <ComposedChart data={scenari} margin={{ top: 10, right: 10, left: 10, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                    <XAxis dataKey="anno" fontSize={11} stroke={C.t3} />
                    <YAxis tickFormatter={v => '€' + v + 'k'} fontSize={10} stroke={C.t3} />
                    <Tooltip formatter={v => ['€' + v + 'k']} />
                    <Legend />
                    <ReferenceLine y={0} stroke={C.t3} strokeWidth={1} />
                    <Line type="monotone" dataKey="ott" name="Ottimistico" stroke={C.verde} strokeWidth={2} dot={{ r: 3, fill: C.verde }} />
                    <Line type="monotone" dataKey="base" name="Base (BP)" stroke={C.CTA} strokeWidth={3} dot={{ r: 4, fill: C.CTA }} />
                    <Line type="monotone" dataKey="pess" name="Pessimistico" stroke={C.rosso} strokeWidth={2} strokeDasharray="6 3" dot={{ r: 3, fill: C.rosso }} />
                  </ComposedChart>
                </ResponsiveContainer>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 6, marginTop: 8 }}>
                  {D.cashflow.tesoreria.eventi_straord.map((ev, i) => (
                    <div key={i} style={{ padding: '4px 8px', background: ev.importo > 0 ? C.verdeBg : C.rossoBg, borderRadius: 6, fontSize: 10, color: ev.importo > 0 ? C.verde : C.rosso }}>
                      {ev.importo > 0 ? '↗' : '↘'} {ev.desc} ({ev.data_stima})
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* C4: KPI Cash Flow */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12 }}>
              {[
                { label: 'DSO ASP', valore: D.cashflow.kpi.dso + ' gg', target: '< ' + BENCH.dso + ' gg', sem: React.createElement(Semaforo, { valore: D.cashflow.kpi.dso, verdeMin: BENCH.dso, gialloMin: BENCH.dso * 1.5, invertito: true }) },
                { label: 'DPO Fornitori', valore: D.cashflow.kpi.dpo + ' gg', target: '< ' + BENCH.dpo + ' gg', sem: React.createElement(Semaforo, { valore: D.cashflow.kpi.dpo, verdeMin: BENCH.dpo, gialloMin: BENCH.dpo * 1.3, invertito: true }) },
                { label: 'DSCR', valore: '1.15x', target: '> 1.2x', sem: React.createElement(Semaforo, { valore: 1.15, verdeMin: 1.2, gialloMin: 1.0 }) },
                { label: 'Autonomia Cassa', valore: copCassa.giorni + ' gg (' + copCassa.mesi + ' mesi)', target: '> 2.0 mesi', sem: React.createElement(Semaforo, { valore: copCassa.mesi, verdeMin: 2.0, gialloMin: 1.0 }) },
              ].map((kpi, i) => (
                <div key={i} style={{ ...cardS, textAlign: 'center' }}>
                  <div style={{ fontSize: 11, color: C.t3, fontWeight: 500 }}>{kpi.label}</div>
                  <div style={{ fontSize: 20, fontWeight: 700, color: C.t1, margin: '6px 0' }}>{kpi.valore}</div>
                  <div style={{ marginBottom: 6 }}>{kpi.sem}</div>
                  <div style={{ fontSize: 10, color: C.t3 }}>Target: {kpi.target}</div>
                </div>
              ))}
            </div>

            {/* C5: Tabella dettaglio 13 settimane */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Dettaglio 13 Settimane — Scenario Piano</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>Flussi settimanali con incassi, uscite e saldo cumulato (€k). ★ = evento straordinario.</p>
              <div style={{ overflowX: 'auto' }}>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 11 }}>
                  <thead><tr style={{ borderBottom: '2px solid ' + C.primario, background: '#f0f4f8' }}>
                    <th style={{ padding: '5px 6px', textAlign: 'left', fontSize: 10 }}>Sett.</th>
                    <th style={{ padding: '5px 6px', textAlign: 'right', fontSize: 10, color: C.verde }}>Incassi €k</th>
                    <th style={{ padding: '5px 6px', textAlign: 'right', fontSize: 10, color: C.rosso }}>Uscite €k</th>
                    <th style={{ padding: '5px 6px', textAlign: 'right', fontSize: 10 }}>Saldo €k</th>
                    <th style={{ padding: '5px 6px', textAlign: 'left', fontSize: 10 }}>Evento / Note</th>
                  </tr></thead>
                  <tbody>
                    {cassaSett_piano.map((r, i) => (
                      <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, background: r.evento ? '#f0fdf4' : i % 2 === 0 ? 'white' : '#fafbfc' }}>
                        <td style={{ padding: '4px 6px', fontWeight: 600 }}>{r.s}</td>
                        <td style={{ padding: '4px 6px', textAlign: 'right', fontFamily: 'monospace', color: C.verde }}>{r.incassi}</td>
                        <td style={{ padding: '4px 6px', textAlign: 'right', fontFamily: 'monospace', color: C.rosso }}>{r.pag}</td>
                        <td style={{ padding: '4px 6px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 700, color: r.saldo < 0 ? C.rosso : r.saldo < 200 ? C.giallo : C.verde }}>{r.saldo < 0 ? '' : '+'}{r.saldo}</td>
                        <td style={{ padding: '4px 6px', fontSize: 10, color: r.evento ? C.verde : C.t3, fontWeight: r.evento ? 600 : 400 }}>{r.evento ? '★ ' + r.evento : r.inc_det}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* C6: CCC + Scadenziario */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
              {/* Cash Conversion Cycle */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Cash Conversion Cycle</h3>
                {(() => {
                  const kp = D.cashflow.kpi;
                  const dio = 15; // Days Inventory Outstanding (stimato per servizi)
                  const ccc = kp.dso + dio - kp.dpo;
                  const cccBench = BENCH.dso + 15 - BENCH.dpo;
                  const items = [
                    { label: 'DSO (incasso clienti ASP)', val: kp.dso, unit: 'gg', col: '#3b82f6', op: '+' },
                    { label: 'DIO (ciclo scorte/servizi)', val: dio, unit: 'gg', col: '#8b5cf6', op: '+' },
                    { label: 'DPO (pagamento fornitori)', val: kp.dpo, unit: 'gg', col: '#06b6d4', op: '-' },
                    { label: 'CCC', val: ccc, unit: 'gg', col: ccc <= cccBench ? C.verde : ccc <= cccBench * 1.5 ? C.giallo : C.rosso, op: '=' },
                  ];
                  return (
                    <div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                        {items.map((it, i) => (
                          <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '8px 12px', background: i === 3 ? '#f0f4f8' : 'white', borderRadius: 6, border: '1px solid ' + (i === 3 ? it.col : C.bordo) }}>
                            <span style={{ fontSize: 16, fontWeight: 700, color: C.t3, width: 16, textAlign: 'center' }}>{it.op}</span>
                            <span style={{ flex: 1, fontSize: 12, color: C.t1, fontWeight: i === 3 ? 700 : 500 }}>{it.label}</span>
                            <span style={{ fontSize: 18, fontWeight: 700, color: it.col, fontFamily: 'monospace' }}>{it.val} {it.unit}</span>
                          </div>
                        ))}
                      </div>
                      <div style={{ marginTop: 12, padding: '8px 12px', background: ccc <= 0 ? C.verdeBg : '#fffbeb', borderRadius: 6, fontSize: 11, color: ccc <= 0 ? C.verde : '#92400e' }}>
                        {ccc <= 0
                          ? 'CCC negativo: Karol incassa prima di pagare — posizione finanziaria favorevole.'
                          : `CCC ${ccc} gg: ${ccc} giorni di finanziamento del ciclo operativo. Benchmark settore: ${cccBench} gg.`
                        }
                      </div>
                    </div>
                  );
                })()}
              </div>

              {/* Scadenziario crediti/debiti */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Scadenziario Crediti / Debiti</h3>
                {(() => {
                  const sc = D.cashflow.scadenziario;
                  const thS = { padding: '6px 8px', textAlign: 'right', color: C.t2, fontSize: 11 };
                  const tdS = { padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontSize: 12 };
                  return (
                    <div>
                      <table style={{ width: '100%', borderCollapse: 'collapse', marginBottom: 12 }}>
                        <thead>
                          <tr style={{ borderBottom: '2px solid ' + C.bordo }}>
                            <th style={{ ...thS, textAlign: 'left' }}>Fascia</th>
                            <th style={thS}>Crediti</th>
                            <th style={thS}>%</th>
                            <th style={thS}>Debiti</th>
                            <th style={thS}>%</th>
                            <th style={thS}>Saldo</th>
                          </tr>
                        </thead>
                        <tbody>
                          {sc.crediti.map((cr, i) => {
                            const db = sc.debiti[i];
                            const saldo = cr.importo - db.importo;
                            return (
                              <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo }}>
                                <td style={{ padding: '6px 8px', fontSize: 12, fontWeight: 500 }}>{cr.fascia}</td>
                                <td style={{ ...tdS, color: C.verde }}>{fmt(cr.importo)}</td>
                                <td style={{ ...tdS, color: C.t3, fontSize: 10 }}>{fmtPct(cr.pct)}</td>
                                <td style={{ ...tdS, color: C.rosso }}>{fmt(db.importo)}</td>
                                <td style={{ ...tdS, color: C.t3, fontSize: 10 }}>{fmtPct(db.pct)}</td>
                                <td style={{ ...tdS, fontWeight: 600, color: saldo >= 0 ? C.verde : C.rosso }}>{saldo >= 0 ? '+' : ''}{fmt(saldo)}</td>
                              </tr>
                            );
                          })}
                          <tr style={{ borderTop: '2px solid ' + C.primario, background: '#f0f4f8' }}>
                            <td style={{ padding: '6px 8px', fontWeight: 700, fontSize: 12 }}>Totale</td>
                            <td style={{ ...tdS, fontWeight: 700, color: C.verde }}>{fmt(sc.totCrediti)}</td>
                            <td style={{ ...tdS, color: C.t3 }}>100%</td>
                            <td style={{ ...tdS, fontWeight: 700, color: C.rosso }}>{fmt(sc.totDebiti)}</td>
                            <td style={{ ...tdS, color: C.t3 }}>100%</td>
                            <td style={{ ...tdS, fontWeight: 700, color: (sc.totCrediti - sc.totDebiti) >= 0 ? C.verde : C.rosso }}>{fmt(sc.totCrediti - sc.totDebiti)}</td>
                          </tr>
                        </tbody>
                      </table>
                      <div style={{ display: 'flex', gap: 8 }}>
                        <div style={{ flex: 1, padding: '8px 10px', background: C.verdeBg, borderRadius: 6, fontSize: 11, color: C.verde, textAlign: 'center' }}>
                          Crediti entro 60gg: {fmtPct(sc.crediti[0].pct + sc.crediti[1].pct)}
                        </div>
                        <div style={{ flex: 1, padding: '8px 10px', background: C.rossoBg, borderRadius: 6, fontSize: 11, color: C.rosso, textAlign: 'center' }}>
                          Debiti oltre 60gg: {fmtPct(sc.debiti[2].pct + sc.debiti[3].pct)}
                        </div>
                      </div>
                    </div>
                  );
                })()}
              </div>
            </div>
          </div>
        )}

        {/* ======================== MAPPA DEBITI ======================== */}
        {tab === 'debiti' && (() => {
          const DEBT = D.debiti;
          const ST = DEBT.stock;
          const categorie = [
            { key: 'bancari', label: 'Debiti Bancari', color: '#3b82f6', totale: ST.bancari.totale },
            { key: 'erariali', label: 'Debiti Erariali (netto R&S)', color: '#dc2626', totale: ST.erariali.netto_crediti_rs },
            { key: 'previdenziali', label: 'Debiti Previdenziali', color: '#f59e0b', totale: ST.previdenziali.totale },
            { key: 'commerciali', label: 'Debiti Commerciali', color: '#8b5cf6', totale: ST.commerciali.totale },
            { key: 'personale', label: 'Debiti Personale', color: '#06b6d4', totale: ST.personale.totale },
            { key: 'altri', label: 'Altri Debiti', color: '#64748b', totale: ST.altri.totale },
          ];
          return (
            <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>

              {/* CARD 1: Esposizione Totale */}
              <div style={cardS}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 16 }}>
                  <div>
                    <h3 style={{ fontSize: 18, fontWeight: 700, color: C.primario, marginBottom: 4 }}>Mappa Debiti — Karol S.p.A.</h3>
                    <p style={{ fontSize: 12, color: C.t3 }}>Bilancio Verifica {DEBT.data_riferimento} + Piano Rateizzazioni</p>
                  </div>
                  <div style={{ textAlign: 'right' }}>
                    <div style={{ fontSize: 28, fontWeight: 700, color: C.rosso }}>{fmt(DEBT.esposizione.totale)}</div>
                    <div style={{ fontSize: 11, color: C.t3, marginTop: 4 }}>Esposizione totale (escl. infragruppo lordo)</div>
                  </div>
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 12, marginTop: 16 }}>
                  {categorie.map((cat, i) => (
                    <div key={i} style={{ padding: '12px 16px', background: cat.color + '10', borderRadius: 12, borderLeft: '4px solid ' + cat.color }}>
                      <div style={{ fontSize: 11, color: C.t2, marginBottom: 4 }}>{cat.label}</div>
                      <div style={{ fontSize: 16, fontWeight: 700, color: cat.color }}>{fmt(cat.totale)}</div>
                      <div style={{ fontSize: 10, color: C.t3, marginTop: 2 }}>{fmtPct(cat.totale / DEBT.esposizione.totale)}</div>
                    </div>
                  ))}
                </div>

                {/* Alert EBITDA reale negativo */}
                <div style={{ marginTop: 16, padding: '12px 16px', background: '#fee2e2', borderRadius: 10, borderLeft: '4px solid ' + C.rosso }}>
                  <div style={{ fontSize: 12, fontWeight: 700, color: C.rosso }}>⚠ EBITDA REALE 8M = -€76k</div>
                  <div style={{ fontSize: 11, color: C.t1, marginTop: 2 }}>EBITDA contabile €319k - CTA extra-tariff non-cash €395k = <strong>-€76k</strong>. L'azienda brucia cassa operativamente. Personale al 61,9% dei ricavi (soglia: 55%). Il CdA ne ha presa coscienza solo recentemente.</div>
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, marginTop: 16 }}>
                  <div style={{ padding: '12px 16px', background: C.sfondo, borderRadius: 10 }}>
                    <div style={{ fontSize: 11, color: C.t2, marginBottom: 4 }}>Rate Mensili 2025</div>
                    <div style={{ fontSize: 18, fontWeight: 700, color: C.giallo }}>{fmt(DEBT.rate_mensili_2025.totale)}</div>
                  </div>
                  <div style={{ padding: '12px 16px', background: C.sfondo, borderRadius: 10 }}>
                    <div style={{ fontSize: 11, color: C.t2, marginBottom: 4 }}>Cassa al 31/08</div>
                    <div style={{ fontSize: 18, fontWeight: 700, color: C.rosso }}>{fmt(DEBT.esposizione.cassa)}</div>
                  </div>
                  <div style={{ padding: '12px 16px', background: C.sfondo, borderRadius: 10 }}>
                    <div style={{ fontSize: 11, color: C.t2, marginBottom: 4 }}>Sanzioni evitabili/anno</div>
                    <div style={{ fontSize: 18, fontWeight: 700, color: C.giallo }}>{fmt(103000)}</div>
                  </div>
                </div>
              </div>

              {/* CARD 2: Piano Rateizzazioni Grafico */}
              <div style={cardS}>
                <h3 style={{ fontSize: 18, fontWeight: 700, color: C.primario, marginBottom: 4 }}>Piano Rateizzazioni Cartelle — 2025-2030</h3>
                <p style={{ fontSize: 12, color: C.t3, marginBottom: 16 }}>13 cartelle attive + 2 sospese (ripartono 2027). Cartella MH €3.008k pesa €37.697/mese per 8 anni.</p>

                <ResponsiveContainer width="100%" height={260}>
                  <BarChart data={DEBT.rate_annuali} margin={{ top: 10, right: 20, left: 10, bottom: 20 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                    <XAxis dataKey="anno" fontSize={12} stroke={C.t2} />
                    <YAxis tickFormatter={v => (v/1000).toFixed(0) + 'k'} fontSize={9} stroke={C.t3} />
                    <Tooltip formatter={v => [fmt(v)]} />
                    <Legend />
                    <Bar dataKey="capitale" stackId="rate" fill={C.rosso} name="Capitale" radius={[0,0,0,0]} />
                    <Bar dataKey="interessi" stackId="rate" fill={C.giallo} name="Interessi" radius={[4,4,0,0]} />
                  </BarChart>
                </ResponsiveContainer>

                <table style={{ width: '100%', marginTop: 12, borderCollapse: 'collapse', fontSize: 11 }}>
                  <thead>
                    <tr style={{ borderBottom: '2px solid ' + C.primario, background: '#f8fafc' }}>
                      {['Anno','Capitale','Interessi','Totale','€/mese','Note'].map(h => (
                        <th key={h} style={{ padding: '8px 6px', textAlign: h === 'Note' || h === 'Anno' ? 'left' : 'right', color: C.t2, fontWeight: 600 }}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {DEBT.rate_annuali.map((r, i) => (
                      <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, background: i % 2 === 0 ? '#f8fafc' : 'white' }}>
                        <td style={{ padding: '8px 6px', fontWeight: 600 }}>{r.anno}</td>
                        <td style={{ padding: '8px 6px', textAlign: 'right', fontFamily: 'monospace' }}>{fmt(r.capitale)}</td>
                        <td style={{ padding: '8px 6px', textAlign: 'right', fontFamily: 'monospace' }}>{fmt(r.interessi)}</td>
                        <td style={{ padding: '8px 6px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 600, color: C.primario }}>{fmt(r.totale)}</td>
                        <td style={{ padding: '8px 6px', textAlign: 'right', fontFamily: 'monospace' }}>{fmt(r.mese)}</td>
                        <td style={{ padding: '8px 6px', fontSize: 10, color: r.nota ? C.rosso : C.t3 }}>{r.nota || '—'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* CARD 3: Dettaglio Erariali + Previdenziali */}
              <div style={cardS}>
                <h3 style={{ fontSize: 18, fontWeight: 700, color: C.primario, marginBottom: 16 }}>Dettaglio Debiti Erariali e Previdenziali</h3>

                {[{cat: ST.erariali, label: 'Erariali', color: '#dc2626', tot: ST.erariali.totale},
                  {cat: ST.previdenziali, label: 'Previdenziali', color: '#f59e0b', tot: ST.previdenziali.totale}].map((sec, si) => (
                  <div key={si} style={{ marginBottom: 20 }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8, paddingBottom: 6, borderBottom: '2px solid ' + sec.color }}>
                      <h4 style={{ fontSize: 13, fontWeight: 700, color: sec.color }}>{sec.label}</h4>
                      <span style={{ fontSize: 13, fontWeight: 700, color: sec.color }}>{fmt(sec.tot)}</span>
                    </div>
                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 10 }}>
                      <thead>
                        <tr style={{ background: '#f8fafc', borderBottom: '1px solid ' + C.bordo }}>
                          <th style={{ padding: '6px 8px', textAlign: 'left', color: C.t2 }}>Voce</th>
                          <th style={{ padding: '6px 8px', textAlign: 'right', color: C.t2 }}>Importo</th>
                          <th style={{ padding: '6px 8px', textAlign: 'center', color: C.t2 }}>In rate?</th>
                          <th style={{ padding: '6px 8px', textAlign: 'left', color: C.t2 }}>Note</th>
                        </tr>
                      </thead>
                      <tbody>
                        {sec.cat.dettaglio.map((d, di) => (
                          <tr key={di} style={{ borderBottom: '1px solid ' + C.bordo, background: di % 2 === 0 ? '#f8fafc' : 'white' }}>
                            <td style={{ padding: '6px 8px' }}>{d.desc}</td>
                            <td style={{ padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 600, color: d.residuo < 0 ? C.verde : C.t1 }}>{fmt(d.residuo)}</td>
                            <td style={{ padding: '6px 8px', textAlign: 'center', color: d.in_rate ? C.giallo : C.t3, fontWeight: d.in_rate ? 600 : 400 }}>{d.in_rate ? '✓ Sì' : '—'}</td>
                            <td style={{ padding: '6px 8px', fontSize: 9, color: d.nota ? (d.nota.includes('⚠') ? C.rosso : C.t3) : C.t3 }}>{d.nota || '—'}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ))}
              </div>

              {/* CARD 4: Posizioni Intercompany */}
              <div style={cardS}>
                <h3 style={{ fontSize: 18, fontWeight: 700, color: C.primario, marginBottom: 4 }}>Posizioni Intercompany</h3>
                <p style={{ fontSize: 12, color: C.t3, marginBottom: 16 }}>Debiti (rosso) vs Crediti (verde) — Netto evidenziato</p>

                <div style={{ display: 'flex', flexDirection: 'column', gap: 14 }}>
                  {ST.infragruppo.dettaglio.map((rel, i) => {
                    const maxVal = Math.max(rel.debito, rel.credito, 1);
                    return (
                      <div key={i}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 4 }}>
                          <span style={{ fontSize: 12, fontWeight: 600, color: C.t1 }}>{rel.desc}</span>
                          <span style={{ fontSize: 12, fontWeight: 700, color: rel.netto < 0 ? C.rosso : C.verde, fontFamily: 'monospace' }}>{fmt(rel.netto)}</span>
                        </div>
                        <div style={{ display: 'flex', height: 22, borderRadius: 6, overflow: 'hidden', background: '#f1f5f9', gap: 1 }}>
                          {rel.debito > 0 && <div style={{ width: (rel.debito / maxVal * 100) + '%', background: C.rosso, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 8, color: 'white', fontWeight: 600 }}>{fmt(rel.debito)}</div>}
                          {rel.credito > 0 && <div style={{ width: (rel.credito / maxVal * 100) + '%', background: C.verde, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 8, color: 'white', fontWeight: 600 }}>{fmt(rel.credito)}</div>}
                        </div>
                        {rel.nota && <div style={{ fontSize: 9, color: rel.nota.includes('⚠') ? C.rosso : C.t3, marginTop: 2 }}>{rel.nota}</div>}
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* CARD 5: Rottamazione 5 */}
              <div style={cardS}>
                <h3 style={{ fontSize: 18, fontWeight: 700, color: C.primario, marginBottom: 4 }}>Rottamazione 5 — Impatto CE 2026</h3>
                <p style={{ fontSize: 12, color: C.t3, marginBottom: 16 }}>Email Pecchia 23/01/2026 — 10 cartelle Karol Spa + 1 Betania</p>

                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, marginBottom: 16 }}>
                  <div style={{ padding: '14px 16px', background: C.verdeBg, borderRadius: 10, borderLeft: '4px solid ' + C.verde }}>
                    <div style={{ fontSize: 11, color: C.t2, marginBottom: 4 }}>Karol Spa — Sopravvenienza</div>
                    <div style={{ fontSize: 18, fontWeight: 700, color: C.verde }}>{fmt(DEBT.rottamazione5.karol_spa.sopravvenienza)}</div>
                    <div style={{ fontSize: 10, color: C.t3, marginTop: 4 }}>Paga {fmt(DEBT.rottamazione5.karol_spa.definibile)} vs residuo {fmt(DEBT.rottamazione5.karol_spa.residuo)}</div>
                  </div>
                  <div style={{ padding: '14px 16px', background: C.gialloBg, borderRadius: 10, borderLeft: '4px solid ' + C.giallo }}>
                    <div style={{ fontSize: 11, color: C.t2, marginBottom: 4 }}>Betania — Sopravvenienza</div>
                    <div style={{ fontSize: 18, fontWeight: 700, color: C.giallo }}>{fmt(DEBT.rottamazione5.betania.sopravvenienza)}</div>
                    <div style={{ fontSize: 10, color: C.t3, marginTop: 4 }}>Paga {fmt(DEBT.rottamazione5.betania.definibile)} vs residuo {fmt(DEBT.rottamazione5.betania.residuo)}</div>
                  </div>
                  <div style={{ padding: '14px 16px', background: C.violaBg, borderRadius: 10, borderLeft: '4px solid ' + C.viola }}>
                    <div style={{ fontSize: 11, color: C.t2, marginBottom: 4 }}>Risparmio Totale Gruppo</div>
                    <div style={{ fontSize: 18, fontWeight: 700, color: C.viola }}>{fmt(DEBT.rottamazione5.totale_risparmio)}</div>
                    <div style={{ fontSize: 10, color: C.t3, marginTop: 4 }}>Migliora CE 2026 (one-off)</div>
                  </div>
                </div>
                <div style={{ padding: '10px 14px', background: C.sfondo, borderRadius: 8, fontSize: 11, color: C.t2 }}>{DEBT.rottamazione5.nota}</div>
              </div>

              {/* CARD 6: Anomalie CE 8M + Da Verificare */}
              <div style={cardS}>
                <h3 style={{ fontSize: 18, fontWeight: 700, color: C.primario, marginBottom: 4 }}>Anomalie CE 8M 2025 — Rubinetti Aperti</h3>
                <p style={{ fontSize: 12, color: C.t3, marginBottom: 16 }}>Da Bilancio Verifica Provvisorio 31/08/2025 — ordine di impatto</p>

                <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                  {D.ce_8m.anomalie.map((a, i) => (
                    <div key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: 12, padding: '10px 14px', background: a.priorita <= 2 ? '#fee2e2' : a.priorita <= 4 ? '#fef9c3' : '#f8fafc', borderRadius: 8, borderLeft: '3px solid ' + (a.priorita <= 2 ? C.rosso : a.priorita <= 4 ? C.giallo : C.t3) }}>
                      <div style={{ minWidth: 24, height: 24, borderRadius: '50%', background: a.priorita <= 2 ? C.rosso : a.priorita <= 4 ? C.giallo : C.t3, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 10, fontWeight: 700 }}>{a.priorita}</div>
                      <div style={{ flex: 1 }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 2 }}>
                          <span style={{ fontSize: 12, fontWeight: 600, color: C.t1 }}>{a.voce}</span>
                          <span style={{ fontSize: 12, fontWeight: 700, color: a.impatto_ann < 0 ? C.rosso : C.giallo, fontFamily: 'monospace' }}>{fmt(a.impatto_ann)}/anno</span>
                        </div>
                        <div style={{ fontSize: 10, color: C.t2 }}>{a.nota}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* CARD 7: Checklist Da Verificare */}
              <div style={cardS}>
                <h3 style={{ fontSize: 18, fontWeight: 700, color: C.primario, marginBottom: 16 }}>Checklist — Da Verificare</h3>
                <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                  {DEBT.da_verificare.map((item, i) => (
                    <div key={i} style={{ display: 'flex', gap: 10, padding: '8px 12px', background: C.sfondo, borderRadius: 8, borderLeft: '3px solid ' + C.giallo }}>
                      <span style={{ fontSize: 12, color: C.t1, lineHeight: 1.5 }}>{i + 1}. {item}</span>
                    </div>
                  ))}
                </div>
              </div>

            </div>
          );
        })()}

        {/* ======================== PIANO FINANZIARIO ======================== */}
        {tab === 'piano' && (() => {
          const P = D.piano;
          const nuoveBU = P.nuove_bu;
          const fmtK = v => '€ ' + Math.round(v/1000).toLocaleString('it-IT') + 'k';
          const fmtM = v => '€ ' + (v/1000000).toFixed(1).replace('.', ',') + 'M';

          // Costruisci dati per grafici dai dati reali BP
          const pianoData = P.anni.map((a, i) => ({
            anno: String(a), fcf: Math.round(P.fcf.fcf_op[i]/1000),
            debt: Math.round(P.servizio.totale[i]/1000),
            cassa: Math.round(P.cassa[i]/1000),
            ebitda: Math.round(P.fcf.ebitda[i]/1000),
            ricavi: Math.round(P.ricavi[i]/1000),
            pfn_gest: Math.round(P.pfn.gestionale[i]/1000),
            dscr: P.servizio.totale[i] > 0 ? P.fcf.fcf_op[i] / P.servizio.totale[i] : 0,
          }));

          // Debt service breakdown per anno (primi 6 anni)
          const debtBreak = P.anni.slice(0, 8).map((a, i) => ({
            anno: String(a),
            'Mutui esistenti': Math.round((P.servizio.mutui_esistenti_cap[i] + P.servizio.mutui_interessi[i])/1000),
            'Nuovo Mutuo MCC': Math.round(P.servizio.mutui_nuovi_cap[i]/1000),
            'Cartelle/Rottam.': Math.round((P.servizio.cartelle_ratezz[i] + P.servizio.cartelle_rottam[i] + P.servizio.cartelle_inps[i] + P.servizio.cartelle_interessi[i])/1000),
            'Fornitori/Personale': Math.round((P.servizio.fornitori[i] + P.servizio.personale[i])/1000),
          }));

          // Stock debiti nel tempo
          const stockData = P.anni.map((a, i) => ({
            anno: String(a),
            Bancari: Math.round(P.stock.bancari[i]/1000),
            Tributari: Math.round(P.stock.tributari[i]/1000),
            Fornitori: Math.round(P.stock.fornitori[i]/1000),
            Personale: Math.round(P.stock.personale[i]/1000),
          }));

          return (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>

            {/* Header Piano */}
            <div style={{...cardS, background: 'linear-gradient(135deg, #1F4E79 0%, #2E75B6 100%)', color: 'white'}}>
              <h3 style={{ fontSize: 17, fontWeight: 700, marginBottom: 8 }}>Piano Finanziario 2025-2035 — Dati da BP</h3>
              <p style={{ fontSize: 13, opacity: 0.9 }}>Mutuo MCC {fmt(P.mutuo.importo)} (10yr, {(P.mutuo.tasso*100)}%, garanzia {P.mutuo.garanzia}) | Erogazione: {P.mutuo.data_stima_erogazione} | Target: ricavi 2027 {fmt(P.target.ricavi_2027)}</p>
              <div style={{ display: 'flex', gap: 12, marginTop: 12, flexWrap: 'wrap' }}>
                {[
                  { l: 'Rata mutuo/anno', v: fmt(P.mutuo.rata_annua), c: '#10b981' },
                  { l: 'PFN Gest. 2025', v: fmtM(P.pfn.gestionale[0]), c: '#dc2626' },
                  { l: 'Cassa 2026', v: fmtM(P.cassa[1]), c: '#10b981' },
                  { l: 'PFN → 0', v: String(P.target.pfn_zero), c: '#8b5cf6' },
                  { l: 'Crediti Regione', v: fmtM(5500000), c: '#f59e0b' },
                  { l: 'Debt Service 2026', v: fmtM(P.servizio.totale[1]), c: '#ef4444' },
                ].map((k, i) => (
                  <div key={i} style={{ background: 'rgba(255,255,255,0.15)', borderRadius: 8, padding: '6px 12px', minWidth: 120 }}>
                    <div style={{ fontSize: 9, opacity: 0.7 }}>{k.l}</div>
                    <div style={{ fontSize: 15, fontWeight: 700, color: k.c }}>{k.v}</div>
                  </div>
                ))}
              </div>
            </div>

            {/* Utilizzo fondi mutuo */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Utilizzo Fondi Mutuo MCC — {fmt(P.mutuo.importo)}</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>Destinazione deliberata nel memorandum di richiesta</p>
              <div style={{ display: 'flex', gap: 12, flexWrap: 'wrap' }}>
                {[
                  { l: 'CAPEX (BRT + KMC + Roma)', v: P.mutuo.utilizzo.capex.importo, pct: P.mutuo.utilizzo.capex.pct, c: C.primario, icon: '🏗️' },
                  { l: 'Arretrati Personale (accordo sindacale)', v: P.mutuo.utilizzo.arretrati_personale.importo, pct: P.mutuo.utilizzo.arretrati_personale.pct, c: '#d97706', icon: '👥' },
                  { l: 'Buffer Liquidità Operativa', v: P.mutuo.utilizzo.buffer_liquidita.importo, pct: P.mutuo.utilizzo.buffer_liquidita.pct, c: C.verde, icon: '💰' },
                ].map((u, i) => (
                  <div key={i} style={{ flex: '1 1 200px', border: '1px solid ' + C.bordo, borderRadius: 8, padding: 14, borderTop: '3px solid ' + u.c }}>
                    <div style={{ fontSize: 20, marginBottom: 4 }}>{u.icon}</div>
                    <div style={{ fontSize: 12, color: C.t2, marginBottom: 4 }}>{u.l}</div>
                    <div style={{ fontSize: 20, fontWeight: 800, color: u.c }}>{fmt(u.v)}</div>
                    <div style={{ fontSize: 11, color: C.t3 }}>{(u.pct*100).toFixed(1)}% del mutuo</div>
                  </div>
                ))}
              </div>
            </div>

            {/* FCF vs Debt Service + DSCR */}
            <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: 16 }}>
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>FCF Operativo vs Servizio Debito (€k)</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>2026: mutuo €5M copre gap. 2027-28: "passaggio stretto". Dal 2029: FCF {'>'} Debito</p>
                <ResponsiveContainer width="100%" height={260}>
                  <ComposedChart data={pianoData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                    <XAxis dataKey="anno" fontSize={11} />
                    <YAxis fontSize={10} tickFormatter={v => v.toLocaleString('it-IT')} />
                    <Tooltip formatter={(v, n) => ['€ ' + v.toLocaleString('it-IT') + 'k', n]} />
                    <Legend wrapperStyle={{ fontSize: 11 }} />
                    <Bar dataKey="fcf" name="FCF Operativo" fill={C.verde} radius={[4,4,0,0]} barSize={28} />
                    <Bar dataKey="debt" name="Servizio Debito" fill={C.rosso} radius={[4,4,0,0]} barSize={28} />
                    <Line dataKey="cassa" name="Cassa Finale" type="monotone" stroke={C.primario} strokeWidth={2} dot={{ r: 3 }} />
                  </ComposedChart>
                </ResponsiveContainer>
              </div>

              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>DSCR</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>FCF / Debt Service — soglia 1,0x</p>
                <ResponsiveContainer width="100%" height={260}>
                  <ComposedChart data={pianoData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                    <XAxis dataKey="anno" fontSize={10} />
                    <YAxis fontSize={10} domain={[0, 3]} tickFormatter={v => v.toFixed(1) + 'x'} />
                    <Tooltip formatter={(v) => [v.toFixed(2) + 'x', 'DSCR']} />
                    <ReferenceLine y={1.0} stroke={C.rosso} strokeDasharray="5 5" label={{ value: '1,0x', fill: C.rosso, fontSize: 10, position: 'right' }} />
                    <Bar dataKey="dscr" radius={[4,4,0,0]} barSize={30}>
                      {pianoData.map((d, i) => <Cell key={i} fill={d.dscr >= 1.2 ? C.verde : d.dscr >= 1.0 ? C.giallo : C.rosso} />)}
                    </Bar>
                  </ComposedChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* Debt Service Breakdown Stacked */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Composizione Servizio Debito (€k)</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>Dettaglio per categoria: mutui, cartelle, arretrati — 2026 picco €5,1M (include CAPEX + personale)</p>
              <ResponsiveContainer width="100%" height={280}>
                <BarChart data={debtBreak}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                  <XAxis dataKey="anno" fontSize={11} />
                  <YAxis fontSize={10} tickFormatter={v => v.toLocaleString('it-IT')} />
                  <Tooltip formatter={(v, n) => ['€ ' + v.toLocaleString('it-IT') + 'k', n]} />
                  <Legend wrapperStyle={{ fontSize: 11 }} />
                  <Bar dataKey="Mutui esistenti" stackId="a" fill="#64748b" />
                  <Bar dataKey="Nuovo Mutuo MCC" stackId="a" fill={C.primario} />
                  <Bar dataKey="Cartelle/Rottam." stackId="a" fill="#d97706" />
                  <Bar dataKey="Fornitori/Personale" stackId="a" fill="#ef4444" radius={[4,4,0,0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Stock debiti + PFN Gestionale */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Stock Debiti Residui (€k)</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>Da €24,3M (2025) a €4,9M (2035) — rientro progressivo</p>
                <ResponsiveContainer width="100%" height={260}>
                  <AreaChart data={stockData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                    <XAxis dataKey="anno" fontSize={10} />
                    <YAxis fontSize={10} tickFormatter={v => v.toLocaleString('it-IT')} />
                    <Tooltip formatter={(v, n) => ['€ ' + v.toLocaleString('it-IT') + 'k', n]} />
                    <Legend wrapperStyle={{ fontSize: 11 }} />
                    <Area dataKey="Bancari" stackId="1" fill="#64748b" stroke="#475569" fillOpacity={0.7} />
                    <Area dataKey="Tributari" stackId="1" fill="#d97706" stroke="#b45309" fillOpacity={0.7} />
                    <Area dataKey="Fornitori" stackId="1" fill="#ef4444" stroke="#dc2626" fillOpacity={0.7} />
                    <Area dataKey="Personale" stackId="1" fill="#8b5cf6" stroke="#7c3aed" fillOpacity={0.7} />
                  </AreaChart>
                </ResponsiveContainer>
              </div>

              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>PFN Gestionale (€k)</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>Target: PFN → 0 entro {P.target.pfn_zero}. Include debiti tributari e fornitori.</p>
                <ResponsiveContainer width="100%" height={260}>
                  <ComposedChart data={pianoData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                    <XAxis dataKey="anno" fontSize={10} />
                    <YAxis fontSize={10} tickFormatter={v => v.toLocaleString('it-IT')} />
                    <Tooltip formatter={(v, n) => ['€ ' + v.toLocaleString('it-IT') + 'k', 'PFN Gestionale']} />
                    <ReferenceLine y={0} stroke={C.verde} strokeDasharray="5 5" />
                    <Area dataKey="pfn_gest" fill={C.rossoBg} stroke={C.rosso} strokeWidth={2} fillOpacity={0.3} />
                  </ComposedChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* Nuove BU — Card grid */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Nuove Business Unit — Pipeline Aperture</h3>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: 12 }}>
                {nuoveBU.map((bu, i) => (
                  <div key={i} style={{ border: '1px solid ' + C.bordo, borderRadius: 8, padding: 14, borderLeft: '4px solid ' + (bu.cod === 'BRT' ? C.verde : bu.cod === 'KMC' ? C.giallo : '#3b82f6') }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 }}>
                      <span style={{ fontWeight: 700, fontSize: 14 }}>{bu.cod} — {bu.nome}</span>
                      <span style={{ fontSize: 10, padding: '2px 8px', borderRadius: 10, background: bu.cod === 'BRT' ? C.verdeBg : bu.cod === 'KMC' ? C.gialloBg : '#dbeafe', color: bu.cod === 'BRT' ? C.verde : bu.cod === 'KMC' ? C.giallo : '#2563eb', fontWeight: 600 }}>{bu.tipo}</span>
                    </div>
                    <div style={{ fontSize: 12, color: C.t2, marginBottom: 8 }}>{bu.regione} {bu.pl > 0 ? '| ' + bu.pl + ' PL' : ''}</div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 4, fontSize: 12 }}>
                      <div><span style={{ color: C.t3 }}>CAPEX residuo:</span> <strong>{fmt(bu.capex_residuo)}</strong></div>
                      <div><span style={{ color: C.t3 }}>Ricavi a regime:</span> <strong>{fmt(bu.ricavi_regime)}</strong></div>
                      <div><span style={{ color: C.t3 }}>Apertura:</span> <strong>{bu.apertura_stima}</strong></div>
                      <div><span style={{ color: C.t3 }}>Ramp-up:</span> <strong>{bu.ramp_up_mesi} mesi</strong></div>
                      <div><span style={{ color: C.t3 }}>Ricavi 2026:</span> <strong>{fmt(bu.ricavi_bu.r2026)}</strong></div>
                      <div><span style={{ color: C.t3 }}>Ricavi 2027:</span> <strong>{fmt(bu.ricavi_bu.r2027)}</strong></div>
                    </div>
                    <p style={{ fontSize: 11, color: C.t2, marginTop: 8, fontStyle: 'italic' }}>{bu.nota}</p>
                  </div>
                ))}
              </div>
            </div>

            {/* Crediti attesi + Piano ammortamento mutuo */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Crediti Attesi — Risorse Straordinarie</h3>
                {[
                  { titolo: 'Crediti v/Regione (contenzioso CTA)', importo: P.crediti_attesi.cta_contenzioso.importo, stato: P.crediti_attesi.cta_contenzioso.incasso_piano, prob: 'Alta', c: C.verde },
                  { titolo: 'Crediti Fiscali (Innovazione + Patent Box)', importo: P.crediti_attesi.crediti_fiscali.importo, stato: P.crediti_attesi.crediti_fiscali.stato, prob: 'Media-Alta', c: C.giallo },
                  { titolo: 'ZES Unica', importo: P.crediti_attesi.zes_unica.importo, stato: 'Finestra ' + P.crediti_attesi.zes_unica.finestra, prob: 'Media', c: '#7c3aed' },
                ].map((cr, i) => (
                  <div key={i} style={{ border: '1px solid ' + C.bordo, borderRadius: 8, padding: 12, marginBottom: 8, borderLeft: '3px solid ' + cr.c }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <div>
                        <div style={{ fontSize: 13, fontWeight: 700 }}>{cr.titolo}</div>
                        <div style={{ fontSize: 11, color: C.t2, marginTop: 2 }}>{cr.stato}</div>
                      </div>
                      <div style={{ fontSize: 18, fontWeight: 800, color: cr.c }}>{fmt(cr.importo)}</div>
                    </div>
                  </div>
                ))}
                <p style={{ fontSize: 11, color: C.t3, fontStyle: 'italic' }}>Totale potenziale: {fmt(5500000 + 1500000 + 550000)}</p>
              </div>

              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Piano Ammortamento Mutuo MCC</h3>
                <div style={{ fontSize: 11, overflowX: 'auto' }}>
                  <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 11 }}>
                    <thead>
                      <tr style={{ background: C.primario, color: 'white' }}>
                        {['Anno', 'Capitale', 'Interessi', 'Rata', 'Residuo'].map(h => <th key={h} style={{ padding: '6px 8px', textAlign: 'right', fontWeight: 600 }}>{h}</th>)}
                      </tr>
                    </thead>
                    <tbody>
                      {P.mutuo.piano_amm.map((r, i) => (
                        <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, background: i % 2 ? '#f8fafc' : 'white' }}>
                          <td style={{ padding: '5px 8px', fontWeight: 600 }}>{r.anno}</td>
                          <td style={{ padding: '5px 8px', textAlign: 'right' }}>{fmt(r.capitale)}</td>
                          <td style={{ padding: '5px 8px', textAlign: 'right' }}>{fmt(r.interessi)}</td>
                          <td style={{ padding: '5px 8px', textAlign: 'right', fontWeight: 600 }}>{fmt(r.rata)}</td>
                          <td style={{ padding: '5px 8px', textAlign: 'right', color: C.rosso }}>{fmt(r.deb_fin)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
          );
        })()}

        {/* ======================== ANALISI COSTI ======================== */}
        {tab === 'analisi' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>

            {/* Composizione costi per categoria — Stacked Bar */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Composizione Costi per UO</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Stacked bar — Breakdown categorie di costo</p>
              <ResponsiveContainer width="100%" height={320}>
                <BarChart data={UO.map(u => ({
                  nome: u.cod, Personale: u.costi.personale, Materiali: u.costi.materiali,
                  Servizi: u.costi.servizi, Utenze: u.costi.utenze, Manutenzione: u.costi.manutenzione, Altri: u.costi.altri
                }))} margin={{ top: 10, right: 20, left: 20, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                  <XAxis dataKey="nome" fontSize={12} stroke={C.t2} />
                  <YAxis tickFormatter={v => fmt(v)} fontSize={9} stroke={C.t3} />
                  <Tooltip formatter={v => [fmt(v)]} />
                  <Legend />
                  <Bar dataKey="Personale" stackId="a" fill="#3b82f6" />
                  <Bar dataKey="Materiali" stackId="a" fill="#8b5cf6" />
                  <Bar dataKey="Servizi" stackId="a" fill="#06b6d4" />
                  <Bar dataKey="Utenze" stackId="a" fill="#f59e0b" />
                  <Bar dataKey="Manutenzione" stackId="a" fill="#ef4444" />
                  <Bar dataKey="Altri" stackId="a" fill="#94a3b8" radius={[4,4,0,0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Treemap costi — visualizzazione gerarchica */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Mappa Costi — Treemap Gerarchico</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Area proporzionale all'importo — Costi diretti UO + Sede HQ</p>
              {(() => {
                const catColors = { Personale: '#3b82f6', Materiali: '#8b5cf6', Servizi: '#06b6d4', Utenze: '#f59e0b', Manutenzione: '#ef4444', Altri: '#94a3b8', Sede: '#1e293b' };
                // Costruisci dati treemap: per ogni UO, le categorie di costo
                const tmData = [];
                UO.forEach(u => {
                  Object.entries(u.costi).forEach(([cat, val]) => {
                    if (val > 0) {
                      const catLabel = cat.charAt(0).toUpperCase() + cat.slice(1);
                      tmData.push({ name: u.cod + ' — ' + catLabel, size: val, uo: u.cod, cat: catLabel, color: catColors[catLabel] || '#94a3b8' });
                    }
                  });
                });
                // Aggiungi costi sede
                Object.entries(D.SEDE).forEach(([k, v]) => {
                  if (k !== 'totale' && typeof v === 'number' && v > 0) {
                    const label = k.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
                    tmData.push({ name: 'SEDE — ' + label, size: v, uo: 'SEDE', cat: 'Sede', color: catColors.Sede });
                  }
                });
                tmData.sort((a, b) => b.size - a.size);

                const CustomContent = (props) => {
                  const { x, y, width, height, name, size } = props;
                  if (width < 40 || height < 25) return null;
                  return (
                    <g>
                      <rect x={x} y={y} width={width} height={height} rx={4}
                        style={{ fill: props.color || '#94a3b8', stroke: '#fff', strokeWidth: 2, opacity: 0.85 }} />
                      {width > 60 && height > 35 && (
                        <text x={x + width / 2} y={y + height / 2 - 7} textAnchor="middle" fill="#fff" fontSize={10} fontWeight={600}>
                          {name?.split(' — ')[0]}
                        </text>
                      )}
                      {width > 60 && height > 35 && (
                        <text x={x + width / 2} y={y + height / 2 + 8} textAnchor="middle" fill="#ffffffcc" fontSize={9}>
                          {fmt(size)}
                        </text>
                      )}
                    </g>
                  );
                };

                return (
                  <div>
                    <ResponsiveContainer width="100%" height={340}>
                      <Treemap data={tmData} dataKey="size" nameKey="name" content={<CustomContent />}>
                        <Tooltip formatter={v => [fmt(v), 'Importo']} />
                      </Treemap>
                    </ResponsiveContainer>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: 12, marginTop: 10, justifyContent: 'center' }}>
                      {Object.entries(catColors).map(([cat, col]) => (
                        <span key={cat} style={{ fontSize: 11, display: 'flex', alignItems: 'center', gap: 5 }}>
                          <span style={{ width: 12, height: 12, borderRadius: 3, background: col, opacity: 0.85 }}></span>{cat}
                        </span>
                      ))}
                    </div>
                  </div>
                );
              })()}
            </div>

            {/* Benchmark confronto — incidenza % su ricavi */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Benchmark — Incidenza Costi su Ricavi</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Confronto UO vs benchmark settore</p>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={UO.map(u => ({
                  nome: u.cod,
                  'Pers %': +(u.persPct * 100).toFixed(1),
                  'Bench Pers': +(BENCH.pers_pct * 100).toFixed(1),
                  'Costi Dir %': +((u.costiDir / u.ricavi) * 100).toFixed(1),
                }))} layout="vertical" margin={{ left: 45, right: 30 }}>
                  <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
                  <XAxis type="number" domain={[0, 100]} tickFormatter={v => v + '%'} fontSize={11} stroke={C.t3} />
                  <YAxis type="category" dataKey="nome" fontSize={12} stroke={C.t2} />
                  <Tooltip formatter={v => [v + '%']} />
                  <Legend />
                  <Bar dataKey="Pers %" fill="#3b82f6" barSize={14} radius={[0,4,4,0]} />
                  <Bar dataKey="Bench Pers" fill="#cbd5e1" barSize={14} radius={[0,4,4,0]} />
                  <Bar dataKey="Costi Dir %" fill="#8b5cf6" barSize={14} radius={[0,4,4,0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* RADIOGRAFIA SEDE HQ */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Radiografia Sede HQ — Costo Lordo vs Netto</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>La Sede internalizza servizi per il gruppo e incassa ricavi intercompany. Costo netto = costo lordo - ricavi controllate.</p>
              {(() => {
                const S = D.SEDE;
                const sedeItems = [
                  { voce: 'Personale HQ', importo: S.personale_hq, pct: S.personale_hq/S.totale, note: '~12 FTE. Include: amm.ne, HR, acquisti, qualità, legale, IT, tecnico, marketing' },
                  { voce: 'Consulenze/Servizi', importo: S.consulenze, pct: S.consulenze/S.totale, note: '⚠ €812k — dettaglio per fornitore IN ATTESA', alert: true },
                  { voce: 'Altri oneri', importo: S.altri, pct: S.altri/S.totale, note: 'Emolumenti CdA, sindaci, spese legali, varie' },
                  { voce: 'Affitti sede', importo: S.affitti, pct: S.affitti/S.totale, note: 'Locazione uffici direzione' },
                  { voce: 'Oneri finanziari', importo: S.oneri_fin, pct: S.oneri_fin/S.totale, note: 'Interessi mutui immobiliari CTA+COS + altri' },
                  { voce: 'Imposte', importo: S.imposte, pct: S.imposte/S.totale, note: '' },
                ];
                const ricItems = [
                  { voce: 'Betania (servizi direzione)', importo: INTERCO.betania },
                  { voce: 'Zaharaziz (servizi mensa)', importo: INTERCO.zaharaziz },
                  { voce: 'Lab (ristorno partecipazione)', importo: INTERCO.lab_ristorno },
                  { voce: 'Proventi fin./sopravvenienze', importo: S.ricavi_hq },
                ];
                const totRicHQ = INTERCO.totale + S.ricavi_hq;
                return <div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                    {/* Costi */}
                    <div>
                      <h4 style={{ fontSize: 12, fontWeight: 700, color: C.rosso, marginBottom: 8 }}>Costi Sede — {fmt(S.totale)}</h4>
                      <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <tbody>
                          {sedeItems.map((r, i) => (
                            <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo }}>
                              <td style={{ padding: '5px 6px', fontSize: 11, fontWeight: 500 }}>{r.voce}</td>
                              <td style={{ padding: '5px 6px', textAlign: 'right', fontFamily: 'monospace', fontSize: 12, color: C.rosso }}>{fmt(r.importo)}</td>
                              <td style={{ padding: '5px 6px', textAlign: 'right', fontSize: 10, color: C.t3 }}>{fmtPct(r.pct)}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    {/* Ricavi */}
                    <div>
                      <h4 style={{ fontSize: 12, fontWeight: 700, color: C.verde, marginBottom: 8 }}>Ricavi HQ — {fmt(totRicHQ)}</h4>
                      <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <tbody>
                          {ricItems.map((r, i) => (
                            <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo }}>
                              <td style={{ padding: '5px 6px', fontSize: 11, fontWeight: 500 }}>{r.voce}</td>
                              <td style={{ padding: '5px 6px', textAlign: 'right', fontFamily: 'monospace', fontSize: 12, color: C.verde }}>{fmt(r.importo)}</td>
                            </tr>
                          ))}
                          <tr style={{ borderTop: '2px solid ' + C.primario, background: '#f0f4f8' }}>
                            <td style={{ padding: '5px 6px', fontWeight: 700, fontSize: 12 }}>COSTO NETTO SEDE</td>
                            <td style={{ padding: '5px 6px', textAlign: 'right', fontFamily: 'monospace', fontSize: 14, fontWeight: 700, color: C.rosso }}>{fmt(S.totale - totRicHQ)}</td>
                          </tr>
                        </tbody>
                      </table>
                      <div style={{ marginTop: 12, padding: '8px 10px', background: '#eff6ff', borderRadius: 6, fontSize: 11, color: C.primario }}>
                        Incidenza netta su ricavi BU: <b>{fmtPct((S.totale - totRicHQ) / TOT.ric)}</b> (vs {fmtPct(S.totale / TOT.ric)} lordo)
                      </div>
                    </div>
                  </div>

                  {/* Funzioni HQ e duplicazioni */}
                  <div style={{ marginTop: 16 }}>
                    <h4 style={{ fontSize: 12, fontWeight: 700, color: C.t1, marginBottom: 8 }}>Mappa Funzioni HQ — Dove si Duplica?</h4>
                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 11 }}>
                      <thead><tr style={{ borderBottom: '2px solid ' + C.primario, background: '#f0f4f8' }}>
                        <th style={{ padding: '5px 8px', textAlign: 'left', fontSize: 10 }}>Funzione</th>
                        <th style={{ padding: '5px 8px', textAlign: 'right', fontSize: 10 }}>Costo Stimato</th>
                        <th style={{ padding: '5px 8px', textAlign: 'center', fontSize: 10 }}>Duplica BU?</th>
                        <th style={{ padding: '5px 8px', textAlign: 'left', fontSize: 10 }}>Note / Azione</th>
                      </tr></thead>
                      <tbody>
                        {S.funzioni.map((f, i) => (
                          <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, background: f.duplica_bu ? '#fef2f2' : 'white' }}>
                            <td style={{ padding: '5px 8px', fontWeight: 500 }}>{f.funzione}</td>
                            <td style={{ padding: '5px 8px', textAlign: 'right', fontFamily: 'monospace', color: f.stima ? C.t1 : C.t3 }}>{f.stima ? fmt(f.stima) : '⬜ da rilevare'}</td>
                            <td style={{ padding: '5px 8px', textAlign: 'center' }}>{f.duplica_bu ? <span style={{ color: C.rosso, fontWeight: 700 }}>⚠ SÌ</span> : <span style={{ color: C.verde }}>No</span>}</td>
                            <td style={{ padding: '5px 8px', fontSize: 10, color: C.t2 }}>{f.note}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8, marginTop: 10 }}>
                      <div style={{ padding: '8px 12px', background: C.rossoBg, borderRadius: 6, fontSize: 11, color: C.rosso }}>
                        ⚠ DUPLICAZIONI: Amministrazione e Ufficio Acquisti sono le due funzioni dove BU e Sede rischiano di pagare due volte lo stesso lavoro. Serve mappa ruoli per decisione centralizza/decentra.
                      </div>
                      <div style={{ padding: '8px 12px', background: '#fef9c3', borderRadius: 6, fontSize: 11, color: '#92400e' }}>
                        ⬜ DATI MANCANTI: costo per funzione da Zucchetti (chi fa cosa e quanto costa), dettaglio €812k consulenze per fornitore/contratto, personale Lab €80k — dove contabilizzato?
                      </div>
                    </div>
                  </div>
                </div>;
              })()}
            </div>

            {/* Narrative per UO */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Variance Analysis — Narrative</h3>
              {narrative.map((n, i) => {
                const u = UO.find(x => x.cod === n.uo);
                const ac = alertCol(n.alert);
                return (
                  <div key={i} style={{ marginBottom: 12, padding: '14px 16px', borderRadius: 10, background: ac.bg, borderLeft: '5px solid ' + ac.color }}>
                    <div style={{ display: 'flex', alignItems: 'center', marginBottom: 6 }}>
                      {u && <span style={{ width: 10, height: 10, borderRadius: '50%', background: u.colore, display: 'inline-block', marginRight: 8 }}></span>}
                      <span style={{ fontWeight: 700, fontSize: 14, color: C.t1 }}>{n.uo === 'GRUPPO' ? 'GRUPPO KAROL' : n.uo + ' — ' + (u ? u.nome : '')}</span>
                      <span style={{ marginLeft: 8, fontSize: 11, padding: '2px 8px', borderRadius: 12, background: ac.color, color: '#fff' }}>{n.alert}</span>
                      <span style={{ marginLeft: 'auto', fontFamily: 'monospace', fontSize: 13, fontWeight: 600, color: (u ? u.molG : TOT.molG) >= 0 ? C.verde : C.rosso }}>
                        MOL-G: {fmt(u ? u.molG : TOT.molG)}
                      </span>
                    </div>
                    <p style={{ fontSize: 12, color: C.t1, lineHeight: 1.6, marginBottom: 4 }}>{n.testo}</p>
                    <p style={{ fontSize: 11, color: C.t2, fontStyle: 'italic', borderTop: '1px solid ' + ac.color + '33', paddingTop: 6 }}>
                      <strong>Outlook:</strong> {n.outlook}
                    </p>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* ======================== SIMULAZIONI ======================== */}
        {tab === 'simulazioni' && (() => {
          // Calcola impatto simulazione
          const simTotRic = TOT.ric * (1 + simRic / 100);
          const simTotPers = TOT.pers * (1 + simPers / 100);
          const simTotSede = TOT.sede * (1 + simSede / 100);
          const simAltriCosti = TOT.cDir - TOT.pers;
          const simMolI = simTotRic - simTotPers - simAltriCosti;
          const simMolG = simMolI - simTotSede;
          const simEbit = simMolG - TOT.ammort - TOT.oneri_fin;

          const deltaRic = simTotRic - TOT.ric;
          const deltaMolG = simMolG - TOT.molG;
          const deltaEbit = simEbit - TOT.ebit;

          const SliderRow = ({ label, value, setter, min, max, step, unit }) => (
            <div style={{ marginBottom: 16 }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 }}>
                <span style={{ fontSize: 13, fontWeight: 600, color: C.t1 }}>{label}</span>
                <span style={{ fontSize: 14, fontWeight: 700, color: value === 0 ? C.t3 : value > 0 ? C.verde : C.rosso, fontFamily: 'monospace' }}>
                  {value > 0 ? '+' : ''}{value}{unit || '%'}
                </span>
              </div>
              <input type="range" min={min} max={max} step={step || 1} value={value}
                onChange={e => setter(Number(e.target.value))}
                style={{ width: '100%', accentColor: C.primario }} />
              <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 10, color: C.t3 }}>
                <span>{min}{unit || '%'}</span><span>0</span><span>+{max}{unit || '%'}</span>
              </div>
            </div>
          );

          return (
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
              {/* Panel sliders */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Leve What-If</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 20 }}>Trascina gli slider per simulare variazioni % su base annua</p>
                <SliderRow label="Ricavi (variazione %)" value={simRic} setter={setSimRic} min={-20} max={20} />
                <SliderRow label="Costo Personale (variazione %)" value={simPers} setter={setSimPers} min={-15} max={15} />
                <SliderRow label="Costi Sede (variazione %)" value={simSede} setter={setSimSede} min={-30} max={10} />
                <SliderRow label="Occupancy (delta pp)" value={simOcc} setter={setSimOcc} min={-10} max={10} />
                <button onClick={() => { setSimRic(0); setSimPers(0); setSimOcc(0); setSimSede(0); }}
                  style={{ marginTop: 8, padding: '8px 20px', background: C.primario, color: 'white', border: 'none', borderRadius: 6, cursor: 'pointer', fontSize: 12, fontWeight: 600, fontFamily: 'inherit' }}>
                  Reset
                </button>
              </div>

              {/* Panel risultati */}
              <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                <div style={cardS}>
                  <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 16 }}>Impatto Simulazione</h3>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12 }}>
                    {[
                      { label: 'Ricavi Sim.', val: simTotRic, delta: deltaRic, base: TOT.ric },
                      { label: 'MOL-G Sim.', val: simMolG, delta: deltaMolG, base: TOT.molG },
                      { label: 'EBIT Sim.', val: simEbit, delta: deltaEbit, base: TOT.ebit },
                    ].map((r, i) => (
                      <div key={i} style={{ padding: 12, borderRadius: 8, background: r.delta >= 0 ? C.verdeBg : C.rossoBg, textAlign: 'center' }}>
                        <div style={{ fontSize: 10, color: C.t3, marginBottom: 4 }}>{r.label}</div>
                        <div style={{ fontSize: 16, fontWeight: 700, color: C.t1 }}>{fmt(r.val)}</div>
                        <div style={{ fontSize: 11, color: r.delta >= 0 ? C.verde : C.rosso, fontWeight: 600, marginTop: 2 }}>
                          {r.delta >= 0 ? '+' : ''}{fmt(r.delta)}
                        </div>
                        <div style={{ fontSize: 10, color: C.t3, marginTop: 2 }}>Base: {fmt(r.base)}</div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Waterfall impatto */}
                <div style={cardS}>
                  <h3 style={{ fontSize: 13, fontWeight: 700, color: C.t1, marginBottom: 8 }}>Waterfall Impatto</h3>
                  <ResponsiveContainer width="100%" height={220}>
                    <BarChart data={[
                      { voce: 'MOL-G Attuale', base: 0, val: TOT.molG, col: C.primario },
                      { voce: 'Δ Ricavi', base: TOT.molG, val: deltaRic, col: deltaRic >= 0 ? C.verde : C.rosso },
                      { voce: 'Δ Personale', base: TOT.molG + deltaRic, val: -(simTotPers - TOT.pers), col: simTotPers <= TOT.pers ? C.verde : C.rosso },
                      { voce: 'Δ Sede', base: simMolI - simTotSede + (simTotSede - TOT.sede), val: -(simTotSede - TOT.sede), col: simTotSede <= TOT.sede ? C.verde : C.rosso },
                      { voce: 'MOL-G Sim.', base: 0, val: simMolG, col: simMolG >= 0 ? '#047857' : '#b91c1c' },
                    ]} margin={{ top: 10, right: 10, left: 10, bottom: 30 }}>
                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                      <XAxis dataKey="voce" fontSize={10} angle={-25} textAnchor="end" height={50} stroke={C.t2} />
                      <YAxis tickFormatter={v => fmt(v)} fontSize={9} stroke={C.t3} />
                      <Tooltip formatter={v => [fmt(v)]} />
                      <Bar dataKey="base" stackId="a" fill="transparent" />
                      <Bar dataKey="val" stackId="a" radius={[3,3,0,0]} barSize={32}>
                        {[0,1,2,3,4].map(i => <Cell key={i} fill={[C.primario, deltaRic >= 0 ? C.verde : C.rosso, simTotPers <= TOT.pers ? C.verde : C.rosso, simTotSede <= TOT.sede ? C.verde : C.rosso, simMolG >= 0 ? '#047857' : '#b91c1c'][i]} />)}
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </div>

                {/* KPI simulati */}
                <div style={{ ...cardS, padding: '12px 16px' }}>
                  <div style={{ fontSize: 12, fontWeight: 600, color: C.t1, marginBottom: 6 }}>KPI Simulati</div>
                  <div style={{ display: 'flex', gap: 12 }}>
                    <span style={{ fontSize: 11, color: C.t2 }}>MOL-G %: <strong style={{ color: simMolG / simTotRic >= 0.08 ? C.verde : C.rosso }}>{fmtPct(simMolG / simTotRic)}</strong></span>
                    <span style={{ fontSize: 11, color: C.t2 }}>Pers %: <strong style={{ color: simTotPers / simTotRic <= 0.55 ? C.verde : C.rosso }}>{fmtPct(simTotPers / simTotRic)}</strong></span>
                    <span style={{ fontSize: 11, color: C.t2 }}>Sede %: <strong style={{ color: simTotSede / simTotRic <= 0.12 ? C.verde : C.rosso }}>{fmtPct(simTotSede / simTotRic)}</strong></span>
                  </div>
                </div>
              </div>

              {/* Proiezione multi-anno (full width) */}
              <div style={{ ...cardS, gridColumn: '1 / -1' }}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Proiezione Multi-Anno — Scenario Simulato</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Effetto cumulato delle leve what-if su 5 anni (ipotesi: variazione costante annua)</p>
                {(() => {
                  const anno0 = D.meta.anno;
                  const proj = [];
                  for (let a = 0; a <= 5; a++) {
                    const compRic = Math.pow(1 + simRic / 100, a);
                    const compPers = Math.pow(1 + simPers / 100, a);
                    const compSede = Math.pow(1 + simSede / 100, a);
                    const ric = TOT.ric * compRic;
                    const pers = TOT.pers * compPers;
                    const altriC = TOT.cDir - TOT.pers;
                    const molI = ric - pers - altriC;
                    const sede = TOT.sede * compSede;
                    const molG = molI - sede;
                    const ebit = molG - TOT.ammort - TOT.oneri_fin;
                    proj.push({ anno: anno0 + a, Ricavi: Math.round(ric), 'MOL-G': Math.round(molG), EBIT: Math.round(ebit) });
                  }
                  return (
                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: 16 }}>
                      <ResponsiveContainer width="100%" height={260}>
                        <ComposedChart data={proj} margin={{ top: 10, right: 20, left: 20, bottom: 5 }}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                          <XAxis dataKey="anno" fontSize={12} stroke={C.t2} />
                          <YAxis tickFormatter={v => fmt(v)} fontSize={9} stroke={C.t3} />
                          <Tooltip formatter={v => [fmt(v)]} />
                          <Legend />
                          <Bar dataKey="Ricavi" fill="#e2e8f0" barSize={28} radius={[3,3,0,0]} />
                          <Line type="monotone" dataKey="MOL-G" stroke={C.CTA} strokeWidth={2.5} dot={{ r: 4, fill: C.CTA }} />
                          <Line type="monotone" dataKey="EBIT" stroke={C.rosso} strokeWidth={2} strokeDasharray="5 3" dot={{ r: 3, fill: C.rosso }} />
                          <ReferenceLine y={0} stroke={C.t3} strokeWidth={1} />
                        </ComposedChart>
                      </ResponsiveContainer>
                      <table style={{ borderCollapse: 'collapse', fontSize: 11, alignSelf: 'center' }}>
                        <thead>
                          <tr style={{ borderBottom: '2px solid ' + C.bordo }}>
                            <th style={{ padding: '5px 8px', color: C.t2, textAlign: 'left' }}>Anno</th>
                            <th style={{ padding: '5px 8px', color: C.t2, textAlign: 'right' }}>Ricavi</th>
                            <th style={{ padding: '5px 8px', color: C.t2, textAlign: 'right' }}>MOL-G</th>
                            <th style={{ padding: '5px 8px', color: C.t2, textAlign: 'right' }}>EBIT</th>
                          </tr>
                        </thead>
                        <tbody>
                          {proj.map((p, i) => (
                            <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, background: i === 0 ? '#f0f4f8' : 'transparent' }}>
                              <td style={{ padding: '5px 8px', fontWeight: i === 0 ? 700 : 500 }}>{p.anno}{i === 0 ? ' (att.)' : ''}</td>
                              <td style={{ padding: '5px 8px', textAlign: 'right', fontFamily: 'monospace' }}>{fmt(p.Ricavi)}</td>
                              <td style={{ padding: '5px 8px', textAlign: 'right', fontFamily: 'monospace', color: p['MOL-G'] >= 0 ? C.verde : C.rosso }}>{fmt(p['MOL-G'])}</td>
                              <td style={{ padding: '5px 8px', textAlign: 'right', fontFamily: 'monospace', color: p.EBIT >= 0 ? C.verde : C.rosso }}>{fmt(p.EBIT)}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  );
                })()}
                <div style={{ marginTop: 10, padding: '8px 12px', background: '#f0f4f8', borderRadius: 6, fontSize: 11, color: C.t2 }}>
                  {simRic === 0 && simPers === 0 && simSede === 0
                    ? 'Muovi gli slider per vedere la proiezione multi-anno. L\'effetto si compone geometricamente.'
                    : `Ipotesi: Ricavi ${simRic >= 0 ? '+' : ''}${simRic}%/anno, Personale ${simPers >= 0 ? '+' : ''}${simPers}%/anno, Sede ${simSede >= 0 ? '+' : ''}${simSede}%/anno — compounding su 5 anni.`
                  }
                </div>
              </div>
            </div>
          );
        })()}

      </div>

      {/* FOOTER */}
      <div style={{ textAlign: 'center', padding: '16px 0', fontSize: 11, color: C.t3, borderTop: '1px solid ' + C.bordo }}>
        Karol CdG v4.3 — Gruppo Karol S.p.A. — Cruscotto Controllo di Gestione | Aggiornamento: {D.meta.ultimo_aggiornamento}
      </div>
    </div>
  );
};

ReactDOM.render(React.createElement(KarolDashboard), document.getElementById('root'));
</script>
</body>
</html>
