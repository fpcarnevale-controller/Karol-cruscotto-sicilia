import React, { useState } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LineChart, Line, Legend, PieChart, Pie, Cell, RadarChart, Radar, PolarGrid, PolarAngleAxis, PolarRadiusAxis } from 'recharts';

const KarolCdGDashboard = () => {
  const [showCEDetail, setShowCEDetail] = useState(false);
  const [showKPI, setShowKPI] = useState(false);
  const [showProiezioni, setShowProiezioni] = useState(false);
  const [uoSelezionata, setUoSelezionata] = useState(null);
  const [vistaCorrente, setVistaCorrente] = useState('overview');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DATI CE INDUSTRIALE â€” dal Master Excel (elabora.py output)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const uoDati = [
    {
      codice: "VLB", nome: "RSA Villabate", tipo: "RSA Alzheimer", postiLetto: 44,
      ricavi: 2004045, costiDiretti: 1675033, molI: 329012, molIPct: 0.1642,
      costiSede: 353127, molG: -24115, molGPct: -0.0120,
      personale: 1147329, personalePct: 0.5725,
      occupancy: 0.900, ricavoGiornata: 138.66,
      dettaglioRicavi: {
        R01: 1845916, R04: 91939, R05: 35551, R07: 30638
      },
      dettaglioCosti: {
        medici: 281811, infermieri: 311213, oss: 484900, amministrativi: 69405,
        farmaci: 123037, diagnostico: 49558, vitto: 80764, altri_mat: 30720,
        lavanderia: 30044, pulizie: 41108, manutenzioni: 30089, utenze: 50856,
        consulenze: 20071, ammortamenti: 71458
      },
      ricaviMensili: [169640, 149876, 173154, 168672, 174978, 166476, 164006, 154880, 163696, 174683, 170602, 173382],
      costiMensili: [140731, 139023, 141794, 142431, 139408, 138816, 138345, 135571, 138366, 140063, 138567, 141919]
    },
    {
      codice: "CTA", nome: "CTA Ex Stagno", tipo: "Psichiatrico", postiLetto: 40,
      ricavi: 1895648, costiDiretti: 1670541, molI: 225107, molIPct: 0.1187,
      costiSede: 326072, molG: -100965, molGPct: -0.0533,
      personale: 1125426, personalePct: 0.5937,
      occupancy: 0.920, ricavoGiornata: 141.19,
      dettaglioRicavi: {
        R01: 1811515, R04: 54502, R07: 29630
      },
      dettaglioCosti: {
        medici: 361861, infermieri: 348194, oss: 348096, amministrativi: 67274,
        farmaci: 135550, diagnostico: 45258, vitto: 66842, altri_mat: 29090,
        lavanderia: 29194, pulizie: 47773, manutenzioni: 37541, utenze: 57897,
        consulenze: 28568, ammortamenti: 67402
      },
      ricaviMensili: [159954, 144470, 163122, 157669, 165770, 157080, 153507, 148029, 153462, 166605, 161823, 164157],
      costiMensili: [139727, 138994, 137273, 138930, 139301, 139815, 137848, 136411, 139877, 142422, 140868, 139074]
    },
    {
      codice: "COS", nome: "CdC Cosentino", tipo: "Riabilitazione", postiLetto: 50,
      ricavi: 3799179, costiDiretti: 2924314, molI: 874865, molIPct: 0.2303,
      costiSede: 541917, molG: 332949, molGPct: 0.0876,
      personale: 1790988, personalePct: 0.4714,
      occupancy: 0.860, ricavoGiornata: 241.99,
      dettaglioRicavi: {
        R01: 2901765, R02: 366230, R04: 232898, R05: 88105, R06: 180302, R07: 29879
      },
      dettaglioCosti: {
        medici: 688628, infermieri: 531454, oss: 259305, tecnici: 204100, amministrativi: 107502,
        farmaci: 292406, diagnostico: 144209, vitto: 109600, altri_mat: 70921,
        lavanderia: 55100, pulizie: 90644, manutenzioni: 73187, utenze: 90861,
        consulenze: 57869, ammortamenti: 148530
      },
      ricaviMensili: [320319, 290930, 321212, 318851, 328869, 319828, 309744, 294979, 308393, 333165, 321909, 330982],
      costiMensili: [244695, 241092, 240802, 247326, 245338, 242449, 243186, 234286, 242532, 244702, 251201, 246704]
    },
    {
      codice: "LAB", nome: "Karol Lab", tipo: "Laboratorio", postiLetto: 0,
      ricavi: 1450153, costiDiretti: 891341, molI: 558813, molIPct: 0.3853,
      costiSede: 212873, molG: 345940, molGPct: 0.2386,
      personale: 438075, personalePct: 0.3021,
      occupancy: null, ricavoGiornata: null,
      dettaglioRicavi: {
        R03: 1140319, R06: 291900, R07: 17934
      },
      dettaglioCosti: {
        medici: 89746, tecnici: 279030, amministrativi: 69298,
        farmaci: 173633, diagnostico: 92392, altri_mat: 35100,
        pulizie: 17409, manutenzioni: 29324, utenze: 23048,
        consulenze: 23709, ammortamenti: 58650
      },
      ricaviMensili: [123238, 120564, 123838, 126162, 120026, 116683, 116136, 111219, 116108, 127791, 130075, 118316],
      costiMensili: [74958, 73556, 74432, 75376, 76159, 75846, 73710, 69849, 73075, 74976, 74564, 74839]
    },
    {
      codice: "KCP", nome: "Karol Casa Protetta", tipo: "Casa Protetta", postiLetto: 20,
      ricavi: 700261, costiDiretti: 603299, molI: 96961, molIPct: 0.1385,
      costiSede: 158011, molG: -61050, molGPct: -0.0872,
      personale: 391420, personalePct: 0.5590,
      occupancy: null, ricavoGiornata: null,
      dettaglioRicavi: {
        R01: 582468, R04: 87988, R07: 29804
      },
      dettaglioCosti: {
        medici: 77686, infermieri: 108839, oss: 173820, amministrativi: 31075,
        farmaci: 34676, diagnostico: 13350, vitto: 41082, altri_mat: 13507,
        lavanderia: 13529, pulizie: 20846, manutenzioni: 16925, utenze: 23299,
        consulenze: 7007, ammortamenti: 27658
      },
      ricaviMensili: [59361, 53405, 61086, 58202, 60141, 57339, 57604, 54021, 57324, 61888, 58959, 60931],
      costiMensili: [49419, 50019, 50686, 50607, 50544, 50694, 49326, 48620, 50241, 51418, 51571, 50155]
    }
  ];

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // KPI CON SEMAFORI â€” dal foglio KPI_Calcolati
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const kpiData = [
    { kpi: "MOL % Industriale", uo: "VLB", valore: 0.1642, target: 0.15, alert: "VERDE" },
    { kpi: "MOL % Gestionale", uo: "VLB", valore: -0.0120, target: 0.08, alert: "ROSSO" },
    { kpi: "Costo Personale %", uo: "VLB", valore: 0.5725, target: 0.55, alert: "GIALLO" },
    { kpi: "Occupancy %", uo: "VLB", valore: 0.900, target: 0.90, alert: "GIALLO" },
    { kpi: "MOL % Industriale", uo: "CTA", valore: 0.1187, target: 0.15, alert: "GIALLO" },
    { kpi: "MOL % Gestionale", uo: "CTA", valore: -0.0533, target: 0.08, alert: "ROSSO" },
    { kpi: "Costo Personale %", uo: "CTA", valore: 0.5937, target: 0.55, alert: "GIALLO" },
    { kpi: "Occupancy %", uo: "CTA", valore: 0.920, target: 0.90, alert: "VERDE" },
    { kpi: "MOL % Industriale", uo: "COS", valore: 0.2303, target: 0.15, alert: "VERDE" },
    { kpi: "MOL % Gestionale", uo: "COS", valore: 0.0876, target: 0.08, alert: "GIALLO" },
    { kpi: "Costo Personale %", uo: "COS", valore: 0.4714, target: 0.55, alert: "VERDE" },
    { kpi: "Occupancy %", uo: "COS", valore: 0.860, target: 0.90, alert: "GIALLO" },
    { kpi: "MOL % Industriale", uo: "LAB", valore: 0.3853, target: 0.15, alert: "VERDE" },
    { kpi: "MOL % Gestionale", uo: "LAB", valore: 0.2386, target: 0.08, alert: "VERDE" },
    { kpi: "Costo Personale %", uo: "LAB", valore: 0.3021, target: 0.55, alert: "VERDE" },
    { kpi: "MOL % Industriale", uo: "KCP", valore: 0.1385, target: 0.15, alert: "GIALLO" },
    { kpi: "MOL % Gestionale", uo: "KCP", valore: -0.0872, target: 0.08, alert: "ROSSO" },
    { kpi: "Costo Personale %", uo: "KCP", valore: 0.5590, target: 0.55, alert: "GIALLO" },
    { kpi: "MOL % Consolidato", uo: "GRUPPO", valore: 0.0500, target: 0.12, alert: "ROSSO" },
    { kpi: "Peso Costi Sede %", uo: "GRUPPO", valore: 0.1616, target: 0.15, alert: "VERDE" },
    { kpi: "Costo Personale % Consolidato", uo: "GRUPPO", valore: 0.4968, target: 0.55, alert: "VERDE" }
  ];

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // DATI AGGREGATI
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const totRicavi = 9849287;
  const totCostiDiretti = 7764528;
  const totMolI = 2084759;
  const totMolIPct = 0.2117;
  const totCostiSede = 1592000;
  const costiSedeNonAlloc = 403000;
  const totMolG = 492759;
  const totMolGPct = 0.0500;

  const mesi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];

  // Trend mensile aggregato
  const trendMensile = mesi.map((m, i) => {
    const ricavi = uoDati.reduce((s, uo) => s + uo.ricaviMensili[i], 0);
    const costi = uoDati.reduce((s, uo) => s + uo.costiMensili[i], 0);
    return { mese: m, Ricavi: Math.round(ricavi), Costi: Math.round(costi), MOL_I: Math.round(ricavi - costi) };
  });

  // Performance bar chart
  const barCE = uoDati.map(uo => ({
    nome: uo.codice,
    Ricavi: uo.ricavi,
    'Costi Diretti': uo.costiDiretti,
    'MOL-I': uo.molI
  }));

  // Waterfall MOL
  const waterfallData = [
    { nome: 'Ricavi', valore: totRicavi, fill: '#1F4E79' },
    { nome: 'Personale', valore: -4893238, fill: '#ef4444' },
    { nome: 'Acquisti', valore: -1581693, fill: '#f97316' },
    { nome: 'Servizi', valore: -915897, fill: '#eab308' },
    { nome: 'Ammort.', valore: -373698, fill: '#a3a3a3' },
    { nome: 'MOL-I', valore: totMolI, fill: '#10b981' },
    { nome: 'Sede', valore: -totCostiSede, fill: '#8b5cf6' },
    { nome: 'MOL-G', valore: totMolG, fill: totMolG >= 0 ? '#10b981' : '#ef4444' }
  ];

  // Composizione costi sede
  const costiSedeBreakdown = [
    { nome: 'Servizi alle UO', valore: 1207000, colore: '#3b82f6' },
    { nome: 'Governance', valore: 665000, colore: '#8b5cf6' },
    { nome: 'Sviluppo', valore: 270000, colore: '#f59e0b' },
    { nome: 'Storico', valore: 133000, colore: '#a3a3a3' }
  ];

  // Alert counts
  const alertRosso = kpiData.filter(k => k.alert === 'ROSSO').length;
  const alertGiallo = kpiData.filter(k => k.alert === 'GIALLO').length;
  const alertVerde = kpiData.filter(k => k.alert === 'VERDE').length;

  const alertPie = [
    { nome: 'ROSSO', valore: alertRosso, colore: '#ef4444' },
    { nome: 'GIALLO', valore: alertGiallo, colore: '#f59e0b' },
    { nome: 'VERDE', valore: alertVerde, colore: '#10b981' }
  ];

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HELPERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const fmt = (v) => `â‚¬${Math.round(v).toLocaleString('it-IT')}`;
  const fmtK = (v) => `â‚¬${(v/1000).toFixed(0)}k`;
  const fmtM = (v) => `â‚¬${(v/1000000).toFixed(2)}M`;
  const fmtPct = (v) => `${(v * 100).toFixed(1)}%`;
  const alertColor = (a) => a === 'ROSSO' ? '#ef4444' : a === 'GIALLO' ? '#f59e0b' : '#10b981';
  const alertBg = (a) => a === 'ROSSO' ? 'bg-red-100 text-red-800' : a === 'GIALLO' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
  const alertIcon = (a) => a === 'ROSSO' ? 'ğŸ”´' : a === 'GIALLO' ? 'ğŸŸ¡' : 'ğŸŸ¢';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-4">
      <div className="max-w-7xl mx-auto">

        {/* HEADER */}
        <div className="mb-6 text-center">
          <h1 className="text-3xl font-bold text-gray-900 mb-1">
            Controllo di Gestione â€” Gruppo Karol
          </h1>
          <p className="text-sm text-gray-500">
            Anno 2025 | Dati Simulati (Test Pipeline) | 5 UnitÃ  Operative | 12 Mesi
          </p>

          {/* Navigation */}
          <div className="flex justify-center gap-2 mt-4">
            {[
              { id: 'overview', label: 'Overview' },
              { id: 'ce', label: 'CE Industriale' },
              { id: 'kpi', label: 'KPI Semafori' },
              { id: 'trend', label: 'Trend Mensile' }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setVistaCorrente(tab.id)}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                  vistaCorrente === tab.id
                    ? 'bg-blue-700 text-white shadow-md'
                    : 'bg-white text-gray-600 hover:bg-gray-100 border'
                }`}
              >
                {tab.label}
              </button>
            ))}
          </div>
        </div>

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• OVERVIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {vistaCorrente === 'overview' && (
          <>
            {/* KPI Cards principali */}
            <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
              <div className="bg-white rounded-xl shadow p-4 border-l-4 border-blue-600">
                <p className="text-xs text-gray-500 mb-1">Ricavi Totali</p>
                <p className="text-xl font-bold text-blue-700">{fmtM(totRicavi)}</p>
              </div>
              <div className="bg-white rounded-xl shadow p-4 border-l-4 border-green-500">
                <p className="text-xs text-gray-500 mb-1">MOL Industriale</p>
                <p className="text-xl font-bold text-green-600">{fmtM(totMolI)}</p>
                <p className="text-xs text-green-600">{fmtPct(totMolIPct)}</p>
              </div>
              <div className="bg-white rounded-xl shadow p-4 border-l-4 border-purple-500">
                <p className="text-xs text-gray-500 mb-1">Costi Sede</p>
                <p className="text-xl font-bold text-purple-600">{fmtM(totCostiSede)}</p>
                <p className="text-xs text-purple-600">16,2% ricavi</p>
              </div>
              <div className={`bg-white rounded-xl shadow p-4 border-l-4 ${totMolG >= 0 ? 'border-green-500' : 'border-red-500'}`}>
                <p className="text-xs text-gray-500 mb-1">MOL Gestionale</p>
                <p className={`text-xl font-bold ${totMolG >= 0 ? 'text-green-600' : 'text-red-600'}`}>{fmtM(totMolG)}</p>
                <p className={`text-xs ${totMolG >= 0 ? 'text-green-600' : 'text-red-600'}`}>{fmtPct(totMolGPct)}</p>
              </div>
              <div className="bg-white rounded-xl shadow p-4 border-l-4 border-orange-500">
                <p className="text-xs text-gray-500 mb-1">Alert Attivi</p>
                <p className="text-xl font-bold text-orange-600">{alertRosso + alertGiallo}</p>
                <p className="text-xs text-gray-500">{alertRosso} ğŸ”´ {alertGiallo} ğŸŸ¡ {alertVerde} ğŸŸ¢</p>
              </div>
            </div>

            {/* Charts Row */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
              {/* Bar Chart CE per UO */}
              <div className="lg:col-span-2 bg-white rounded-xl shadow p-4">
                <h3 className="text-sm font-semibold text-gray-700 mb-3">CE Industriale per UO</h3>
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={barCE} margin={{ top: 10, right: 20, left: 10, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="nome" fontSize={12} />
                    <YAxis tickFormatter={(v) => fmtK(v)} fontSize={10} />
                    <Tooltip formatter={(v) => fmt(v)} />
                    <Legend />
                    <Bar dataKey="Ricavi" fill="#1F4E79" />
                    <Bar dataKey="Costi Diretti" fill="#ef4444" />
                    <Bar dataKey="MOL-I" fill="#10b981" />
                  </BarChart>
                </ResponsiveContainer>
              </div>

              {/* Alert Pie */}
              <div className="bg-white rounded-xl shadow p-4">
                <h3 className="text-sm font-semibold text-gray-700 mb-3">Distribuzione Alert KPI</h3>
                <ResponsiveContainer width="100%" height={200}>
                  <PieChart>
                    <Pie data={alertPie} cx="50%" cy="50%" outerRadius={70} dataKey="valore"
                      label={({ nome, valore }) => `${nome}: ${valore}`}>
                      {alertPie.map((e, i) => <Cell key={i} fill={e.colore} />)}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
                <div className="text-xs text-center text-gray-500 mt-1">
                  {alertRosso} critici | {alertGiallo} attenzione | {alertVerde} ok
                </div>
              </div>
            </div>

            {/* Tabella Riepilogo UO */}
            <div className="bg-white rounded-xl shadow p-4 mb-6">
              <h3 className="text-sm font-semibold text-gray-700 mb-3">Riepilogo per UnitÃ  Operativa</h3>
              <div className="overflow-x-auto">
                <table className="w-full text-xs">
                  <thead>
                    <tr className="bg-gray-800 text-white">
                      <th className="p-2 text-left">UO</th>
                      <th className="p-2 text-left">Tipologia</th>
                      <th className="p-2 text-right">Ricavi</th>
                      <th className="p-2 text-right">Costi Dir.</th>
                      <th className="p-2 text-right">MOL-I</th>
                      <th className="p-2 text-center">MOL-I %</th>
                      <th className="p-2 text-right">Sede</th>
                      <th className="p-2 text-right">MOL-G</th>
                      <th className="p-2 text-center">MOL-G %</th>
                      <th className="p-2 text-center">Pers. %</th>
                    </tr>
                  </thead>
                  <tbody>
                    {uoDati.map((uo, i) => (
                      <tr key={i} className={`border-b hover:bg-blue-50 cursor-pointer ${i % 2 === 0 ? 'bg-gray-50' : ''}`}
                        onClick={() => setUoSelezionata(uo)}>
                        <td className="p-2 font-semibold text-blue-700">{uo.codice}</td>
                        <td className="p-2 text-gray-600">{uo.tipo}</td>
                        <td className="p-2 text-right font-mono">{fmtK(uo.ricavi)}</td>
                        <td className="p-2 text-right font-mono text-red-600">{fmtK(uo.costiDiretti)}</td>
                        <td className="p-2 text-right font-mono text-green-700">{fmtK(uo.molI)}</td>
                        <td className="p-2 text-center">
                          <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                            uo.molIPct >= 0.20 ? 'bg-green-100 text-green-800' :
                            uo.molIPct >= 0.12 ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                          }`}>{fmtPct(uo.molIPct)}</span>
                        </td>
                        <td className="p-2 text-right font-mono text-purple-600">{fmtK(uo.costiSede)}</td>
                        <td className={`p-2 text-right font-mono font-semibold ${uo.molG >= 0 ? 'text-green-700' : 'text-red-600'}`}>
                          {fmtK(uo.molG)}
                        </td>
                        <td className="p-2 text-center">
                          <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                            uo.molGPct >= 0.08 ? 'bg-green-100 text-green-800' :
                            uo.molGPct >= 0 ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                          }`}>{fmtPct(uo.molGPct)}</span>
                        </td>
                        <td className="p-2 text-center">
                          <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                            uo.personalePct <= 0.50 ? 'bg-green-100 text-green-800' :
                            uo.personalePct <= 0.58 ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                          }`}>{fmtPct(uo.personalePct)}</span>
                        </td>
                      </tr>
                    ))}
                    {/* Totale */}
                    <tr className="bg-gray-800 text-white font-semibold">
                      <td className="p-2" colSpan={2}>TOTALE GRUPPO</td>
                      <td className="p-2 text-right font-mono">{fmtK(totRicavi)}</td>
                      <td className="p-2 text-right font-mono">{fmtK(totCostiDiretti)}</td>
                      <td className="p-2 text-right font-mono">{fmtK(totMolI)}</td>
                      <td className="p-2 text-center">{fmtPct(totMolIPct)}</td>
                      <td className="p-2 text-right font-mono">{fmtK(totCostiSede)}</td>
                      <td className="p-2 text-right font-mono">{fmtK(totMolG)}</td>
                      <td className="p-2 text-center">{fmtPct(totMolGPct)}</td>
                      <td className="p-2 text-center">49,7%</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <p className="text-xs text-gray-400 mt-2">Clicca su una riga per il dettaglio UO</p>
            </div>

            {/* Costi Sede Breakdown */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
              <div className="bg-white rounded-xl shadow p-4">
                <h3 className="text-sm font-semibold text-gray-700 mb-3">Composizione Costi Sede (â‚¬2,28M)</h3>
                <ResponsiveContainer width="100%" height={220}>
                  <PieChart>
                    <Pie data={costiSedeBreakdown} cx="50%" cy="50%" outerRadius={80} dataKey="valore"
                      label={({ nome, valore }) => `${nome}: ${fmtK(valore)}`}>
                      {costiSedeBreakdown.map((e, i) => <Cell key={i} fill={e.colore} />)}
                    </Pie>
                    <Tooltip formatter={(v) => fmt(v)} />
                  </PieChart>
                </ResponsiveContainer>
                <div className="text-xs text-gray-500 text-center">
                  Allocabili: â‚¬1.592k | Non allocabili: â‚¬403k (Sviluppo + Storici)
                </div>
              </div>

              <div className="bg-white rounded-xl shadow p-4">
                <h3 className="text-sm font-semibold text-gray-700 mb-3">Margini per UO</h3>
                <ResponsiveContainer width="100%" height={220}>
                  <BarChart data={uoDati.map(uo => ({
                    nome: uo.codice,
                    'MOL-I %': +(uo.molIPct * 100).toFixed(1),
                    'MOL-G %': +(uo.molGPct * 100).toFixed(1)
                  }))} margin={{ top: 10, right: 20, left: 10, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="nome" fontSize={12} />
                    <YAxis unit="%" fontSize={10} />
                    <Tooltip formatter={(v) => `${v}%`} />
                    <Legend />
                    <Bar dataKey="MOL-I %" fill="#10b981" />
                    <Bar dataKey="MOL-G %" fill="#3b82f6" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>
          </>
        )}

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CE INDUSTRIALE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {vistaCorrente === 'ce' && (
          <div className="bg-white rounded-xl shadow p-4 mb-6">
            <h3 className="text-sm font-semibold text-gray-700 mb-4">Conto Economico Industriale â€” Anno 2025</h3>
            <div className="overflow-x-auto">
              <table className="w-full text-xs font-mono">
                <thead>
                  <tr className="bg-gray-800 text-white">
                    <th className="p-2 text-left" style={{minWidth: '200px'}}>Voce</th>
                    {uoDati.map(uo => <th key={uo.codice} className="p-2 text-right" style={{minWidth: '90px'}}>{uo.codice}</th>)}
                    <th className="p-2 text-right font-bold" style={{minWidth: '100px'}}>TOTALE</th>
                  </tr>
                </thead>
                <tbody>
                  {/* RICAVI */}
                  <tr className="bg-blue-50 font-semibold">
                    <td className="p-2" colSpan={7}>RICAVI</td>
                  </tr>
                  {[
                    { cod: 'R01', voce: 'Convenzione SSN/ASP - Degenza', vals: [1845916, 1811515, 2901765, 0, 582468] },
                    { cod: 'R02', voce: 'Convenzione SSN/ASP - Ambulat.', vals: [0, 0, 366230, 0, 0] },
                    { cod: 'R03', voce: 'Convenzione SSN/ASP - Lab', vals: [0, 0, 0, 1140319, 0] },
                    { cod: 'R04', voce: 'Privati - Degenza', vals: [91939, 54502, 232898, 0, 87988] },
                    { cod: 'R05', voce: 'Privati - Comfort', vals: [35551, 0, 88105, 0, 0] },
                    { cod: 'R06', voce: 'Privati - Ambulat./Lab', vals: [0, 0, 180302, 291900, 0] },
                    { cod: 'R07', voce: 'Altri ricavi', vals: [30638, 29630, 29879, 17934, 29804] }
                  ].map(r => (
                    <tr key={r.cod} className="border-b hover:bg-gray-50">
                      <td className="p-2 text-gray-600">{r.cod} â€” {r.voce}</td>
                      {r.vals.map((v, i) => (
                        <td key={i} className="p-2 text-right">{v > 0 ? fmtK(v) : 'â€”'}</td>
                      ))}
                      <td className="p-2 text-right font-semibold">{fmtK(r.vals.reduce((a,b) => a+b, 0))}</td>
                    </tr>
                  ))}
                  <tr className="bg-blue-100 font-bold border-b-2 border-blue-300">
                    <td className="p-2">TOTALE RICAVI</td>
                    {uoDati.map(uo => <td key={uo.codice} className="p-2 text-right">{fmtK(uo.ricavi)}</td>)}
                    <td className="p-2 text-right">{fmtK(totRicavi)}</td>
                  </tr>

                  {/* COSTI */}
                  <tr className="bg-red-50 font-semibold"><td className="p-2" colSpan={7}>COSTI DIRETTI</td></tr>
                  {[
                    { voce: 'Personale', vals: uoDati.map(uo => uo.personale) },
                    { voce: '  di cui Medici', vals: uoDati.map(uo => uo.dettaglioCosti.medici || 0), sub: true },
                    { voce: '  di cui Infermieri', vals: uoDati.map(uo => uo.dettaglioCosti.infermieri || 0), sub: true },
                    { voce: '  di cui OSS', vals: uoDati.map(uo => uo.dettaglioCosti.oss || 0), sub: true },
                    { voce: 'Farmaci e presidi', vals: uoDati.map(uo => uo.dettaglioCosti.farmaci || 0) },
                    { voce: 'Mat. diagnostico', vals: uoDati.map(uo => uo.dettaglioCosti.diagnostico || 0) },
                    { voce: 'Vitto', vals: uoDati.map(uo => uo.dettaglioCosti.vitto || 0) },
                    { voce: 'Servizi (lav+pul+man+ut)', vals: uoDati.map(uo =>
                      (uo.dettaglioCosti.lavanderia||0) + (uo.dettaglioCosti.pulizie||0) +
                      (uo.dettaglioCosti.manutenzioni||0) + (uo.dettaglioCosti.utenze||0)) },
                    { voce: 'Consulenze sanitarie', vals: uoDati.map(uo => uo.dettaglioCosti.consulenze || 0) },
                    { voce: 'Ammortamenti', vals: uoDati.map(uo => uo.dettaglioCosti.ammortamenti || 0) }
                  ].map((r, idx) => (
                    <tr key={idx} className={`border-b hover:bg-gray-50 ${r.sub ? 'text-gray-400' : ''}`}>
                      <td className={`p-2 ${r.sub ? 'pl-6 text-gray-400 italic' : 'text-gray-600'}`}>{r.voce}</td>
                      {r.vals.map((v, i) => (
                        <td key={i} className="p-2 text-right text-red-600">{v > 0 ? fmtK(v) : 'â€”'}</td>
                      ))}
                      <td className="p-2 text-right font-semibold text-red-700">{fmtK(r.vals.reduce((a,b) => a+b, 0))}</td>
                    </tr>
                  ))}
                  <tr className="bg-red-100 font-bold border-b-2 border-red-300">
                    <td className="p-2">TOTALE COSTI DIRETTI</td>
                    {uoDati.map(uo => <td key={uo.codice} className="p-2 text-right text-red-700">{fmtK(uo.costiDiretti)}</td>)}
                    <td className="p-2 text-right text-red-700">{fmtK(totCostiDiretti)}</td>
                  </tr>

                  {/* MOL-I */}
                  <tr className="bg-green-100 font-bold text-base border-b-2 border-green-400">
                    <td className="p-2">MOL INDUSTRIALE</td>
                    {uoDati.map(uo => (
                      <td key={uo.codice} className={`p-2 text-right ${uo.molI >= 0 ? 'text-green-700' : 'text-red-600'}`}>
                        {fmtK(uo.molI)}
                      </td>
                    ))}
                    <td className="p-2 text-right text-green-700">{fmtK(totMolI)}</td>
                  </tr>
                  <tr className="bg-green-50">
                    <td className="p-2 text-gray-500">Margine %</td>
                    {uoDati.map(uo => (
                      <td key={uo.codice} className="p-2 text-right text-green-600 font-semibold">
                        {fmtPct(uo.molIPct)}
                      </td>
                    ))}
                    <td className="p-2 text-right text-green-700 font-bold">{fmtPct(totMolIPct)}</td>
                  </tr>

                  {/* SEDE */}
                  <tr className="bg-purple-50 font-semibold"><td className="p-2" colSpan={7}>COSTI SEDE ALLOCATI</td></tr>
                  <tr className="border-b">
                    <td className="p-2 text-gray-600">Allocazione sede</td>
                    {uoDati.map(uo => <td key={uo.codice} className="p-2 text-right text-purple-600">{fmtK(uo.costiSede)}</td>)}
                    <td className="p-2 text-right text-purple-700 font-semibold">{fmtK(totCostiSede)}</td>
                  </tr>

                  {/* MOL-G */}
                  <tr className="bg-gray-800 text-white font-bold text-base">
                    <td className="p-2">MOL GESTIONALE</td>
                    {uoDati.map(uo => (
                      <td key={uo.codice} className={`p-2 text-right ${uo.molG >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                        {fmtK(uo.molG)}
                      </td>
                    ))}
                    <td className={`p-2 text-right ${totMolG >= 0 ? 'text-green-300' : 'text-red-300'}`}>{fmtK(totMolG)}</td>
                  </tr>
                  <tr className="bg-gray-700 text-white">
                    <td className="p-2 text-gray-300">Margine %</td>
                    {uoDati.map(uo => (
                      <td key={uo.codice} className={`p-2 text-right ${uo.molGPct >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                        {fmtPct(uo.molGPct)}
                      </td>
                    ))}
                    <td className={`p-2 text-right font-bold ${totMolGPct >= 0 ? 'text-green-300' : 'text-red-300'}`}>{fmtPct(totMolGPct)}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• KPI SEMAFORI â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {vistaCorrente === 'kpi' && (
          <div className="space-y-4 mb-6">
            <div className="bg-white rounded-xl shadow p-4">
              <h3 className="text-sm font-semibold text-gray-700 mb-4">KPI con Semafori â€” Anno 2025</h3>

              {/* KPI per UO */}
              {['VLB','CTA','COS','LAB','KCP'].map(codUO => {
                const uo = uoDati.find(u => u.codice === codUO);
                const kpis = kpiData.filter(k => k.uo === codUO);
                return (
                  <div key={codUO} className="mb-4">
                    <h4 className="text-xs font-bold text-gray-800 mb-2 bg-gray-100 p-2 rounded">
                      {uo.codice} â€” {uo.nome} ({uo.tipo})
                    </h4>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                      {kpis.map((k, i) => (
                        <div key={i} className={`p-3 rounded-lg border-l-4 ${
                          k.alert === 'ROSSO' ? 'border-red-500 bg-red-50' :
                          k.alert === 'GIALLO' ? 'border-yellow-500 bg-yellow-50' :
                          'border-green-500 bg-green-50'
                        }`}>
                          <p className="text-xs text-gray-500">{k.kpi}</p>
                          <p className="text-lg font-bold" style={{color: alertColor(k.alert)}}>
                            {fmtPct(k.valore)}
                          </p>
                          <p className="text-xs text-gray-400">Target: {fmtPct(k.target)}</p>
                          <span className={`text-xs px-1.5 py-0.5 rounded-full ${alertBg(k.alert)}`}>
                            {alertIcon(k.alert)} {k.alert}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}

              {/* KPI Gruppo */}
              <div className="mt-4 border-t-2 border-gray-300 pt-4">
                <h4 className="text-xs font-bold text-gray-800 mb-2 bg-gray-800 text-white p-2 rounded">
                  GRUPPO KAROL â€” KPI Consolidati
                </h4>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                  {kpiData.filter(k => k.uo === 'GRUPPO').map((k, i) => (
                    <div key={i} className={`p-4 rounded-lg border-l-4 ${
                      k.alert === 'ROSSO' ? 'border-red-500 bg-red-50' :
                      k.alert === 'GIALLO' ? 'border-yellow-500 bg-yellow-50' :
                      'border-green-500 bg-green-50'
                    }`}>
                      <p className="text-xs text-gray-500">{k.kpi}</p>
                      <p className="text-2xl font-bold" style={{color: alertColor(k.alert)}}>
                        {fmtPct(k.valore)}
                      </p>
                      <p className="text-xs text-gray-400">Target: {fmtPct(k.target)}</p>
                      <span className={`text-xs px-2 py-1 rounded-full ${alertBg(k.alert)}`}>
                        {alertIcon(k.alert)} {k.alert}
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TREND MENSILE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {vistaCorrente === 'trend' && (
          <div className="space-y-4 mb-6">
            {/* Trend aggregato */}
            <div className="bg-white rounded-xl shadow p-4">
              <h3 className="text-sm font-semibold text-gray-700 mb-3">Trend Ricavi vs Costi â€” Gruppo (12 Mesi)</h3>
              <ResponsiveContainer width="100%" height={300}>
                <LineChart data={trendMensile} margin={{ top: 10, right: 20, left: 10, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="mese" fontSize={11} />
                  <YAxis tickFormatter={(v) => fmtK(v)} fontSize={10} />
                  <Tooltip formatter={(v) => fmt(v)} />
                  <Legend />
                  <Line type="monotone" dataKey="Ricavi" stroke="#1F4E79" strokeWidth={2} dot={false} />
                  <Line type="monotone" dataKey="Costi" stroke="#ef4444" strokeWidth={2} dot={false} />
                  <Line type="monotone" dataKey="MOL_I" stroke="#10b981" strokeWidth={2} strokeDasharray="5 5" dot={false} />
                </LineChart>
              </ResponsiveContainer>
            </div>

            {/* Trend per singola UO */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {uoDati.map(uo => {
                const data = mesi.map((m, i) => ({
                  mese: m,
                  Ricavi: uo.ricaviMensili[i],
                  Costi: uo.costiMensili[i],
                  MOL: uo.ricaviMensili[i] - uo.costiMensili[i]
                }));
                return (
                  <div key={uo.codice} className="bg-white rounded-xl shadow p-3">
                    <h4 className="text-xs font-semibold text-gray-700 mb-2">
                      {uo.codice} â€” {uo.tipo}
                      <span className={`ml-2 px-1.5 py-0.5 rounded-full text-xs ${
                        uo.molGPct >= 0.08 ? 'bg-green-100 text-green-700' :
                        uo.molGPct >= 0 ? 'bg-yellow-100 text-yellow-700' :
                        'bg-red-100 text-red-700'
                      }`}>MOL-G {fmtPct(uo.molGPct)}</span>
                    </h4>
                    <ResponsiveContainer width="100%" height={160}>
                      <LineChart data={data} margin={{ top: 5, right: 10, left: 0, bottom: 5 }}>
                        <XAxis dataKey="mese" fontSize={9} tick={{fill: '#999'}} />
                        <YAxis tickFormatter={(v) => `${(v/1000).toFixed(0)}k`} fontSize={9} width={40} />
                        <Tooltip formatter={(v) => fmt(v)} />
                        <Line type="monotone" dataKey="Ricavi" stroke="#1F4E79" strokeWidth={1.5} dot={false} />
                        <Line type="monotone" dataKey="Costi" stroke="#ef4444" strokeWidth={1.5} dot={false} />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL DETTAGLIO UO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {uoSelezionata && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => setUoSelezionata(null)}>
            <div className="bg-white rounded-xl p-6 max-w-3xl w-full mx-4 max-h-screen overflow-y-auto" onClick={e => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-bold text-gray-900">
                  {uoSelezionata.codice} â€” {uoSelezionata.nome}
                </h3>
                <button onClick={() => setUoSelezionata(null)} className="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
              </div>

              {/* Info principali */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                <div className="bg-blue-50 p-3 rounded-lg text-center">
                  <p className="text-xs text-gray-500">Ricavi</p>
                  <p className="text-lg font-bold text-blue-700">{fmtK(uoSelezionata.ricavi)}</p>
                </div>
                <div className="bg-green-50 p-3 rounded-lg text-center">
                  <p className="text-xs text-gray-500">MOL-I</p>
                  <p className="text-lg font-bold text-green-600">{fmtK(uoSelezionata.molI)} ({fmtPct(uoSelezionata.molIPct)})</p>
                </div>
                <div className={`p-3 rounded-lg text-center ${uoSelezionata.molG >= 0 ? 'bg-green-50' : 'bg-red-50'}`}>
                  <p className="text-xs text-gray-500">MOL-G</p>
                  <p className={`text-lg font-bold ${uoSelezionata.molG >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    {fmtK(uoSelezionata.molG)} ({fmtPct(uoSelezionata.molGPct)})
                  </p>
                </div>
                <div className="bg-gray-50 p-3 rounded-lg text-center">
                  <p className="text-xs text-gray-500">Tipo / PL</p>
                  <p className="text-lg font-bold text-gray-700">{uoSelezionata.tipo}</p>
                  <p className="text-xs text-gray-500">{uoSelezionata.postiLetto > 0 ? `${uoSelezionata.postiLetto} posti letto` : 'No degenza'}</p>
                </div>
              </div>

              {/* KPI UO */}
              <div className="mb-4">
                <h4 className="text-xs font-semibold text-gray-600 mb-2">KPI</h4>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                  {kpiData.filter(k => k.uo === uoSelezionata.codice).map((k, i) => (
                    <div key={i} className={`p-2 rounded border-l-3 ${
                      k.alert === 'ROSSO' ? 'border-l-red-500 bg-red-50' :
                      k.alert === 'GIALLO' ? 'border-l-yellow-500 bg-yellow-50' :
                      'border-l-green-500 bg-green-50'
                    }`} style={{borderLeftWidth: '3px'}}>
                      <p className="text-xs text-gray-500">{k.kpi}</p>
                      <p className="text-sm font-bold" style={{color: alertColor(k.alert)}}>{fmtPct(k.valore)}</p>
                      <p className="text-xs text-gray-400">vs {fmtPct(k.target)} {alertIcon(k.alert)}</p>
                    </div>
                  ))}
                </div>
              </div>

              {/* Trend UO */}
              <div>
                <h4 className="text-xs font-semibold text-gray-600 mb-2">Trend Mensile</h4>
                <ResponsiveContainer width="100%" height={200}>
                  <LineChart data={mesi.map((m, i) => ({
                    mese: m,
                    Ricavi: uoSelezionata.ricaviMensili[i],
                    Costi: uoSelezionata.costiMensili[i]
                  }))} margin={{ top: 5, right: 20, left: 10, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="mese" fontSize={10} />
                    <YAxis tickFormatter={(v) => fmtK(v)} fontSize={10} />
                    <Tooltip formatter={(v) => fmt(v)} />
                    <Legend />
                    <Line type="monotone" dataKey="Ricavi" stroke="#1F4E79" strokeWidth={2} />
                    <Line type="monotone" dataKey="Costi" stroke="#ef4444" strokeWidth={2} />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </div>
          </div>
        )}

        {/* Footer */}
        <div className="text-center text-xs text-gray-400 mt-6 pb-4">
          Karol S.p.A. â€” Controllo di Gestione | Dati simulati per test pipeline | Elaborazione: elabora.py v1.0
        </div>

      </div>
    </div>
  );
};

export default KarolCdGDashboard;