<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Karol CdG ‚Äî Controllo di Gestione</title>
<script type="importmap">
{"imports":{"react":"https://esm.sh/react@18.2.0","react-dom":"https://esm.sh/react-dom@18.2.0","react/jsx-runtime":"https://esm.sh/react@18.2.0/jsx-runtime","recharts":"https://esm.sh/recharts@2.12.7?external=react,react-dom"}}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script type="module">
import React, { useState } from 'react';
import ReactDOM from 'react-dom';
import * as Recharts from 'recharts';
window.React = React;
window.ReactDOM = ReactDOM;
window.Recharts = Recharts;
const s = document.querySelector('script[data-type="babel-source"]');
if (s) { const c = Babel.transform(s.textContent, {presets:['react']}).code; new Function(c)(); }
</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'DM Sans', 'Segoe UI', sans-serif; background: #F0F4F8; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/template" data-type="babel-source">
const { useState } = React;
const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LineChart, Line, Legend, AreaChart, Area, Cell, ReferenceLine, ComposedChart, PieChart, Pie, Treemap } = Recharts;

// ============================================================================
// PALETTE COLORI KAROL ‚Äî D1
// ============================================================================
const C = {
  primario: '#1F4E79', primarioChiaro: '#2E75B6', primarioScuro: '#163A5C',
  sfondo: '#F0F4F8', card: '#FFFFFF', bordo: '#e2e8f0',
  verde: '#059669', verdeBg: '#dcfce7', verdeChiaro: '#10b981',
  giallo: '#d97706', gialloBg: '#fef9c3', gialloChiaro: '#f59e0b',
  rosso: '#dc2626', rossoBg: '#fee2e2', rossoChiaro: '#ef4444',
  viola: '#7c3aed', violaBg: '#ede9fe',
  VLB: '#0ea5e9', CTA: '#3b82f6', COS: '#8b5cf6', LAB: '#f59e0b', KCP: '#ec4899',
  budget: '#cbd5e1', t1: '#1e293b', t2: '#64748b', t3: '#94a3b8',
};

// ============================================================================
// KAROL_DATA ‚Äî Struttura centralizzata dati CdG
// ============================================================================
const KAROL_DATA = {
  meta: { anno: 2025, mesi_chiusi: 3, dati_reali: true, ultimo_aggiornamento: '14/02/2026',
    fonte: 'CE Q1 31/03/2025 + HR Zucchetti Q1 + Bilancio SPA/Consolidato 2024 + Provvisorio 8M 31/08/2025', metodo_ann: 'Q1√ó4 con rettifiche da FY2024' },

  // Benchmark settore RSA/Healthcare
  BENCHMARK: {
    pers_pct: 0.55, mol_i_pct: 0.15, mol_g_pct: 0.08,
    occ_pct: 0.90, costo_pl_gg: 130, dso: 60, dpo: 90, dscr: 1.2, cop_cassa_mesi: 2.0,
  },

  // Unit√† Operative ‚Äî DATI REALI Q1 2025 annualizzati (√ó4)
  // Personale: fonte HR Zucchetti (pi√π completo di CE C1=67, include TFR/INAIL/mensilit√† agg.)
  // Altri costi: fonte CE DARE per C1 (materiali=55, servizi=57+59+61+63, utenze=65, altri=71)
  // Ricavi: fonte CE AVERE (incl. convenzionato + privato + ambulatori + adeguamenti)
  // LAB: fuori perimetro gruppo, riportata separatamente
  UO: [
    { cod: 'VLB', nome: 'RSA Villabate', tipo: 'RSA Alzheimer', pl: 44, colore: C.VLB,
      ricavi: 2632599, budget_ricavi: 2632599, // Q1 658.150 √ó 4
      costi: { personale: 1971012, materiali: 22552, servizi: 224063, utenze: 219307, manutenzione: 0, altri: 3315 },
      budget_costi: { personale: 1971012, materiali: 22552, servizi: 224063, utenze: 219307, manutenzione: 0, altri: 3315 },
      sede: 0, ammortamenti: 214000, oneri_fin: 514, // D&A allocata pro-rata ricavi (24% di ‚Ç¨893k)
      // NOTA: VLB include personale Centro Gottardo (FKT ~‚Ç¨40k fatture), cucina, trasporto disabili
      occ: 0.900, gg_degenza: 14454,
      rM: [227327, 204228, 226594],
      cM: [155958, 173522, 163273],
    },
    { cod: 'CTA', nome: 'CTA Ex Stagno', tipo: 'Psichiatrico', pl: 40, colore: C.CTA,
      ricavi: 2817347, budget_ricavi: 2817347, // Q1 704.337 √ó 4
      costi: { personale: 1668136, materiali: 20355, servizi: 194451, utenze: 4820, manutenzione: 0, altri: 302 },
      budget_costi: { personale: 1668136, materiali: 20355, servizi: 194451, utenze: 4820, manutenzione: 0, altri: 302 },
      sede: 0, ammortamenti: 229000, oneri_fin: 465, // D&A allocata pro-rata ricavi (26% di ‚Ç¨893k)
      // NOTA: include adeguamento CTA ‚Ç¨640k/anno ‚Äî contenzioso Regione ‚Ç¨7M+ in risoluzione
      occ: 0.920, gg_degenza: 13432,
      rM: [244596, 222658, 237082],
      cM: [134740, 141514, 140780],
    },
    { cod: 'COS', nome: 'CdC Cosentino', tipo: 'Riabilitazione', pl: 50, colore: C.COS,
      ricavi: 4860598, budget_ricavi: 4860598, // Q1 1.215.149 √ó 4
      costi: { personale: 2092806, materiali: 1231668, servizi: 626943, utenze: 88474, manutenzione: 0, altri: 14598 },
      budget_costi: { personale: 2092806, materiali: 1231668, servizi: 626943, utenze: 88474, manutenzione: 0, altri: 14598 },
      sede: 0, ammortamenti: 395000, oneri_fin: 5461, // D&A allocata pro-rata ricavi (44% di ‚Ç¨893k)
      // NOTA: estate non opera ‚Äî calo fatturato privato Q2-Q3
      occ: 0.860, gg_degenza: 15695,
      rM: [348508, 423023, 443618],
      cM: [176692, 168717, 177792],
    },
    { cod: 'KCP', nome: 'Karol Casa Protetta', tipo: 'Casa Protetta', pl: 20, colore: C.KCP,
      ricavi: 664941, budget_ricavi: 664941, // Q1 166.235 √ó 4
      costi: { personale: 527070, materiali: 16484, servizi: 62787, utenze: 0, manutenzione: 0, altri: 32 },
      budget_costi: { personale: 527070, materiali: 16484, servizi: 62787, utenze: 0, manutenzione: 0, altri: 32 },
      sede: 0, ammortamenti: 55000, oneri_fin: 4, // D&A allocata pro-rata ricavi (6% di ‚Ç¨893k)
      // NOTA: brucia ‚Ç¨300k+/anno ‚Äî piano chiusura e spostamento 40 PL a BRT
      occ: null, gg_degenza: 7300,
      rM: [57768, 54536, 53932],
      cM: [42490, 45721, 43557],
    },
  ],

  // LAB ‚Äî Fuori perimetro gruppo, monitoraggio separato
  LAB: {
    cod: 'LAB', nome: 'Karol Lab', tipo: 'Laboratorio Controllata',
    ricavi_q1: 0, costi_q1_personale: 39443, costi_q1_ce: 34525,
    nota: 'Azienda controllata ‚Äî non inclusa nei totali di gruppo. Costo personale HR Q1: ‚Ç¨39.443, costo CE Q1: ‚Ç¨34.525. Nessun ricavo attribuito nel CE Q1.',
  },

  // Costi sede HQ ‚Äî da CE Div.18 √ó 4
  // Personale HQ da HR Zucchetti: ‚Ç¨292.951 Q1 ‚Üí ‚Ç¨1.171.805 FY
  SEDE: { totale: 2335144, personale_hq: 1171805, affitti: 92861, consulenze: 811812, IT: 0, assicurazioni: 0, altri: 165619,
    oneri_fin: 91009, imposte: 68239,
    ricavi_hq: 208790, // CE AVERE Div.18 √ó 4 (proventi finanziari, sopravvenienze)
    nota: 'Totale costi HQ Q1 ‚Ç¨583.786 √ó 4. Include: personale ‚Ç¨1.172k, consulenze/servizi ‚Ç¨812k, altri oneri ‚Ç¨166k, affitti ‚Ç¨93k, oneri fin. ‚Ç¨91k, imposte ‚Ç¨68k.' },

  // Cash Flow
  cashflow: {
    // Waterfall calcolato da dati reali Q1√ó4 ‚Äî BU operative (escluso LAB)
    // Ricavi BU: 10.975.485 | Personale BU: 6.259.024 | Mat: 1.291.059 | Servizi: 1.108.244 | Utenze: 312.601 | Altri: 18.247
    // MOL-I BU: 1.986.310 | Sede HQ: 2.335.144 | MOL-G: -348.834
    waterfallRaw: [
      { voce: 'Ricavi BU', valore: 10975485, tipo: 'entrata' },
      { voce: 'Personale', valore: -6259024, tipo: 'uscita' },
      { voce: 'Materiali', valore: -1291059, tipo: 'uscita' },
      { voce: 'Servizi', valore: -1108244, tipo: 'uscita' },
      { voce: 'Utenze/Affitti', valore: -312601, tipo: 'uscita' },
      { voce: 'Altri Costi', valore: -18247, tipo: 'uscita' },
      { voce: 'MOL-I BU', valore: 1986310, tipo: 'subtotale' },
      { voce: 'Proventi HQ', valore: 208790, tipo: 'entrata' },
      { voce: 'Costi Sede', valore: -2335144, tipo: 'uscita' },
      { voce: 'MOL-G', valore: -140044, tipo: 'subtotale' },
      { voce: 'D&A (FY24)', valore: -893000, tipo: 'uscita' },
      { voce: 'Oneri Fin.', valore: -268000, tipo: 'uscita' },
      { voce: 'Imposte', valore: -68239, tipo: 'uscita' },
      { voce: 'EBIT', valore: -1369283, tipo: 'finale' },
    ],
    cassaSett: [
      { s: 'S1', saldo: 420, incassi: 180, pag: 150 }, { s: 'S2', saldo: 390, incassi: 120, pag: 150 },
      { s: 'S3', saldo: 340, incassi: 100, pag: 150 }, { s: 'S4', saldo: 510, incassi: 320, pag: 150 },
      { s: 'S5', saldo: 460, incassi: 100, pag: 150 }, { s: 'S6', saldo: 380, incassi: 70, pag: 150 },
      { s: 'S7', saldo: 290, incassi: 60, pag: 150 },  { s: 'S8', saldo: 240, incassi: 100, pag: 150 },
      { s: 'S9', saldo: 210, incassi: 120, pag: 150 },  { s: 'S10', saldo: 180, incassi: 120, pag: 150 },
      { s: 'S11', saldo: 350, incassi: 320, pag: 150 }, { s: 'S12', saldo: 400, incassi: 200, pag: 150 },
    ],
    scenari: [
      // Scenari cassa: base = mutuo 10yr 4,5% + ramp-up BRT giu26 + taglio costi 10%
      // ottimistico = base + CTA contenzioso ‚Ç¨7M + ZES ‚Ç¨550k + ramp-up rapido Roma
      // pessimistico = ritardo mutuo 6M + no CTA rinnovo + ramp-up Roma 18M
      { anno: '2025', ott: 350, base: 230, pess: 80 },
      { anno: '2026', ott: 1200, base: 650, pess: -100 }, // Mutuo H1 2026 + BRT apertura
      { anno: '2027', ott: 1800, base: 900, pess: -350 }, // DSCR critico, ramp-up
      { anno: '2028', ott: 2400, base: 1300, pess: -200 }, // BU a regime progressivo
      { anno: '2029', ott: 3200, base: 1800, pess: 100 },  // Consolidamento
      { anno: '2030', ott: 4100, base: 2500, pess: 500 },  // Target ‚Ç¨30M+ ricavi gruppo
    ],
    kpi: { dso: 50, dpo: 75, dscr: 0.95, cop_cassa: 0.8, ccn: -2100000, capex: 2300000, debito_annuo: 890000 },
    // NOTA: DSCR <1.0 nel 2027-28 √® il "passaggio stretto" ‚Äî mutuo 10yr con preammortamento + crediti fiscali + CTA settlement = mitigazione
    // Scadenziario crediti/debiti (simulato)
    scadenziario: {
      crediti: [
        { fascia: '0-30 gg', importo: 380000, pct: 0.31 },
        { fascia: '31-60 gg', importo: 420000, pct: 0.34 },
        { fascia: '61-90 gg', importo: 285000, pct: 0.23 },
        { fascia: '> 90 gg', importo: 145000, pct: 0.12 },
      ],
      debiti: [
        { fascia: '0-30 gg', importo: 210000, pct: 0.27 },
        { fascia: '31-60 gg', importo: 290000, pct: 0.37 },
        { fascia: '61-90 gg', importo: 185000, pct: 0.24 },
        { fascia: '> 90 gg', importo: 95000, pct: 0.12 },
      ],
      totCrediti: 1230000,
      totDebiti: 780000,
    },
  },

  narrative: [
    { uo: 'VLB', alert: 'ROSSO', testo: 'Personale 74,9% dei ricavi ‚Äî include personale Centro Gottardo (FKT, ~‚Ç¨40k fatture attive), cucina centralizzata e trasporto disabili allocati impropriamente. Affitto ‚Ç¨219k da proprietario rigido. Piano strategico: spostare i 40 PL convenzionati al Borgo Ritrovato (nuova BU giugno 2026) per risparmiare locazione e razionalizzare personale.', outlook: 'In ristrutturazione ‚Äî migrazione a BRT prevista H2 2026' },
    { uo: 'CTA', alert: 'GIALLO', testo: 'Miglior MOL-I % del gruppo (33%). Include adeguamento tariffario CTA ‚Ç¨640k/anno. Contenzioso con Regione per ‚Ç¨7M+ di crediti in bilancio ‚Äî transazione imminente ("fra pochi giorni"). Se confermata: game-changer per liquidit√† gruppo. Rischio residuo: se adeguamento non rinnovato, MOL-I crolla al 10%.', outlook: 'In attesa transazione regionale ‚Äî alto impatto' },
    { uo: 'COS', alert: 'VERDE', testo: 'Top performer per volumi: ricavi FY stimati ‚Ç¨4,86M. MOL-I 16,5%. Estate non opera: calo fatturato privato Q2-Q3 spiega parte del deterioramento MOL 8M. Materiali elevati (‚Ç¨1,23M) per attivit√† chirurgica/riabilitativa. Personale 43,1% ‚Äî il migliore del gruppo.', outlook: 'Favorevole ‚Äî attenzione stagionalit√† estiva' },
    { uo: 'KCP', alert: 'ROSSO', testo: 'Casa Protetta 20 PL brucia ‚Ç¨300k+/anno. Personale 79,3% dei ricavi ‚Äî insostenibile per diseconomie di scala. Piano: chiusura e spostamento PL al Borgo Ritrovato, con razionalizzazione personale e risparmio su costi fissi.', outlook: 'In chiusura ‚Äî migrazione PL a BRT' },
    { uo: 'GRUPPO', alert: 'ROSSO', testo: 'MOL-I BU ‚Ç¨1,99M (18,1%) sopra benchmark, ma Sede HQ ‚Ç¨2,34M (21,3%) + D&A ‚Ç¨893k + Oneri Fin. ‚Ç¨268k portano l\'EBIT a -‚Ç¨1,37M. Crescita storica a debito + COVID + gestione paternalistica (eccesso personale). Normalizzando il bilancio 2024 (senza ‚Ç¨1,26M interessi ASP straordinari): perdita operativa reale ~‚Ç¨800k. Target management: -10% costi per superare DSCR critico 2027-28. Strumento: mutuo bancario 10yr (non Bond) + crediti fiscali innovazione/patent box + transazione CTA ‚Ç¨7M.', outlook: 'Critico ‚Äî passaggio stretto 2027-28, piano di rientro in corso' },
  ],

  // ====== PIANO FINANZIARIO ‚Äî Nuove BU e struttura debito ======
  piano: {
    // Mutuo bancario (sostituisce Bond)
    mutuo: { importo: 5000000, durata_anni: 10, tasso: 0.045, preammortamento_mesi: 12, rata_annua: 620000, data_stima_erogazione: 'H1 2026' },
    // MCC Medio Credito Centrale
    mcc: { importo: 5000000, durata_anni: 8, tasso: 0.035, garanzia_pubblica: true, rata_annua: 700000 },
    // Debiti in rientro
    debiti_rientro: {
      tributari: { totale: 8780000, di_cui_rottamazione: 'da quantificare', rata_annua_stima: 1200000 },
      previdenziali: { totale: 5750000, rata_annua_stima: 800000 },
      // Scadenziario dettagliato: IN ATTESA dati dal management
    },
    // Nuove BU
    nuove_bu: [
      { cod: 'BRT', nome: 'Borgo Ritrovato', tipo: 'RSA Alzheimer', pl: 60, regione: 'Sicilia (Palermo)',
        capex_residuo: 800000, ricavi_regime: 3500000, apertura_stima: 'Giugno 2026', ramp_up_mesi: 4,
        nota: 'Rischio basso ‚Äî domanda altissima, liste attesa. Assorbir√† 40 PL da VLB.' },
      { cod: 'KMC', nome: 'Karol Medical Center', tipo: 'Day Surgery/Ambulatorio', pl: 20, regione: 'Sicilia (Palermo)',
        capex_residuo: 500000, ricavi_regime: 2000000, apertura_stima: 'Q4 2026', ramp_up_mesi: 9,
        nota: 'Rischio medio-alto ‚Äî primo approccio mercato privato, serve referral network.' },
      { cod: 'ROM', nome: 'RSA Roma Santa Margherita', tipo: 'RSA', pl: 77, regione: 'Lazio',
        capex_residuo: 1000000, ricavi_regime: 4500000, apertura_stima: 'Q1 2027', ramp_up_mesi: 12,
        nota: 'Pre-accreditamento solido, 2-3 mesi post-lavori. Prima presenza fuori Sicilia.' },
    ],
    // Crediti attesi (non nel CE operativo)
    crediti_attesi: {
      cta_contenzioso: { importo: 7000000, probabilita: 'alta', tempistica: 'imminente' },
      crediti_fiscali: { importo: 1500000, tipo: 'innovazione + patent box', stato: 'in certificazione (studio Roma)' },
      zes_unica: { importo: 550000, finestra: 'marzo-maggio 2026', nel_bp: false },
    },
    // Obiettivi
    target: { riduzione_costi_pct: 0.10, ricavi_2027: 18600000, ebitda_target_pct: 0.14 },
  },
};

// ============================================================================
// COMPUTED ‚Äî Aggregati calcolati da KAROL_DATA
// ============================================================================
const D = KAROL_DATA;
const UO = D.UO;
const BENCH = D.BENCHMARK;

// Helper costi totali per UO
const costiTot = u => Object.values(u.costi).reduce((s, v) => s + v, 0);
const budgetCostiTot = u => Object.values(u.budget_costi).reduce((s, v) => s + v, 0);

// Calcola MOL-I, MOL-G, margini per ogni UO
UO.forEach(u => {
  u.costiDir = costiTot(u);
  u.molI = u.ricavi - u.costiDir;
  u.molIPct = u.ricavi > 0 ? u.molI / u.ricavi : 0;
  u.molG = u.molI - u.sede;
  u.molGPct = u.ricavi > 0 ? u.molG / u.ricavi : 0;
  u.persPct = u.ricavi > 0 ? u.costi.personale / u.ricavi : 0;
  u.ricGg = u.gg_degenza ? u.ricavi / u.gg_degenza : null;
  u.costo_pl_gg = (u.pl && u.gg_degenza) ? u.costiDir / u.gg_degenza : null;
  // EBIT (risultato operativo)
  u.ebit = u.molG - u.ammortamenti - u.oneri_fin;
  // Budget delta
  u.delta_ricavi = u.ricavi - u.budget_ricavi;
  u.delta_costi = u.costiDir - budgetCostiTot(u);
});

const TOT = {
  ric: UO.reduce((s, u) => s + u.ricavi, 0),
  cDir: UO.reduce((s, u) => s + u.costiDir, 0),
  pers: UO.reduce((s, u) => s + u.costi.personale, 0),
  molI: UO.reduce((s, u) => s + u.molI, 0),
  sede: D.SEDE.totale,
  ammort: UO.reduce((s, u) => s + u.ammortamenti, 0),
  oneri_fin: UO.reduce((s, u) => s + u.oneri_fin, 0),
};
TOT.molIPct = TOT.ric > 0 ? TOT.molI / TOT.ric : 0;
TOT.molG = TOT.molI - TOT.sede;
TOT.molGPct = TOT.ric > 0 ? TOT.molG / TOT.ric : 0;
TOT.persPct = TOT.ric > 0 ? TOT.pers / TOT.ric : 0;
TOT.ebit = TOT.molG - TOT.ammort - TOT.oneri_fin;
TOT.budget_ric = UO.reduce((s, u) => s + u.budget_ricavi, 0);
TOT.budget_cDir = UO.reduce((s, u) => s + budgetCostiTot(u), 0);

// KPI semafori auto-calcolati
const autoKPI = [];
UO.forEach(u => {
  autoKPI.push({ kpi: 'MOL-I %', uo: u.cod, v: u.molIPct, tgt: BENCH.mol_i_pct, a: u.molIPct >= BENCH.mol_i_pct ? 'VERDE' : u.molIPct >= BENCH.mol_i_pct * 0.7 ? 'GIALLO' : 'ROSSO' });
  autoKPI.push({ kpi: 'MOL-G %', uo: u.cod, v: u.molGPct, tgt: BENCH.mol_g_pct, a: u.molGPct >= BENCH.mol_g_pct ? 'VERDE' : u.molGPct >= 0 ? 'GIALLO' : 'ROSSO' });
  autoKPI.push({ kpi: 'Pers. %', uo: u.cod, v: u.persPct, tgt: BENCH.pers_pct, a: u.persPct <= BENCH.pers_pct ? 'VERDE' : u.persPct <= BENCH.pers_pct * 1.1 ? 'GIALLO' : 'ROSSO' });
  if (u.occ !== null) autoKPI.push({ kpi: 'Occ. %', uo: u.cod, v: u.occ, tgt: BENCH.occ_pct, a: u.occ >= BENCH.occ_pct ? 'VERDE' : u.occ >= BENCH.occ_pct * 0.9 ? 'GIALLO' : 'ROSSO' });
  if (u.costo_pl_gg !== null) autoKPI.push({ kpi: 'Costo PL/gg', uo: u.cod, v: u.costo_pl_gg, tgt: BENCH.costo_pl_gg, a: u.costo_pl_gg <= BENCH.costo_pl_gg ? 'VERDE' : u.costo_pl_gg <= BENCH.costo_pl_gg * 1.15 ? 'GIALLO' : 'ROSSO' });
});
const KPI = autoKPI;

// Waterfall calcolato
const { waterfallRaw, cassaSett, scenari } = D.cashflow;
let rt = 0;
const waterfall = waterfallRaw.map(w => {
  if (w.tipo === 'entrata') { const b = rt; rt += w.valore; return { ...w, base: b, barra: w.valore, col: C.verde }; }
  if (w.tipo === 'uscita') { const r = { ...w, base: Math.min(rt, rt + w.valore), barra: Math.abs(w.valore), col: C.rosso }; rt += w.valore; return r; }
  if (w.tipo === 'subtotale') { rt = w.valore; return { ...w, base: 0, barra: Math.abs(w.valore), col: w.valore >= 0 ? '#2563eb' : '#b91c1c' }; }
  rt = w.valore; return { ...w, base: 0, barra: Math.abs(w.valore), col: w.valore >= 0 ? '#047857' : '#b91c1c' };
});

const narrative = D.narrative;

// ============================================================================
// HELPERS ‚Äî formattazione importi PRECISI (no abbreviazioni)
// ============================================================================
const formatEuro = v => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v);
const fmt = formatEuro;
const fmtPct = v => (v * 100).toFixed(1) + '%';
const mesi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
const mesiDisp = mesi.slice(0, D.meta.mesi_chiusi); // Solo mesi con dati reali

const Semaforo = ({ valore, testo, verdeMin, gialloMin, invertito }) => {
  let colore, sfondo;
  if (invertito) {
    colore = valore <= verdeMin ? C.verde : valore <= gialloMin ? C.giallo : C.rosso;
  } else {
    colore = valore >= verdeMin ? C.verde : valore >= gialloMin ? C.giallo : C.rosso;
  }
  sfondo = colore === C.verde ? C.verdeBg : colore === C.giallo ? C.gialloBg : C.rossoBg;
  return React.createElement('span', { style: { background: sfondo, color: colore, padding: '2px 10px', borderRadius: 12, fontSize: 11, fontWeight: 600 } }, testo || (typeof valore === 'number' ? (valore % 1 === 0 ? valore : valore.toFixed(1)) : valore));
};

const Badge = ({ reale }) => {
  if (reale) return React.createElement('span', { style: { fontSize: 9, padding: '1px 6px', borderRadius: 10, background: C.verdeBg, color: C.verde, marginLeft: 6, fontWeight: 600 } }, 'Consuntivo');
  return React.createElement('span', { style: { fontSize: 9, padding: '1px 6px', borderRadius: 10, background: '#fff7ed', color: '#c2410c', marginLeft: 6, fontWeight: 600 } }, 'Dati simulati');
};

const alertCol = a => ({ color: a === 'ROSSO' ? C.rosso : a === 'GIALLO' ? C.giallo : C.verde, bg: a === 'ROSSO' ? C.rossoBg : a === 'GIALLO' ? C.gialloBg : C.verdeBg });

// Helper delta con freccia
const DeltaBadge = ({ v, inverse }) => {
  const pos = inverse ? v <= 0 : v >= 0;
  const col = pos ? C.verde : C.rosso;
  const bg = pos ? C.verdeBg : C.rossoBg;
  const arrow = v > 0 ? '‚ñ≤' : v < 0 ? '‚ñº' : '‚Äî';
  return React.createElement('span', { style: { fontSize: 10, padding: '2px 6px', borderRadius: 8, background: bg, color: col, fontWeight: 600 } }, arrow + ' ' + formatEuro(Math.abs(v)));
};

// ============================================================================
// COMPONENTE PRINCIPALE
// ============================================================================
const KarolDashboard = () => {
  const [tab, setTab] = useState('overview');
  const [selUO, setSelUO] = useState(null);
  const [ceView, setCeView] = useState('consolidato');
  const [simRic, setSimRic] = useState(0);
  const [simPers, setSimPers] = useState(0);
  const [simOcc, setSimOcc] = useState(0);
  const [simSede, setSimSede] = useState(0);
  const [showExport, setShowExport] = useState(false);
  const [exporting, setExporting] = useState(false);
  const [fcMethod, setFcMethod] = useState('lin');

  // ---- Export PDF ‚Äî Report strutturato multi-pagina ----
  const exportPDF = async () => {
    setExporting(true);
    setShowExport(false);
    try {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const W = pdf.internal.pageSize.getWidth();
      const H = pdf.internal.pageSize.getHeight();
      const M = 15; // margine
      const CW = W - 2 * M; // content width
      let Y = M;

      const fmtN = v => { const abs = Math.abs(Math.round(v)); const s = abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.'); return (v < 0 ? '-' : '') + '‚Ç¨ ' + s; };
      const fmtP = v => (v * 100).toFixed(1).replace('.', ',') + '%';

      const checkPage = (need) => { if (Y + need > H - 15) { pdf.addPage(); Y = M; addFooter(); } };
      const addFooter = () => {
        const pg = pdf.internal.getNumberOfPages();
        pdf.setFontSize(8); pdf.setTextColor(150);
        pdf.text('Karol S.p.A. ‚Äî Controllo di Gestione ‚Äî ' + D.meta.ultimo_aggiornamento, M, H - 8);
        pdf.text('Pag. ' + pg, W - M, H - 8, { align: 'right' });
      };

      // Helper tabella
      const drawTable = (headers, rows, colWidths, opts = {}) => {
        const rH = 7; // row height
        const fSize = opts.fontSize || 8;
        checkPage(rH * (rows.length + 2));
        // Header
        pdf.setFillColor(240, 244, 248);
        pdf.rect(M, Y, CW, rH, 'F');
        pdf.setFontSize(fSize); pdf.setTextColor(80);
        pdf.setFont(undefined, 'bold');
        let x = M;
        headers.forEach((h, i) => {
          const align = i === 0 ? 'left' : 'right';
          const tx = i === 0 ? x + 2 : x + colWidths[i] - 2;
          pdf.text(h, tx, Y + 5, { align });
          x += colWidths[i];
        });
        Y += rH;
        // Rows
        pdf.setFont(undefined, 'normal');
        rows.forEach((row, ri) => {
          checkPage(rH);
          if (row._bold) pdf.setFont(undefined, 'bold');
          if (row._bg) { pdf.setFillColor(...(row._bg)); pdf.rect(M, Y, CW, rH, 'F'); }
          x = M;
          row.cells.forEach((cell, i) => {
            const align = i === 0 ? 'left' : 'right';
            const tx = i === 0 ? x + 2 : x + colWidths[i] - 2;
            if (row._colors && row._colors[i]) { const c = row._colors[i]; pdf.setTextColor(c[0], c[1], c[2]); }
            else { pdf.setTextColor(row._bold ? 30 : 60); }
            pdf.text(String(cell), tx, Y + 5, { align });
            x += colWidths[i];
          });
          pdf.setFont(undefined, 'normal');
          Y += rH;
          pdf.setDrawColor(230); pdf.line(M, Y, W - M, Y);
        });
        Y += 4;
      };

      // === PAGINA 1: COPERTINA + RIEPILOGO ===
      pdf.setFontSize(22); pdf.setTextColor(30, 41, 59);
      pdf.text('KAROL S.p.A.', W / 2, 40, { align: 'center' });
      pdf.setFontSize(14); pdf.setTextColor(100);
      pdf.text('Controllo di Gestione ‚Äî Gruppo Sicilia', W / 2, 50, { align: 'center' });
      pdf.setFontSize(11); pdf.setTextColor(60);
      pdf.text('Anno ' + D.meta.anno + ' ‚Äî ' + D.meta.mesi_chiusi + ' mesi consuntivati', W / 2, 60, { align: 'center' });
      pdf.text('Report generato il ' + new Date().toLocaleDateString('it-IT'), W / 2, 67, { align: 'center' });

      // KPI sintesi
      Y = 82;
      const kpiSintesi = [
        ['Ricavi Totali', fmtN(TOT.ric)], ['MOL Industriale', fmtN(TOT.molI) + ' (' + fmtP(TOT.molIPct) + ')'],
        ['Costi Sede', fmtN(TOT.sede)], ['MOL Gestionale', fmtN(TOT.molG) + ' (' + fmtP(TOT.molGPct) + ')'],
        ['EBIT', fmtN(TOT.ebit)], ['Personale %', fmtP(TOT.persPct)],
      ];
      pdf.setFontSize(10); pdf.setTextColor(30);
      pdf.setFont(undefined, 'bold'); pdf.text('Indicatori Chiave', M, Y); Y += 6;
      kpiSintesi.forEach(([l, v]) => {
        pdf.setFont(undefined, 'normal'); pdf.setTextColor(80); pdf.text(l + ':', M + 2, Y);
        pdf.setFont(undefined, 'bold'); pdf.setTextColor(30); pdf.text(v, M + 70, Y);
        Y += 6;
      });

      // Tabella riepilogo UO
      Y += 6;
      pdf.setFont(undefined, 'bold'); pdf.setTextColor(30); pdf.setFontSize(10);
      pdf.text('Riepilogo per Unit√† Operativa', M, Y); Y += 6;
      const rH = ['UO', 'Ricavi', 'Costi Dir.', 'MOL-I', 'MOL-I %', 'Sede', 'MOL-G', 'Pers %'];
      const rW = [32, 22, 22, 22, 16, 20, 22, 16];
      const rRows = UO.map(u => ({
        cells: [u.cod, fmtN(u.ricavi), fmtN(u.costiDir), fmtN(u.molI), fmtP(u.molIPct), fmtN(u.sede), fmtN(u.molG), fmtP(u.persPct)],
        _colors: { 3: u.molI >= 0 ? [5,150,105] : [220,38,38], 6: u.molG >= 0 ? [5,150,105] : [220,38,38] },
      }));
      rRows.push({ cells: ['TOTALE', fmtN(TOT.ric), fmtN(TOT.cDir), fmtN(TOT.molI), fmtP(TOT.molIPct), fmtN(TOT.sede), fmtN(TOT.molG), fmtP(TOT.persPct)], _bold: true, _bg: [240,244,248] });
      drawTable(rH, rRows, rW);
      addFooter();

      // === PAGINA 2: CE CONSOLIDATO ===
      pdf.addPage(); Y = M; addFooter();
      pdf.setFontSize(14); pdf.setTextColor(30); pdf.setFont(undefined, 'bold');
      pdf.text('Conto Economico Consolidato', M, Y + 5); Y += 12;

      const budCosti = { pers: UO.reduce((s,u) => s + u.budget_costi.personale, 0), mat: UO.reduce((s,u) => s + u.budget_costi.materiali, 0), serv: UO.reduce((s,u) => s + u.budget_costi.servizi, 0), ut: UO.reduce((s,u) => s + u.budget_costi.utenze, 0), man: UO.reduce((s,u) => s + u.budget_costi.manutenzione, 0), altri: UO.reduce((s,u) => s + u.budget_costi.altri, 0) };
      const budCDir = Object.values(budCosti).reduce((s,v) => s + v, 0);
      const ceH = ['Voce', 'Consuntivo', 'Budget', 'Delta', '% Ricavi'];
      const ceW = [46, 30, 30, 30, 26];
      const mRic = (v, base) => base !== 0 ? fmtP(Math.abs(v) / Math.abs(base)) : '-';
      const ceRows2 = [
        { cells: ['Ricavi', fmtN(TOT.ric), fmtN(TOT.budget_ric), fmtN(TOT.ric - TOT.budget_ric), '100,0%'], _bold: true },
        { cells: ['  Personale', fmtN(-TOT.pers), fmtN(-budCosti.pers), fmtN(budCosti.pers - TOT.pers), mRic(TOT.pers, TOT.ric)] },
        { cells: ['  Materiali', fmtN(-UO.reduce((s,u) => s + u.costi.materiali, 0)), fmtN(-budCosti.mat), '', mRic(UO.reduce((s,u) => s + u.costi.materiali, 0), TOT.ric)] },
        { cells: ['  Servizi', fmtN(-UO.reduce((s,u) => s + u.costi.servizi, 0)), fmtN(-budCosti.serv), '', ''] },
        { cells: ['  Utenze', fmtN(-UO.reduce((s,u) => s + u.costi.utenze, 0)), fmtN(-budCosti.ut), '', ''] },
        { cells: ['  Manutenzione', fmtN(-UO.reduce((s,u) => s + u.costi.manutenzione, 0)), fmtN(-budCosti.man), '', ''] },
        { cells: ['MOL Industriale', fmtN(TOT.molI), fmtN(TOT.budget_ric - budCDir), fmtN(TOT.molI - (TOT.budget_ric - budCDir)), fmtP(TOT.molIPct)], _bold: true, _bg: [240,244,248] },
        { cells: ['  Costi Sede', fmtN(-TOT.sede), fmtN(-1550000), fmtN(1550000 - TOT.sede), mRic(TOT.sede, TOT.ric)] },
        { cells: ['MOL Gestionale', fmtN(TOT.molG), '', '', fmtP(TOT.molGPct)], _bold: true, _bg: [240,244,248] },
        { cells: ['  Ammortamenti', fmtN(-TOT.ammort), fmtN(-350000), '', ''] },
        { cells: ['  Oneri Finanziari', fmtN(-TOT.oneri_fin), fmtN(-125000), '', ''] },
        { cells: ['Risultato Operativo', fmtN(TOT.ebit), '', '', fmtP(TOT.ebit / TOT.ric)], _bold: true, _bg: [230,240,255],
          _colors: { 1: TOT.ebit >= 0 ? [5,150,105] : [220,38,38] } },
      ];
      drawTable(ceH, ceRows2, ceW, { fontSize: 9 });

      // === PAGINA 3: CASH FLOW ===
      pdf.addPage(); Y = M; addFooter();
      pdf.setFontSize(14); pdf.setTextColor(30); pdf.setFont(undefined, 'bold');
      pdf.text('Cash Flow', M, Y + 5); Y += 12;

      const cfH = ['Voce', 'Importo', 'Tipo'];
      const cfW = [60, 50, 50];
      const cfRows2 = waterfallRaw.map(w => ({
        cells: [w.voce, fmtN(w.valore), w.tipo],
        _bold: w.tipo === 'subtotale' || w.tipo === 'finale',
        _bg: (w.tipo === 'subtotale' || w.tipo === 'finale') ? [240,244,248] : null,
        _colors: { 1: w.valore >= 0 ? [5,150,105] : [220,38,38] },
      }));
      drawTable(cfH, cfRows2, cfW, { fontSize: 9 });

      // KPI Cash Flow
      Y += 4;
      pdf.setFontSize(10); pdf.setFont(undefined, 'bold'); pdf.setTextColor(30);
      pdf.text('KPI Cash Flow', M, Y); Y += 7;
      const kpCF = D.cashflow.kpi;
      const ccc = kpCF.dso + 15 - kpCF.dpo;
      [['DSO ASP', kpCF.dso + ' gg', '< ' + BENCH.dso + ' gg'], ['DPO Fornitori', kpCF.dpo + ' gg', '< ' + BENCH.dpo + ' gg'],
       ['DSCR', kpCF.dscr + 'x', '> 1.2x'], ['Copertura Cassa', kpCF.cop_cassa + ' mesi', '> 2.0 mesi'],
       ['CCC', ccc + ' gg', '< ' + (BENCH.dso + 15 - BENCH.dpo) + ' gg']].forEach(([l, v, t]) => {
        pdf.setFont(undefined, 'normal'); pdf.setTextColor(80); pdf.text(l + ':', M + 2, Y);
        pdf.setFont(undefined, 'bold'); pdf.setTextColor(30); pdf.text(v, M + 55, Y);
        pdf.setFont(undefined, 'normal'); pdf.setTextColor(140); pdf.text('(target: ' + t + ')', M + 85, Y);
        Y += 6;
      });

      // Scadenziario
      Y += 6;
      pdf.setFontSize(10); pdf.setFont(undefined, 'bold'); pdf.setTextColor(30);
      pdf.text('Scadenziario Crediti / Debiti', M, Y); Y += 7;
      const scH = ['Fascia', 'Crediti', '%', 'Debiti', '%', 'Saldo'];
      const scW = [28, 28, 18, 28, 18, 28];
      const sc = D.cashflow.scadenziario;
      const scRows = sc.crediti.map((cr, i) => {
        const db = sc.debiti[i]; const saldo = cr.importo - db.importo;
        return { cells: [cr.fascia, fmtN(cr.importo), fmtP(cr.pct), fmtN(db.importo), fmtP(db.pct), fmtN(saldo)],
          _colors: { 1: [5,150,105], 3: [220,38,38], 5: saldo >= 0 ? [5,150,105] : [220,38,38] } };
      });
      scRows.push({ cells: ['Totale', fmtN(sc.totCrediti), '100%', fmtN(sc.totDebiti), '100%', fmtN(sc.totCrediti - sc.totDebiti)], _bold: true, _bg: [240,244,248] });
      drawTable(scH, scRows, scW);

      // === PAGINA 4: NARRATIVE ===
      pdf.addPage(); Y = M; addFooter();
      pdf.setFontSize(14); pdf.setTextColor(30); pdf.setFont(undefined, 'bold');
      pdf.text('Variance Analysis ‚Äî Narrative', M, Y + 5); Y += 14;

      D.narrative.forEach(n => {
        checkPage(30);
        const alertBg = n.alert === 'VERDE' ? [220,252,231] : n.alert === 'GIALLO' ? [254,249,195] : [254,226,226];
        const alertTx = n.alert === 'VERDE' ? [5,150,105] : n.alert === 'GIALLO' ? [146,64,14] : [220,38,38];
        pdf.setFillColor(...alertBg);
        pdf.roundedRect(M, Y, CW, 22, 2, 2, 'F');
        pdf.setFontSize(10); pdf.setFont(undefined, 'bold'); pdf.setTextColor(30);
        const u = UO.find(x => x.cod === n.uo);
        pdf.text(n.uo === 'GRUPPO' ? 'GRUPPO KAROL' : n.uo + ' ‚Äî ' + (u ? u.nome : ''), M + 4, Y + 6);
        pdf.setFontSize(8); pdf.setTextColor(...alertTx);
        pdf.text('[' + n.alert + ']', M + 80, Y + 6);
        pdf.setFont(undefined, 'normal'); pdf.setTextColor(60); pdf.setFontSize(8);
        const lines = pdf.splitTextToSize(n.testo, CW - 8);
        pdf.text(lines, M + 4, Y + 12);
        pdf.setFontSize(7); pdf.setTextColor(120); pdf.setFont(undefined, 'italic');
        pdf.text('Outlook: ' + n.outlook, M + 4, Y + 19);
        Y += 26;
      });

      pdf.save('Karol_CdG_Report_' + new Date().toISOString().slice(0,10) + '.pdf');
    } catch(e) { console.error(e); alert('Errore export PDF: ' + e.message); }
    setExporting(false);
  };

  // ---- Export Excel ----
  const exportExcel = () => {
    setExporting(true);
    try {
      const wb = XLSX.utils.book_new();

      // Foglio Riepilogo
      const riepilogo = [
        ['KAROL S.p.A. ‚Äî Controllo di Gestione Sicilia'],
        ['Anno ' + D.meta.anno + ' ‚Äî ' + D.meta.mesi_chiusi + ' mesi'],
        [],
        ['UO', 'Ricavi', 'Costi Dir.', 'MOL-I', 'MOL-I %', 'Sede', 'MOL-G', 'MOL-G %', 'Pers %', 'Occ %'],
        ...UO.map(u => [u.cod + ' ‚Äî ' + u.nome, u.ricavi, u.costiDir, u.molI, u.molIPct, u.sede, u.molG, u.molGPct, u.persPct, u.occ]),
        [],
        ['TOTALE', TOT.ric, TOT.cDir, TOT.molI, TOT.molIPct, TOT.sede, TOT.molG, TOT.molGPct, TOT.persPct, ''],
      ];
      const ws1 = XLSX.utils.aoa_to_sheet(riepilogo);
      ws1['!cols'] = [{ wch: 28 }, ...Array(9).fill({ wch: 16 })];
      XLSX.utils.book_append_sheet(wb, ws1, 'Riepilogo');

      // Foglio CE Consolidato
      const ceRows = [
        ['Voce', 'Consuntivo', 'Budget', 'Delta', '% Ricavi'],
        ['Ricavi', TOT.ric, TOT.budget_ric, TOT.ric - TOT.budget_ric, 1],
        ['Personale', -TOT.pers, -UO.reduce((s,u) => s + u.budget_costi.personale, 0), '', ''],
        ['Materiali', -UO.reduce((s,u) => s + u.costi.materiali, 0), -UO.reduce((s,u) => s + u.budget_costi.materiali, 0), '', ''],
        ['Servizi', -UO.reduce((s,u) => s + u.costi.servizi, 0), -UO.reduce((s,u) => s + u.budget_costi.servizi, 0), '', ''],
        ['Utenze', -UO.reduce((s,u) => s + u.costi.utenze, 0), -UO.reduce((s,u) => s + u.budget_costi.utenze, 0), '', ''],
        ['Manutenzione', -UO.reduce((s,u) => s + u.costi.manutenzione, 0), -UO.reduce((s,u) => s + u.budget_costi.manutenzione, 0), '', ''],
        ['MOL Industriale', TOT.molI, TOT.budget_ric - TOT.budget_cDir, '', TOT.molIPct],
        ['Costi Sede', -TOT.sede, -1550000, '', ''],
        ['MOL Gestionale', TOT.molG, '', '', TOT.molGPct],
        ['Ammortamenti', -TOT.ammort, -350000, '', ''],
        ['Oneri Finanziari', -TOT.oneri_fin, -125000, '', ''],
        ['Risultato Operativo', TOT.ebit, '', '', ''],
      ];
      const ws2 = XLSX.utils.aoa_to_sheet(ceRows);
      ws2['!cols'] = [{ wch: 22 }, ...Array(4).fill({ wch: 18 })];
      XLSX.utils.book_append_sheet(wb, ws2, 'CE Consolidato');

      // Foglio Trend Mensile
      const trendRows = [
        ['Mese', ...UO.map(u => u.cod + ' Ricavi'), ...UO.map(u => u.cod + ' Costi')],
        ...mesiDisp.map((m, i) => [m, ...UO.map(u => u.rM[i]), ...UO.map(u => u.cM[i])]),
      ];
      const ws3 = XLSX.utils.aoa_to_sheet(trendRows);
      XLSX.utils.book_append_sheet(wb, ws3, 'Trend Mensile');

      // Foglio KPI
      const kpiRows = [
        ['UO', 'KPI', 'Valore', 'Target', 'Semaforo'],
        ...KPI.map(k => [k.uo, k.kpi, k.v, k.tgt, k.a]),
      ];
      const ws4 = XLSX.utils.aoa_to_sheet(kpiRows);
      XLSX.utils.book_append_sheet(wb, ws4, 'KPI');

      // Foglio Cash Flow
      const cfRows = [
        ['Voce', 'Importo', 'Tipo'],
        ...waterfallRaw.map(w => [w.voce, w.valore, w.tipo]),
        [],
        ['KPI Cash Flow'],
        ['DSO ASP', D.cashflow.kpi.dso],
        ['DPO Fornitori', D.cashflow.kpi.dpo],
        ['DSCR', D.cashflow.kpi.dscr],
        ['Copertura Cassa (mesi)', D.cashflow.kpi.cop_cassa],
      ];
      const ws5 = XLSX.utils.aoa_to_sheet(cfRows);
      XLSX.utils.book_append_sheet(wb, ws5, 'Cash Flow');

      XLSX.writeFile(wb, 'Karol_CdG_Report_' + new Date().toISOString().slice(0,10) + '.xlsx');
    } catch(e) { alert('Errore export Excel: ' + e.message); }
    setExporting(false);
    setShowExport(false);
  };

  const nR = KPI.filter(k => k.a === 'ROSSO').length;
  const nG = KPI.filter(k => k.a === 'GIALLO').length;
  const nV = KPI.filter(k => k.a === 'VERDE').length;
  const uoReali = D.meta.dati_reali ? UO.length : 0;

  // Scostamento MOL-G
  const scost = [...UO].map(u => ({ nome: u.cod, nomeC: u.nome, scost: u.molG, fill: u.molG >= 0 ? C.verde : C.rosso })).sort((a,b) => a.scost - b.scost);

  // Trend multi-UO
  const trendUO = mesiDisp.map((m, i) => { const d = { mese: m }; UO.forEach(u => { d[u.cod] = u.rM[i]; }); return d; });

  const tabs = [
    { id: 'overview', label: 'Overview', icon: 'üìä' },
    { id: 'ce', label: 'Conto Economico', icon: 'üìã' },
    { id: 'strutture', label: 'Strutture', icon: 'üè•' },
    { id: 'trend', label: 'Trend', icon: 'üìà' },
    { id: 'cashflow', label: 'Cash Flow', icon: 'üí∞' },
    { id: 'piano', label: 'Piano Finanziario', icon: 'üèóÔ∏è' },
    { id: 'analisi', label: 'Analisi', icon: 'üîç' },
    { id: 'simulazioni', label: 'Simulazioni', icon: 'üéõÔ∏è' },
  ];

  const cardS = { background: C.card, borderRadius: 10, padding: 20, boxShadow: '0 1px 4px rgba(0,0,0,0.05)', border: '1px solid ' + C.bordo };

  return (
    <div id="dashboard-content" style={{ background: C.sfondo, minHeight: '100vh', fontFamily: "'DM Sans', 'Segoe UI', sans-serif" }}>
      {/* HEADER */}
      <div style={{ background: 'linear-gradient(135deg, ' + C.primario + ' 0%, ' + C.primarioChiaro + ' 100%)', padding: '20px 32px', color: 'white' }}>
        <div style={{ maxWidth: 1280, margin: '0 auto', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <div>
            <div style={{ fontSize: 24, fontWeight: 800, letterSpacing: 2 }}>KAROL</div>
            <div style={{ fontSize: 12, opacity: 0.7, letterSpacing: 3, marginTop: 2 }}>CONTROLLO DI GESTIONE</div>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
            <button onClick={() => setShowExport(true)}
              style={{ padding: '8px 18px', background: 'rgba(255,255,255,0.15)', border: '1px solid rgba(255,255,255,0.3)', borderRadius: 8, color: 'white', cursor: 'pointer', fontSize: 13, fontWeight: 600, fontFamily: 'inherit', backdropFilter: 'blur(4px)' }}>
              üì• Export
            </button>
          </div>
          <div style={{ textAlign: 'right' }}>
            <div style={{ fontSize: 15, fontWeight: 600 }}>Sicilia ‚Äî Anno {D.meta.anno} ({D.meta.mesi_chiusi} Mesi)</div>
            <div style={{ fontSize: 11, opacity: 0.7, marginTop: 4 }}>
              Completezza dati: {uoReali}/{UO.length} UO reali
              <span style={{ display: 'inline-block', width: 60, height: 5, borderRadius: 3, background: 'rgba(255,255,255,.2)', marginLeft: 8, verticalAlign: 'middle', overflow: 'hidden' }}>
                <span style={{ display: 'block', width: (uoReali/UO.length*100) + '%', height: '100%', borderRadius: 3, background: '#fca5a5' }}></span>
              </span>
            </div>
          </div>
        </div>
      </div>

      {/* EXPORT MODAL */}
      {showExport && (
        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', zIndex: 1000, display: 'flex', alignItems: 'center', justifyContent: 'center' }}
          onClick={() => setShowExport(false)}>
          <div style={{ background: C.card, borderRadius: 16, padding: '28px 32px', width: 420, boxShadow: '0 20px 60px rgba(0,0,0,0.2)' }}
            onClick={e => e.stopPropagation()}>
            <h3 style={{ fontSize: 18, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Export Report</h3>
            <p style={{ fontSize: 12, color: C.t3, marginBottom: 20 }}>Karol CdG ‚Äî Anno {D.meta.anno}</p>
            <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
              <button onClick={exportPDF} disabled={exporting}
                style={{ padding: '14px 20px', background: C.rosso + '10', border: '2px solid ' + C.rosso + '30', borderRadius: 10, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 12, fontFamily: 'inherit' }}>
                <span style={{ fontSize: 24 }}>üìÑ</span>
                <div style={{ textAlign: 'left' }}>
                  <div style={{ fontSize: 14, fontWeight: 700, color: C.t1 }}>Export PDF</div>
                  <div style={{ fontSize: 11, color: C.t3 }}>Report strutturato 4 pagine (Riepilogo, CE, Cash Flow, Narrative)</div>
                </div>
              </button>
              <button onClick={exportExcel} disabled={exporting}
                style={{ padding: '14px 20px', background: C.verde + '10', border: '2px solid ' + C.verde + '30', borderRadius: 10, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 12, fontFamily: 'inherit' }}>
                <span style={{ fontSize: 24 }}>üìä</span>
                <div style={{ textAlign: 'left' }}>
                  <div style={{ fontSize: 14, fontWeight: 700, color: C.t1 }}>Export Excel</div>
                  <div style={{ fontSize: 11, color: C.t3 }}>Report completo: Riepilogo, CE, Trend, KPI, Cash Flow</div>
                </div>
              </button>
            </div>
            {exporting && <div style={{ textAlign: 'center', marginTop: 16, fontSize: 13, color: C.primario, fontWeight: 600 }}>Generazione in corso...</div>}
            <button onClick={() => setShowExport(false)}
              style={{ marginTop: 16, width: '100%', padding: '10px', background: 'transparent', border: '1px solid ' + C.bordo, borderRadius: 8, cursor: 'pointer', fontSize: 13, color: C.t2, fontFamily: 'inherit' }}>
              Chiudi
            </button>
          </div>
        </div>
      )}

      {/* KPI CARDS */}
      <div style={{ maxWidth: 1280, margin: '-20px auto 0', padding: '0 24px', position: 'relative', zIndex: 1 }}>
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(155px, 1fr))', gap: 12 }}>
          {[
            { label: 'Ricavi Totali', valore: fmt(TOT.ric), colore: C.CTA },
            { label: 'MOL Industriale', valore: fmt(TOT.molI), sub: fmtPct(TOT.molIPct), colore: C.verde },
            { label: 'Costi Sede', valore: fmt(TOT.sede), sub: fmtPct(TOT.sede / TOT.ric) + ' ricavi', colore: C.viola },
            { label: 'MOL Gestionale', valore: fmt(TOT.molG), sub: fmtPct(TOT.molGPct), colore: TOT.molG >= 0 ? C.verde : C.rosso },
            { label: 'DSO ASP', valore: D.cashflow.kpi.dso + ' gg', sub: 'Target <' + BENCH.dso, colore: D.cashflow.kpi.dso > BENCH.dso ? C.giallo : C.verde },
            { label: 'Copertura Cassa', valore: D.cashflow.kpi.cop_cassa + ' mesi', sub: 'Target >' + BENCH.cop_cassa_mesi, colore: D.cashflow.kpi.cop_cassa < BENCH.cop_cassa_mesi ? C.giallo : C.verde },
            { label: 'Alert', valore: (nR+nG) + ' attivi', sub: nR + ' rossi / ' + nG + ' gialli / ' + nV + ' verdi', colore: nR > 0 ? C.rosso : C.giallo },
          ].map((kpi, i) => (
            <div key={i} style={{ background: C.card, borderRadius: 10, padding: '14px 16px', boxShadow: '0 1px 4px rgba(0,0,0,0.06)', borderLeft: '3px solid ' + kpi.colore, borderTop: '1px solid #f1f5f9' }}>
              <div style={{ fontSize: 11, color: C.t3, fontWeight: 500, marginBottom: 6 }}>{kpi.label}</div>
              <div style={{ fontSize: 18, fontWeight: 700, color: kpi.colore }}>{kpi.valore}</div>
              {kpi.sub && <div style={{ fontSize: 11, color: C.t3, marginTop: 2 }}>{kpi.sub}</div>}
            </div>
          ))}
        </div>
      </div>

      {/* TAB NAVIGATION */}
      <div style={{ maxWidth: 1280, margin: '20px auto 0', padding: '0 24px' }}>
        <div style={{ display: 'flex', gap: 4, borderBottom: '2px solid ' + C.bordo }}>
          {tabs.map(t => (
            <button key={t.id} onClick={() => setTab(t.id)}
              style={{ padding: '10px 20px', border: 'none', cursor: 'pointer', background: tab === t.id ? C.card : 'transparent', color: tab === t.id ? C.primario : C.t2, fontWeight: tab === t.id ? 700 : 500, fontSize: 14, borderBottom: tab === t.id ? '3px solid ' + C.primario : '3px solid transparent', borderRadius: '8px 8px 0 0', transition: 'all 0.2s', fontFamily: 'inherit' }}>
              {t.icon} {t.label}
            </button>
          ))}
        </div>
      </div>

      {/* CONTENT */}
      <div style={{ maxWidth: 1280, margin: '0 auto', padding: '20px 24px 40px' }}>

        {/* ======================== OVERVIEW ======================== */}
        {tab === 'overview' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>

            {/* 6 Card Costi Gestionali */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: 12 }}>
              {[
                { label: 'Personale', valore: TOT.pers, pct: TOT.persPct, bench: BENCH.pers_pct, icon: 'üë•', inv: true },
                { label: 'Materiali/Farmaci', valore: UO.reduce((s,u) => s + u.costi.materiali, 0), pct: UO.reduce((s,u) => s + u.costi.materiali, 0) / TOT.ric, bench: 0.12, icon: 'üíä', inv: true },
                { label: 'Servizi', valore: UO.reduce((s,u) => s + u.costi.servizi, 0), pct: UO.reduce((s,u) => s + u.costi.servizi, 0) / TOT.ric, bench: 0.12, icon: 'üîß', inv: true },
                { label: 'Utenze', valore: UO.reduce((s,u) => s + u.costi.utenze, 0), pct: UO.reduce((s,u) => s + u.costi.utenze, 0) / TOT.ric, bench: 0.05, icon: '‚ö°', inv: true },
                { label: 'Manutenzione', valore: UO.reduce((s,u) => s + u.costi.manutenzione, 0), pct: UO.reduce((s,u) => s + u.costi.manutenzione, 0) / TOT.ric, bench: 0.03, icon: 'üèóÔ∏è', inv: true },
                { label: 'Costi Sede/HQ', valore: TOT.sede, pct: TOT.sede / TOT.ric, bench: 0.12, icon: 'üè¢', inv: true },
              ].map((c, i) => {
                const ok = c.inv ? c.pct <= c.bench : c.pct >= c.bench;
                const warn = c.inv ? c.pct <= c.bench * 1.15 : c.pct >= c.bench * 0.85;
                const col = ok ? C.verde : warn ? C.giallo : C.rosso;
                const bg = ok ? C.verdeBg : warn ? C.gialloBg : C.rossoBg;
                return (
                  <div key={i} style={{ ...cardS, padding: '14px 16px', borderLeft: '3px solid ' + col }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 }}>
                      <span style={{ fontSize: 11, color: C.t3, fontWeight: 500 }}>{c.icon} {c.label}</span>
                      <span style={{ fontSize: 10, padding: '2px 6px', borderRadius: 8, background: bg, color: col, fontWeight: 600 }}>{fmtPct(c.pct)}</span>
                    </div>
                    <div style={{ fontSize: 17, fontWeight: 700, color: C.t1 }}>{fmt(c.valore)}</div>
                    <div style={{ fontSize: 10, color: C.t3, marginTop: 2 }}>Bench: {fmtPct(c.bench)}</div>
                  </div>
                );
              })}
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
              {/* B1: Bar orizzontale scostamento MOL-G */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Scostamento MOL-G per UO</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Divergenza dal breakeven per unit√† operativa</p>
                <ResponsiveContainer width="100%" height={260}>
                  <BarChart data={scost} layout="vertical" margin={{ left: 50, right: 50 }}>
                    <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
                    <XAxis type="number" tickFormatter={v => fmt(v)} fontSize={10} stroke={C.t3} />
                    <YAxis type="category" dataKey="nome" fontSize={12} width={45} stroke={C.t2} />
                    <Tooltip formatter={v => [fmt(v), 'MOL-G']} />
                    <ReferenceLine x={0} stroke={C.t3} strokeWidth={1.5} />
                    <Bar dataKey="scost" name="MOL-G" radius={[0, 4, 4, 0]} barSize={22}>
                      {scost.map((d, i) => <Cell key={i} fill={d.fill} />)}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
                <div style={{ textAlign: 'center', marginTop: 8, fontSize: 13, fontWeight: 600, color: TOT.molG >= 0 ? C.verde : C.rosso }}>
                  MOL-G Gruppo: {fmt(TOT.molG)}
                </div>
              </div>

              {/* B2: Tabella semaforo aggiornata con Costo PL/gg */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Matrice KPI per UO</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Semaforo performance operativa</p>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
                  <thead>
                    <tr style={{ borderBottom: '2px solid ' + C.bordo }}>
                      {['UO', 'MOL-I %', 'MOL-G %', 'Pers. %', 'Occ. %', 'Costo PL/gg'].map(h => (
                        <th key={h} style={{ padding: '8px 4px', textAlign: h === 'UO' ? 'left' : 'center', color: C.t2, fontWeight: 600, fontSize: 10 }}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {UO.map((u, i) => {
                      const kpis = KPI.filter(k => k.uo === u.cod);
                      const cell = (name) => {
                        const k = kpis.find(x => x.kpi.startsWith(name));
                        if (!k) return <td style={{ textAlign: 'center', color: C.t3, fontSize: 11 }}>n/d</td>;
                        const ac = alertCol(k.a);
                        const display = name === 'Costo PL' ? fmt(k.v) : fmtPct(k.v);
                        return <td style={{ textAlign: 'center' }}><span style={{ background: ac.bg, color: ac.color, padding: '2px 6px', borderRadius: 10, fontSize: 10, fontWeight: 600, fontFamily: 'monospace' }}>{display}</span></td>;
                      };
                      return (
                        <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, cursor: 'pointer' }} onClick={() => { setSelUO(u); setTab('strutture'); }}>
                          <td style={{ padding: '10px 4px', fontWeight: 600, color: C.t1, fontSize: 12 }}>
                            <span style={{ display: 'inline-block', width: 10, height: 10, borderRadius: 3, background: u.colore, marginRight: 6 }}></span>
                            {u.cod}
                          </td>
                          {cell('MOL-I')}{cell('MOL-G')}{cell('Pers')}{cell('Occ')}{cell('Costo PL')}
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
                <div style={{ marginTop: 12, display: 'flex', gap: 16, justifyContent: 'center' }}>
                  {[{ c: C.verdeBg, t: C.verde, l: 'In target' }, { c: C.gialloBg, t: C.giallo, l: 'Attenzione' }, { c: C.rossoBg, t: C.rosso, l: 'Critico' }]
                    .map(leg => <span key={leg.l} style={{ fontSize: 10, display: 'flex', alignItems: 'center', gap: 4 }}>
                      <span style={{ width: 10, height: 10, borderRadius: 3, background: leg.c, border: '1px solid ' + leg.t }}></span>{leg.l}
                    </span>)}
                </div>
              </div>
            </div>

            {/* Sintesi direzionale */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Sintesi Direzionale</h3>
              {narrative.filter(n => n.uo === 'GRUPPO').map((n, i) => {
                const ac = alertCol(n.alert);
                return (
                  <div key={i} style={{ padding: '12px 16px', background: ac.bg, borderRadius: 8, borderLeft: '4px solid ' + ac.color, marginBottom: 8 }}>
                    <p style={{ fontSize: 12, color: C.t1, lineHeight: 1.6, marginBottom: 4 }}>{n.testo}</p>
                    <p style={{ fontSize: 11, color: C.t2, fontStyle: 'italic' }}>Outlook: {n.outlook}</p>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* ======================== CONTO ECONOMICO ======================== */}
        {tab === 'ce' && (() => {
          // CE Consolidato righe
          const ceRighe = [
            { voce: 'Ricavi', val: TOT.ric, bud: TOT.budget_ric, cls: 'header' },
            { voce: '  Personale', val: -TOT.pers, bud: -UO.reduce((s,u) => s + u.budget_costi.personale, 0), cls: 'costo' },
            { voce: '  Materiali/Farmaci', val: -UO.reduce((s,u) => s + u.costi.materiali, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.materiali, 0), cls: 'costo' },
            { voce: '  Servizi', val: -UO.reduce((s,u) => s + u.costi.servizi, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.servizi, 0), cls: 'costo' },
            { voce: '  Utenze', val: -UO.reduce((s,u) => s + u.costi.utenze, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.utenze, 0), cls: 'costo' },
            { voce: '  Manutenzione', val: -UO.reduce((s,u) => s + u.costi.manutenzione, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.manutenzione, 0), cls: 'costo' },
            { voce: '  Altri costi diretti', val: -UO.reduce((s,u) => s + u.costi.altri, 0), bud: -UO.reduce((s,u) => s + u.budget_costi.altri, 0), cls: 'costo' },
            { voce: 'MOL Industriale', val: TOT.molI, bud: TOT.budget_ric - TOT.budget_cDir, cls: 'subtotale' },
            { voce: '  Costi Sede/HQ', val: -TOT.sede, bud: -1550000, cls: 'costo' },
            { voce: 'MOL Gestionale', val: TOT.molG, bud: (TOT.budget_ric - TOT.budget_cDir) - 1550000, cls: 'subtotale' },
            { voce: '  Ammortamenti', val: -TOT.ammort, bud: -350000, cls: 'costo' },
            { voce: '  Oneri finanziari', val: -TOT.oneri_fin, bud: -125000, cls: 'costo' },
            { voce: 'Risultato Operativo', val: TOT.ebit, bud: (TOT.budget_ric - TOT.budget_cDir) - 1550000 - 350000 - 125000, cls: 'totale' },
          ];

          // CE per singola BU
          const ceBU = (u) => [
            { voce: 'Ricavi', val: u.ricavi, bud: u.budget_ricavi, cls: 'header' },
            { voce: '  Personale', val: -u.costi.personale, bud: -u.budget_costi.personale, cls: 'costo' },
            { voce: '  Materiali', val: -u.costi.materiali, bud: -u.budget_costi.materiali, cls: 'costo' },
            { voce: '  Servizi', val: -u.costi.servizi, bud: -u.budget_costi.servizi, cls: 'costo' },
            { voce: '  Utenze', val: -u.costi.utenze, bud: -u.budget_costi.utenze, cls: 'costo' },
            { voce: '  Manutenzione', val: -u.costi.manutenzione, bud: -u.budget_costi.manutenzione, cls: 'costo' },
            { voce: '  Altri', val: -u.costi.altri, bud: -u.budget_costi.altri, cls: 'costo' },
            { voce: 'MOL Industriale', val: u.molI, bud: u.budget_ricavi - budgetCostiTot(u), cls: 'subtotale' },
            { voce: '  Quota Sede', val: -u.sede, bud: -u.sede * 0.95, cls: 'costo' },
            { voce: 'MOL Gestionale', val: u.molG, bud: (u.budget_ricavi - budgetCostiTot(u)) - u.sede * 0.95, cls: 'subtotale' },
            { voce: '  Ammortamenti', val: -u.ammortamenti, bud: -u.ammortamenti * 0.95, cls: 'costo' },
            { voce: '  Oneri finanziari', val: -u.oneri_fin, bud: -u.oneri_fin * 0.95, cls: 'costo' },
            { voce: 'Risultato Operativo', val: u.ebit, bud: (u.budget_ricavi - budgetCostiTot(u)) - u.sede * 0.95 - u.ammortamenti * 0.95 - u.oneri_fin * 0.95, cls: 'totale' },
          ];

          // Forecast ‚Äî 3 metodi
          const mC = D.meta.mesi_chiusi;
          const mR = 12 - mC; // mesi residui
          const forecastCalc = UO.map(u => {
            const ricMese = u.ricavi / mC;
            const costMese = u.costiDir / mC;
            // Linearizzazione: media mensile √ó 12
            const lin_ric = ricMese * 12;
            const lin_cost = costMese * 12;
            // Budget residuo: consuntivo YTD + budget residuo proporzionale
            const budRicMese = u.budget_ricavi / 12;
            const budCostMese = budgetCostiTot(u) / 12;
            const bud_ric = u.ricavi + budRicMese * mR;
            const bud_cost = u.costiDir + budCostMese * mR;
            // Trend ponderato: media mobile ponderata ultimi 3 mesi √ó residui + YTD
            const rM = u.rM || [];
            const cM = u.cM || [];
            const w3ric = rM.length >= 3 ? (rM[rM.length-1]*3 + rM[rM.length-2]*2 + rM[rM.length-3]*1) / 6 : ricMese;
            const w3cost = cM.length >= 3 ? (cM[cM.length-1]*3 + cM[cM.length-2]*2 + cM[cM.length-3]*1) / 6 : costMese;
            const trnd_ric = u.ricavi + w3ric * mR;
            const trnd_cost = u.costiDir + w3cost * mR;
            return {
              cod: u.cod, nome: u.nome, colore: u.colore,
              lin: { ric: lin_ric, cost: lin_cost, molI: lin_ric - lin_cost },
              bud: { ric: bud_ric, cost: bud_cost, molI: bud_ric - bud_cost },
              trnd: { ric: trnd_ric, cost: trnd_cost, molI: trnd_ric - trnd_cost },
            };
          });
          const fcData = forecastCalc.map(f => ({ ...f, fc: f[fcMethod] }));

          const CETable = ({ righe }) => (
            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
              <thead>
                <tr style={{ borderBottom: '2px solid ' + C.bordo, background: '#f8fafc' }}>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: C.t2, fontWeight: 600, width: '35%' }}>Voce</th>
                  <th style={{ padding: '10px 8px', textAlign: 'right', color: C.t2, fontWeight: 600 }}>Consuntivo</th>
                  <th style={{ padding: '10px 8px', textAlign: 'right', color: C.t2, fontWeight: 600 }}>Budget</th>
                  <th style={{ padding: '10px 8px', textAlign: 'right', color: C.t2, fontWeight: 600 }}>Delta</th>
                  <th style={{ padding: '10px 8px', textAlign: 'right', color: C.t2, fontWeight: 600 }}>% Ricavi</th>
                </tr>
              </thead>
              <tbody>
                {righe.map((r, i) => {
                  const delta = r.val - r.bud;
                  const isH = r.cls === 'header' || r.cls === 'subtotale' || r.cls === 'totale';
                  const bg = r.cls === 'totale' ? '#f0f4f8' : r.cls === 'subtotale' ? '#f8fafc' : 'transparent';
                  const fw = isH ? 700 : 400;
                  const ricRef = righe[0].val;
                  return (
                    <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, background: bg }}>
                      <td style={{ padding: '8px', fontWeight: fw, color: C.t1, fontSize: isH ? 13 : 12 }}>{r.voce}</td>
                      <td style={{ padding: '8px', textAlign: 'right', fontWeight: fw, color: C.t1, fontFamily: 'monospace' }}>{fmt(r.val)}</td>
                      <td style={{ padding: '8px', textAlign: 'right', color: C.t2, fontFamily: 'monospace' }}>{fmt(r.bud)}</td>
                      <td style={{ padding: '8px', textAlign: 'right' }}>
                        <span style={{ color: delta >= 0 ? C.verde : C.rosso, fontWeight: 600, fontFamily: 'monospace', fontSize: 11 }}>
                          {delta >= 0 ? '+' : ''}{fmt(delta)}
                        </span>
                      </td>
                      <td style={{ padding: '8px', textAlign: 'right', color: C.t3, fontSize: 11, fontFamily: 'monospace' }}>
                        {ricRef !== 0 ? fmtPct(Math.abs(r.val) / Math.abs(ricRef)) : '-'}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          );

          return (
            <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
              {/* Sub-tab navigation */}
              <div style={{ display: 'flex', gap: 8 }}>
                {[{ id: 'consolidato', l: 'CE Consolidato' }, { id: 'perbu', l: 'CE per BU' }, { id: 'forecast', l: 'Forecast' }].map(st => (
                  <button key={st.id} onClick={() => setCeView(st.id)}
                    style={{ padding: '8px 18px', border: '2px solid ' + (ceView === st.id ? C.primario : C.bordo), background: ceView === st.id ? C.primario + '10' : C.card, borderRadius: 8, cursor: 'pointer', fontSize: 13, fontWeight: ceView === st.id ? 700 : 500, color: ceView === st.id ? C.primario : C.t2, fontFamily: 'inherit' }}>
                    {st.l}
                  </button>
                ))}
              </div>

              {/* CE Consolidato */}
              {ceView === 'consolidato' && (
                <div style={cardS}>
                  <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Conto Economico Consolidato ‚Äî Gruppo Karol Sicilia</h3>
                  <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Anno {D.meta.anno} ‚Äî {D.meta.mesi_chiusi} mesi | Consuntivo vs Budget</p>
                  <CETable righe={ceRighe} />
                  <div style={{ marginTop: 16, padding: '10px 14px', background: TOT.ebit >= 0 ? C.verdeBg : C.rossoBg, borderRadius: 8, borderLeft: '4px solid ' + (TOT.ebit >= 0 ? C.verde : C.rosso) }}>
                    <p style={{ fontSize: 12, color: C.t1 }}>
                      Risultato operativo: <strong>{fmt(TOT.ebit)}</strong> ‚Äî MOL-G {fmtPct(TOT.molGPct)} (target {fmtPct(BENCH.mol_g_pct)})
                    </p>
                  </div>
                </div>
              )}

              {/* CE per BU */}
              {ceView === 'perbu' && (
                <div>
                  <div style={{ display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' }}>
                    {UO.map(u => (
                      <button key={u.cod} onClick={() => setSelUO(u)}
                        style={{ padding: '8px 16px', border: '2px solid ' + (selUO && selUO.cod === u.cod ? u.colore : C.bordo), background: selUO && selUO.cod === u.cod ? u.colore + '15' : C.card, borderRadius: 8, cursor: 'pointer', fontSize: 13, fontWeight: 600, color: selUO && selUO.cod === u.cod ? u.colore : C.t2, fontFamily: 'inherit' }}>
                        {u.cod} ‚Äî {u.nome}
                      </button>
                    ))}
                  </div>
                  {(() => {
                    const u = selUO || UO[0];
                    return (
                      <div style={cardS}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                          <div>
                            <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1 }}>CE ‚Äî {u.nome}</h3>
                            <p style={{ fontSize: 11, color: C.t2 }}>{u.tipo}{u.pl > 0 ? ' ‚Äî ' + u.pl + ' PL' : ''}</p>
                          </div>
                          <div style={{ textAlign: 'right' }}>
                            <span style={{ fontSize: 18, fontWeight: 700, color: u.molG >= 0 ? C.verde : C.rosso }}>{fmt(u.molG)}</span>
                            <div style={{ fontSize: 10, color: C.t3 }}>MOL-G ({fmtPct(u.molGPct)})</div>
                          </div>
                        </div>
                        <CETable righe={ceBU(u)} />
                        {/* Riconciliazione */}
                        <div style={{ marginTop: 12, padding: '8px 12px', background: '#f8fafc', borderRadius: 6, fontSize: 11, color: C.t2 }}>
                          Riconciliazione: Ricavi {fmt(u.ricavi)} ‚àí Costi Diretti {fmt(u.costiDir)} = MOL-I {fmt(u.molI)} ‚àí Sede {fmt(u.sede)} = MOL-G {fmt(u.molG)} ‚úì
                        </div>
                      </div>
                    );
                  })()}
                </div>
              )}

              {/* Forecast */}
              {ceView === 'forecast' && (() => {
                const methods = [
                  { id: 'lin', l: 'Linearizzazione', desc: 'Media mensile √ó 12' },
                  { id: 'bud', l: 'Budget Residuo', desc: 'YTD + budget pro-rata residuo' },
                  { id: 'trnd', l: 'Trend Ponderato', desc: 'YTD + media mobile 3M ponderata √ó residuo' },
                ];
                const totFcRic = fcData.reduce((s,f) => s + f.fc.ric, 0);
                const totFcMolI = fcData.reduce((s,f) => s + f.fc.molI, 0);
                const totFcVsBud = totFcRic - TOT.budget_ric;
                // Barchart confronto metodi
                const barFcData = UO.map((u, i) => ({
                  cod: u.cod,
                  Budget: u.budget_ricavi,
                  Linearizzazione: forecastCalc[i].lin.ric,
                  'Budget Residuo': forecastCalc[i].bud.ric,
                  'Trend Ponderato': forecastCalc[i].trnd.ric,
                }));
                return (
                <div style={cardS}>
                  <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Forecast Anno ‚Äî Confronto Metodi</h3>
                  <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>Proiezione basata su {mC} mesi consuntivati, {mR} mesi residui</p>
                  {/* Selettore metodo */}
                  <div style={{ display: 'flex', gap: 8, marginBottom: 16 }}>
                    {methods.map(m => (
                      <button key={m.id} onClick={() => setFcMethod(m.id)}
                        style={{ padding: '6px 14px', border: '2px solid ' + (fcMethod === m.id ? C.primario : C.bordo), background: fcMethod === m.id ? C.primario + '10' : 'white', borderRadius: 6, cursor: 'pointer', fontSize: 11, fontWeight: fcMethod === m.id ? 700 : 500, color: fcMethod === m.id ? C.primario : C.t2, fontFamily: 'inherit' }}>
                        {m.l}
                        <div style={{ fontSize: 9, color: C.t3, fontWeight: 400 }}>{m.desc}</div>
                      </button>
                    ))}
                  </div>
                  {/* Tabella forecast */}
                  <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
                    <thead>
                      <tr style={{ borderBottom: '2px solid ' + C.bordo, background: '#f8fafc' }}>
                        <th style={{ padding: '8px', textAlign: 'left', color: C.t2 }}>UO</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>Consuntivo YTD</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>Forecast 12M</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>Budget Anno</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>Fc vs Budget</th>
                        <th style={{ padding: '8px', textAlign: 'right', color: C.t2 }}>MOL-I Fc</th>
                      </tr>
                    </thead>
                    <tbody>
                      {fcData.map((f, i) => {
                        const u = UO[i];
                        const fcVsBud = f.fc.ric - u.budget_ricavi;
                        return (
                          <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo }}>
                            <td style={{ padding: '8px', fontWeight: 600, color: C.t1 }}>
                              <span style={{ display: 'inline-block', width: 10, height: 10, borderRadius: 3, background: f.colore, marginRight: 6 }}></span>
                              {f.cod}
                            </td>
                            <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'monospace' }}>{fmt(u.ricavi)}</td>
                            <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'monospace', fontWeight: 600 }}>{fmt(f.fc.ric)}</td>
                            <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'monospace', color: C.t2 }}>{fmt(u.budget_ricavi)}</td>
                            <td style={{ padding: '8px', textAlign: 'right' }}>
                              <span style={{ color: fcVsBud >= 0 ? C.verde : C.rosso, fontWeight: 600, fontFamily: 'monospace', fontSize: 11 }}>
                                {fcVsBud >= 0 ? '+' : ''}{fmt(fcVsBud)}
                              </span>
                            </td>
                            <td style={{ padding: '8px', textAlign: 'right', fontFamily: 'monospace', color: f.fc.molI >= 0 ? C.verde : C.rosso, fontWeight: 600 }}>{fmt(f.fc.molI)}</td>
                          </tr>
                        );
                      })}
                      <tr style={{ borderTop: '2px solid ' + C.primario, background: '#f0f4f8' }}>
                        <td style={{ padding: '8px', fontWeight: 700 }}>TOTALE</td>
                        <td style={{ padding: '8px', textAlign: 'right', fontWeight: 700, fontFamily: 'monospace' }}>{fmt(TOT.ric)}</td>
                        <td style={{ padding: '8px', textAlign: 'right', fontWeight: 700, fontFamily: 'monospace' }}>{fmt(totFcRic)}</td>
                        <td style={{ padding: '8px', textAlign: 'right', fontWeight: 700, fontFamily: 'monospace', color: C.t2 }}>{fmt(TOT.budget_ric)}</td>
                        <td style={{ padding: '8px', textAlign: 'right' }}>
                          <span style={{ color: totFcVsBud >= 0 ? C.verde : C.rosso, fontWeight: 700, fontFamily: 'monospace' }}>{totFcVsBud >= 0 ? '+' : ''}{fmt(totFcVsBud)}</span>
                        </td>
                        <td style={{ padding: '8px', textAlign: 'right', fontWeight: 700, fontFamily: 'monospace', color: totFcMolI >= 0 ? C.verde : C.rosso }}>{fmt(totFcMolI)}</td>
                      </tr>
                    </tbody>
                  </table>
                  {/* Grafico confronto metodi */}
                  <div style={{ marginTop: 16 }}>
                    <h4 style={{ fontSize: 13, fontWeight: 600, color: C.t1, marginBottom: 8 }}>Confronto Metodi ‚Äî Ricavi Forecast per UO</h4>
                    <ResponsiveContainer width="100%" height={260}>
                      <BarChart data={barFcData} margin={{ top: 10, right: 20, left: 20, bottom: 5 }}>
                        <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                        <XAxis dataKey="cod" fontSize={12} stroke={C.t2} />
                        <YAxis tickFormatter={v => fmt(v)} fontSize={9} stroke={C.t3} />
                        <Tooltip formatter={v => [fmt(v)]} />
                        <Legend />
                        <Bar dataKey="Budget" fill="#94a3b8" barSize={16} />
                        <Bar dataKey="Linearizzazione" fill="#3b82f6" barSize={16} />
                        <Bar dataKey="Budget Residuo" fill="#8b5cf6" barSize={16} />
                        <Bar dataKey="Trend Ponderato" fill="#06b6d4" barSize={16} />
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                  {/* Note metodo */}
                  <div style={{ marginTop: 12, padding: '10px 14px', background: '#f0f4f8', borderRadius: 8, fontSize: 11, color: C.t2 }}>
                    <strong>Metodo attivo: {methods.find(m => m.id === fcMethod)?.l}</strong> ‚Äî {methods.find(m => m.id === fcMethod)?.desc}.
                    {fcMethod === 'lin' && ' Ipotesi: ritmo costante nei mesi residui uguale alla media YTD.'}
                    {fcMethod === 'bud' && ' Ipotesi: mesi residui seguono il budget originale, consuntivo acquisito.'}
                    {fcMethod === 'trnd' && ' Ipotesi: trend recente (pesi 3-2-1 su ultimi 3 mesi) proiettato sui mesi residui.'}
                  </div>
                </div>
                );
              })()}
            </div>
          );
        })()}

        {/* ======================== STRUTTURE ======================== */}
        {tab === 'strutture' && (
          <div>
            <div style={{ display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' }}>
              {UO.map(u => (
                <button key={u.cod} onClick={() => setSelUO(u)}
                  style={{ padding: '8px 16px', border: '2px solid ' + (selUO && selUO.cod === u.cod ? u.colore : C.bordo), background: selUO && selUO.cod === u.cod ? u.colore + '15' : C.card, borderRadius: 8, cursor: 'pointer', fontSize: 13, fontWeight: 600, color: selUO && selUO.cod === u.cod ? u.colore : C.t2, fontFamily: 'inherit' }}>
                  {u.cod} ‚Äî {u.nome}
                </button>
              ))}
            </div>
            {(() => {
              const u = selUO || UO[0];
              const data = mesiDisp.map((m, i) => ({ mese: m, Ricavi: u.rM[i], Costi: u.cM[i], MOL: u.rM[i] - u.cM[i] }));
              const uKpi = KPI.filter(k => k.uo === u.cod);
              const uNarr = narrative.find(n => n.uo === u.cod);
              return (
                <div style={cardS}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                    <div>
                      <h3 style={{ fontSize: 17, fontWeight: 700, color: C.t1 }}>{u.nome} <Badge reale={u.datiReali} /></h3>
                      <p style={{ fontSize: 12, color: C.t2 }}>{u.tipo}{u.pl > 0 ? ' ‚Äî ' + u.pl + ' PL' : ''} | Ricavo/gg: {u.ricGg ? fmt(Math.round(u.ricGg)) : 'n/a'}{u.costo_pl_gg ? ' | Costo PL/gg: ' + fmt(Math.round(u.costo_pl_gg)) : ''}</p>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontSize: 22, fontWeight: 700, color: u.molG >= 0 ? C.verde : C.rosso }}>{fmt(u.molG)}</div>
                      <div style={{ fontSize: 11, color: C.t3 }}>MOL Gestionale ({fmtPct(u.molGPct)})</div>
                    </div>
                  </div>
                  {/* KPI */}
                  <div style={{ display: 'flex', gap: 10, marginBottom: 16, flexWrap: 'wrap' }}>
                    {uKpi.map((k, i) => {
                      const ac = alertCol(k.a);
                      return (
                        <div key={i} style={{ padding: '8px 12px', borderRadius: 8, background: ac.bg, borderLeft: '3px solid ' + ac.color, flex: '1 1 120px' }}>
                          <div style={{ fontSize: 10, color: C.t2 }}>{k.kpi}</div>
                          <div style={{ fontSize: 18, fontWeight: 700, color: ac.color }}>{fmtPct(k.v)}</div>
                          <div style={{ fontSize: 9, color: C.t3 }}>vs {fmtPct(k.tgt)}</div>
                        </div>
                      );
                    })}
                  </div>
                  {/* Narrative */}
                  {uNarr && (
                    <div style={{ padding: '10px 14px', background: alertCol(uNarr.alert).bg, borderRadius: 8, borderLeft: '4px solid ' + alertCol(uNarr.alert).color, marginBottom: 16 }}>
                      <p style={{ fontSize: 12, color: C.t1, lineHeight: 1.5 }}>{uNarr.testo}</p>
                    </div>
                  )}
                  {/* Donut composizione costi + Chart trend */}
                  <div style={{ display: 'grid', gridTemplateColumns: '280px 1fr', gap: 16 }}>
                    <div>
                      <h4 style={{ fontSize: 12, fontWeight: 600, color: C.t2, marginBottom: 8 }}>Composizione Costi</h4>
                      <ResponsiveContainer width="100%" height={200}>
                        <PieChart>
                          <Pie data={[
                            { name: 'Personale', value: u.costi.personale, fill: '#3b82f6' },
                            { name: 'Materiali', value: u.costi.materiali, fill: '#8b5cf6' },
                            { name: 'Servizi', value: u.costi.servizi, fill: '#06b6d4' },
                            { name: 'Utenze', value: u.costi.utenze, fill: '#f59e0b' },
                            { name: 'Manut.', value: u.costi.manutenzione, fill: '#ef4444' },
                            { name: 'Altri', value: u.costi.altri, fill: '#94a3b8' },
                          ].filter(d => d.value > 0)} dataKey="value" innerRadius={50} outerRadius={80} paddingAngle={2}>
                          </Pie>
                          <Tooltip formatter={v => [fmt(v)]} />
                        </PieChart>
                      </ResponsiveContainer>
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: 6, justifyContent: 'center' }}>
                        {[
                          { c: '#3b82f6', l: 'Pers.' }, { c: '#8b5cf6', l: 'Mat.' }, { c: '#06b6d4', l: 'Serv.' },
                          { c: '#f59e0b', l: 'Uten.' }, { c: '#ef4444', l: 'Man.' }, { c: '#94a3b8', l: 'Altri' },
                        ].map(leg => <span key={leg.l} style={{ fontSize: 9, display: 'flex', alignItems: 'center', gap: 3 }}>
                          <span style={{ width: 8, height: 8, borderRadius: 2, background: leg.c }}></span>{leg.l}
                        </span>)}
                      </div>
                    </div>
                    <div>
                      <h4 style={{ fontSize: 12, fontWeight: 600, color: C.t2, marginBottom: 8 }}>Trend Mensile Ricavi vs Costi</h4>
                      <ResponsiveContainer width="100%" height={250}>
                        <ComposedChart data={data} margin={{ top: 10, right: 20, left: 10, bottom: 5 }}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                          <XAxis dataKey="mese" fontSize={12} stroke={C.t3} />
                          <YAxis tickFormatter={v => fmt(v)} fontSize={9} stroke={C.t3} />
                          <Tooltip formatter={v => [fmt(v)]} />
                          <Legend />
                          <Bar dataKey="Ricavi" fill={u.colore} radius={[4,4,0,0]} barSize={18} />
                          <Bar dataKey="Costi" fill={C.budget} radius={[4,4,0,0]} barSize={18} />
                          <Line type="monotone" dataKey="MOL" name="MOL-I" stroke={C.verde} strokeWidth={2} dot={{ r: 3 }} />
                        </ComposedChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </div>
              );
            })()}
          </div>
        )}

        {/* ======================== TREND ======================== */}
        {tab === 'trend' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
            {/* B3: Multi-UO overlay */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Trend Ricavi per UO ‚Äî Confronto 12 Mesi</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Clicca sulla legenda per nascondere/mostrare le linee</p>
              <ResponsiveContainer width="100%" height={380}>
                <LineChart data={trendUO} margin={{ top: 10, right: 20, left: 10, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                  <XAxis dataKey="mese" fontSize={12} stroke={C.t3} />
                  <YAxis tickFormatter={v => fmt(v)} fontSize={11} stroke={C.t3} />
                  <Tooltip formatter={(v, name) => [fmt(v), name]} />
                  <Legend />
                  {UO.map(u => (
                    <Line key={u.cod} type="monotone" dataKey={u.cod} stroke={u.colore} strokeWidth={u.cod === 'COS' ? 3 : 2} dot={{ r: 3 }} activeDot={{ r: 6 }} />
                  ))}
                </LineChart>
              </ResponsiveContainer>
            </div>
            {/* Mini sparklines per UO */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: 12 }}>
              {UO.map(u => {
                const data = mesiDisp.map((m, i) => ({ m, R: u.rM[i], C: u.cM[i] }));
                return (
                  <div key={u.cod} style={{ ...cardS, padding: 14 }}>
                    <div style={{ display: 'flex', alignItems: 'center', marginBottom: 8 }}>
                      <span style={{ width: 10, height: 10, borderRadius: '50%', background: u.colore, display: 'inline-block', marginRight: 6 }}></span>
                      <span style={{ fontSize: 13, fontWeight: 600, color: C.t1 }}>{u.cod}</span>
                      <span style={{ fontSize: 11, color: C.t3, marginLeft: 6 }}>{u.tipo}</span>
                      <Badge reale={u.datiReali} />
                      <span style={{ marginLeft: 'auto', fontSize: 11, padding: '2px 8px', borderRadius: 12, background: u.molGPct >= .08 ? C.verdeBg : u.molGPct >= 0 ? C.gialloBg : C.rossoBg, color: u.molGPct >= .08 ? C.verde : u.molGPct >= 0 ? C.giallo : C.rosso, fontWeight: 600 }}>
                        MOL-G {fmtPct(u.molGPct)}
                      </span>
                    </div>
                    <ResponsiveContainer width="100%" height={120}>
                      <LineChart data={data} margin={{ top: 5, right: 10, left: 0, bottom: 5 }}>
                        <XAxis dataKey="m" fontSize={9} tick={{ fill: C.t3 }} />
                        <YAxis tickFormatter={v => (v/1000).toFixed(0) + 'k'} fontSize={9} width={38} />
                        <Tooltip formatter={v => [fmt(v)]} />
                        <Line type="monotone" dataKey="R" name="Ricavi" stroke={u.colore} strokeWidth={2} dot={false} />
                        <Line type="monotone" dataKey="C" name="Costi" stroke={C.rossoChiaro} strokeWidth={1.5} dot={false} strokeDasharray="4 3" />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* ======================== CASH FLOW ======================== */}
        {tab === 'cashflow' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
            {/* C1: Waterfall */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Composizione Cash Flow Annuale</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Waterfall da Ricavi a Cash Flow Netto ‚Äî Gruppo Karol Sicilia</p>
              <ResponsiveContainer width="100%" height={340}>
                <BarChart data={waterfall} margin={{ top: 20, right: 20, left: 20, bottom: 50 }}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                  <XAxis dataKey="voce" fontSize={10} angle={-35} textAnchor="end" height={60} stroke={C.t2} />
                  <YAxis tickFormatter={v => fmt(v)} fontSize={11} stroke={C.t3} />
                  <Tooltip formatter={(v, name) => { if (name === 'base') return ['','']; return [fmt(v), 'Valore']; }} />
                  <Bar dataKey="base" stackId="a" fill="transparent" />
                  <Bar dataKey="barra" stackId="a" radius={[3,3,0,0]} barSize={36}>
                    {waterfall.map((d, i) => <Cell key={i} fill={d.col} />)}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
              <div style={{ display: 'flex', justifyContent: 'center', gap: 20, marginTop: 8 }}>
                {[{ c: C.verde, l: 'Entrate' }, { c: C.rosso, l: 'Uscite' }, { c: '#2563eb', l: 'Subtotali' }, { c: '#b91c1c', l: 'CF Netto (neg.)' }]
                  .map(leg => <span key={leg.l} style={{ fontSize: 11, display: 'flex', alignItems: 'center', gap: 5 }}>
                    <span style={{ width: 12, height: 12, borderRadius: 3, background: leg.c }}></span>{leg.l}
                  </span>)}
              </div>
            </div>

            {/* C2+C3: Cassa + Scenari */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Saldo Cassa ‚Äî 12 Settimane</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Soglia minima ‚Ç¨200k (linea tratteggiata)</p>
                <ResponsiveContainer width="100%" height={260}>
                  <AreaChart data={cassaSett} margin={{ top: 10, right: 10, left: 10, bottom: 5 }}>
                    <defs>
                      <linearGradient id="gradC" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor={C.CTA} stopOpacity={0.2}/>
                        <stop offset="95%" stopColor={C.CTA} stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                    <XAxis dataKey="s" fontSize={11} stroke={C.t3} />
                    <YAxis tickFormatter={v => '‚Ç¨' + v + '.000'} fontSize={10} stroke={C.t3} domain={[0, 600]} />
                    <Tooltip formatter={v => ['‚Ç¨' + v + '.000']} />
                    <ReferenceLine y={200} stroke={C.rosso} strokeDasharray="6 4" strokeWidth={2} label={{ value: 'Soglia min.', position: 'right', fontSize: 10, fill: C.rosso }} />
                    <Area type="monotone" dataKey="saldo" name="Saldo" stroke={C.CTA} strokeWidth={2.5} fill="url(#gradC)" dot={(props) => {
                      const { cx, cy, payload } = props;
                      if (payload.saldo < 200) return <circle cx={cx} cy={cy} r={5} fill={C.rosso} stroke="white" strokeWidth={2} />;
                      return <circle cx={cx} cy={cy} r={3} fill={C.CTA} stroke="white" strokeWidth={1.5} />;
                    }} />
                  </AreaChart>
                </ResponsiveContainer>
                <div style={{ marginTop: 8, padding: '8px 12px', background: C.rossoBg, borderRadius: 6, fontSize: 11, color: C.rosso, fontWeight: 500 }}>
                  ‚ö†Ô∏è S10: Saldo ‚Ç¨180k sotto soglia ‚Äî possibile tensione di cassa per ritardo incassi ASP
                </div>
              </div>

              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Cash Flow Cumulato ‚Äî Scenari 5 Anni</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Ottimistico / Base / Pessimistico (‚Ç¨k cumulati)</p>
                <ResponsiveContainer width="100%" height={260}>
                  <ComposedChart data={scenari} margin={{ top: 10, right: 10, left: 10, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                    <XAxis dataKey="anno" fontSize={12} stroke={C.t3} />
                    <YAxis tickFormatter={v => '‚Ç¨' + v + '.000'} fontSize={11} stroke={C.t3} />
                    <Tooltip formatter={v => ['‚Ç¨' + v + '.000']} />
                    <Legend />
                    <ReferenceLine y={0} stroke={C.t3} strokeWidth={1} />
                    <Line type="monotone" dataKey="ott" name="Ottimistico" stroke={C.verde} strokeWidth={2} dot={{ r: 4, fill: C.verde }} />
                    <Line type="monotone" dataKey="base" name="Base" stroke={C.CTA} strokeWidth={3} dot={{ r: 4, fill: C.CTA }} />
                    <Line type="monotone" dataKey="pess" name="Pessimistico" stroke={C.rosso} strokeWidth={2} strokeDasharray="6 3" dot={{ r: 4, fill: C.rosso }} />
                  </ComposedChart>
                </ResponsiveContainer>
                <div style={{ marginTop: 8, padding: '8px 12px', background: '#fffbeb', borderRadius: 6, fontSize: 11, color: '#92400e' }}>
                  Scenario pessimistico: CF negativo dal 2027 ‚Äî necessaria rinegoziazione debito o riduzione CAPEX
                </div>
              </div>
            </div>

            {/* C4: KPI Cash Flow */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12 }}>
              {[
                { label: 'DSO ASP', valore: D.cashflow.kpi.dso + ' gg', target: '< ' + BENCH.dso + ' gg', sem: React.createElement(Semaforo, { valore: D.cashflow.kpi.dso, verdeMin: BENCH.dso, gialloMin: BENCH.dso * 1.5, invertito: true }) },
                { label: 'DPO Fornitori', valore: D.cashflow.kpi.dpo + ' gg', target: '< ' + BENCH.dpo + ' gg', sem: React.createElement(Semaforo, { valore: D.cashflow.kpi.dpo, verdeMin: BENCH.dpo, gialloMin: BENCH.dpo * 1.3, invertito: true }) },
                { label: 'DSCR', valore: '1.15x', target: '> 1.2x', sem: React.createElement(Semaforo, { valore: 1.15, verdeMin: 1.2, gialloMin: 1.0 }) },
                { label: 'Copertura Cassa', valore: '1.8 mesi', target: '> 2.0 mesi', sem: React.createElement(Semaforo, { valore: 1.8, verdeMin: 2.0, gialloMin: 1.0 }) },
              ].map((kpi, i) => (
                <div key={i} style={{ ...cardS, textAlign: 'center' }}>
                  <div style={{ fontSize: 11, color: C.t3, fontWeight: 500 }}>{kpi.label}</div>
                  <div style={{ fontSize: 20, fontWeight: 700, color: C.t1, margin: '6px 0' }}>{kpi.valore}</div>
                  <div style={{ marginBottom: 6 }}>{kpi.sem}</div>
                  <div style={{ fontSize: 10, color: C.t3 }}>Target: {kpi.target}</div>
                </div>
              ))}
            </div>

            {/* C5: CCC + Scadenziario */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
              {/* Cash Conversion Cycle */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Cash Conversion Cycle</h3>
                {(() => {
                  const kp = D.cashflow.kpi;
                  const dio = 15; // Days Inventory Outstanding (stimato per servizi)
                  const ccc = kp.dso + dio - kp.dpo;
                  const cccBench = BENCH.dso + 15 - BENCH.dpo;
                  const items = [
                    { label: 'DSO (incasso clienti ASP)', val: kp.dso, unit: 'gg', col: '#3b82f6', op: '+' },
                    { label: 'DIO (ciclo scorte/servizi)', val: dio, unit: 'gg', col: '#8b5cf6', op: '+' },
                    { label: 'DPO (pagamento fornitori)', val: kp.dpo, unit: 'gg', col: '#06b6d4', op: '-' },
                    { label: 'CCC', val: ccc, unit: 'gg', col: ccc <= cccBench ? C.verde : ccc <= cccBench * 1.5 ? C.giallo : C.rosso, op: '=' },
                  ];
                  return (
                    <div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                        {items.map((it, i) => (
                          <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '8px 12px', background: i === 3 ? '#f0f4f8' : 'white', borderRadius: 6, border: '1px solid ' + (i === 3 ? it.col : C.bordo) }}>
                            <span style={{ fontSize: 16, fontWeight: 700, color: C.t3, width: 16, textAlign: 'center' }}>{it.op}</span>
                            <span style={{ flex: 1, fontSize: 12, color: C.t1, fontWeight: i === 3 ? 700 : 500 }}>{it.label}</span>
                            <span style={{ fontSize: 18, fontWeight: 700, color: it.col, fontFamily: 'monospace' }}>{it.val} {it.unit}</span>
                          </div>
                        ))}
                      </div>
                      <div style={{ marginTop: 12, padding: '8px 12px', background: ccc <= 0 ? C.verdeBg : '#fffbeb', borderRadius: 6, fontSize: 11, color: ccc <= 0 ? C.verde : '#92400e' }}>
                        {ccc <= 0
                          ? 'CCC negativo: Karol incassa prima di pagare ‚Äî posizione finanziaria favorevole.'
                          : `CCC ${ccc} gg: ${ccc} giorni di finanziamento del ciclo operativo. Benchmark settore: ${cccBench} gg.`
                        }
                      </div>
                    </div>
                  );
                })()}
              </div>

              {/* Scadenziario crediti/debiti */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Scadenziario Crediti / Debiti</h3>
                {(() => {
                  const sc = D.cashflow.scadenziario;
                  const thS = { padding: '6px 8px', textAlign: 'right', color: C.t2, fontSize: 11 };
                  const tdS = { padding: '6px 8px', textAlign: 'right', fontFamily: 'monospace', fontSize: 12 };
                  return (
                    <div>
                      <table style={{ width: '100%', borderCollapse: 'collapse', marginBottom: 12 }}>
                        <thead>
                          <tr style={{ borderBottom: '2px solid ' + C.bordo }}>
                            <th style={{ ...thS, textAlign: 'left' }}>Fascia</th>
                            <th style={thS}>Crediti</th>
                            <th style={thS}>%</th>
                            <th style={thS}>Debiti</th>
                            <th style={thS}>%</th>
                            <th style={thS}>Saldo</th>
                          </tr>
                        </thead>
                        <tbody>
                          {sc.crediti.map((cr, i) => {
                            const db = sc.debiti[i];
                            const saldo = cr.importo - db.importo;
                            return (
                              <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo }}>
                                <td style={{ padding: '6px 8px', fontSize: 12, fontWeight: 500 }}>{cr.fascia}</td>
                                <td style={{ ...tdS, color: C.verde }}>{fmt(cr.importo)}</td>
                                <td style={{ ...tdS, color: C.t3, fontSize: 10 }}>{fmtPct(cr.pct)}</td>
                                <td style={{ ...tdS, color: C.rosso }}>{fmt(db.importo)}</td>
                                <td style={{ ...tdS, color: C.t3, fontSize: 10 }}>{fmtPct(db.pct)}</td>
                                <td style={{ ...tdS, fontWeight: 600, color: saldo >= 0 ? C.verde : C.rosso }}>{saldo >= 0 ? '+' : ''}{fmt(saldo)}</td>
                              </tr>
                            );
                          })}
                          <tr style={{ borderTop: '2px solid ' + C.primario, background: '#f0f4f8' }}>
                            <td style={{ padding: '6px 8px', fontWeight: 700, fontSize: 12 }}>Totale</td>
                            <td style={{ ...tdS, fontWeight: 700, color: C.verde }}>{fmt(sc.totCrediti)}</td>
                            <td style={{ ...tdS, color: C.t3 }}>100%</td>
                            <td style={{ ...tdS, fontWeight: 700, color: C.rosso }}>{fmt(sc.totDebiti)}</td>
                            <td style={{ ...tdS, color: C.t3 }}>100%</td>
                            <td style={{ ...tdS, fontWeight: 700, color: (sc.totCrediti - sc.totDebiti) >= 0 ? C.verde : C.rosso }}>{fmt(sc.totCrediti - sc.totDebiti)}</td>
                          </tr>
                        </tbody>
                      </table>
                      <div style={{ display: 'flex', gap: 8 }}>
                        <div style={{ flex: 1, padding: '8px 10px', background: C.verdeBg, borderRadius: 6, fontSize: 11, color: C.verde, textAlign: 'center' }}>
                          Crediti entro 60gg: {fmtPct(sc.crediti[0].pct + sc.crediti[1].pct)}
                        </div>
                        <div style={{ flex: 1, padding: '8px 10px', background: C.rossoBg, borderRadius: 6, fontSize: 11, color: C.rosso, textAlign: 'center' }}>
                          Debiti oltre 60gg: {fmtPct(sc.debiti[2].pct + sc.debiti[3].pct)}
                        </div>
                      </div>
                    </div>
                  );
                })()}
              </div>
            </div>
          </div>
        )}

        {/* ======================== PIANO FINANZIARIO ======================== */}
        {tab === 'piano' && (() => {
          const P = D.piano;
          const nuoveBU = P.nuove_bu;
          const riskCol = r => r === 'basso' ? C.verde : r === 'medio-alto' ? C.giallo : C.rosso;

          // Timeline dati per grafico
          const timeline = [
            { anno: '2025', ricavi_attuali: 10975, ricavi_nuove: 0, ebitda: -140, debt_service: 890, cassa: 230 },
            { anno: '2026', ricavi_attuali: 11200, ricavi_nuove: 1200, ebitda: 450, debt_service: 2000, cassa: 650 },
            { anno: '2027', ricavi_attuali: 11500, ricavi_nuove: 5500, ebitda: 2400, debt_service: 2800, cassa: 900 },
            { anno: '2028', ricavi_attuali: 11800, ricavi_nuove: 7200, ebitda: 3200, debt_service: 2800, cassa: 1300 },
            { anno: '2029', ricavi_attuali: 12000, ricavi_nuove: 8500, ebitda: 3800, debt_service: 2600, cassa: 1800 },
            { anno: '2030', ricavi_attuali: 12200, ricavi_nuove: 9800, ebitda: 4500, debt_service: 2400, cassa: 2500 },
          ];
          const dscr_data = [
            { anno: '2025', dscr: 0.85, soglia: 1.0 },
            { anno: '2026', dscr: 0.92, soglia: 1.0 },
            { anno: '2027', dscr: 0.86, soglia: 1.0 },
            { anno: '2028', dscr: 1.05, soglia: 1.0 },
            { anno: '2029', dscr: 1.35, soglia: 1.0 },
            { anno: '2030', dscr: 1.65, soglia: 1.0 },
          ];

          return (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>

            {/* Header Piano */}
            <div style={{...cardS, background: 'linear-gradient(135deg, #1F4E79 0%, #2E75B6 100%)', color: 'white'}}>
              <h3 style={{ fontSize: 17, fontWeight: 700, marginBottom: 8 }}>Piano Finanziario 2025-2030</h3>
              <p style={{ fontSize: 13, opacity: 0.9 }}>Mutuo bancario {fmt(P.mutuo.importo)} (10yr, {(P.mutuo.tasso*100).toFixed(1)}%) + MCC {fmt(P.mcc.importo)} | Target: riduzione costi {(P.target.riduzione_costi_pct*100)}% | Ricavi 2027: {fmt(P.target.ricavi_2027)}</p>
              <div style={{ display: 'flex', gap: 16, marginTop: 12, flexWrap: 'wrap' }}>
                {[
                  { l: 'Mutuo (stima)', v: P.mutuo.data_stima_erogazione, c: '#10b981' },
                  { l: 'DSCR 2027', v: '0,86x', c: '#dc2626' },
                  { l: 'CTA Contenzioso', v: fmt(P.crediti_attesi.cta_contenzioso.importo), c: '#f59e0b' },
                  { l: 'ZES Unica', v: fmt(P.crediti_attesi.zes_unica.importo), c: '#8b5cf6' },
                ].map((k, i) => (
                  <div key={i} style={{ background: 'rgba(255,255,255,0.15)', borderRadius: 8, padding: '8px 14px', minWidth: 140 }}>
                    <div style={{ fontSize: 10, opacity: 0.8 }}>{k.l}</div>
                    <div style={{ fontSize: 16, fontWeight: 700, color: k.c }}>{k.v}</div>
                  </div>
                ))}
              </div>
            </div>

            {/* Nuove BU ‚Äî Card grid */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Nuove Business Unit ‚Äî Pipeline</h3>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: 12 }}>
                {nuoveBU.map((bu, i) => (
                  <div key={i} style={{ border: '1px solid ' + C.bordo, borderRadius: 8, padding: 14, borderLeft: '4px solid ' + (bu.cod === 'BRT' ? C.verde : bu.cod === 'KMC' ? C.giallo : C.rosso) }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 }}>
                      <span style={{ fontWeight: 700, fontSize: 14 }}>{bu.cod} ‚Äî {bu.nome}</span>
                      <span style={{ fontSize: 10, padding: '2px 8px', borderRadius: 10, background: bu.cod === 'BRT' ? C.verdeBg : bu.cod === 'KMC' ? C.gialloBg : C.rossoBg, color: bu.cod === 'BRT' ? C.verde : bu.cod === 'KMC' ? C.giallo : C.rosso, fontWeight: 600 }}>{bu.tipo}</span>
                    </div>
                    <div style={{ fontSize: 12, color: C.t2, marginBottom: 8 }}>{bu.regione} | {bu.pl} PL</div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 4, fontSize: 12 }}>
                      <div><span style={{ color: C.t3 }}>CAPEX residuo:</span> <strong>{fmt(bu.capex_residuo)}</strong></div>
                      <div><span style={{ color: C.t3 }}>Ricavi a regime:</span> <strong>{fmt(bu.ricavi_regime)}</strong></div>
                      <div><span style={{ color: C.t3 }}>Apertura:</span> <strong>{bu.apertura_stima}</strong></div>
                      <div><span style={{ color: C.t3 }}>Ramp-up:</span> <strong>{bu.ramp_up_mesi} mesi</strong></div>
                    </div>
                    <p style={{ fontSize: 11, color: C.t2, marginTop: 8, fontStyle: 'italic' }}>{bu.nota}</p>
                  </div>
                ))}
              </div>
            </div>

            {/* DSCR Chart */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>DSCR ‚Äî Debt Service Coverage Ratio</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>Soglia minima 1,0x ‚Äî "passaggio stretto" 2025-2027</p>
                <ResponsiveContainer width="100%" height={250}>
                  <ComposedChart data={dscr_data}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                    <XAxis dataKey="anno" fontSize={12} />
                    <YAxis fontSize={11} domain={[0, 2]} tickFormatter={v => v.toFixed(1) + 'x'} />
                    <Tooltip formatter={(v, n) => [v.toFixed(2) + 'x', n === 'dscr' ? 'DSCR' : 'Soglia']} />
                    <ReferenceLine y={1.0} stroke={C.rosso} strokeDasharray="5 5" label={{ value: 'Min 1,0x', fill: C.rosso, fontSize: 10 }} />
                    <Bar dataKey="dscr" radius={[4,4,0,0]} barSize={40}>
                      {dscr_data.map((d, i) => <Cell key={i} fill={d.dscr >= 1.0 ? C.verde : d.dscr >= 0.9 ? C.giallo : C.rosso} />)}
                    </Bar>
                  </ComposedChart>
                </ResponsiveContainer>
              </div>

              {/* Struttura debito */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Struttura Debito e Rientro</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 12 }}>PFN consolidata ‚Ç¨19,1M (FY2024) ‚Äî target rientro 5 anni</p>
                <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                  {[
                    { l: 'Debiti tributari', v: P.debiti_rientro.tributari.totale, rata: P.debiti_rientro.tributari.rata_annua_stima, c: C.rosso },
                    { l: 'Debiti previdenziali', v: P.debiti_rientro.previdenziali.totale, rata: P.debiti_rientro.previdenziali.rata_annua_stima, c: '#d97706' },
                    { l: 'Mutuo bancario (nuovo)', v: P.mutuo.importo, rata: P.mutuo.rata_annua, c: C.primario },
                    { l: 'MCC (nuovo)', v: P.mcc.importo, rata: P.mcc.rata_annua, c: '#7c3aed' },
                  ].map((d, i) => (
                    <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 8, padding: '8px 12px', background: '#f8fafc', borderRadius: 6, borderLeft: '3px solid ' + d.c }}>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: 13, fontWeight: 600 }}>{d.l}</div>
                        <div style={{ fontSize: 11, color: C.t3 }}>Rata annua stima: {fmt(d.rata)}</div>
                      </div>
                      <div style={{ fontSize: 16, fontWeight: 700, color: d.c }}>{fmt(d.v)}</div>
                    </div>
                  ))}
                  <div style={{ padding: '10px 12px', background: C.rossoBg, borderRadius: 6, borderLeft: '3px solid ' + C.rosso, marginTop: 4 }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                      <span style={{ fontSize: 14, fontWeight: 700, color: C.rosso }}>Debt Service Annuo Totale</span>
                      <span style={{ fontSize: 16, fontWeight: 800, color: C.rosso }}>{fmt(P.debiti_rientro.tributari.rata_annua_stima + P.debiti_rientro.previdenziali.rata_annua_stima + P.mutuo.rata_annua + P.mcc.rata_annua)}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Ricavi proiezione */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Proiezione Ricavi ‚Äî Attuali + Nuove BU (‚Ç¨k)</h3>
              <ResponsiveContainer width="100%" height={280}>
                <BarChart data={timeline}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                  <XAxis dataKey="anno" fontSize={12} />
                  <YAxis fontSize={11} tickFormatter={v => v.toLocaleString('it-IT') + 'k'} />
                  <Tooltip formatter={(v, n) => ['‚Ç¨ ' + v.toLocaleString('it-IT') + 'k', n === 'ricavi_attuali' ? 'BU Attuali' : 'Nuove BU']} />
                  <Legend />
                  <Bar dataKey="ricavi_attuali" name="BU Attuali" stackId="a" fill={C.primario} radius={[0,0,0,0]} />
                  <Bar dataKey="ricavi_nuove" name="Nuove BU" stackId="a" fill={C.verde} radius={[4,4,0,0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Crediti attesi */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Crediti Attesi ‚Äî Non nel CE Operativo</h3>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: 12 }}>
                {[
                  { titolo: 'Contenzioso CTA/Regione', importo: P.crediti_attesi.cta_contenzioso.importo, stato: 'Transazione imminente', prob: 'Alta', c: C.verde },
                  { titolo: 'Crediti Fiscali (Innovazione + Patent Box)', importo: P.crediti_attesi.crediti_fiscali.importo, stato: P.crediti_attesi.crediti_fiscali.stato, prob: 'Media-Alta', c: C.giallo },
                  { titolo: 'ZES Unica', importo: P.crediti_attesi.zes_unica.importo, stato: 'Finestra ' + P.crediti_attesi.zes_unica.finestra, prob: 'Media', c: '#7c3aed' },
                ].map((cr, i) => (
                  <div key={i} style={{ border: '1px solid ' + C.bordo, borderRadius: 8, padding: 14, borderTop: '3px solid ' + cr.c }}>
                    <div style={{ fontSize: 13, fontWeight: 700, marginBottom: 4 }}>{cr.titolo}</div>
                    <div style={{ fontSize: 22, fontWeight: 800, color: cr.c, marginBottom: 6 }}>{fmt(cr.importo)}</div>
                    <div style={{ fontSize: 11, color: C.t2 }}>{cr.stato}</div>
                    <div style={{ fontSize: 11, marginTop: 4 }}><span style={{ color: C.t3 }}>Probabilit\u00E0:</span> <strong>{cr.prob}</strong></div>
                  </div>
                ))}
              </div>
              <p style={{ fontSize: 11, color: C.t3, marginTop: 8, fontStyle: 'italic' }}>Totale potenziale: {fmt(7000000 + 1500000 + 550000)} ‚Äî se realizzati, migliorano DSCR di ~0,8x e riducono PFN del 47%</p>
            </div>

          </div>
          );
        })()}

        {/* ======================== ANALISI COSTI ======================== */}
        {tab === 'analisi' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>

            {/* Composizione costi per categoria ‚Äî Stacked Bar */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Composizione Costi per UO</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Stacked bar ‚Äî Breakdown categorie di costo</p>
              <ResponsiveContainer width="100%" height={320}>
                <BarChart data={UO.map(u => ({
                  nome: u.cod, Personale: u.costi.personale, Materiali: u.costi.materiali,
                  Servizi: u.costi.servizi, Utenze: u.costi.utenze, Manutenzione: u.costi.manutenzione, Altri: u.costi.altri
                }))} margin={{ top: 10, right: 20, left: 20, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                  <XAxis dataKey="nome" fontSize={12} stroke={C.t2} />
                  <YAxis tickFormatter={v => fmt(v)} fontSize={9} stroke={C.t3} />
                  <Tooltip formatter={v => [fmt(v)]} />
                  <Legend />
                  <Bar dataKey="Personale" stackId="a" fill="#3b82f6" />
                  <Bar dataKey="Materiali" stackId="a" fill="#8b5cf6" />
                  <Bar dataKey="Servizi" stackId="a" fill="#06b6d4" />
                  <Bar dataKey="Utenze" stackId="a" fill="#f59e0b" />
                  <Bar dataKey="Manutenzione" stackId="a" fill="#ef4444" />
                  <Bar dataKey="Altri" stackId="a" fill="#94a3b8" radius={[4,4,0,0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Treemap costi ‚Äî visualizzazione gerarchica */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Mappa Costi ‚Äî Treemap Gerarchico</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Area proporzionale all'importo ‚Äî Costi diretti UO + Sede HQ</p>
              {(() => {
                const catColors = { Personale: '#3b82f6', Materiali: '#8b5cf6', Servizi: '#06b6d4', Utenze: '#f59e0b', Manutenzione: '#ef4444', Altri: '#94a3b8', Sede: '#1e293b' };
                // Costruisci dati treemap: per ogni UO, le categorie di costo
                const tmData = [];
                UO.forEach(u => {
                  Object.entries(u.costi).forEach(([cat, val]) => {
                    if (val > 0) {
                      const catLabel = cat.charAt(0).toUpperCase() + cat.slice(1);
                      tmData.push({ name: u.cod + ' ‚Äî ' + catLabel, size: val, uo: u.cod, cat: catLabel, color: catColors[catLabel] || '#94a3b8' });
                    }
                  });
                });
                // Aggiungi costi sede
                Object.entries(D.SEDE).forEach(([k, v]) => {
                  if (k !== 'totale' && v > 0) {
                    const label = k.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
                    tmData.push({ name: 'SEDE ‚Äî ' + label, size: v, uo: 'SEDE', cat: 'Sede', color: catColors.Sede });
                  }
                });
                tmData.sort((a, b) => b.size - a.size);

                const CustomContent = (props) => {
                  const { x, y, width, height, name, size } = props;
                  if (width < 40 || height < 25) return null;
                  return (
                    <g>
                      <rect x={x} y={y} width={width} height={height} rx={4}
                        style={{ fill: props.color || '#94a3b8', stroke: '#fff', strokeWidth: 2, opacity: 0.85 }} />
                      {width > 60 && height > 35 && (
                        <text x={x + width / 2} y={y + height / 2 - 7} textAnchor="middle" fill="#fff" fontSize={10} fontWeight={600}>
                          {name?.split(' ‚Äî ')[0]}
                        </text>
                      )}
                      {width > 60 && height > 35 && (
                        <text x={x + width / 2} y={y + height / 2 + 8} textAnchor="middle" fill="#ffffffcc" fontSize={9}>
                          {fmt(size)}
                        </text>
                      )}
                    </g>
                  );
                };

                return (
                  <div>
                    <ResponsiveContainer width="100%" height={340}>
                      <Treemap data={tmData} dataKey="size" nameKey="name" content={<CustomContent />}>
                        <Tooltip formatter={v => [fmt(v), 'Importo']} />
                      </Treemap>
                    </ResponsiveContainer>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: 12, marginTop: 10, justifyContent: 'center' }}>
                      {Object.entries(catColors).map(([cat, col]) => (
                        <span key={cat} style={{ fontSize: 11, display: 'flex', alignItems: 'center', gap: 5 }}>
                          <span style={{ width: 12, height: 12, borderRadius: 3, background: col, opacity: 0.85 }}></span>{cat}
                        </span>
                      ))}
                    </div>
                  </div>
                );
              })()}
            </div>

            {/* Benchmark confronto ‚Äî incidenza % su ricavi */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Benchmark ‚Äî Incidenza Costi su Ricavi</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Confronto UO vs benchmark settore</p>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={UO.map(u => ({
                  nome: u.cod,
                  'Pers %': +(u.persPct * 100).toFixed(1),
                  'Bench Pers': +(BENCH.pers_pct * 100).toFixed(1),
                  'Costi Dir %': +((u.costiDir / u.ricavi) * 100).toFixed(1),
                }))} layout="vertical" margin={{ left: 45, right: 30 }}>
                  <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
                  <XAxis type="number" domain={[0, 100]} tickFormatter={v => v + '%'} fontSize={11} stroke={C.t3} />
                  <YAxis type="category" dataKey="nome" fontSize={12} stroke={C.t2} />
                  <Tooltip formatter={v => [v + '%']} />
                  <Legend />
                  <Bar dataKey="Pers %" fill="#3b82f6" barSize={14} radius={[0,4,4,0]} />
                  <Bar dataKey="Bench Pers" fill="#cbd5e1" barSize={14} radius={[0,4,4,0]} />
                  <Bar dataKey="Costi Dir %" fill="#8b5cf6" barSize={14} radius={[0,4,4,0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Narrative per UO */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Variance Analysis ‚Äî Narrative</h3>
              {narrative.map((n, i) => {
                const u = UO.find(x => x.cod === n.uo);
                const ac = alertCol(n.alert);
                return (
                  <div key={i} style={{ marginBottom: 12, padding: '14px 16px', borderRadius: 10, background: ac.bg, borderLeft: '5px solid ' + ac.color }}>
                    <div style={{ display: 'flex', alignItems: 'center', marginBottom: 6 }}>
                      {u && <span style={{ width: 10, height: 10, borderRadius: '50%', background: u.colore, display: 'inline-block', marginRight: 8 }}></span>}
                      <span style={{ fontWeight: 700, fontSize: 14, color: C.t1 }}>{n.uo === 'GRUPPO' ? 'GRUPPO KAROL' : n.uo + ' ‚Äî ' + (u ? u.nome : '')}</span>
                      <span style={{ marginLeft: 8, fontSize: 11, padding: '2px 8px', borderRadius: 12, background: ac.color, color: '#fff' }}>{n.alert}</span>
                      <span style={{ marginLeft: 'auto', fontFamily: 'monospace', fontSize: 13, fontWeight: 600, color: (u ? u.molG : TOT.molG) >= 0 ? C.verde : C.rosso }}>
                        MOL-G: {fmt(u ? u.molG : TOT.molG)}
                      </span>
                    </div>
                    <p style={{ fontSize: 12, color: C.t1, lineHeight: 1.6, marginBottom: 4 }}>{n.testo}</p>
                    <p style={{ fontSize: 11, color: C.t2, fontStyle: 'italic', borderTop: '1px solid ' + ac.color + '33', paddingTop: 6 }}>
                      <strong>Outlook:</strong> {n.outlook}
                    </p>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* ======================== SIMULAZIONI ======================== */}
        {tab === 'simulazioni' && (() => {
          // Calcola impatto simulazione
          const simTotRic = TOT.ric * (1 + simRic / 100);
          const simTotPers = TOT.pers * (1 + simPers / 100);
          const simTotSede = TOT.sede * (1 + simSede / 100);
          const simAltriCosti = TOT.cDir - TOT.pers;
          const simMolI = simTotRic - simTotPers - simAltriCosti;
          const simMolG = simMolI - simTotSede;
          const simEbit = simMolG - TOT.ammort - TOT.oneri_fin;

          const deltaRic = simTotRic - TOT.ric;
          const deltaMolG = simMolG - TOT.molG;
          const deltaEbit = simEbit - TOT.ebit;

          const SliderRow = ({ label, value, setter, min, max, step, unit }) => (
            <div style={{ marginBottom: 16 }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 }}>
                <span style={{ fontSize: 13, fontWeight: 600, color: C.t1 }}>{label}</span>
                <span style={{ fontSize: 14, fontWeight: 700, color: value === 0 ? C.t3 : value > 0 ? C.verde : C.rosso, fontFamily: 'monospace' }}>
                  {value > 0 ? '+' : ''}{value}{unit || '%'}
                </span>
              </div>
              <input type="range" min={min} max={max} step={step || 1} value={value}
                onChange={e => setter(Number(e.target.value))}
                style={{ width: '100%', accentColor: C.primario }} />
              <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 10, color: C.t3 }}>
                <span>{min}{unit || '%'}</span><span>0</span><span>+{max}{unit || '%'}</span>
              </div>
            </div>
          );

          return (
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
              {/* Panel sliders */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Leve What-If</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 20 }}>Trascina gli slider per simulare variazioni % su base annua</p>
                <SliderRow label="Ricavi (variazione %)" value={simRic} setter={setSimRic} min={-20} max={20} />
                <SliderRow label="Costo Personale (variazione %)" value={simPers} setter={setSimPers} min={-15} max={15} />
                <SliderRow label="Costi Sede (variazione %)" value={simSede} setter={setSimSede} min={-30} max={10} />
                <SliderRow label="Occupancy (delta pp)" value={simOcc} setter={setSimOcc} min={-10} max={10} />
                <button onClick={() => { setSimRic(0); setSimPers(0); setSimOcc(0); setSimSede(0); }}
                  style={{ marginTop: 8, padding: '8px 20px', background: C.primario, color: 'white', border: 'none', borderRadius: 6, cursor: 'pointer', fontSize: 12, fontWeight: 600, fontFamily: 'inherit' }}>
                  Reset
                </button>
              </div>

              {/* Panel risultati */}
              <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                <div style={cardS}>
                  <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 16 }}>Impatto Simulazione</h3>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12 }}>
                    {[
                      { label: 'Ricavi Sim.', val: simTotRic, delta: deltaRic, base: TOT.ric },
                      { label: 'MOL-G Sim.', val: simMolG, delta: deltaMolG, base: TOT.molG },
                      { label: 'EBIT Sim.', val: simEbit, delta: deltaEbit, base: TOT.ebit },
                    ].map((r, i) => (
                      <div key={i} style={{ padding: 12, borderRadius: 8, background: r.delta >= 0 ? C.verdeBg : C.rossoBg, textAlign: 'center' }}>
                        <div style={{ fontSize: 10, color: C.t3, marginBottom: 4 }}>{r.label}</div>
                        <div style={{ fontSize: 16, fontWeight: 700, color: C.t1 }}>{fmt(r.val)}</div>
                        <div style={{ fontSize: 11, color: r.delta >= 0 ? C.verde : C.rosso, fontWeight: 600, marginTop: 2 }}>
                          {r.delta >= 0 ? '+' : ''}{fmt(r.delta)}
                        </div>
                        <div style={{ fontSize: 10, color: C.t3, marginTop: 2 }}>Base: {fmt(r.base)}</div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Waterfall impatto */}
                <div style={cardS}>
                  <h3 style={{ fontSize: 13, fontWeight: 700, color: C.t1, marginBottom: 8 }}>Waterfall Impatto</h3>
                  <ResponsiveContainer width="100%" height={220}>
                    <BarChart data={[
                      { voce: 'MOL-G Attuale', base: 0, val: TOT.molG, col: C.primario },
                      { voce: 'Œî Ricavi', base: TOT.molG, val: deltaRic, col: deltaRic >= 0 ? C.verde : C.rosso },
                      { voce: 'Œî Personale', base: TOT.molG + deltaRic, val: -(simTotPers - TOT.pers), col: simTotPers <= TOT.pers ? C.verde : C.rosso },
                      { voce: 'Œî Sede', base: simMolI - simTotSede + (simTotSede - TOT.sede), val: -(simTotSede - TOT.sede), col: simTotSede <= TOT.sede ? C.verde : C.rosso },
                      { voce: 'MOL-G Sim.', base: 0, val: simMolG, col: simMolG >= 0 ? '#047857' : '#b91c1c' },
                    ]} margin={{ top: 10, right: 10, left: 10, bottom: 30 }}>
                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                      <XAxis dataKey="voce" fontSize={10} angle={-25} textAnchor="end" height={50} stroke={C.t2} />
                      <YAxis tickFormatter={v => fmt(v)} fontSize={9} stroke={C.t3} />
                      <Tooltip formatter={v => [fmt(v)]} />
                      <Bar dataKey="base" stackId="a" fill="transparent" />
                      <Bar dataKey="val" stackId="a" radius={[3,3,0,0]} barSize={32}>
                        {[0,1,2,3,4].map(i => <Cell key={i} fill={[C.primario, deltaRic >= 0 ? C.verde : C.rosso, simTotPers <= TOT.pers ? C.verde : C.rosso, simTotSede <= TOT.sede ? C.verde : C.rosso, simMolG >= 0 ? '#047857' : '#b91c1c'][i]} />)}
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </div>

                {/* KPI simulati */}
                <div style={{ ...cardS, padding: '12px 16px' }}>
                  <div style={{ fontSize: 12, fontWeight: 600, color: C.t1, marginBottom: 6 }}>KPI Simulati</div>
                  <div style={{ display: 'flex', gap: 12 }}>
                    <span style={{ fontSize: 11, color: C.t2 }}>MOL-G %: <strong style={{ color: simMolG / simTotRic >= 0.08 ? C.verde : C.rosso }}>{fmtPct(simMolG / simTotRic)}</strong></span>
                    <span style={{ fontSize: 11, color: C.t2 }}>Pers %: <strong style={{ color: simTotPers / simTotRic <= 0.55 ? C.verde : C.rosso }}>{fmtPct(simTotPers / simTotRic)}</strong></span>
                    <span style={{ fontSize: 11, color: C.t2 }}>Sede %: <strong style={{ color: simTotSede / simTotRic <= 0.12 ? C.verde : C.rosso }}>{fmtPct(simTotSede / simTotRic)}</strong></span>
                  </div>
                </div>
              </div>

              {/* Proiezione multi-anno (full width) */}
              <div style={{ ...cardS, gridColumn: '1 / -1' }}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Proiezione Multi-Anno ‚Äî Scenario Simulato</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Effetto cumulato delle leve what-if su 5 anni (ipotesi: variazione costante annua)</p>
                {(() => {
                  const anno0 = D.meta.anno;
                  const proj = [];
                  for (let a = 0; a <= 5; a++) {
                    const compRic = Math.pow(1 + simRic / 100, a);
                    const compPers = Math.pow(1 + simPers / 100, a);
                    const compSede = Math.pow(1 + simSede / 100, a);
                    const ric = TOT.ric * compRic;
                    const pers = TOT.pers * compPers;
                    const altriC = TOT.cDir - TOT.pers;
                    const molI = ric - pers - altriC;
                    const sede = TOT.sede * compSede;
                    const molG = molI - sede;
                    const ebit = molG - TOT.ammort - TOT.oneri_fin;
                    proj.push({ anno: anno0 + a, Ricavi: Math.round(ric), 'MOL-G': Math.round(molG), EBIT: Math.round(ebit) });
                  }
                  return (
                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: 16 }}>
                      <ResponsiveContainer width="100%" height={260}>
                        <ComposedChart data={proj} margin={{ top: 10, right: 20, left: 20, bottom: 5 }}>
                          <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                          <XAxis dataKey="anno" fontSize={12} stroke={C.t2} />
                          <YAxis tickFormatter={v => fmt(v)} fontSize={9} stroke={C.t3} />
                          <Tooltip formatter={v => [fmt(v)]} />
                          <Legend />
                          <Bar dataKey="Ricavi" fill="#e2e8f0" barSize={28} radius={[3,3,0,0]} />
                          <Line type="monotone" dataKey="MOL-G" stroke={C.CTA} strokeWidth={2.5} dot={{ r: 4, fill: C.CTA }} />
                          <Line type="monotone" dataKey="EBIT" stroke={C.rosso} strokeWidth={2} strokeDasharray="5 3" dot={{ r: 3, fill: C.rosso }} />
                          <ReferenceLine y={0} stroke={C.t3} strokeWidth={1} />
                        </ComposedChart>
                      </ResponsiveContainer>
                      <table style={{ borderCollapse: 'collapse', fontSize: 11, alignSelf: 'center' }}>
                        <thead>
                          <tr style={{ borderBottom: '2px solid ' + C.bordo }}>
                            <th style={{ padding: '5px 8px', color: C.t2, textAlign: 'left' }}>Anno</th>
                            <th style={{ padding: '5px 8px', color: C.t2, textAlign: 'right' }}>Ricavi</th>
                            <th style={{ padding: '5px 8px', color: C.t2, textAlign: 'right' }}>MOL-G</th>
                            <th style={{ padding: '5px 8px', color: C.t2, textAlign: 'right' }}>EBIT</th>
                          </tr>
                        </thead>
                        <tbody>
                          {proj.map((p, i) => (
                            <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, background: i === 0 ? '#f0f4f8' : 'transparent' }}>
                              <td style={{ padding: '5px 8px', fontWeight: i === 0 ? 700 : 500 }}>{p.anno}{i === 0 ? ' (att.)' : ''}</td>
                              <td style={{ padding: '5px 8px', textAlign: 'right', fontFamily: 'monospace' }}>{fmt(p.Ricavi)}</td>
                              <td style={{ padding: '5px 8px', textAlign: 'right', fontFamily: 'monospace', color: p['MOL-G'] >= 0 ? C.verde : C.rosso }}>{fmt(p['MOL-G'])}</td>
                              <td style={{ padding: '5px 8px', textAlign: 'right', fontFamily: 'monospace', color: p.EBIT >= 0 ? C.verde : C.rosso }}>{fmt(p.EBIT)}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  );
                })()}
                <div style={{ marginTop: 10, padding: '8px 12px', background: '#f0f4f8', borderRadius: 6, fontSize: 11, color: C.t2 }}>
                  {simRic === 0 && simPers === 0 && simSede === 0
                    ? 'Muovi gli slider per vedere la proiezione multi-anno. L\'effetto si compone geometricamente.'
                    : `Ipotesi: Ricavi ${simRic >= 0 ? '+' : ''}${simRic}%/anno, Personale ${simPers >= 0 ? '+' : ''}${simPers}%/anno, Sede ${simSede >= 0 ? '+' : ''}${simSede}%/anno ‚Äî compounding su 5 anni.`
                  }
                </div>
              </div>
            </div>
          );
        })()}

      </div>

      {/* FOOTER */}
      <div style={{ textAlign: 'center', padding: '16px 0', fontSize: 11, color: C.t3, borderTop: '1px solid ' + C.bordo }}>
        Karol CdG v4.0 ‚Äî Gruppo Karol S.p.A. ‚Äî Cruscotto Controllo di Gestione | Aggiornamento: {D.meta.ultimo_aggiornamento}
      </div>
    </div>
  );
};

ReactDOM.render(React.createElement(KarolDashboard), document.getElementById('root'));
</script>
</body>
</html>
