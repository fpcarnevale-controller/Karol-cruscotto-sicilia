<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Karol CdG ‚Äî Controllo di Gestione</title>
<script type="importmap">
{"imports":{"react":"https://esm.sh/react@18.2.0","react-dom":"https://esm.sh/react-dom@18.2.0","react/jsx-runtime":"https://esm.sh/react@18.2.0/jsx-runtime","recharts":"https://esm.sh/recharts@2.12.7?external=react,react-dom"}}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="module">
import React, { useState } from 'react';
import ReactDOM from 'react-dom';
import * as Recharts from 'recharts';
window.React = React;
window.ReactDOM = ReactDOM;
window.Recharts = Recharts;
const s = document.querySelector('script[data-type="babel-source"]');
if (s) { const c = Babel.transform(s.textContent, {presets:['react']}).code; new Function(c)(); }
</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'DM Sans', 'Segoe UI', sans-serif; background: #F0F4F8; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/template" data-type="babel-source">
const { useState } = React;
const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LineChart, Line, Legend, AreaChart, Area, Cell, ReferenceLine, ComposedChart } = Recharts;

// ============================================================================
// PALETTE COLORI KAROL ‚Äî D1
// ============================================================================
const C = {
  primario: '#1F4E79', primarioChiaro: '#2E75B6', primarioScuro: '#163A5C',
  sfondo: '#F0F4F8', card: '#FFFFFF', bordo: '#e2e8f0',
  verde: '#059669', verdeBg: '#dcfce7', verdeChiaro: '#10b981',
  giallo: '#d97706', gialloBg: '#fef9c3', gialloChiaro: '#f59e0b',
  rosso: '#dc2626', rossoBg: '#fee2e2', rossoChiaro: '#ef4444',
  viola: '#7c3aed', violaBg: '#ede9fe',
  VLB: '#0ea5e9', CTA: '#3b82f6', COS: '#8b5cf6', LAB: '#f59e0b', KCP: '#ec4899',
  budget: '#cbd5e1', t1: '#1e293b', t2: '#64748b', t3: '#94a3b8',
};

// ============================================================================
// DATI CE ‚Äî Master Excel (elabora.py output 13/02/2026)
// ============================================================================
const UO = [
  { cod: 'VLB', nome: 'RSA Villabate', tipo: 'RSA Alzheimer', pl: 44, colore: C.VLB, datiReali: false,
    ricavi: 2004045, costiDir: 1675033, molI: 329012, molIPct: .1642,
    sede: 353127, molG: -24115, molGPct: -.0120,
    pers: 1147329, persPct: .5725, occ: .900, ricGg: 138.66,
    rM: [169640,149876,173154,168672,174978,166476,164006,154880,163696,174683,170602,173382],
    cM: [140731,139023,141794,142431,139408,138816,138345,135571,138366,140063,138567,141919] },
  { cod: 'CTA', nome: 'CTA Ex Stagno', tipo: 'Psichiatrico', pl: 40, colore: C.CTA, datiReali: false,
    ricavi: 1895648, costiDir: 1670541, molI: 225107, molIPct: .1187,
    sede: 326072, molG: -100965, molGPct: -.0533,
    pers: 1125426, persPct: .5937, occ: .920, ricGg: 141.19,
    rM: [159954,144470,163122,157669,165770,157080,153507,148029,153462,166605,161823,164157],
    cM: [139727,138994,137273,138930,139301,139815,137848,136411,139877,142422,140868,139074] },
  { cod: 'COS', nome: 'CdC Cosentino', tipo: 'Riabilitazione', pl: 50, colore: C.COS, datiReali: false,
    ricavi: 3799179, costiDir: 2924314, molI: 874865, molIPct: .2303,
    sede: 541917, molG: 332949, molGPct: .0876,
    pers: 1790988, persPct: .4714, occ: .860, ricGg: 241.99,
    rM: [320319,290930,321212,318851,328869,319828,309744,294979,308393,333165,321909,330982],
    cM: [244695,241092,240802,247326,245338,242449,243186,234286,242532,244702,251201,246704] },
  { cod: 'LAB', nome: 'Karol Lab', tipo: 'Laboratorio', pl: 0, colore: C.LAB, datiReali: false,
    ricavi: 1450153, costiDir: 891341, molI: 558813, molIPct: .3853,
    sede: 212873, molG: 345940, molGPct: .2386,
    pers: 438075, persPct: .3021, occ: null, ricGg: null,
    rM: [123238,120564,123838,126162,120026,116683,116136,111219,116108,127791,130075,118316],
    cM: [74958,73556,74432,75376,76159,75846,73710,69849,73075,74976,74564,74839] },
  { cod: 'KCP', nome: 'Karol Casa Protetta', tipo: 'Casa Protetta', pl: 20, colore: C.KCP, datiReali: false,
    ricavi: 700261, costiDir: 603299, molI: 96961, molIPct: .1385,
    sede: 158011, molG: -61050, molGPct: -.0872,
    pers: 391420, persPct: .5590, occ: null, ricGg: null,
    rM: [59361,53405,61086,58202,60141,57339,57604,54021,57324,61888,58959,60931],
    cM: [49419,50019,50686,50607,50544,50694,49326,48620,50241,51418,51571,50155] },
];

const TOT = { ric: 9849287, cDir: 7764528, molI: 2084759, molIPct: .2117, sede: 1592000, molG: 492759, molGPct: .0500, pers: 4893238, persPct: .4968 };

const KPI = [
  { kpi: 'MOL-I %', uo: 'VLB', v: .1642, tgt: .15, a: 'VERDE' },
  { kpi: 'MOL-G %', uo: 'VLB', v: -.0120, tgt: .08, a: 'ROSSO' },
  { kpi: 'Pers. %', uo: 'VLB', v: .5725, tgt: .55, a: 'GIALLO' },
  { kpi: 'Occ. %', uo: 'VLB', v: .900, tgt: .90, a: 'GIALLO' },
  { kpi: 'MOL-I %', uo: 'CTA', v: .1187, tgt: .15, a: 'GIALLO' },
  { kpi: 'MOL-G %', uo: 'CTA', v: -.0533, tgt: .08, a: 'ROSSO' },
  { kpi: 'Pers. %', uo: 'CTA', v: .5937, tgt: .55, a: 'GIALLO' },
  { kpi: 'Occ. %', uo: 'CTA', v: .920, tgt: .90, a: 'VERDE' },
  { kpi: 'MOL-I %', uo: 'COS', v: .2303, tgt: .15, a: 'VERDE' },
  { kpi: 'MOL-G %', uo: 'COS', v: .0876, tgt: .08, a: 'GIALLO' },
  { kpi: 'Pers. %', uo: 'COS', v: .4714, tgt: .55, a: 'VERDE' },
  { kpi: 'Occ. %', uo: 'COS', v: .860, tgt: .90, a: 'GIALLO' },
  { kpi: 'MOL-I %', uo: 'LAB', v: .3853, tgt: .15, a: 'VERDE' },
  { kpi: 'MOL-G %', uo: 'LAB', v: .2386, tgt: .08, a: 'VERDE' },
  { kpi: 'Pers. %', uo: 'LAB', v: .3021, tgt: .55, a: 'VERDE' },
  { kpi: 'MOL-I %', uo: 'KCP', v: .1385, tgt: .15, a: 'GIALLO' },
  { kpi: 'MOL-G %', uo: 'KCP', v: -.0872, tgt: .08, a: 'ROSSO' },
  { kpi: 'Pers. %', uo: 'KCP', v: .5590, tgt: .55, a: 'GIALLO' },
];

// Cash Flow
const waterfallRaw = [
  { voce: 'Ricavi', valore: 9849287, tipo: 'entrata' },
  { voce: 'Personale', valore: -4893238, tipo: 'uscita' },
  { voce: 'Costi diretti', valore: -1581693, tipo: 'uscita' },
  { voce: 'Servizi/Utenze', valore: -915897, tipo: 'uscita' },
  { voce: 'EBITDA', valore: 2084759, tipo: 'subtotale' },
  { voce: 'Costi Sede', valore: -1592000, tipo: 'uscita' },
  { voce: 'MOL-G', valore: 492759, tipo: 'subtotale' },
  { voce: 'Var. CCN', valore: -145000, tipo: 'uscita' },
  { voce: 'CF Operativo', valore: 347759, tipo: 'subtotale' },
  { voce: 'CAPEX', valore: -280000, tipo: 'uscita' },
  { voce: 'Free CF', valore: 67759, tipo: 'subtotale' },
  { voce: 'Debito', valore: -520000, tipo: 'uscita' },
  { voce: 'Imposte', valore: -148000, tipo: 'uscita' },
  { voce: 'CF Netto', valore: -600241, tipo: 'finale' },
];

let rt = 0;
const waterfall = waterfallRaw.map(w => {
  if (w.tipo === 'entrata') { rt = w.valore; return { ...w, base: 0, barra: w.valore, col: C.verde }; }
  if (w.tipo === 'uscita') { const b = rt + w.valore; const r = { ...w, base: Math.min(rt, rt + w.valore), barra: Math.abs(w.valore), col: C.rosso }; rt += w.valore; return r; }
  if (w.tipo === 'subtotale') { rt = w.valore; return { ...w, base: 0, barra: w.valore, col: '#2563eb' }; }
  rt = w.valore; return { ...w, base: 0, barra: Math.abs(w.valore), col: w.valore >= 0 ? '#047857' : '#b91c1c' };
});

const cassaSett = [
  { s: 'S1', saldo: 420, incassi: 180, pag: 150 }, { s: 'S2', saldo: 390, incassi: 120, pag: 150 },
  { s: 'S3', saldo: 340, incassi: 100, pag: 150 }, { s: 'S4', saldo: 510, incassi: 320, pag: 150 },
  { s: 'S5', saldo: 460, incassi: 100, pag: 150 }, { s: 'S6', saldo: 380, incassi: 70, pag: 150 },
  { s: 'S7', saldo: 290, incassi: 60, pag: 150 },  { s: 'S8', saldo: 240, incassi: 100, pag: 150 },
  { s: 'S9', saldo: 210, incassi: 120, pag: 150 },  { s: 'S10', saldo: 180, incassi: 120, pag: 150 },
  { s: 'S11', saldo: 350, incassi: 320, pag: 150 }, { s: 'S12', saldo: 400, incassi: 200, pag: 150 },
];

const scenari = [
  { anno: '2025', ott: 350, base: 250, pess: 80 },
  { anno: '2026', ott: 720, base: 480, pess: 120 },
  { anno: '2027', ott: 1150, base: 750, pess: -50 },
  { anno: '2028', ott: 1650, base: 1050, pess: -180 },
  { anno: '2029', ott: 2250, base: 1400, pess: -350 },
];

const narrative = [
  { uo: 'VLB', alert: 'GIALLO', testo: 'MOL-I 16,4% in target, ma costi sede (17,6% ricavi) assorbono il margine ‚Üí MOL-G -‚Ç¨24k. Azione: rinegoziare allocazione sede o aumentare occupancy oltre 90%.', outlook: 'Strutturale' },
  { uo: 'CTA', alert: 'ROSSO', testo: 'MOL-G -‚Ç¨101k. Personale al 59,4% dei ricavi. Il costo medici (‚Ç¨362k) √® il pi√π alto del gruppo. Azione: ottimizzare mix medici/OSS.', outlook: 'Persistente' },
  { uo: 'COS', alert: 'VERDE', testo: 'Best performer. MOL-I 23%, MOL-G 8,8%. Mix ricavi diversificato. Ricavo/giornata ‚Ç¨242 il pi√π alto.', outlook: 'Favorevole' },
  { uo: 'LAB', alert: 'VERDE', testo: 'Top performer con MOL-G 23,9%. Asset-light, personale solo 30,2%. Potenziale per crescita volumi.', outlook: 'Molto favorevole' },
  { uo: 'KCP', alert: 'ROSSO', testo: 'MOL-G -‚Ç¨61k (-8,7%). Diseconomie di scala: 20 PL, sede 22,6% ricavi. Valutare accorpamento con VLB.', outlook: 'Strutturale' },
  { uo: 'GRUPPO', alert: 'ROSSO', testo: 'MOL-G 5,0% sotto target 8%. Costi sede 16,2%. COS+LAB generano margine, VLB/CTA/KCP lo erodono. CF netto -‚Ç¨600k per debito (‚Ç¨520k) e CAPEX (‚Ç¨280k).', outlook: 'Critico ‚Äî piano efficientamento necessario' },
];

// ============================================================================
// HELPERS
// ============================================================================
const fmt = v => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v);
const fmtK = v => '‚Ç¨' + (v/1000).toFixed(0) + 'k';
const fmtM = v => '‚Ç¨' + (v/1000000).toFixed(1) + 'M';
const fmtPct = v => (v * 100).toFixed(1) + '%';
const mesi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];

const Semaforo = ({ valore, testo, verdeMin, gialloMin, invertito }) => {
  let colore, sfondo;
  if (invertito) {
    colore = valore <= verdeMin ? C.verde : valore <= gialloMin ? C.giallo : C.rosso;
  } else {
    colore = valore >= verdeMin ? C.verde : valore >= gialloMin ? C.giallo : C.rosso;
  }
  sfondo = colore === C.verde ? C.verdeBg : colore === C.giallo ? C.gialloBg : C.rossoBg;
  return React.createElement('span', { style: { background: sfondo, color: colore, padding: '2px 10px', borderRadius: 12, fontSize: 11, fontWeight: 600 } }, testo || (typeof valore === 'number' ? (valore % 1 === 0 ? valore : valore.toFixed(1)) : valore));
};

const Badge = ({ reale }) => {
  if (reale) return React.createElement('span', { style: { fontSize: 9, padding: '1px 6px', borderRadius: 10, background: C.verdeBg, color: C.verde, marginLeft: 6, fontWeight: 600 } }, 'Consuntivo');
  return React.createElement('span', { style: { fontSize: 9, padding: '1px 6px', borderRadius: 10, background: '#fff7ed', color: '#c2410c', marginLeft: 6, fontWeight: 600 } }, 'Dati simulati');
};

const alertCol = a => ({ color: a === 'ROSSO' ? C.rosso : a === 'GIALLO' ? C.giallo : C.verde, bg: a === 'ROSSO' ? C.rossoBg : a === 'GIALLO' ? C.gialloBg : C.verdeBg });

// ============================================================================
// COMPONENTE PRINCIPALE
// ============================================================================
const KarolDashboard = () => {
  const [tab, setTab] = useState('overview');
  const [selUO, setSelUO] = useState(null);

  const nR = KPI.filter(k => k.a === 'ROSSO').length;
  const nG = KPI.filter(k => k.a === 'GIALLO').length;
  const nV = KPI.filter(k => k.a === 'VERDE').length;
  const uoReali = UO.filter(u => u.datiReali).length;

  // Scostamento MOL-G
  const scost = [...UO].map(u => ({ nome: u.cod, nomeC: u.nome, scost: u.molG, fill: u.molG >= 0 ? C.verde : C.rosso })).sort((a,b) => a.scost - b.scost);

  // Trend multi-UO
  const trendUO = mesi.map((m, i) => { const d = { mese: m }; UO.forEach(u => { d[u.cod] = u.rM[i]; }); return d; });

  const tabs = [
    { id: 'overview', label: 'Overview', icon: 'üìä' },
    { id: 'strutture', label: 'Strutture', icon: 'üè•' },
    { id: 'trend', label: 'Trend', icon: 'üìà' },
    { id: 'cashflow', label: 'Cash Flow', icon: 'üí∞' },
    { id: 'analisi', label: 'Analisi', icon: 'üîç' },
  ];

  const cardS = { background: C.card, borderRadius: 10, padding: 20, boxShadow: '0 1px 4px rgba(0,0,0,0.05)', border: '1px solid ' + C.bordo };

  return (
    <div style={{ background: C.sfondo, minHeight: '100vh', fontFamily: "'DM Sans', 'Segoe UI', sans-serif" }}>
      {/* HEADER */}
      <div style={{ background: 'linear-gradient(135deg, ' + C.primario + ' 0%, ' + C.primarioChiaro + ' 100%)', padding: '20px 32px', color: 'white' }}>
        <div style={{ maxWidth: 1280, margin: '0 auto', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <div>
            <div style={{ fontSize: 24, fontWeight: 800, letterSpacing: 2 }}>KAROL</div>
            <div style={{ fontSize: 12, opacity: 0.7, letterSpacing: 3, marginTop: 2 }}>CONTROLLO DI GESTIONE</div>
          </div>
          <div style={{ textAlign: 'right' }}>
            <div style={{ fontSize: 15, fontWeight: 600 }}>Sicilia ‚Äî Anno 2025 (12 Mesi)</div>
            <div style={{ fontSize: 11, opacity: 0.7, marginTop: 4 }}>
              Completezza dati: {uoReali}/{UO.length} UO reali
              <span style={{ display: 'inline-block', width: 60, height: 5, borderRadius: 3, background: 'rgba(255,255,255,.2)', marginLeft: 8, verticalAlign: 'middle', overflow: 'hidden' }}>
                <span style={{ display: 'block', width: (uoReali/UO.length*100) + '%', height: '100%', borderRadius: 3, background: '#fca5a5' }}></span>
              </span>
            </div>
          </div>
        </div>
      </div>

      {/* KPI CARDS */}
      <div style={{ maxWidth: 1280, margin: '-20px auto 0', padding: '0 24px', position: 'relative', zIndex: 1 }}>
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(155px, 1fr))', gap: 12 }}>
          {[
            { label: 'Ricavi Totali', valore: fmtM(TOT.ric), colore: C.CTA },
            { label: 'MOL Industriale', valore: fmtM(TOT.molI), sub: fmtPct(TOT.molIPct), colore: C.verde },
            { label: 'Costi Sede', valore: fmtM(TOT.sede), sub: '16,2% ricavi', colore: C.viola },
            { label: 'MOL Gestionale', valore: fmtM(TOT.molG), sub: fmtPct(TOT.molGPct), colore: TOT.molG >= 0 ? C.verde : C.rosso },
            { label: 'DSO ASP', valore: '135 gg', sub: 'Target <120', colore: C.giallo },
            { label: 'Copertura Cassa', valore: '1,8 mesi', sub: 'Target >2,0', colore: C.giallo },
            { label: 'Alert', valore: (nR+nG) + ' attivi', sub: nR + 'üî¥ ' + nG + 'üü° ' + nV + 'üü¢', colore: C.rosso },
          ].map((kpi, i) => (
            <div key={i} style={{ background: C.card, borderRadius: 10, padding: '14px 16px', boxShadow: '0 1px 4px rgba(0,0,0,0.06)', borderLeft: '3px solid ' + kpi.colore, borderTop: '1px solid #f1f5f9' }}>
              <div style={{ fontSize: 11, color: C.t3, fontWeight: 500, marginBottom: 6 }}>{kpi.label}</div>
              <div style={{ fontSize: 18, fontWeight: 700, color: kpi.colore }}>{kpi.valore}</div>
              {kpi.sub && <div style={{ fontSize: 11, color: C.t3, marginTop: 2 }}>{kpi.sub}</div>}
            </div>
          ))}
        </div>
      </div>

      {/* TAB NAVIGATION */}
      <div style={{ maxWidth: 1280, margin: '20px auto 0', padding: '0 24px' }}>
        <div style={{ display: 'flex', gap: 4, borderBottom: '2px solid ' + C.bordo }}>
          {tabs.map(t => (
            <button key={t.id} onClick={() => setTab(t.id)}
              style={{ padding: '10px 20px', border: 'none', cursor: 'pointer', background: tab === t.id ? C.card : 'transparent', color: tab === t.id ? C.primario : C.t2, fontWeight: tab === t.id ? 700 : 500, fontSize: 14, borderBottom: tab === t.id ? '3px solid ' + C.primario : '3px solid transparent', borderRadius: '8px 8px 0 0', transition: 'all 0.2s', fontFamily: 'inherit' }}>
              {t.icon} {t.label}
            </button>
          ))}
        </div>
      </div>

      {/* CONTENT */}
      <div style={{ maxWidth: 1280, margin: '0 auto', padding: '20px 24px 40px' }}>

        {/* ======================== OVERVIEW ======================== */}
        {tab === 'overview' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>

            {/* B4: Occupancy Gauge */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: 12 }}>
              {UO.filter(u => u.occ !== null).map((u, i) => {
                const pct = u.occ * 100;
                const col = pct >= 90 ? C.verde : pct >= 80 ? C.giallo : C.rosso;
                return (
                  <div key={i} style={{ ...cardS, textAlign: 'center', padding: '12px 8px' }}>
                    <p style={{ fontSize: 11, color: C.t2, marginBottom: 8, fontWeight: 600 }}>
                      <span style={{ display: 'inline-block', width: 8, height: 8, borderRadius: '50%', background: u.colore, marginRight: 4 }}></span>
                      {u.cod} ‚Äî Occupancy
                    </p>
                    <svg width="100" height="60" viewBox="0 0 100 60" style={{ margin: '0 auto', display: 'block' }}>
                      <path d="M 10 55 A 40 40 0 0 1 90 55" fill="none" stroke="#e2e8f0" strokeWidth="8" strokeLinecap="round" />
                      <path d="M 10 55 A 40 40 0 0 1 90 55" fill="none" stroke={col} strokeWidth="8" strokeLinecap="round" strokeDasharray={(pct / 100 * 126) + ' 126'} />
                      <text x="50" y="50" textAnchor="middle" fontSize="16" fontWeight="700" fill={col}>{pct.toFixed(0)}%</text>
                    </svg>
                    <p style={{ fontSize: 10, color: C.t3, marginTop: 4 }}>{u.pl} PL | Target 90%</p>
                  </div>
                );
              })}
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
              {/* B1: Bar orizzontale scostamento MOL-G */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Scostamento MOL-G per UO</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Divergenza dal breakeven per unit√† operativa</p>
                <ResponsiveContainer width="100%" height={260}>
                  <BarChart data={scost} layout="vertical" margin={{ left: 50, right: 50 }}>
                    <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
                    <XAxis type="number" tickFormatter={fmtK} fontSize={11} stroke={C.t3} />
                    <YAxis type="category" dataKey="nome" fontSize={12} width={45} stroke={C.t2} />
                    <Tooltip formatter={v => [fmt(v), 'MOL-G']} />
                    <ReferenceLine x={0} stroke={C.t3} strokeWidth={1.5} />
                    <Bar dataKey="scost" name="MOL-G" radius={[0, 4, 4, 0]} barSize={22}>
                      {scost.map((d, i) => <Cell key={i} fill={d.fill} />)}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
                <div style={{ textAlign: 'center', marginTop: 8, fontSize: 13, fontWeight: 600, color: TOT.molG >= 0 ? C.verde : C.rosso }}>
                  MOL-G Gruppo: {fmt(TOT.molG)}
                </div>
              </div>

              {/* B2: Tabella semaforo */}
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Matrice KPI per UO</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Semaforo performance operativa</p>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
                  <thead>
                    <tr style={{ borderBottom: '2px solid ' + C.bordo }}>
                      {['UO', 'MOL-I %', 'MOL-G %', 'Pers. %', 'Occ. %'].map(h => (
                        <th key={h} style={{ padding: '8px 6px', textAlign: h === 'UO' ? 'left' : 'center', color: C.t2, fontWeight: 600, fontSize: 11 }}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {UO.map((u, i) => {
                      const kpis = KPI.filter(k => k.uo === u.cod);
                      const cell = (name) => {
                        const k = kpis.find(x => x.kpi.startsWith(name));
                        if (!k) return <td style={{ textAlign: 'center', color: C.t3, fontSize: 11 }}>n/d</td>;
                        const ac = alertCol(k.a);
                        return <td style={{ textAlign: 'center' }}><span style={{ background: ac.bg, color: ac.color, padding: '2px 8px', borderRadius: 10, fontSize: 11, fontWeight: 600, fontFamily: 'monospace' }}>{fmtPct(k.v)}</span></td>;
                      };
                      return (
                        <tr key={i} style={{ borderBottom: '1px solid ' + C.bordo, cursor: 'pointer' }} onClick={() => setSelUO(u)}>
                          <td style={{ padding: '10px 6px', fontWeight: 600, color: C.t1 }}>
                            <span style={{ display: 'inline-block', width: 10, height: 10, borderRadius: 3, background: u.colore, marginRight: 8 }}></span>
                            {u.cod}
                            <Badge reale={u.datiReali} />
                          </td>
                          {cell('MOL-I')}{cell('MOL-G')}{cell('Pers')}{cell('Occ')}
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
                <div style={{ marginTop: 12, display: 'flex', gap: 16, justifyContent: 'center' }}>
                  {[{ c: C.verdeBg, t: C.verde, l: 'In target' }, { c: C.gialloBg, t: C.giallo, l: 'Attenzione' }, { c: C.rossoBg, t: C.rosso, l: 'Critico' }]
                    .map(leg => <span key={leg.l} style={{ fontSize: 10, display: 'flex', alignItems: 'center', gap: 4 }}>
                      <span style={{ width: 10, height: 10, borderRadius: 3, background: leg.c, border: '1px solid ' + leg.t }}></span>{leg.l}
                    </span>)}
                </div>
              </div>
            </div>

            {/* Sintesi direzionale */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 12 }}>Sintesi Direzionale</h3>
              {narrative.filter(n => n.uo === 'GRUPPO').map((n, i) => {
                const ac = alertCol(n.alert);
                return (
                  <div key={i} style={{ padding: '12px 16px', background: ac.bg, borderRadius: 8, borderLeft: '4px solid ' + ac.color, marginBottom: 8 }}>
                    <p style={{ fontSize: 12, color: C.t1, lineHeight: 1.6, marginBottom: 4 }}>{n.testo}</p>
                    <p style={{ fontSize: 11, color: C.t2, fontStyle: 'italic' }}>Outlook: {n.outlook}</p>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* ======================== STRUTTURE ======================== */}
        {tab === 'strutture' && (
          <div>
            <div style={{ display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' }}>
              {UO.map(u => (
                <button key={u.cod} onClick={() => setSelUO(u)}
                  style={{ padding: '8px 16px', border: '2px solid ' + (selUO && selUO.cod === u.cod ? u.colore : C.bordo), background: selUO && selUO.cod === u.cod ? u.colore + '15' : C.card, borderRadius: 8, cursor: 'pointer', fontSize: 13, fontWeight: 600, color: selUO && selUO.cod === u.cod ? u.colore : C.t2, fontFamily: 'inherit' }}>
                  {u.cod} ‚Äî {u.nome}
                </button>
              ))}
            </div>
            {(() => {
              const u = selUO || UO[0];
              const data = mesi.map((m, i) => ({ mese: m, Ricavi: u.rM[i], Costi: u.cM[i], MOL: u.rM[i] - u.cM[i] }));
              const uKpi = KPI.filter(k => k.uo === u.cod);
              const uNarr = narrative.find(n => n.uo === u.cod);
              return (
                <div style={cardS}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                    <div>
                      <h3 style={{ fontSize: 17, fontWeight: 700, color: C.t1 }}>{u.nome} <Badge reale={u.datiReali} /></h3>
                      <p style={{ fontSize: 12, color: C.t2 }}>{u.tipo}{u.pl > 0 ? ' ‚Äî ' + u.pl + ' PL' : ''} | Ricavo/gg: {u.ricGg ? '‚Ç¨' + u.ricGg.toFixed(0) : 'n/a'}</p>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontSize: 22, fontWeight: 700, color: u.molG >= 0 ? C.verde : C.rosso }}>{fmt(u.molG)}</div>
                      <div style={{ fontSize: 11, color: C.t3 }}>MOL Gestionale ({fmtPct(u.molGPct)})</div>
                    </div>
                  </div>
                  {/* KPI */}
                  <div style={{ display: 'flex', gap: 10, marginBottom: 16, flexWrap: 'wrap' }}>
                    {uKpi.map((k, i) => {
                      const ac = alertCol(k.a);
                      return (
                        <div key={i} style={{ padding: '8px 12px', borderRadius: 8, background: ac.bg, borderLeft: '3px solid ' + ac.color, flex: '1 1 120px' }}>
                          <div style={{ fontSize: 10, color: C.t2 }}>{k.kpi}</div>
                          <div style={{ fontSize: 18, fontWeight: 700, color: ac.color }}>{fmtPct(k.v)}</div>
                          <div style={{ fontSize: 9, color: C.t3 }}>vs {fmtPct(k.tgt)}</div>
                        </div>
                      );
                    })}
                  </div>
                  {/* Narrative */}
                  {uNarr && (
                    <div style={{ padding: '10px 14px', background: alertCol(uNarr.alert).bg, borderRadius: 8, borderLeft: '4px solid ' + alertCol(uNarr.alert).color, marginBottom: 16 }}>
                      <p style={{ fontSize: 12, color: C.t1, lineHeight: 1.5 }}>{uNarr.testo}</p>
                    </div>
                  )}
                  {/* Chart */}
                  <ResponsiveContainer width="100%" height={300}>
                    <ComposedChart data={data} margin={{ top: 10, right: 20, left: 10, bottom: 5 }}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                      <XAxis dataKey="mese" fontSize={12} stroke={C.t3} />
                      <YAxis tickFormatter={fmtK} fontSize={11} stroke={C.t3} />
                      <Tooltip formatter={v => [fmt(v)]} />
                      <Legend />
                      <Bar dataKey="Ricavi" fill={u.colore} radius={[4,4,0,0]} barSize={20} />
                      <Bar dataKey="Costi" fill={C.budget} radius={[4,4,0,0]} barSize={20} />
                      <Line type="monotone" dataKey="MOL" name="MOL-I" stroke={C.verde} strokeWidth={2} dot={{ r: 3 }} />
                    </ComposedChart>
                  </ResponsiveContainer>
                </div>
              );
            })()}
          </div>
        )}

        {/* ======================== TREND ======================== */}
        {tab === 'trend' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
            {/* B3: Multi-UO overlay */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Trend Ricavi per UO ‚Äî Confronto 12 Mesi</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Clicca sulla legenda per nascondere/mostrare le linee</p>
              <ResponsiveContainer width="100%" height={380}>
                <LineChart data={trendUO} margin={{ top: 10, right: 20, left: 10, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                  <XAxis dataKey="mese" fontSize={12} stroke={C.t3} />
                  <YAxis tickFormatter={fmtK} fontSize={11} stroke={C.t3} />
                  <Tooltip formatter={(v, name) => [fmt(v), name]} />
                  <Legend />
                  {UO.map(u => (
                    <Line key={u.cod} type="monotone" dataKey={u.cod} stroke={u.colore} strokeWidth={u.cod === 'COS' ? 3 : 2} dot={{ r: 3 }} activeDot={{ r: 6 }} />
                  ))}
                </LineChart>
              </ResponsiveContainer>
            </div>
            {/* Mini sparklines per UO */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: 12 }}>
              {UO.map(u => {
                const data = mesi.map((m, i) => ({ m, R: u.rM[i], C: u.cM[i] }));
                return (
                  <div key={u.cod} style={{ ...cardS, padding: 14 }}>
                    <div style={{ display: 'flex', alignItems: 'center', marginBottom: 8 }}>
                      <span style={{ width: 10, height: 10, borderRadius: '50%', background: u.colore, display: 'inline-block', marginRight: 6 }}></span>
                      <span style={{ fontSize: 13, fontWeight: 600, color: C.t1 }}>{u.cod}</span>
                      <span style={{ fontSize: 11, color: C.t3, marginLeft: 6 }}>{u.tipo}</span>
                      <Badge reale={u.datiReali} />
                      <span style={{ marginLeft: 'auto', fontSize: 11, padding: '2px 8px', borderRadius: 12, background: u.molGPct >= .08 ? C.verdeBg : u.molGPct >= 0 ? C.gialloBg : C.rossoBg, color: u.molGPct >= .08 ? C.verde : u.molGPct >= 0 ? C.giallo : C.rosso, fontWeight: 600 }}>
                        MOL-G {fmtPct(u.molGPct)}
                      </span>
                    </div>
                    <ResponsiveContainer width="100%" height={120}>
                      <LineChart data={data} margin={{ top: 5, right: 10, left: 0, bottom: 5 }}>
                        <XAxis dataKey="m" fontSize={9} tick={{ fill: C.t3 }} />
                        <YAxis tickFormatter={v => (v/1000).toFixed(0) + 'k'} fontSize={9} width={38} />
                        <Tooltip formatter={v => [fmt(v)]} />
                        <Line type="monotone" dataKey="R" name="Ricavi" stroke={u.colore} strokeWidth={2} dot={false} />
                        <Line type="monotone" dataKey="C" name="Costi" stroke={C.rossoChiaro} strokeWidth={1.5} dot={false} strokeDasharray="4 3" />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* ======================== CASH FLOW ======================== */}
        {tab === 'cashflow' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
            {/* C1: Waterfall */}
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Composizione Cash Flow Annuale</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Waterfall da Ricavi a Cash Flow Netto ‚Äî Gruppo Karol Sicilia</p>
              <ResponsiveContainer width="100%" height={340}>
                <BarChart data={waterfall} margin={{ top: 20, right: 20, left: 20, bottom: 50 }}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                  <XAxis dataKey="voce" fontSize={10} angle={-35} textAnchor="end" height={60} stroke={C.t2} />
                  <YAxis tickFormatter={fmtM} fontSize={11} stroke={C.t3} />
                  <Tooltip formatter={(v, name) => { if (name === 'base') return ['','']; return [fmtM(v), 'Valore']; }} />
                  <Bar dataKey="base" stackId="a" fill="transparent" />
                  <Bar dataKey="barra" stackId="a" radius={[3,3,0,0]} barSize={36}>
                    {waterfall.map((d, i) => <Cell key={i} fill={d.col} />)}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
              <div style={{ display: 'flex', justifyContent: 'center', gap: 20, marginTop: 8 }}>
                {[{ c: C.verde, l: 'Entrate' }, { c: C.rosso, l: 'Uscite' }, { c: '#2563eb', l: 'Subtotali' }, { c: '#b91c1c', l: 'CF Netto (neg.)' }]
                  .map(leg => <span key={leg.l} style={{ fontSize: 11, display: 'flex', alignItems: 'center', gap: 5 }}>
                    <span style={{ width: 12, height: 12, borderRadius: 3, background: leg.c }}></span>{leg.l}
                  </span>)}
              </div>
            </div>

            {/* C2+C3: Cassa + Scenari */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Saldo Cassa ‚Äî 12 Settimane</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Soglia minima ‚Ç¨200k (linea tratteggiata)</p>
                <ResponsiveContainer width="100%" height={260}>
                  <AreaChart data={cassaSett} margin={{ top: 10, right: 10, left: 10, bottom: 5 }}>
                    <defs>
                      <linearGradient id="gradC" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="5%" stopColor={C.CTA} stopOpacity={0.2}/>
                        <stop offset="95%" stopColor={C.CTA} stopOpacity={0}/>
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                    <XAxis dataKey="s" fontSize={11} stroke={C.t3} />
                    <YAxis tickFormatter={v => '‚Ç¨' + v + 'k'} fontSize={11} stroke={C.t3} domain={[0, 600]} />
                    <Tooltip formatter={v => ['‚Ç¨' + v + 'k']} />
                    <ReferenceLine y={200} stroke={C.rosso} strokeDasharray="6 4" strokeWidth={2} label={{ value: 'Soglia min.', position: 'right', fontSize: 10, fill: C.rosso }} />
                    <Area type="monotone" dataKey="saldo" name="Saldo" stroke={C.CTA} strokeWidth={2.5} fill="url(#gradC)" dot={(props) => {
                      const { cx, cy, payload } = props;
                      if (payload.saldo < 200) return <circle cx={cx} cy={cy} r={5} fill={C.rosso} stroke="white" strokeWidth={2} />;
                      return <circle cx={cx} cy={cy} r={3} fill={C.CTA} stroke="white" strokeWidth={1.5} />;
                    }} />
                  </AreaChart>
                </ResponsiveContainer>
                <div style={{ marginTop: 8, padding: '8px 12px', background: C.rossoBg, borderRadius: 6, fontSize: 11, color: C.rosso, fontWeight: 500 }}>
                  ‚ö†Ô∏è S10: Saldo ‚Ç¨180k sotto soglia ‚Äî possibile tensione di cassa per ritardo incassi ASP
                </div>
              </div>

              <div style={cardS}>
                <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Cash Flow Cumulato ‚Äî Scenari 5 Anni</h3>
                <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Ottimistico / Base / Pessimistico (‚Ç¨k cumulati)</p>
                <ResponsiveContainer width="100%" height={260}>
                  <ComposedChart data={scenari} margin={{ top: 10, right: 10, left: 10, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                    <XAxis dataKey="anno" fontSize={12} stroke={C.t3} />
                    <YAxis tickFormatter={v => '‚Ç¨' + v + 'k'} fontSize={11} stroke={C.t3} />
                    <Tooltip formatter={v => ['‚Ç¨' + v + 'k']} />
                    <Legend />
                    <ReferenceLine y={0} stroke={C.t3} strokeWidth={1} />
                    <Line type="monotone" dataKey="ott" name="Ottimistico" stroke={C.verde} strokeWidth={2} dot={{ r: 4, fill: C.verde }} />
                    <Line type="monotone" dataKey="base" name="Base" stroke={C.CTA} strokeWidth={3} dot={{ r: 4, fill: C.CTA }} />
                    <Line type="monotone" dataKey="pess" name="Pessimistico" stroke={C.rosso} strokeWidth={2} strokeDasharray="6 3" dot={{ r: 4, fill: C.rosso }} />
                  </ComposedChart>
                </ResponsiveContainer>
                <div style={{ marginTop: 8, padding: '8px 12px', background: '#fffbeb', borderRadius: 6, fontSize: 11, color: '#92400e' }}>
                  Scenario pessimistico: CF negativo dal 2027 ‚Äî necessaria rinegoziazione debito o riduzione CAPEX
                </div>
              </div>
            </div>

            {/* C4: KPI Cash Flow */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12 }}>
              {[
                { label: 'DSO ASP', valore: '135 gg', target: '< 120 gg', sem: React.createElement(Semaforo, { valore: 135, verdeMin: 120, gialloMin: 150, invertito: true }) },
                { label: 'DPO Fornitori', valore: '95 gg', target: '< 120 gg', sem: React.createElement(Semaforo, { valore: 95, verdeMin: 90, gialloMin: 120, invertito: true }) },
                { label: 'DSCR', valore: '1.15x', target: '> 1.2x', sem: React.createElement(Semaforo, { valore: 1.15, verdeMin: 1.2, gialloMin: 1.0 }) },
                { label: 'Copertura Cassa', valore: '1.8 mesi', target: '> 2.0 mesi', sem: React.createElement(Semaforo, { valore: 1.8, verdeMin: 2.0, gialloMin: 1.0 }) },
              ].map((kpi, i) => (
                <div key={i} style={{ ...cardS, textAlign: 'center' }}>
                  <div style={{ fontSize: 11, color: C.t3, fontWeight: 500 }}>{kpi.label}</div>
                  <div style={{ fontSize: 20, fontWeight: 700, color: C.t1, margin: '6px 0' }}>{kpi.valore}</div>
                  <div style={{ marginBottom: 6 }}>{kpi.sem}</div>
                  <div style={{ fontSize: 10, color: C.t3 }}>Target: {kpi.target}</div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* ======================== ANALISI ======================== */}
        {tab === 'analisi' && (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
            <div style={cardS}>
              <h3 style={{ fontSize: 15, fontWeight: 700, color: C.t1, marginBottom: 4 }}>Variance Analysis ‚Äî Decomposizione Scostamenti</h3>
              <p style={{ fontSize: 11, color: C.t3, marginBottom: 16 }}>Driver decomposition con narrative per il management</p>
              {narrative.map((n, i) => {
                const u = UO.find(x => x.cod === n.uo);
                const ac = alertCol(n.alert);
                return (
                  <div key={i} style={{ marginBottom: 12, padding: '14px 16px', borderRadius: 10, background: ac.bg, borderLeft: '5px solid ' + ac.color }}>
                    <div style={{ display: 'flex', alignItems: 'center', marginBottom: 6 }}>
                      {u && <span style={{ width: 10, height: 10, borderRadius: '50%', background: u.colore, display: 'inline-block', marginRight: 8 }}></span>}
                      <span style={{ fontWeight: 700, fontSize: 14, color: C.t1 }}>{n.uo === 'GRUPPO' ? 'GRUPPO KAROL' : n.uo + ' ‚Äî ' + (u ? u.nome : '')}</span>
                      <span style={{ marginLeft: 8, fontSize: 11, padding: '2px 8px', borderRadius: 12, background: ac.color, color: '#fff' }}>{n.alert}</span>
                      <span style={{ marginLeft: 'auto', fontFamily: 'monospace', fontSize: 13, fontWeight: 600, color: (u ? u.molG : TOT.molG) >= 0 ? C.verde : C.rosso }}>
                        MOL-G: {fmt(u ? u.molG : TOT.molG)}
                      </span>
                    </div>
                    <p style={{ fontSize: 12, color: C.t1, lineHeight: 1.6, marginBottom: 4 }}>{n.testo}</p>
                    <p style={{ fontSize: 11, color: C.t2, fontStyle: 'italic', borderTop: '1px solid ' + ac.color + '33', paddingTop: 6 }}>
                      <strong>Outlook:</strong> {n.outlook}
                    </p>
                  </div>
                );
              })}
            </div>
          </div>
        )}

      </div>

      {/* FOOTER */}
      <div style={{ textAlign: 'center', padding: '16px 0', fontSize: 11, color: C.t3, borderTop: '1px solid ' + C.bordo }}>
        Karol CdG v2.0 ‚Äî Gruppo Karol S.p.A. ‚Äî Dati simulati test pipeline | Finance Analysis: Variance Decomposition + Waterfall
      </div>
    </div>
  );
};

ReactDOM.render(React.createElement(KarolDashboard), document.getElementById('root'));
</script>
</body>
</html>
